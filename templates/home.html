{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
        <h1 class="cim">Kezdőlap</h1>
        <h2>Saját rakományok</h2>
        {% if cargos %}
        <div class="table-actions">
            <button id="deleteSelected" title="Törlés">
                <img src="{{ url_for('static', filename='icons/trash.png') }}" style="width:20px">
            </button>
            <button id="republishSelected" title="Újraközlés">
                <img src="{{ url_for('static', filename='icons/refresh.png') }}" style="width:20px">
            </button>
        </div>

        <div class="table-wrapper">
        <table id="shipmentsTable" class="display" style="font-size: 0.9em; width:100%;">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                    <th>Felvét ország</th>
                    <th>Felvét irányítószám</th>
                    <th>Felvét város</th>
                    <th><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                    <th>Letét ország</th>
                    <th>Letét irányítószám</th>
                    <th>Letét város</th>
                    <th>Áru hossza (m)</th>
                    <th>Áru tömege (t)</th>
                    <th>Jármű típusa</th>
                    <th>Jármű szerkezete</th>
                    <th>Jármű felszereltsége</th>
                    <th>Rakomány rögzítése</th>
                    <th>Bizonyítványok</th>
                    <th style="display:none;">created_at</th>
                </tr>
            </thead>
            <tbody>
                {% for cargo in cargos %}
                <tr data-id="{{ cargo.cargo_id }}">
                    <td><input type="checkbox" class="rowCheckbox"></td>
                    <td>
                        {% if cargo.start_date_1 %}{{ cargo.start_date_1.strftime('%Y.%m.%d.') }}
                        {% if cargo.start_date_2 %} (+{{ (cargo.start_date_2 - cargo.start_date_1).days }}){% endif %}{% endif %}
                        {% if cargo.start_time_1 or cargo.start_time_2 %}
                        <br>{{ cargo.start_time_1.strftime('%H:%M') if cargo.start_time_1 else '' }}
                        – {{ cargo.start_time_2.strftime('%H:%M') if cargo.start_time_2 else '' }}{% endif %}
                    </td>
                    <td>{{ cargo.origin_country.upper() }}</td>
                    <td>{{ cargo.masked_origin_postcode or cargo.origin_postcode }}</td>
                    <td>{{ cargo.masked_origin_city or cargo.origin_city }}</td>
                    <td>
                        {% if cargo.end_date_1 %}{{ cargo.end_date_1.strftime('%Y.%m.%d.') }}
                        {% if cargo.end_date_2 %} (+{{ (cargo.end_date_2 - cargo.end_date_1).days }}){% endif %}{% endif %}
                        {% if cargo.end_time_1 or cargo.end_time_2 %}
                        <br>{{ cargo.end_time_1.strftime('%H:%M') if cargo.end_time_1 else '' }}
                        – {{ cargo.end_time_2.strftime('%H:%M') if cargo.end_time_2 else '' }}{% endif %}
                    </td>
                    <td>{{ cargo.destination_country.upper() }}</td>
                    <td>{{ cargo.masked_destination_postcode or cargo.destination_postcode }}</td>
                    <td>{{ cargo.masked_destination_city or cargo.destination_city }}</td>
                    <td>{{ cargo.size }}</td>
                    <td>{{ cargo.weight }}</td>
                    <td>{{ cargo.vehicle_type or '-' }}</td>
                    <td>{{ cargo.stucture or '-' }}</td>
                    <td>{{ cargo.equipment or '-' }}</td>
                    <td>{{ cargo.cargo_securement or '-' }}</td>
                    <td>{{ cargo.certificates or '-' }}</td>
                    <td style="display:none;">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <p>Nincs még rakomány.</p>
        {% endif %}
    </main>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    var table = $('#shipmentsTable').DataTable({
        "order": [[16, "desc"], [1, "asc"]],
        "pageLength": 25,
        "stripeClasses": ['odd-row', 'even-row'],
        "columnDefs": [{ "orderable": false, "targets": 0 }] // checkbox ne legyen rendezhető
    });

    $('#selectAll').on('click', function() {
        var rows = table.rows({ 'search': 'applied' }).nodes();
        $('input.rowCheckbox', rows).prop('checked', this.checked);
    });

    $('#deleteSelected').on('click', function() {
        var selectedIds = [];
        table.$('input.rowCheckbox:checked').each(function() {
            selectedIds.push($(this).closest('tr').data('id'));
        });

        if(selectedIds.length === 0) {
            alert("Nincs kiválasztva sor!");
            return;
        }

        if(confirm("Biztosan törölni szeretnéd a kiválasztott sorokat?")) {
            $.ajax({
                url: "{{ url_for('delete_cargos') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ ids: selectedIds }),
                success: function(response) {
                    table.rows($('input.rowCheckbox:checked').parents('tr')).remove().draw();
                },
                error: function() {
                    alert("Hiba történt a törlés során!");
                }
            });
        }
    });


    var republishCooldown = false;

$('#republishSelected').on('click', function() {
    if(republishCooldown) {
        alert("Várj, az újraközlés csak 30 másodpercenként lehetséges!");
        return;
    }

    var selectedIds = [];
    table.$('input.rowCheckbox:checked').each(function() {
        selectedIds.push($(this).closest('tr').data('id'));
    });

    if(selectedIds.length === 0) {
        alert("Nincs kiválasztva sor!");
        return;
    }

    if(confirm("Biztosan újraközölni szeretnéd a kiválasztott sorokat?")) {
        $.ajax({
            url: "{{ url_for('republish_cargos') }}", // új backend endpoint
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ ids: selectedIds }),
            success: function(response) {
                table.rows().every(function() {
                    var id = $(this.node()).data('id');
                    if(response.republished.includes(id)) {
                        this.data()[17] = response.now; // updated
                    }
                });
                table.draw(false);
            },

            error: function() {
                alert("Hiba történt az újraközlés során!");
            }
        });
    }
});

});


</script>

<style>
.home-container { display: flex; flex-wrap: wrap; }
.sidebar { flex: 1 1 200px; }
.main-content { flex: 3 1 600px; padding: 15px; }
.table-wrapper { overflow-x: auto; }
.table-actions { margin-bottom: 10px; }
.odd-row { background-color: #fff !important; color: black; }
.even-row { background-color: #f9f9f9 !important; color: black; }
#shipmentsTable { border: 1px solid black; }

@media (max-width: 768px) {
    .home-container { flex-direction: column; }
    .sidebar { order: 1; width: 100%; }
    .main-content { order: 2; width: 100%; }
}
</style>

{% endblock %}
