{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
        <h1 class="cim">Rakományok</h1>

        <div class="cargo-container">
        <button class="accordion-btn">Raktér feltöltése / rakomány keresése ▼</button>
        <!-- Lenyíló form -->
        <div class="accordion-content">
            <!-- Tabs gombok -->
            <div id="form-tab" class="tab-content" style="display:block;">
                <form action="{{ url_for('vehicles.save_vehicle') }}" method="POST" id="vehicleForm" class="freight-form">
                    <div class="template-select-wrapper">
                        <label for="vehicle_template_select"><strong>Sablon betöltése:</strong></label>
                        <!-- Most már látható select -->
                        <select id="vehicle_template_select" name="template_id">
                            <option value="" selected disabled>Válassz sablont</option>
                            {% for t in templates %}
                                <option value="{{ t.id }}">
                                    {{ t.origin_city }} → {{ t.destination_city }} | {{ t.capacity_t }} t | {{ t.volume_m3 }} m³ | {{ t.vehicle_type or '–' }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Eredet -->
                    <div class="form-section">
                        <h4>Hely adatok</h4>
                        <div class="places">
                            <label for="origin" class="elso_label">Honnan?</label>
                            <label for="origin_diff" class="x"></label>
                            <label for="swap-btn" class="y"></label>
                            <label for="destination" class="masodik_label">Hova?</label>
                            <label for="destination_diff" class="z"></label>

                            <div class="autocomplete-wrapper">
                                <input type="text" id="origin" placeholder="Város" autocomplete="off">
                                <div id="origin_suggestions" class="suggestions"></div>
                                <input type="hidden" id="origin_city" name="origin_city">
                                <input type="hidden" id="origin_zip" name="origin_zip">
                                <input type="hidden" id="origin_country" name="origin_country">
                            </div>


                            <select id="origin_diff" name="origin_diff">
                                <option value="0" selected>+0 km</option>
                                <option value="25">+25 km</option>
                                <option value="50">+50 km</option>
                                <option value="100">+100 km</option>
                                <option value="any">+any km</option>
                            </select>
                            <button type="button" id="swap-btn">⇄</button>

                            <div class="autocomplete-wrapper">
                                <input type="text" id="destination" placeholder="Város" autocomplete="off">
                                <div id="destination_suggestions" class="suggestions"></div>
                                <input type="hidden" id="destination_city" name="destination_city">
                                <input type="hidden" id="destination_zip" name="destination_zip">
                                <input type="hidden" id="destination_country" name="destination_country">
                            </div>


                            <select id="destination_diff" name="destination_diff">
                                <option value="0" selected>+0 km</option>
                                <option value="25">+25 km</option>
                                <option value="50">+50 km</option>
                                <option value="100">+100 km</option>
                                <option value="any">+any km</option>
                            </select>

                            <input type="date" id="available_from" name="available_from">
                            <input type="date" id="available_until" name="available_until">
                        </div>

                        <div class="form-section hidden" id="destination-countries-section">
                        <label for="destination_countries">Országok, ahova mehet a jármű</label>
                        <div class="multiselect">
                            <div class="selectBox" onclick="toggleCheckboxes('destination_countries')">
                                <span id="destination_countries-selected">Válassz országot</span> ▼
                            </div>
                            <select id="destination_countries" name="destination_countries" multiple hidden>
                                {% for country in eu_countries %}
                                    <option value="{{ country.code }}">{{ country.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                    </div>

                    </div>
                    <br>

                    <!-- Jármű alapadatok -->
                    <div class="form-section">
                        <h4>About vehicle</h4>
                        <div class="vehicle-col">
                            <label for="vehicle_type">Jármű típusa *</label>
                            <label for="structure">Felépítmény<span class="required">*</span></label>
                            <select id="vehicle_type" name="vehicle_type" required>
                            <option value="" disabled selected>Válassz jármű típust</option>
                            <option value="Jármű 3,5 t-ig">Jármű 3,5 t-ig</option>
                            <option value="Nyerges szerelvény">Nyerges szerelvény</option>
                            <option value="Pótos szerelvény">Pótos szerelvény</option>
                            <option value="Tehergépjármű 7,5 t-ig">Tehergépjármű 7,5 t-ig</option>
                            <option value="Tehergépjármű 12 t-ig">Tehergépjármű 12 t-ig</option>
                        </select>
                            <select id="structure" name="structure" required>
                                <option value="" disabled selected>Válassz felépítményt</option>
                                <option value="Autószállító">Autószállító</option>
                                <option value="Billenős konténer">Billenős konténer</option>
                                <option value="Cserefelépítmény-Chassis">Cserefelépítmény-Chassis</option>
                                <option value="Dobozos">Dobozos</option>
                                <option value="Furgon">Furgon</option>
                                <option value="Dupla kabinos">Dupla kabinos</option>
                                <option value="Félpótkocsi">Félpótkocsi</option>
                                <option value="Hűtő">Hűtő</option>
                                <option value="Jumbo">Jumbo</option>
                                <option value="Klipper">Klipper</option>
                                <option value="Konténerszállító">Konténerszállító</option>
                                <option value="Kábeldobszálíltó">Kábeldobszálíltó</option>
                                <option value="Középrakodós">Középrakodós</option>
                                <option value="Mega">Mega</option>
                                <option value="Mozgópadlós">Mozgópadlós</option>
                                <option value="Mozgópadlós (ömlesztett áru)">Mozgópadlós (ömlesztett áru)</option>
                                <option value="Mélybölcsős">Mélybölcsős</option>
                                <option value="Nyitott tehergépkocsi">Nyitott tehergépkocsi</option>
                                <option value="Oldalrakodós">Oldalrakodós</option>
                                <option value="Ponyvás">Ponyvás</option>
                                <option value="Sasszé">Sasszé</option>
                                <option value="Siló">Siló</option>
                                <option value="Speciális jármű">Speciális jármű</option>
                                <option value="Szigetelt">Szigetelt</option>
                                <option value="Szállítószalagos">Szállítószalagos</option>
                                <option value="Tartálykocsi">Tartálykocsi</option>
                                <option value="Tautliner">Tautliner</option>
                                <option value="Tele">Tele</option>
                                <option value="Vontató">Vontató</option>
                            </select>

                            <label for="equipment">Felszereltség</label>
                            <label for="securement">Rakományrögzítés</label>

                            <!-- Felszereltség -->
                            <div class="multiselect">
                                <div class="selectBox" onclick="toggleCheckboxes('equipment')">
                                    <span id="equipment-selected">Válassz felszereltséget</span> ▼
                                </div>
                                <div class="checkboxes" id="equipment-checkboxes" data-editor-usable="equipment">
                                    <label><input type="checkbox" value="2. sofőr"> 2. sofőr </label>
                                    <label><input type="checkbox" value="A-Schild"> A-Schild </label>
                                    <label><input type="checkbox" value="ADR"> ADR </label>
                                    <label><input type="checkbox" value="BF3 kísérőjármű"> BF3</label>
                                    <label><input type="checkbox" value="BF4 kísérőjármű"> BF4</label>
                                    <label><input type="checkbox" value="Béka"> Béka</label>
                                    <label><input type="checkbox" value="Emelőhátfal"> Emelőhátfal</label>
                                    <label><input type="checkbox" value="Farönkszállító"> Farönkszállító</label>
                                    <label><input type="checkbox" value="GPS követő"> GPS követő</label>
                                    <label><input type="checkbox" value="Húskampó"> Húskampó</label>
                                    <label><input type="checkbox" value="Rakodódaru"> Rakodódaru</label>
                                    <label><input type="checkbox" value="Rámpa"> Rámpa</label>
                                    <label><input type="checkbox" value="Takaróponyva"> Takaróponyva</label>
                                    <label><input type="checkbox" value="Targonca"> Targonca</label>
                                    <label><input type="checkbox" value="Válaszfal"> Válaszfal</label>
                                    <label><input type="checkbox" value="Vámzsinór"> Vámzsinór</label>
                                </div>
                            </div>
                            <select id="equipment" name="equipment" multiple hidden>
                                <option value="2. sofőr">2. sofőr</option>
                                <option value="A-Schild">A-Schild</option>
                                <option value="ADR">ADR</option>
                                <option value="BF3 kísérőjármű">BF3 kísérőjármű</option>
                                <option value="BF4 kísérőjármű">BF4 kísérőjármű</option>
                                <option value="Béka">Béka</option>
                                <option value="Emelőhátfal">Emelőhátfal</option>
                                <option value="Farönkszállító">Farönkszállító</option>
                                <option value="GPS követő">GPS követő</option>
                                <option value="Húskampó">Húskampó</option>
                                <option value="Rakodódaru">Rakodódaru</option>
                                <option value="Rámpa">Rámpa</option>
                                <option value="Takaróponyva">Takaróponyva</option>
                                <option value="Targonca">Targonca</option>
                                <option value="Válaszfal">Válaszfal</option>
                                <option value="Vámzsinór">Vámzsinór</option>
                            </select>

                            <!-- Rakományrögzítés -->
                            <div class="multiselect">
                                <div class="selectBox" onclick="toggleCheckboxes('securement')">
                                    <span id="securement-selected">Válassz rakományrögzítést</span> ▼
                                </div>
                                <div class="checkboxes" id="securement-checkboxes" data-editor-usable="securement">
                                    <label><input type="checkbox" value="Csúszásgátló"> Csúszásgátló</label>
                                    <label><input type="checkbox" value="Láncos feszítő"> Láncos feszítő</label>
                                    <label><input type="checkbox" value="Multilock"> Multilock</label>
                                    <label><input type="checkbox" value="Oldalfalas"> Oldalfalas</label>
                                    <label><input type="checkbox" value="Palettarögzítő gerenda"> Rögzítő gerenda</label>
                                    <label><input type="checkbox" value="Rakományrögzítő rúd"> Rakományrögzítő rúd</label>
                                    <label><input type="checkbox" value="Rakonca"> Rakonca</label>
                                    <label><input type="checkbox" value="Spanifer"> Spanifer</label>
                                    <label><input type="checkbox" value="Élvédő"> Élvédő</label>
                                </div>
                            </div>
                            <select id="securement" name="securement" multiple hidden>
                                <option value="Csúszásgátló">Csúszásgátló</option>
                                <option value="Láncos feszítő">Láncos feszítő</option>
                                <option value="Multilock">Multilock</option>
                                <option value="Oldalfalas">Oldalfalas</option>
                                <option value="Palettarögzítő gerenda">Palettarögzítő gerenda</option>
                                <option value="Rakományrögzítő rúd">Rakományrögzítő rúd</option>
                                <option value="Rakonca">Rakonca</option>
                                <option value="Spanifer">Spanifer</option>
                                <option value="Élvédő">Élvédő</option>
                            </select>
                        </div>
                        <!-- Leírás + Rendszám sor -->
                        <div class="form-row" style="display: flex; gap: 15px; align-items: flex-start; margin-top: 10px;">
                            <!-- Leírás -->
                            <div class="form-group" style="flex: 3;">
                                <label for="description">Leírás</label>
                                <textarea id="description" name="description" placeholder="Részletek a járműről" rows="1" style="width: 100%; max-height: 35px;"></textarea>
                            </div>

                            <!-- Rendszám -->
                            <div class="form-group" style="flex: 1;">
                                <label for="license_plate">
                                    Rendszám
                                    <span data-bs-toggle="tooltip" title="A rendszám nem fog megjelenni senki számára, amíg az üzlet meg nem köttetik. A gyorsabb ügyintézés miatt érdemes megadni.">
                                        <img src="{{ url_for('static', filename='icons/tooltip.png') }}" alt="Tooltip" style="width:16px; height:16px; vertical-align: middle;">
                                    </span>
                                </label>
                                <input type="text" id="license_plate" name="license_plate" placeholder="Pl. ABC-123" maxlength="10" style="width: 100%;">
                            </div>
                        </div>

                    </div>

                    <!-- Díj / Kapacitás sor átalakítva flexbox-szal -->
                    <div class="form-section flex-row">
                        <div style="flex: 0 0 25%; padding-right:5px;">
                            <label for="capacity_t">Kapacitás (t)</label>
                            <input type="number" step="0.1" id="capacity_t" name="capacity_t">
                        </div>

                        <div style="flex: 0 0 25%; padding-right:5px;">
                            <label for="volume_m3">Raktér méret (m³)</label>
                            <input type="number" step="0.1" id="volume_m3" name="volume_m3">
                        </div>

                        <div style="flex: 0 0 30%; padding-right:5px;">
                            <label for="price">Ár</label>
                            <input type="number" step="0.01" id="price" name="price">
                        </div>

                        <div style="flex: 0 0 15%;">
                            <label for="currency">Pénznem</label>
                            <select id="currency" name="currency">
                                <option value="EUR">EUR</option>
                                <option value="HUF">HUF</option>
                            </select>
                        </div>
                    </div>

                    <div class="cards-row">
                        <div id="paletteCard" class="palette-card">Raklap csere <img src="{{ url_for('static', filename='icons/exchange_palette.png') }}" alt="Palettacsere"></div>
                        <input type="hidden" id="palette_exch" name="palette_exchange" value="false">

                        <div id="oversizeCard" class="oversize-card">Túlméretes áru<img src="{{ url_for('static', filename='icons/oversize.png') }}" alt="Túlméretes"></div>
                        <input type="hidden" id="oversize" name="oversize" value="false">

                        <div id="loadtypeCard" class="loadtype-card">Részrakomány <img src="{{ url_for('static', filename='icons/ltl.png') }}" alt="LTL"></div>
                        <input type="hidden" id="load_type" name="load_type" value="false">

                        <div id="publicLicenseCard" class="publiclicense-card" title="Mások számára is elérhető lesz a rendszám már az üzletkötés előtt. Ne aggódj, nem fogjuk az arcukba nyomni.">Publikus rendszám <img src="{{ url_for('static', filename='icons/license_plate.png') }}" alt="License plate"></div>
                        <input type="hidden" id="public_license" name="public_license" value="false">
                    </div>

                    <input type="hidden" id="origin_lat" name="origin_lat">
                    <input type="hidden" id="origin_lon" name="origin_lon">
                    <input type="hidden" id="destination_lat" name="destination_lat">
                    <input type="hidden" id="destination_lon" name="destination_lon">
                    <input type="hidden" id="routeCoordsInput" name="routeCoordsInput">
                    <!-- Checkboxok a mentés előtt -->
                    <div class="sablon-wrapper">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="sablonCheckbox" name="sablonCheckbox" class="sablon">
                            <span class="checkmark"></span>
                            Mentés sablonként
                        </label>

                        <label class="custom-checkbox">
                            <input type="checkbox" id="longtermCheckbox" name="longtermCheckbox" class="sablon">
                            <span class="checkmark"></span>
                            Mentés állandó fuvarként
                        </label>
                    </div>

                    <div class="btn-wrapper" style="margin-top:15px;">
                        <button type="submit">Keresés és mentés</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- Ezt cseréld be az eredeti modal-dialog sor helyére -->
        <div class="modal fade" id="cargoModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Rakomány részletek</h5>
              </div>
              <div class="modal-body" id="cargoDetails">
                <!-- Ide töltjük majd AJAX-szal a részleteket -->
              </div>
            </div>
          </div>
        </div>

        {% if cargos %}
        <div class="table-wrapper">
            <table id="shipmentsTable" class="display" style="font-size: 0.9em; border:none;">
            <thead>
                <tr>
                    <th class="felvet datum"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                    <th class="felvet">Rakomány felvétel</th>
                    <th class="letet datum"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                    <th class="letet">Rakomány letétel</th>
                    <th class="arujarmu"><img src="{{ url_for('static', filename='icons/length2.png') }}" style="width: 24px"> (m)</th>
                    <th class="arujarmu"><img src="{{ url_for('static', filename='icons/weight.png') }}" style="width: 28px"> (t)</th>
                    <th class="arujarmu">Jármű típusa</th>
                    <th class="arujarmu">Felépítmény</th>
                    <th class="arujarmu">Felszerelés</th>
                    <th class="arujarmu">Rögzítés</th>
                    <th class="arujarmu">Extrák</th>
                    <th class="arujarmu">Megjegyzés</th>
                    <th class="hirdeto">Hirdető cég</th>
                    <th class="action-column letet"></th>
                    <th style="display:none;">created_at</th> <!-- rejtett oszlop a csökkenő rendezéshez -->
                </tr>
            </thead>
            <tbody>
                {% for cargo in cargos %}
                <tr class="cargo-row" data-cargo-id="{{ cargo.cargo_id }}" style="cursor:pointer;">
                    {# Pickup dátum + idő #}
                    <td class="datum">
                        {% set pickups = cargo.locations | selectattr('type', 'equalto', 'pickup') | list %}
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% if first_pickup.start_date %}
                                {% if first_pickup.start_date.year == current_year %}
                                    {{ first_pickup.start_date.strftime('%m.%d.') }}
                                {% else %}
                                    {{ first_pickup.start_date.strftime('%Y.%m.%d.') }}
                                {% endif %}
                                {% if first_pickup.end_date %}
                                    {% set delta = (first_pickup.end_date - first_pickup.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}

                            {% if first_pickup.start_time_1 or first_pickup.start_time_2 %}
                                <br>
                                {{ first_pickup.start_time_1.strftime('%H:%M') if first_pickup.start_time_1 else '' }}
                                – {{ first_pickup.start_time_2.strftime('%H:%M') if first_pickup.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    {# Pickup hely #}
                    <td class="pickup-cell">
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% set extra_pickups = pickups|length - 1 %}
                            <span class="country-zip">
                                {{ first_pickup.country.upper() }} {{ first_pickup.masked_postcode if first_pickup.is_hidden else first_pickup.postcode }}
                            </span>
                            <br>
                            <span class="city">
                                {{ first_pickup.masked_city if first_pickup.is_hidden else first_pickup.city }}
                            </span>
                            {% if extra_pickups > 0 %}
                                <br><span class="extra-count">(+{{ extra_pickups }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    {# Dropoff dátum + idő #}
                    <td class="datum">
                        {% set dropoffs = cargo.locations | selectattr('type', 'equalto', 'dropoff') | list %}
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% if last_dropoff.start_date %}
                                {% if last_dropoff.start_date.year == current_year %}
                                    {{ last_dropoff.start_date.strftime('%m.%d.') }}
                                {% else %}
                                    {{ last_dropoff.start_date.strftime('%Y.%m.%d.') }}
                                {% endif %}
                                {% if last_dropoff.end_date %}
                                    {% set delta = (last_dropoff.end_date - last_dropoff.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}

                            {% if last_dropoff.start_time_1 or last_dropoff.start_time_2 %}
                                <br>
                                {{ last_dropoff.start_time_1.strftime('%H:%M') if last_dropoff.start_time_1 else '' }}
                                – {{ last_dropoff.start_time_2.strftime('%H:%M') if last_dropoff.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    {# Dropoff hely #}
                    <td class="dropoff-cell">
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% set extra_dropoffs = dropoffs|length - 1 %}
                            <span class="country-zip">
                                {{ last_dropoff.country.upper() }} {{ last_dropoff.masked_postcode if last_dropoff.is_hidden else last_dropoff.postcode }}
                            </span>
                            <br>
                            <span class="city">
                                {{ last_dropoff.masked_city if last_dropoff.is_hidden else last_dropoff.city }}
                            </span>
                            {% if extra_dropoffs > 0 %}
                                <br><span class="extra-count">(+{{ extra_dropoffs }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    {# A többi oszlop változatlan marad #}
                    <td>{{ cargo.size }}</td>
                    <td>{{ cargo.weight }}</td>
                    <td>{{ cargo.vehicle_type or '-' }}</td>
                    <td>{{ cargo.structure or '-' }}</td>
                    <td>{{ cargo.equipment or '-' }}</td>
                    <td>{{ cargo.cargo_securement or '-' }}</td>
                    <td>
                        {% set extras = [] %}
                        {% if cargo.palette_exchange %}{% set _ = extras.append('Palettacsere') %}{% endif %}
                        {% if cargo.oversize %}{% set _ = extras.append('Túlméretes áru') %}{% endif %}
                        {{ extras|join('<br>') | safe if extras else '-' }}
                    </td>
                    <td>
                        {% set notes = [] %}
                        {% if cargo.description %}{% set _ = notes.append("Rakomány: " ~ (cargo.description[:50] ~ ('...' if cargo.description|length > 30 else ''))) %}{% endif %}
                        {% if cargo.note %}{% set _ = notes.append("Jármű: " ~ (cargo.note[:50] ~ ('...' if cargo.note|length > 30 else ''))) %}{% endif %}
                        {{ notes|join('<br>')|safe if notes else '-' }}
                    </td>

                    <td>
                        {% if cargo.company %}
                            <a href="{{ url_for('company.company_profile', slug=cargo.company.slug) }}">
                                {{ cargo.company.name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="action-column-right">
                        {% if cargo.user_id == current_user.user_id %}
                            <button class="action-btn offer-btn" disabled title="Saját rakományra nem adhatsz ajánlatot" style="background-color:#ccc; cursor:not-allowed;">🤝</button>
                        {% else %}
                            <button class="action-btn offer-btn" title="Ajánlattétel">🤝</button>
                        {% endif %}
                    </td>
                    <td style="display:none;">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nincs még rakomány.</p>
        {% endif %}
        </div>

        <!-- Modal a konkrét jármű ajánláshoz -->
        <div class="modal fade" id="specificvehicleModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hirdetett rakterek kiválasztása</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Ide töltjük az AJAX-szal a raktereket -->
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
/* Modal body: középre rendezés */
#specificvehicleModal .modal-body {
    display: flex;
    flex-direction: column;   /* függőleges lista */
    align-items: center;      /* vízszintesen középre */
    gap: 15px;                /* kis távolság a gombok között */
    padding: 20px;
}

#specificvehicleModal .vehicle-list {
    width: 80%;
}

/* Vehicle gombok a modalban - konkrét modal szelektorral, felülírja a Bootstrap-et */
#specificvehicleModal .vehicle-select-btn {
    width: 100% !important;               /* teljes szélesség */
    text-align: center !important;
    display: block !important;
    padding: 10px 0 !important;
    font-size: 16px !important;
    border-radius: 8px !important;
    border: 1px solid #333 !important;
    background-color: #eee !important;
    color: #000 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    margin: 0;
}

#specificvehicleModal .vehicle-select-btn.active {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #fff !important;
    margin:0;
}
/* Modal body: középre rendezés */
#specificvehicleModal .modal-body {
    display: flex;
    flex-direction: column;   /* függőleges lista */
    align-items: center;      /* vízszintesen középre */
    gap: 15px;                /* kis távolság a gombok között */
    padding: 20px;
    margin:0;
}

#specificvehicleModal .vehicle-list {
    width: 80%;
}

/* Vehicle gombok a modalban - konkrét modal szelektorral, felülírja a Bootstrap-et */
#specificvehicleModal .vehicle-select-btn {
    width: 100% !important;               /* teljes szélesség */
    text-align: center !important;
    display: block !important;
    padding: 10px 0 !important;
    font-size: 16px !important;
    border-radius: 8px !important;
    border: 1px solid #333 !important;
    background-color: #eee !important;
    color: #000 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

#specificvehicleModal .vehicle-select-btn.active, #specificvehicleModal .vehicle-select-btn.active:hover{
    background-color: #1d1d1d !important;
    border-color: #1d1d1d !important;
    color: #fff !important;
}

#specificvehicleModal .vehicle-select-btn:hover {
    background-color: #818181 !important;
    border-color: #818181 !important;
    color: #fff !important;
}

#vehicle-cancel-btn {
    border: 1px solid #ccc;
    color: #999;
    background-color: #fff;
}

#vehicle-select-confirm-btn:disabled {
    background-color: #ddd;
    border-color: #ccc;
    color: #999;
}

.sablon-wrapper {
    margin-top: 10px;
    width: 15vw;
    display: flex;
    flex-direction: column; /* egymás alá */
    gap: 0.5em;             /* kis távolság a checkboxok között */
}

/* A label legyen flex, a checkmark mindig bal oldalon */
.custom-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    position: relative;
    font-size: 0.9em;
    user-select: none;
}

/* Eredeti checkbox elrejtése */
.custom-checkbox input[type="checkbox"] {
    display: none;
}

/* Saját checkmark stílus */
.custom-checkbox .checkmark {
    width: 25px;
    height: 25px;
    border: 2px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    position: relative;
    margin-right: 10px; /* szöveg és checkmark közti távolság */
}

/* Pipa megjelenítése, ha checked */
.custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: "";
    position: absolute;
    left: 6px;
    top: 2px;
    width: 8px;
    height: 16px;
    border: solid #333;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}


@media (max-width: 1550px) {
    .vehicle-second-row {
        flex-direction: column;
    }

}

#destination-countries-section.inline-mode {
    margin: 0;
    padding: 0;
}

#destination-countries-section.inline-mode label {
    display: none; /* ne legyen cím fölötte */
}

#destination-countries-section.inline-mode .multiselect {
    display: inline-block;
    width: 100%;
}

.autocomplete-wrapper.hidden {
    display: none !important;
}

.suggestions {
    display: none;
    position: relative;
    background: #fff;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.result-item {
    padding: 5px 10px;
    cursor: pointer;
}

.result-item:hover {
    background-color: #f0f0f0;
}

/* találatok */
.search-results .result-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
}

.search-results .result-item:hover {
    background-color: #f0f0f0;
}


/* A sticky action oszlop ne takarja el a child tartalmat: adjunk alacsonyabb z-indexet neki */
.action-column-right {
    position: sticky;
    right: 0;
    z-index: 1; /* alacsonyabb, hogy a child (z-index 5) látszódjon fölötte */
    background: #fff;
}

/* DataTables által beszúrt child sor td-jeire és a wrapperre biztos háttér és magasabb z-index */
table.dataTable tr.child td, .offer-child-wrapper {
    background: #fff;
    z-index: 5;
    padding: 10px;
    width: 100%;
}

.dataTables_wrapper .dataTables_filter {
    float: none !important;
    text-align: left !important;
    width: 10vw;
    margin-bottom: 10px;
}

td{
    min-width: 100px;
    max-width: 150px;
}

/* Form stílus (kényelmes sorban) */
.offer-form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    width : 50%;
    position: sticky;
    left: 10px;
}

/* Új sor: konkrét jármű ajánlása */
.offer-specific-row {
    width: 100%;
    text-align: center;
    margin-top: 10px;
}

.offer-specific-text {
    cursor: pointer;
    color: #007bff;
    font-weight: 600;
    font-size: 1.5em;
    text-decoration: underline;
}

.offer-form label { display: flex; flex-direction: column; font-size: 0.9em; }
.offer-form button { padding: 6px 10px; cursor: pointer; }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.country-zip {
    font-weight: bold;
}

.city {
    font-size: 0.9em;
    color: #333;
}

.places{
    display: grid;
    grid-template-columns: 40% 7% 5% 40% 7%;
    grid-template-rows: auto;
    gap: 10px;
}

#origin {
  grid-column: 1 / 2; /* első oszlop */
}

#origin_diff {
  grid-column: 2 / 3;
    max-height: 40px;
}

#swap-btn {
  grid-column: 3 / 4;
    max-height: 50px;
}

#destination {
  grid-column: 4 / 5;
}

#destination_diff {
  grid-column: 5 / 6;
    max-height: 40px;
}

#available_from {
  grid-column: 1 / 3; /* második sorban széthúzva */
}
#available_until {
  grid-column: 4 / 6;
}

/* Input és select stílus */
.freight-form input,
.freight-form select,
.freight-form textarea {
  width: 100%;
  padding: 6px 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s;
}
.flex-row {
    display: flex;
    flex-wrap: nowrap; /* mindig egy sor */
    gap: 5px; /* kis térköz */
}

.freight-form input:focus,
.freight-form select:focus,
.freight-form textarea:focus {
  outline: none;
  border-color: #007bff;
}

/* Kártyák */
.cards-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.palette-card,
.oversize-card,
.loadtype-card,
.publiclicense-card {
  flex: 1;
  text-align: center;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  background: #fafafa;
  user-select: none;
}

/* Gomb */
.btn-wrapper button {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-wrapper button:hover {
  background: #0056b3;
}

#offer-submit-btn{
    padding: 0 8px;
    height:40px;
    margin-top: auto;
}

.palette-card:hover, .oversize-card:hover, .loadtype-card:hover, .publiclicense-card:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.palette-card.active, .oversize-card.active, .loadtype-card.active, .publiclicense-card.active {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
}

.cards-row img{
    width: 28px;
}

/* ---------- LAYOUT (49% / 49%) ---------- */

.vehicle-col {
  display: flex;
  justify-content: space-between;
  gap: 2%;
  flex-wrap: wrap; /* mobilnál egymás alá tudjanak törni */
}

.vehicle-col label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
}

/* Közvetlenül a label + select párokra */
.vehicle-col select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}

/* A két blokk (label + select) 49%-os szélességgel */
.vehicle-col > label,
.vehicle-col > select {
  width: 49%;
  box-sizing: border-box;
}

/* Multiselect is igazodjon a selectekhez (49–49%) */
.vehicle-col > .multiselect {
  width: 49%;
  box-sizing: border-box;
}

/* Mobilbarát törés */
@media (max-width: 700px) {
  .vehicle-col > .multiselect {
    width: 100%;
  }
}

/* Mobilbarát: kis kijelzőn egymás alá esnek */
@media (max-width: 700px) {
  .vehicle-col > label,
  .vehicle-col > select {
    width: 100%;
  }
}

/* Mobilon legyen 100% */
@media (max-width: 700px) {
  .vehicle-col { width: 100%; }
}

/* ---------- MULTISELECT LOOK ---------- */
/* FONTOS: A .multiselect legyen pozicionálási referencia */
.multiselect {
  position: relative; /* ez lesz a referenciapont az absolute-hoz */
  display: inline-block;
  width: 100%; /* illeszkedjen a selectBox-hoz */
}

/* A lenyíló (checkboxes) pontosan alatta nyíljon meg */
.multiselect .checkboxes {
  position: absolute;
  top: 100%; /* közvetlenül a selectBox alá */
  left: 0;
  width: 100%; /* pont akkora, mint a selectBox */
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  margin-top: 4px;
  display: none;
  max-height: 200px;
  overflow-y: auto;
  z-index: 9999; /* biztos, hogy semmi ne takarja */
}

/* amikor látszik */
.multiselect .checkboxes.active {
  display: block;
}

.selectBox {
  border: 1px solid #d0d7de;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  user-select: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(transparent, rgba(0,0,0,0.01));
  box-shadow: 0 1px 2px rgba(11,15,22,0.03);
}

/* Kijelzett szöveg */
.selectBox span {
  display: inline-block;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: calc(100% - 24px);
}


/* ---------- KÁRTYAPANEL ---------- */
.cards-panel {
  position: absolute;
  width: 100%;
  z-index: 1200;
  margin-top: 8px;
  left: 0;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(11,15,22,0.08);
  padding: 12px;
  box-sizing: border-box;
  display: none;
}

/* Nyitott állapot */
.cards-panel.open { display: grid; }

/* default grid: 4 oszlop (equipmenthez) -- JS állítja a konkrét oszlopszámot */
.cards-grid {
  display: grid;
  gap: 10px;
}

/* Kártya megjelenés */
.card-item {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #e6eef8;
  min-height: 46px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  cursor: pointer;
  font-size: 14px;
  background: linear-gradient(180deg, #ffffff, #fbfdff);
  transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
  user-select: none;
}

/* kiválasztott kártya */
.card-item.selected {
  border-color: #2b9af3;
  box-shadow: 0 6px 18px rgba(43,154,243,0.12);
  transform: translateY(-2px);
  background: linear-gradient(180deg, rgba(43,154,243,0.06), #ffffff);
  font-weight: 600;
}

/* kis meta sor, ha kell */
.card-item small { display:block; font-size:12px; opacity:.8; }

/* ha panel túl magas: görgethető */
.cards-panel.scrollable {
  max-height: 320px;
  overflow: auto;
}

/* Felirat: ha semmi nincs kiválasztva */
.select-placeholder { color: #6b7280; }

/* Kis kiszálló ikon terület (▼ jel) */
.selectBox::after {
  margin-left: 8px;
  font-size: 12px;
  color: #6b7280;
}

/* Általános segédosztályok */
.hidden { display: none !important; }

.accordion-btn {
    width: 30%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    margin-bottom: 10px;
    transition: background 0.2s;
}

.accordion-btn:hover {
    background-color: #0056b3;
}

.accordion-content {
    display: none;
}

.btn-secondary, .btn-primary{
    margin: 0;
}

.btn-holder{
    position: sticky;
    bottom: 10px;
}

.modal-body{
    max-height: 75vh;
}

.vehicle-list{
    max-height: 65vh;
    overflow-y: auto;
}

.modal-footer{
    width: 100%;
    background-color: #fff;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Bootstrap 5 tooltip inicializálás
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})

document.getElementById('destination_diff').addEventListener('change', function() {
    const diffValue = this.value;
    const countriesSection = document.getElementById('destination-countries-section');
    const destinationWrapper = document.querySelector('#destination').closest('.autocomplete-wrapper');
    const parentContainer = destinationWrapper.parentElement;

    if (diffValue === 'any') {
        // --- ha +any km ---
        countriesSection.classList.remove('hidden');

        // rejtsük el az autocomplete inputot
        destinationWrapper.classList.add('hidden');

        // helyezzük a countriesSection-t a helyére (közvetlenül a destination helyére)
        if (!countriesSection.classList.contains('inline-mode')) {
            parentContainer.insertBefore(countriesSection, destinationWrapper.nextSibling);
            countriesSection.classList.add('inline-mode');
        }
    } else {
        // --- ha nem +any ---
        countriesSection.classList.add('hidden');
        destinationWrapper.classList.remove('hidden');

        // országok kiválasztásának ürítése
        const select = document.getElementById('destination_countries');
        Array.from(select.options).forEach(o => o.selected = false);
        updateSelectPlaceholder('destination_countries');
    }
});

function updateSelectPlaceholder(name) {
    const select = document.getElementById(name);
    const selected = Array.from(select.selectedOptions).map(o => o.text);
    const span = document.getElementById(name + '-selected');
    span.innerText = selected.length ? selected.join(', ') : 'Válassz országot';
}

const vehicleForm = document.getElementById("vehicleForm");

document.addEventListener("DOMContentLoaded", function() {
    const destinationDiff = document.getElementById("destination_diff");
    const countriesSection = document.getElementById("destination-countries-section");

    function toggleCountriesSection() {
        if (destinationDiff.value === "any") {
            countriesSection.classList.remove("hidden");
        } else {
            countriesSection.classList.add("hidden");
        }
    }

    destinationDiff.addEventListener("change", toggleCountriesSection);
    toggleCountriesSection(); // azonnal lefut betöltéskor is
});

/**
 * Csökkenti a koordináták számát az útvonalon.
 * @param {Array} coords - [[lat, lon], [lat, lon], ...]
 * @param {number} maxPoints - maximum pontszám
 * @returns {Array} csökkentett koordináták
 */

function downsampleRoute(coords, maxPoints) {
    if (coords.length <= maxPoints) return coords;

    const step = Math.ceil(coords.length / maxPoints);
    const downsampled = [];
    for (let i = 0; i < coords.length; i += step) {
        downsampled.push(coords[i]);
    }
    // Mindig biztosítjuk az utolsó pontot is
    if (downsampled[downsampled.length - 1] !== coords[coords.length - 1]) {
        downsampled.push(coords[coords.length - 1]);
    }
    return downsampled;
}

vehicleForm.addEventListener("submit", async function(e) {
    e.preventDefault(); // ne töltsön újra az oldalt

    // --- Form mezők ---
    const originCity = document.getElementById("origin_city").value;
    const originZip = document.getElementById("origin_zip").value;
    const originCountry = document.getElementById("origin_country").value;

    const destinationDiff = document.getElementById("destination_diff").value;
    const selectedDestCountries = Array.from(document.getElementById("destination_countries").selectedOptions).map(o => o.value);

    const destCityInput = document.getElementById("destination_city").value;
    const destZipInput = document.getElementById("destination_zip").value;
    const destCountryInput = document.getElementById("destination_country").value;

    // --- Geocode lekérés backendről ---
    async function geocode(city, zip, country) {
        const url = `/cargo/geocode_location?city=${encodeURIComponent(city)}&postcode=${encodeURIComponent(zip)}&country=${encodeURIComponent(country)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Geocode hiba");
        return await res.json();
    }

    let originCoords, destCoords;
    try {
        // Origin koordináták mindig lekérve
        originCoords = await geocode(originCity, originZip, originCountry);

        // --- ANY eset ---
        if (destinationDiff === "any") {
            // ha nincs megadva city, akkor automatikusan az origin értékeket használjuk
            const destCity = originCity;
            const destZip = originZip;
            const destCountry = originCountry;

            destCoords = await geocode(destCity, destZip, destCountry);

            // hidden mezők frissítése
            document.getElementById("destination_city").value = destCity;
            document.getElementById("destination_zip").value = destZip;
            document.getElementById("destination_country").value = destCountry;
            document.getElementById("destination_lat").value = destCoords.lat;
            document.getElementById("destination_lon").value = destCoords.lng;
        } 
        // --- Konkrét cél eset ---
        else if (destCityInput || destZipInput || destCountryInput) {
            const destCity = destCityInput || originCity;
            const destZip = destZipInput || originZip;
            const destCountry = destCountryInput || originCountry;

            destCoords = await geocode(destCity, destZip, destCountry);

            document.getElementById("destination_lat").value = destCoords.lat;
            document.getElementById("destination_lon").value = destCoords.lng;
        } 
        // --- Egyébként nincs céladat ---
        else {
            document.getElementById("destination_lat").value = "";
            document.getElementById("destination_lon").value = "";
        }

        // mindig legyen origin koordináta
        document.getElementById("origin_lat").value = originCoords.lat;
        document.getElementById("origin_lon").value = originCoords.lng;

    } catch (err) {
        console.error("Geocode hiba:", err);
        alert("Nem sikerült lekérni a koordinátákat!");
        return;
    }

    // --- OSRM útvonal lekérése (csak ha van cél koordináta) ---
    let routeCoords = [];
    if(destCoords) {
        try {
            const osrmRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${originCoords.lng},${originCoords.lat};${destCoords.lng},${destCoords.lat}?overview=full&geometries=geojson`);
            const data = await osrmRes.json();
            if(data.routes && data.routes.length){
                routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            }
            routeCoords = downsampleRoute(routeCoords, 500);
        } catch(err){
            console.error("OSRM hiba:", err);
        }
    }

    document.getElementById("routeCoordsInput").value = JSON.stringify(routeCoords);

    // --- JSON mező létrehozása a kiválasztott országokhoz ---
    const countriesInput = document.createElement("input");
    countriesInput.type = "hidden";
    countriesInput.name = "selected_dest_countries";
    countriesInput.value = JSON.stringify(selectedDestCountries);
    vehicleForm.appendChild(countriesInput);

    // --- Form submit ---
    vehicleForm.submit();
});

// DataTables inicializálás és kezelése
$(document).ready(function() {
    var table;
    if (! $.fn.DataTable.isDataTable('#shipmentsTable')) {
        table = $('#shipmentsTable').DataTable({
            dom: '<"top"f>rt<"bottom"lip>',
            "order": [[14, "desc"], [0, "asc"]],
            "pageLength": 25,
            // scrollX: true,
            // "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 13 }]
        });
    } else {
        table = $('#shipmentsTable').DataTable(); // létező példányt használjuk
    }

    // Offer gomb click (child row)
    $(document).on('click', 'button.offer-btn', function(e) {
        e.stopPropagation();

        var tr = $(this).closest('tr');
        var row = table.row(tr);
        const cargoId = tr.data('cargo-id');

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
            return;
        }

        // minden child row bezárása előtte
        table.rows().every(function() {
            if (this.child.isShown()) this.child.hide();
            $(this.node()).removeClass('shown');
        });

        const formHtml = `
            <div class="offer-child-wrapper">
                <form class="offer-form">
                    <input type="hidden" name="cargo_id" value="${cargoId}">

                    <!-- 1. sor: standard inputok -->
                    <label>Felvét dátuma: <input type="date" name="pickup_date" required></label>
                    <label>Letét dátuma: <input type="date" name="delivery_date" required></label>
                    <label>Ár: <input type="number" name="price" step="1" required></label>
                    <label>Valuta:
                        <select name="currency">
                            <option value="eur">€</option>
                            <option value="huf">Ft</option>
                        </select>
                    </label>
                    <label>Megjegyzés: <input type="text" name="note" maxlength="50"></label>
                    <button type="submit" id="offer-submit-btn">Küldés</button>

                    <!-- 2. sor: konkrét jármű ajánlása -->
                    <div class="offer-specific-row">
                        <span class="offer-specific-text" data-cargo-id="${cargoId}">
                            Konkrét jármű ajánlása
                        </span>
                    </div>
                </form>
            </div>
        `;

        row.child(formHtml).show();
        tr.addClass('shown');
    });

    // 🔸 Globális változó
    let selectedVehicleId = null;

    // Kattintás a "Konkrét jármű ajánlása" szövegre
    $(document).on('click', '.offer-specific-text', function() {
        const cargoId = $(this).data('cargo-id');

        $.get(`/cargo/specific_vehicles/${cargoId}`, function(html) {
            $('#specificvehicleModal .modal-body').html(html);

            const modalEl = document.getElementById('specificvehicleModal');
            const myModal = new bootstrap.Modal(modalEl);

            // 🔹 Ellenőrizzük, van-e már kiválasztott jármű
            const $form = $(`form.offer-form input[name="cargo_id"][value="${cargoId}"]`).closest('form');
            const existingVehicleId = $form.find('input[name="vehicle_id"]').val();

            // Mindent alaphelyzetbe állítunk
            $('#specificvehicleModal .vehicle-select-btn')
                .removeClass('active btn-primary')
                .addClass('btn-outline-primary');

            if (existingVehicleId) {
                // Jelöljük ki a modalban is
                $('#specificvehicleModal .vehicle-select-btn').each(function() {
                    if (String($(this).data('vehicle-id')) === String(existingVehicleId)) {
                        $(this).addClass('active btn-primary').removeClass('btn-outline-primary');
                    }
                });

                // 🔹 FONTOS: frissítjük a globális változót is!
                selectedVehicleId = String(existingVehicleId);

                $('#vehicle-select-toggle-btn')
                    .text('Kiválasztás')
                    .removeClass('btn-secondary')
                    .addClass('btn-primary');
            } else {
                selectedVehicleId = null;
                $('#vehicle-select-toggle-btn')
                    .text('Mégse')
                    .removeClass('btn-primary')
                    .addClass('btn-secondary');
            }

            myModal.show();
        });
    });

    // Kattintás egy járműre
    $(document).on('click', '.vehicle-select-btn', function() {
        const clickedId = String($(this).data('vehicle-id')); // 👉 mindig stringként kezeljük!

        if (selectedVehicleId === clickedId) {
            // Ugyanaz: töröljük a kijelölést
            selectedVehicleId = null;
            $(this).removeClass('active btn-primary').addClass('btn-outline-primary');

            $('#vehicle-select-toggle-btn')
                .text('Mégse')
                .removeClass('btn-primary')
                .addClass('btn-secondary');
        } else {
            // Új jármű kiválasztása
            $('.vehicle-select-btn').removeClass('active btn-primary').addClass('btn-outline-primary');
            $(this).addClass('active btn-primary').removeClass('btn-outline-primary');

            selectedVehicleId = clickedId;

            $('#vehicle-select-toggle-btn')
                .text('Kiválasztás')
                .removeClass('btn-secondary')
                .addClass('btn-primary');
        }
    });

    // Gomb click: kiválasztás vagy mégse
    $(document).on('click', '#vehicle-select-toggle-btn', function() {
        const $btn = $(this);
        const modalEl = document.getElementById('specificvehicleModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);

        if (selectedVehicleId) {
            // 1️⃣ Keresd meg az aktuális offer formot
            const $activeBtn = $('.vehicle-select-btn.active');
            const cargoId = $activeBtn.data('cargo-id');
            const vehicleName = $activeBtn.data('vehicle-name');
            const vehicleType = $activeBtn.data('vehicle-type');

            const $form = $(`form.offer-form input[name="cargo_id"][value="${cargoId}"]`).closest('form');

            // 2️⃣ Hidden input létrehozása, ha kell
            let $hidden = $form.find('input[name="vehicle_id"]');
            if ($hidden.length === 0) {
                $hidden = $('<input type="hidden" name="vehicle_id">');
                $form.append($hidden);
            }

            // 3️⃣ Beállítjuk a jármű ID-t
            $hidden.val(selectedVehicleId);

            // 4️⃣ Formon vizuális jelzés
            if (vehicleName !== '') {
                $form.find('.offer-specific-text').text(`Kiválasztott jármű: ${vehicleName} (${vehicleType})`);
            } else{
                $form.find('.offer-specific-text').text(`Kiválasztott jármű: ${vehicleType}`);
            }
        }

        // Modal bezárása
        modalInstance.hide();

        // Reset
        selectedVehicleId = null;
        $('#vehicle-select-toggle-btn')
            .text('Mégse')
            .removeClass('btn-primary')
            .addClass('btn-secondary');

        $('.vehicle-select-btn').removeClass('active btn-primary').addClass('btn-outline-primary');
    });


    // Offer form submit
    $('#shipmentsTable').on('submit', '.offer-form', function(e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();  // <-- vehicle_id automatikusan benne lesz

        $.post('/cargo/offer', data)
            .done(function(response) {
                alert('Ajánlat elküldve!');
                $form.closest('.offer-child-wrapper').remove();
            })
            .fail(function(xhr) {
                alert('Hiba: ' + (xhr.responseJSON?.message || 'Ismeretlen hiba'));
            });

        table.rows().every(function() {
            if (this.child.isShown()) this.child.hide();
            $(this.node()).removeClass('shown');
        });
    });

    // Child row-ok bezárása újrarenderkor
    table.on('draw', function() {
        table.rows().every(function() {
            if (this.child && this.child.isShown && this.child.isShown()) {
                this.child.hide();
            }
        });
        $('#shipmentsTable tbody tr').removeClass('shown');
    });
});

// SWAP BUTTON
document.addEventListener("DOMContentLoaded", function () {
    const swapBtn = document.getElementById("swap-btn");
    const originInput = document.getElementById("origin");
    const destinationInput = document.getElementById("destination");

    if (!swapBtn) return;

    swapBtn.addEventListener("click", function (e) {
        e.preventDefault();

        if (!originInput || !destinationInput) return;

        // Csere
        const tmp = originInput.value;
        originInput.value = destinationInput.value;
        destinationInput.value = tmp;

        // Trigger input és change minden autocomplete pluginnek
        ['input', 'change'].forEach(eventType => {
            originInput.dispatchEvent(new Event(eventType, { bubbles: true }));
            destinationInput.dispatchEvent(new Event(eventType, { bubbles: true }));
        });
    }, false);
});

// Oversize és paletta kártyák
document.addEventListener("DOMContentLoaded", () => {
    // ========== Paletta és túlméretes kártyák ==========
    const paletteCard = document.getElementById("paletteCard");
    const oversizeCard = document.getElementById("oversizeCard");
    const paletteInput = document.getElementById("palette_exch");
    const oversizeInput = document.getElementById("oversize");
    const loadtypeCard = document.getElementById("loadtypeCard");
    const loadtypeInput = document.getElementById("load_type");
    const publicLicenseCard = document.getElementById("publicLicenseCard");
    const publiclicenseInput = document.getElementById("public_license");

    if (paletteCard) {
        paletteCard.addEventListener("click", () => {
            paletteCard.classList.toggle("active");
            paletteInput.value = paletteCard.classList.contains("active");
        });
    }

    if (oversizeCard) {
        oversizeCard.addEventListener("click", () => {
            oversizeCard.classList.toggle("active");
            oversizeInput.value = oversizeCard.classList.contains("active");
        });
    }

    if (loadtypeCard) {
        loadtypeCard.addEventListener("click", () => {
            loadtypeCard.classList.toggle("active");
            loadtypeInput.value = loadtypeCard.classList.contains("active");
        });
    }

    if (publicLicenseCard) {
        publicLicenseCard.addEventListener("click", () => {
            publicLicenseCard.classList.toggle("active");
            publiclicenseInput.value = publicLicenseCard.classList.contains("active");
        });
    }
});

// térkép újratöltés módosításnál
$('#cargoModal').on('shown.bs.modal', function () {
    // Ha volt korábbi térkép, távolítsuk el teljesen (elegendő újrakészítéshez)
    if (window.currentMap) {
        try {
            window.currentMap.remove(); // eltávolítja a DOM-t és eseményeket
        } catch (e) {
            console.warn('Korábbi map eltávolítása sikertelen:', e);
        }
        window.currentMap = null;
    }

    // Ellenőrizzük, hogy a modal tartalma tényleg tartalmazza-e a map div-et
    var mapEl = document.getElementById('map');
    if (!mapEl) {
        console.warn('Nincs #map eleme a modal tartalmának. A részletek HTML-je lehet, hogy nem töltődött be időben.');
        return;
    }

    // Alapnézet: egész Európa (középpont ~ közép-európa, zoom 4)
    window.currentMap = L.map('map', { preferCanvas: true }).setView([54.0, 15.0], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(window.currentMap);

    // Olvassuk be a JSON blokkokat a modalból
    var pickups = [];
    var dropoffs = [];
    try {
        var pEl = document.getElementById("pickups-data");
        var dEl = document.getElementById("dropoffs-data");
        if (pEl) pickups = JSON.parse(pEl.textContent || "[]");
        if (dEl) dropoffs = JSON.parse(dEl.textContent || "[]");
        console.log('cargoModal: parsed pickups/dropoffs JSON');
        console.log('  pickups:', pickups);
        console.log('  dropoffs:', dropoffs);
    } catch (e) {
        console.error('Hiba a pick/ drop JSON parsing során:', e);
    }

    // Két szín: felrakók (loading) = zöld, lerakók (unloading) = piros
    var pickupColor = '#2ca25f';   // zöld
    var dropoffColor = '#d73027';  // piros

    // LayerGroup-ek, hogy könnyű legyen kezelni / törölni őket, vagy később ki-/bekapcsolni
    var pickupsLayer = L.layerGroup().addTo(window.currentMap);
    var dropoffsLayer = L.layerGroup().addTo(window.currentMap);
    window.pickupsLayer = pickupsLayer;
    window.dropoffsLayer = dropoffsLayer;

    // Segéd: valid koordináta-e?
    function validCoord(lat, lng) {
        return typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng) && !(lat === 0 && lng === 0);
    }

    // Haversine distance in kilometers between two lat/lng points
    function haversineKm(lat1, lon1, lat2, lon2) {
        function toRad(v) { return v * Math.PI / 180; }
        var R = 6371; // Earth radius km
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Remove previous route layers if present
    function clearRoute() {
        if (window.routeLine) {
            try { window.currentMap.removeLayer(window.routeLine); } catch (e) {}
            window.routeLine = null;
        }
        if (window.pickupsLayer) {
            try { window.currentMap.removeLayer(window.pickupsLayer); } catch (e) {}
            window.pickupsLayer = null;
        }
        if (window.dropoffsLayer) {
            try { window.currentMap.removeLayer(window.dropoffsLayer); } catch (e) {}
            window.dropoffsLayer = null;
        }
    }

    var allCoords = [];
        pickups.forEach(function(p) {
            try {
                var lat = Number(p.lat);
                var lng = Number(p.lng);
                console.log('pickup entry:', p, '-> parsed lat/lng:', lat, lng);
                if (!validCoord(lat, lng)) {
                        console.warn('Skipping pickup with invalid coords', {lat: lat, lng: lng, entry: p});
                        return;
                }
                var m = L.circleMarker([lat, lng], {
                     radius: 7,
                     color: '#000',          // körvonal
                     weight: 1,
                     fillOpacity: 0.9,
                     fillColor: pickupColor
                }).bindPopup("<b>Felrakó</b><br>" + (p.city || p.masked_city || ''));
                console.log('Adding pickup marker at', lat, lng);
                pickupsLayer.addLayer(m);
                allCoords.push([lat, lng]);
            } catch (e) {
                console.error('Error processing pickup entry', p, e);
            }
        });

        dropoffs.forEach(function(p) {
            try {
                var lat = Number(p.lat);
                var lng = Number(p.lng);
                console.log('dropoff entry:', p, '-> parsed lat/lng:', lat, lng);
                if (!validCoord(lat, lng)) {
                        console.warn('Skipping dropoff with invalid coords', {lat: lat, lng: lng, entry: p});
                        return;
                }
                var m = L.circleMarker([lat, lng], {
                     radius: 7,
                     color: '#000',
                     weight: 1,
                     fillOpacity: 0.9,
                     fillColor: dropoffColor
                }).bindPopup("<b>Lerakó</b><br>" + (p.city || p.masked_city || ''));
                console.log('Adding dropoff marker at', lat, lng);
                dropoffsLayer.addLayer(m);
                allCoords.push([lat, lng]);
            } catch (e) {
                console.error('Error processing dropoff entry', p, e);
            }
        });

    // Ha vannak koordináták, igazítsuk a nézetet rájuk; különben marad Europe view
    console.log('All coords collected for map:', allCoords);
    console.log('Number of coords:', allCoords.length);
    // Draw route: order pickups then dropoffs
    var routeCoords = [];
    pickups.forEach(function(p) { var lat=Number(p.lat); var lng=Number(p.lng); if(validCoord(lat,lng)) routeCoords.push([lat,lng]); });
    dropoffs.forEach(function(p) { var lat=Number(p.lat); var lng=Number(p.lng); if(validCoord(lat,lng)) routeCoords.push([lat,lng]); });

    function fallbackToHaversineAndDraw() {
        if (window.routeLine) { try { window.currentMap.removeLayer(window.routeLine); } catch(e){} }
        window.routeLine = L.polyline(routeCoords, {color: '#3388ff', weight: 3, opacity: 0.8}).addTo(window.currentMap);
        // compute distance via haversine
        var totalKm = 0;
        for (var i=0;i<routeCoords.length-1;i++) {
            totalKm += haversineKm(routeCoords[i][0], routeCoords[i][1], routeCoords[i+1][0], routeCoords[i+1][1]);
        }
        var avgSpeedKmh = 60;
        var hours = totalKm / avgSpeedKmh;
        var etaHours = Math.floor(hours);
        var etaMins = Math.round((hours - etaHours) * 60);
        var etaStr = etaHours + 'h ' + etaMins + 'm';
        var infoEl = document.getElementById('route-info');
        if (infoEl) infoEl.textContent = 'Távolság: ' + totalKm.toFixed(1) + ' km · Becsült utazási idő: ' + etaStr + ' (közúti becslés hiányában Haversine)';
        // adjust view
        try { window.currentMap.fitBounds(window.routeLine.getBounds(), { padding: [30,30] }); } catch(e) { console.warn('fitBounds failed for haversine route', e); }
    }

    if (routeCoords.length >= 2) {
        // Try OSRM routing first (free public server). Build lon,lat;... list
        try {
            var coordPairs = routeCoords.map(function(c) { return c[1] + ',' + c[0]; }).join(';');
            var osrmUrl = 'https://router.project-osrm.org/route/v1/driving/' + coordPairs + '?overview=full&geometries=geojson';
            fetch(osrmUrl).then(function(resp){ return resp.json(); }).then(function(osrmData){
                if (osrmData && osrmData.routes && osrmData.routes.length) {
                    var r = osrmData.routes[0];
                    var coords = r.geometry.coordinates.map(function(c){ return [c[1], c[0]]; });
                    if (window.routeLine) { try { window.currentMap.removeLayer(window.routeLine); } catch(e){} }
                    window.routeLine = L.polyline(coords, {color: '#3388ff', weight: 3, opacity: 0.9}).addTo(window.currentMap);
                    // use OSRM distance/duration (meters, seconds)
                    var totalKm = (r.distance || 0) / 1000.0;
                    var durationSec = r.duration || 0;
                    var hours = Math.floor(durationSec / 3600);
                    var mins = Math.round((durationSec - hours*3600) / 60);
                    var etaStr = hours + 'h ' + mins + 'm';
                    var infoEl = document.getElementById('route-info');
                    if (infoEl) infoEl.textContent = 'Útvonal távolság: ' + totalKm.toFixed(1) + ' km · Becsült utazási idő: ' + etaStr + ' (OSRM)';
                    try { window.currentMap.fitBounds(window.routeLine.getBounds(), { padding: [30,30] }); } catch(e) { console.warn('fitBounds failed for OSRM route', e); }
                } else {
                    console.warn('OSRM returned no route, falling back');
                    fallbackToHaversineAndDraw();
                }
            }).catch(function(err){
                console.warn('OSRM request failed, falling back', err);
                fallbackToHaversineAndDraw();
            });
        } catch (ex) {
            console.warn('Error building OSRM request, falling back', ex);
            fallbackToHaversineAndDraw();
        }
    }
});

// Rakomány sor kattintás – modal megnyitás AJAX-szal
document.addEventListener("DOMContentLoaded", function() {
    // Sor kattintás
     document.querySelectorAll(".cargo-row").forEach(function(row) {
        row.addEventListener("click", function(e) {
            let cargoId = this.dataset.cargoId;

            if ($(e.target).closest('.action-column-right').length) {
                return; // kilépünk, modal nem nyílik
            }

            // Lekérés Flask végpontról
            fetch(`/cargo/${cargoId}/details`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("cargoDetails").innerHTML = html;

                    // Bootstrap modal előhívása
                    var myModal = new bootstrap.Modal(document.getElementById('cargoModal'));
                    myModal.show();
                });
        });
    });
});

// kártyás multiselect
(function(){
  const PLACEHOLDERS = {
    equipment: 'Válassz felszereltséget',
    securement: 'Válassz rakományrögzítést',
    destination_countries: 'Válassz országot'
  };

  window.toggleCheckboxes = function(name) {
    let panel = document.getElementById(name + '-panel');
    if (!panel) {
      panel = createPanelFromSelect(name);
    }
    if (!panel) return;

    panel.classList.toggle('open');

    if (panel.classList.contains('open')) {
      const first = panel.querySelector('.card-item');
      if (first) first.focus();
    }
  };

  function createPanelFromSelect(name) {
    let selectEl = document.getElementById(name);
    let panel = document.getElementById(name + '-panel');
    if (panel) return panel;
    if (!selectEl) return null;

    const multiselect = selectEl.closest('.multiselect') || selectEl.previousElementSibling?.closest('.multiselect') || selectEl.parentElement;
    if (!multiselect) return null;

    panel = document.createElement('div');
    panel.className = 'cards-panel';
    panel.id = name + '-panel';

    const grid = document.createElement('div');
    grid.className = 'cards-grid';
    let cols = name === 'securement' ? 3 : 4;
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    Array.from(selectEl.options).forEach((opt, idx) => {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.tabIndex = 0;
        card.dataset.value = opt.value;
        card.dataset.index = idx;
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'center'; // középre igazítás vízszintesen
        card.style.justifyContent = 'center'; // középre függőlegesen (ha kell)

        if (opt.selected) card.classList.add('selected');

        // Ország neve
        const span = document.createElement('span');
        span.textContent = opt.text;
        span.style.display = 'block';
        span.style.textAlign = 'center';
        span.style.marginBottom = '5px';

        // Zászló csak destination_countries esetén
        if (name === 'destination_countries') {
            const flagCode = opt.dataset.flag || opt.value;
            const img = document.createElement('img');
            img.src = `/static/images/flags/${flagCode}.png`;
            img.alt = opt.text;
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.width = '28px';
            img.style.height = 'auto';
            card.appendChild(img);
        }

        card.appendChild(span);

        card.addEventListener('click', () => toggleOption(selectEl, opt, card));
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleOption(selectEl, opt, card);
            }
        });

        grid.appendChild(card);
    });

    if (selectEl.options.length > cols * cols) panel.classList.add('scrollable');

    panel.appendChild(grid);
    multiselect.appendChild(panel);

    refreshSelectedText(name);
    return panel;
  }

    function toggleOption(selectEl, optEl, cardEl) {
        const wasSelected = optEl.selected;
        optEl.selected = !wasSelected;
        cardEl.classList.toggle('selected', optEl.selected);

        // Trigger change event a selectnél
        const ev = new Event('change', { bubbles: true });
        selectEl.dispatchEvent(ev);

        refreshSelectedText(selectEl.id);

        // --- Hidden input frissítése csak +any esetén ---
        if (selectEl.id === 'destination_countries') {
            const destinationDiff = document.getElementById('destination_diff').value;
            if (destinationDiff === 'any') {
                const hiddenInput = document.getElementById('destination_country');
                // Ha van kiválasztott elem, a hidden inputba csak az első kódot írjuk (vagy tetszőleges logika)
                const selectedOpts = Array.from(selectEl.selectedOptions).map(o => o.value);
                hiddenInput.value = selectedOpts.length ? selectedOpts.join(',') : '';
            }
        }
    }


  function refreshSelectedText(name) {
    const span = document.getElementById(name + '-selected');
    const select = document.getElementById(name);
    if (!span || !select) return;

    const selected = Array.from(select.selectedOptions).map(o => o.text);
    if (selected.length === 0) {
      span.textContent = PLACEHOLDERS[name] || 'Válassz';
      span.classList.add('select-placeholder');
    } else if (selected.length <= 3) {
      span.textContent = selected.join(', ');
      span.classList.remove('select-placeholder');
    } else {
      span.textContent = `${selected.length} kiválasztva`;
      span.classList.remove('select-placeholder');
    }
  }

  document.addEventListener('click', function(event) {
    const openPanels = document.querySelectorAll('.cards-panel.open');
    openPanels.forEach(panel => {
      const multiselect = panel.closest('.multiselect');
      if (!multiselect) return;
      if (!multiselect.contains(event.target)) {
        panel.classList.remove('open');
      }
    });
  });

  document.addEventListener('change', function(e){
    const el = e.target;
    if (el && el.tagName === 'SELECT' && el.multiple) {
      const panel = document.getElementById(el.id + '-panel');
      if (!panel) return;
      const cards = panel.querySelectorAll('.card-item');
      cards.forEach(card => {
        const val = card.dataset.value;
        const opt = Array.from(el.options).find(o => o.value === val);
        if (opt) card.classList.toggle('selected', opt.selected);
      });
      refreshSelectedText(el.id);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
        fetch('/vehicles/api/eu-countries')
            .then(res => res.json())
            .then(countries => {
                const select = document.getElementById('destination_countries');
                countries.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code;
                    opt.textContent = c.name;
                    opt.dataset.flag = c.code; // zászló kód
                    select.appendChild(opt);
                });

                // Létrehozzuk a panelt
                createPanelFromSelect('destination_countries');
            })
            .catch(err => console.error("Hiba EU országok betöltésénél:", err));

        // Frissítjük a feliratokat
        ['equipment','securement','destination_countries'].forEach(name => refreshSelectedText(name));
    });
})();

// dátum mezők
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('available_from');
    if (dateInput) {
        const today = new Date(); // mai dátum
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // hónap 0-tól van
        const day = String(today.getDate()).padStart(2, '0');

        dateInput.value = `${year}-${month}-${day}`; // beállítjuk a mező értékét
    }
});

// accordion
document.addEventListener('DOMContentLoaded', function() {
    const accordionBtn = document.querySelector('.accordion-btn');
    const accordionContent = document.querySelector('.accordion-content');

    if (accordionBtn && accordionContent) {
        accordionBtn.addEventListener('click', function() {
            if (accordionContent.style.display === 'block') {
                accordionContent.style.display = 'none';
                accordionBtn.textContent = 'Raktér feltöltése / rakomány keresése ▼';
            } else {
                accordionContent.style.display = 'block';
                accordionBtn.textContent = 'Raktér feltöltése / rakomány keresése ▲';
            }
        });
    }
});

$(document).ready(function() {
    let searchTimer;
    const apiUrl = "/cargo/ajax/city_search";

    // Delegált input esemény minden autocomplete-wrapper inputjára
    $(document).on("input", "#origin, #destination", function() {
        const $input = $(this);
        const query = $input.val().trim();
        const $results = $input.siblings(".suggestions");

        clearTimeout(searchTimer);
        $results.empty().hide();

        if(query.length < 2) return;

        searchTimer = setTimeout(() => {
            const terms = query.split(" ").filter(t => t.length > 0);

            $.get(apiUrl, { q: query }, function(data) {
                $results.empty();

                if(!data.length) return;

                data.forEach(item => {
                    let matched = false;
                    for(const term of terms) {
                        if(/^\d+$/.test(term)) {
                            matched = item.zipcode && item.zipcode.includes(term);
                        } else if(term.length === 2) {
                            matched = item.country_code && item.country_code.toLowerCase().includes(term.toLowerCase());
                        } else {
                            matched = item.city_name.toLowerCase().includes(term.toLowerCase());
                        }
                        if(!matched) break;
                    }

                    if(matched) {
                        const text = `${item.city_name}, ${item.country_code} (${item.zipcode}) `;
                        const $li = $('<div class="result-item"></div>').text(text).data({
                            city: item.city_name,
                            zipcode: item.zipcode,
                            country: item.country_code
                        });
                        $results.append($li);
                    }
                });

                if($results.children().length) $results.show();
            });
        }, 300);
    });

    // Click esemény a találatokra
    $(document).on("click", ".result-item", function() {
        const $li = $(this);
        const $input = $li.closest(".autocomplete-wrapper").find("input[type=text]");
        const fieldset = $input.closest(".autocomplete-wrapper");

        $input.val($li.text());

        // Hidden mezők kitöltése
        fieldset.find("input[type=hidden][id$='_city']").val($li.data("city"));
        fieldset.find("input[type=hidden][id$='_zip']").val($li.data("zipcode"));
        fieldset.find("input[type=hidden][id$='_country']").val($li.data("country"));

        $li.parent().empty().hide();
    });

    // Blur esemény a találati lista bezárásához
    $(document).on("blur", "#origin, #destination", function() {
        const $results = $(this).siblings(".suggestions");
        setTimeout(() => $results.hide(), 200);
    });

    // --- Vehicle sablon betöltés ---
    const templateSelect = document.getElementById('vehicle_template_select');
    const paletteCard = document.getElementById('paletteCard');
    const oversizeCard = document.getElementById('oversizeCard');
    const loadtypeCard = document.getElementById('loadtypeCard');
    const publicLicenseCard = document.getElementById('publicLicenseCard');

    templateSelect.addEventListener('change', async function() {
        const templateId = this.value;
        if (!templateId) return;

        try {
            const res = await fetch(`/vehicles/template/${templateId}`);
            const data = await res.json();

            if (!data.success) {
                alert('Hiba: ' + data.error);
                return;
            }

            const t = data.template;
            console.log('[DEBUG] Betöltött sablon:', t);

            // Egyszerű mezők
            const simpleFields = ['vehicle_type', 'structure', 'capacity_t', 'volume_m3', 'price', 'currency', 'description'];
            simpleFields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = t[f] ?? '';
            });

            // Városok automatikus kiválasztása
            await fillCityFromTemplate('origin', t.origin_city, t.origin_country, t.origin_postcode);
            await fillCityFromTemplate('destination', t.destination_city, t.destination_country, t.destination_postcode);

            // Kapcsoló gombok
            setActive(paletteCard, 'palette_exch', t.palette_exchange);
            setActive(oversizeCard, 'oversize', t.oversize);
            setActive(loadtypeCard, 'load_type', t.load_type === 'LTL');
            setActive(publicLicenseCard, 'public_license', t.public_license);

            // Multiselectek
            setMultiselect('equipment', t.equipment);
            setMultiselect('securement', t.cargo_securement);

        } catch (err) {
            console.error('Hiba a sablon betöltésekor:', err);
            alert('Nem sikerült betölteni a sablont.');
        }
    });

    function setActive(cardEl, hiddenId, active) {
        const hidden = document.getElementById(hiddenId);
        if (active) {
            cardEl.classList.add('active');
            hidden.value = 'true';
        } else {
            cardEl.classList.remove('active');
            hidden.value = 'false';
        }
    }

    function setMultiselect(type, valueStr) {
        const selected = valueStr ? valueStr.split(',').map(v => v.trim()) : [];
        const checkboxes = document.querySelectorAll(`#${type}-checkboxes input[type="checkbox"]`);
        const displaySpan = document.getElementById(`${type}-selected`);
        const hiddenSelect = document.getElementById(type);

        let selectedLabels = [];

        checkboxes.forEach(cb => {
            cb.checked = selected.includes(cb.value);
            if (cb.checked) selectedLabels.push(cb.value);
        });

        if (displaySpan) {
            displaySpan.textContent = selectedLabels.length
                ? selectedLabels.join(', ')
                : (type === 'equipment' ? 'Válassz felszereltséget' : 'Válassz rakományrögzítést');
        }

        if (hiddenSelect) {
            [...hiddenSelect.options].forEach(opt => {
                opt.selected = selected.includes(opt.value);
            });
        }
    }

    // --- Városmező automatikus kiválasztása sablonból ---
    async function fillCityFromTemplate(type, city, countryCode, postcode) {
        return new Promise((resolve) => {
            if (!city) return resolve();

            const input = document.getElementById(type);
            const $results = $(input).siblings(".suggestions");
            if (!input || !$results.length) return resolve();

            // 1️⃣ Beírjuk az inputba a város adatokat
            input.value = `${countryCode || ''} ${postcode || ''} ${city}`.trim();

            // 2️⃣ Triggereljük az input eseményt, hogy az autocomplete lefusson
            $(input).trigger('input');

            // 3️⃣ Várunk max. 2 másodpercet, és ha megjelenik a találat, kattintunk az elsőre
            let tries = 0;
            const maxTries = 20; // 20*100ms = 2s
            const interval = setInterval(() => {
                const $first = $results.children().first();
                if ($first.length) {
                    $first.click();
                    clearInterval(interval);
                    console.log(`[DEBUG] Autocomplete kiválasztva: ${$first.text()}`);
                    resolve();
                } else if (tries++ >= maxTries) {
                    clearInterval(interval);
                    console.warn(`[DEBUG] Nincs találat (timeout): ${city}`);
                    resolve();
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}
