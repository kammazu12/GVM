{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
        <h1 class="cim">Rakom√°nyok</h1>

        {% if cargos %}
        <div class="table-wrapper">
            <table id="shipmentsTable" class="display" style="font-size: 0.9em; width:100%;">
            <thead>
                <tr>
                    <th class="felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                    <th class="felvet" colspan="3">Rakom√°ny felv√©tel</th>
                    <th class="letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                    <th class="letet" colspan="3">Rakom√°ny let√©tel</th>
                    <th class="arujarmu">Hossza (m)</th>
                    <th class="arujarmu">T√∂mege (t)</th>
                    <th class="arujarmu" colspan="5">J√°rm≈± tulajdons√°gok</th>
                    <th class="hirdeto">Hirdet≈ë c√©g</th>
                    <th style="display:none;">created_at</th> <!-- rejtett oszlop a cs√∂kken≈ë rendez√©shez -->
                    <th class="action-column letet"></th>
                </tr>
            </thead>
            <tbody>
                {% for cargo in cargos %}
                <tr data-cargo-id="{{ cargo.cargo_id }}">
                    <td>
                        {% if cargo.start_date_1 %}
                            {{ cargo.start_date_1.strftime('%Y.%m.%d.') }}
                            {% if cargo.start_date_2 %}
                                {% set delta = (cargo.start_date_2 - cargo.start_date_1).days %}
                                (+{{ delta }})
                            {% endif %}
                        {% endif %}

                        {% if cargo.start_time_1 or cargo.start_time_2 %}
                            <br>
                            {{ cargo.start_time_1.strftime('%H:%M') if cargo.start_time_1 else '' }}
                            ‚Äì {{ cargo.start_time_2.strftime('%H:%M') if cargo.start_time_2 else '' }}
                        {% endif %}
                    </td>

                    <td>{{ cargo.origin_country.upper()}}</td>
                    <td>{{ cargo.masked_origin_postcode if cargo.is_hidden_from else cargo.origin_postcode }}</td>
                    <td>{{ cargo.masked_origin_city if cargo.is_hidden_from else cargo.origin_city }}</td>
                    <td>
                        {% if cargo.end_date_1 %}
                            {{ cargo.end_date_1.strftime('%Y.%m.%d.') }}
                            {% if cargo.end_date_2 %}
                                {% set delta = (cargo.end_date_2 - cargo.end_date_1).days %}
                                (+{{ delta }})
                            {% endif %}
                        {% endif %}

                        {% if cargo.end_time_1 or cargo.end_time_2 %}
                            <br>
                            {{ cargo.end_time_1.strftime('%H:%M') if cargo.end_time_1 else '' }}
                            ‚Äì {{ cargo.end_time_2.strftime('%H:%M') if cargo.end_time_2 else '' }}
                        {% endif %}
                    </td>
                    <td>{{ cargo.destination_country.upper()}}</td>
                    <td>{{ cargo.masked_destination_postcode if cargo.is_hidden_to else cargo.destination_postcode }}</td>
                    <td>{{ cargo.masked_destination_city if cargo.is_hidden_to else cargo.destination_city }}</td>
                    <td>{{ cargo.size }}</td>
                    <td>{{ cargo.weight }}</td>
                    <td>{{ cargo.vehicle_type or '-' }}</td>
                    <td>{{ cargo.stucture or '-' }}</td>
                    <td>{{ cargo.equipment or '-' }}</td>
                    <td>{{ cargo.cargo_securement or '-' }}</td>
                    <td>{{ cargo.certificates or '-' }}</td>
                    <td>
                        {% if cargo.company %}
                            <a href="{{ url_for('company_profile', slug=cargo.company.slug) }}">
                                {{ cargo.company.name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="action-column-right">
                        <button class="action-btn offer-btn" id="" title="Aj√°nlatt√©tel">ü§ù</button>
                    </td>
                    <td style="display:none;">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nincs m√©g rakom√°ny.</p>
        {% endif %}
        </div>
    </main>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    var table;
    if (! $.fn.DataTable.isDataTable('#shipmentsTable')) {
        table = $('#shipmentsTable').DataTable({
            "order": [[16, "desc"], [1, "asc"]],
            "pageLength": 5,
            // scrollX: true,
            "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 17 }]
        });
    } else {
        table = $('#shipmentsTable').DataTable(); // l√©tez≈ë p√©ld√°nyt haszn√°ljuk
    }


    // Offer gomb click esem√©ny
    $('#shipmentsTable').on('click', '.offer-btn', function(e) {
        e.stopPropagation();
        var tr = $(this).closest('tr');
        var row = table.row(tr); // table v√°ltoz√≥ m√°r l√©teznie kell

        const cargoId = tr.data('cargo-id');

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
            return;
        }

        table.rows().every(function() {
            if (this.child.isShown()) this.child.hide();
            $(this.node()).removeClass('shown');
        });

        const formHtml = `
            <div class="offer-child-wrapper">
                <form class="offer-form">
                    <input type="hidden" name="cargo_id" value="${cargoId}">
                    <label>Felv√©t d√°tuma: <input type="date" name="pickup_date" required></label>
                    <label>Let√©t d√°tuma: <input type="date" name="delivery_date" required></label>
                    <label>√År: <input type="number" name="price" step="1" required></label>
                    <label>Valuta:
                        <select name="currency">
                            <option value="eur">‚Ç¨</option>
                            <option value="huf">Ft</option>
                        </select>
                    </label>
                    <label>Megjegyz√©s: <input type="text" name="note"></label>
                    <button type="submit">K√ºld√©s</button>
                </form>
            </div>
        `;
        row.child(formHtml).show();
        tr.addClass('shown');
    });


    // Offer form submit
    $('#shipmentsTable').on('submit', '.offer-form', function(e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();

        $.post('/offer', data)
            .done(function(response) {
                alert('Aj√°nlat elk√ºldve!');
                $form.closest('.offer-child-wrapper').remove();
            })
            .fail(function(xhr) {
                alert('Hiba: ' + (xhr.responseJSON?.message || 'Ismeretlen hiba'));
            });
    });

    // Child row-ok bez√°r√°sa √∫jrarenderkor
    table.on('draw', function() {
        table.rows().every(function() {
            if (this.child && this.child.isShown && this.child.isShown()) {
                this.child.hide();
            }
        });
        $('#shipmentsTable tbody tr').removeClass('shown');
    });
});

</script>
{% endblock %}
<style>
    /* A sticky action oszlop ne takarja el a child tartalmat: adjunk alacsonyabb z-indexet neki */
.action-column-right {
    position: sticky;
    right: 0;
    z-index: 1; /* alacsonyabb, hogy a child (z-index 5) l√°tsz√≥djon f√∂l√∂tte */
    background: #fff;
}

/* DataTables √°ltal besz√∫rt child sor td-jeire √©s a wrapperre biztos h√°tt√©r √©s magasabb z-index */
table.dataTable tr.child td, .offer-child-wrapper {
    background: #fff;
    position: relative;
    z-index: 51;
    padding: 10px;
}

/* Form st√≠lus (k√©nyelmes sorban) */
.offer-form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}
.offer-form label { display: flex; flex-direction: column; font-size: 0.9em; }
.offer-form button { padding: 6px 10px; cursor: pointer; }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.offer-notification a.open-chat {
    display: inline-block;
    margin-left: 10px;
    color: #0066cc;
    text-decoration: none;
    font-weight: bold;
}

.offer-notification a.open-chat:hover {
    text-decoration: underline;
}


</style>


{% endblock %}
