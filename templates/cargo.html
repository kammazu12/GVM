{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>

    <main class="main-content">
    <h1 class="cim">Járművek</h1>

    <div class="cargo-container">

        <!-- Accordion gomb -->
        <button class="accordion-btn">Áru keresése/feltöltése ▼</button>

        <!-- Lenyíló form -->
        <div class="accordion-content">
            <form action="{{ url_for('cargo') }}" method="POST" class="freight-form">

              <!-- Honnan és Hová blokk egymás mellett -->
              <!-- Honnan-Hová + Mikor -->
                <div class="grid-top">
                    <fieldset>
                        <legend>Honnan</legend>
                        <label for="from-country">Ország<span class="required">*</span></label>
                        <input type="text" id="from-country" name="from_country" list="country-list" autocomplete="off" required>
                        <datalist id="country-list"></datalist>

                        <label for="from-postcode">Irányítószám<span class="required">*</span></label>
                        <input type="text" id="from-postcode" name="from_postcode" required>

                        <label for="from-city">Település<span class="required">*</span></label>
                        <input type="text" id="from-city" name="from_city" required readonly>
                        <div class="toggle-row">
                            <span>Bújtatott fuvar</span>
                            <label class="switch">
                                <input type="checkbox" name="is_hidden_from">
                                <span class="slider round"></span>
                            </label>
                        </div>

                    </fieldset>

                    <div class="swap-container">
                        <button type="button" id="swap-btn">⇄</button>
                    </div>

                    <fieldset>
                        <legend>Hová</legend>
                        <label for="to-country">Ország<span class="required">*</span></label>
                        <input type="text" id="to-country" name="to_country" required>
                        <label for="to-postcode">Irányítószám<span class="required">*</span></label>
                        <input type="text" id="to-postcode" name="to_postcode" required>
                        <label for="to-city">Település<span class="required">*</span></label>
                        <input type="text" id="to-city" name="to_city" required readonly>
                        <div class="toggle-row">
                            <span>Bújtatott fuvar</span>
                            <label class="switch">
                                <input type="checkbox" name="is_hidden_to">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </fieldset>

                    <fieldset class="date-container">
                        <legend>Mikor</legend>
                        <div class="datetime-row">
                            <label>Felvétel kezdő dátum</label>
                            <div class="datetime-inputs">
                                <input type="date" name="departure_from" required class="date-input">
                                <input type="time" name="departure_from_time_start" placeholder="08:00" class="time-input">
                                <input type="time" name="departure_from_time_end" placeholder="16:00" class="time-input">
                            </div>
                        </div>

                        <div class="datetime-row">
                            <label>Felvétel záró dátum<span class="required">*</span></label>
                            <div class="datetime-inputs">
                                <input type="date" name="departure_end_date" required class="date-input">
                                <input type="time" name="departure_end_time_start" placeholder="08:00" class="time-input">
                                <input type="time" name="departure_end_time_end" placeholder="16:00" class="time-input">
                            </div>
                        </div>

                        <hr>
                        <div class="datetime-row">
                            <label>Rakodás kezdő dátum<span class="required">*</span></label>
                            <div class="datetime-inputs">
                                <input type="date" name="arrival_start_date" required class="date-input">
                                <input type="time" name="arrival_start_time_start" placeholder="08:00" class="time-input">
                                <input type="time" name="arrival_start_time_end" placeholder="16:00" class="time-input">
                            </div>
                        </div>

                        <div class="datetime-row">
                            <label>Rakodás záró dátum<span class="required">*</span></label>
                            <div class="datetime-inputs">
                                <input type="date" name="arrival_end_date" required class="date-input">
                                <input type="time" name="arrival_end_time_start" placeholder="08:00" class="time-input">
                                <input type="time" name="arrival_end_time_end" placeholder="16:00" class="time-input">
                            </div>
                        </div>
                    </fieldset>
                </div>

                <!-- Áru és Jármű alatta -->
                <div class="grid-bottom">
                    <fieldset class="vehicle-grid">
                        <legend>Jármű</legend>
                        <div class="vehicle-odd-row">
                            <label for="vehicle_type">Típus<span class="required">*</span></label>
                            <select id="vehicle_type" name="vehicle_type" required>
                                <option value="" disabled selected>Válassz jármű típust</option>
                                <option value="Jármű 3,5 t-ig">Jármű 3,5 t-ig</option>
                                <option value="Nyerges szerelvény">Nyerges szerelvény</option>
                                <option value="Pótos szerelvény">Pótos szerelvény</option>
                                <option value="Tehergépjármű 7,5 t-ig">Tehergépjármű 7,5 t-ig</option>
                                <option value="Tehergépjármű 12 t-ig">Tehergépjármű 12 t-ig</option>
                            </select>

                            <label for="superstructure">Felépítmény<span class="required">*</span></label>
                            <select id="superstructure" name="superstructure" required>
                                <option value="" disabled selected>Válassz felépítményt</option>
                                <option value="Autószállító">Autószállító</option>
                                <option value="Billenős konténer">Billenős konténer</option>
                                <option value="Cserefelépítmény-Chassis">Cserefelépítmény-Chassis</option>
                                <option value="Dobozos">Dobozos</option>
                                <option value="Furgon">Furgon</option>
                                <option value="Dupla kabinos">Dupla kabinos</option>
                                <option value="Félpótkocsi">Félpótkocsi</option>
                                <option value="Hűtő">Hűtő</option>
                                <option value="Jumbo">Jumbo</option>
                                <option value="Klipper">Klipper</option>
                                <option value="Konténerszállító">Konténerszállító</option>
                                <option value="Kábeldobszálíltó">Kábeldobszálíltó</option>
                                <option value="Középrakodós">Középrakodós</option>
                                <option value="Mega">Mega</option>
                                <option value="Mozgópadlós">Mozgópadlós</option>
                                <option value="Mozgópadlós (ömlesztett áru)">Mozgópadlós (ömlesztett áru)</option>
                                <option value="Mélybölcsős">Mélybölcsős</option>
                                <option value="Nyitott tehergépkocsi">Nyitott tehergépkocsi</option>
                                <option value="Oldalrakodós">Oldalrakodós</option>
                                <option value="Ponyvás">Ponyvás</option>
                                <option value="Sasszé">Sasszé</option>
                                <option value="Siló">Siló</option>
                                <option value="Speciális jármű">Speciális jármű</option>
                                <option value="Szigetelt">Szigetelt</option>
                                <option value="Szállítószalagos">Szállítószalagos</option>
                                <option value="Tartálykocsi">Tartálykocsi</option>
                                <option value="Tautliner">Tautliner</option>
                                <option value="Tele">Tele</option>
                                <option value="Vontató">Vontató</option>
                            </select>
                        </div>

                            <div class="vehicle-even-row">
                                <label for="equipment">Felszereltség</label>
                                <div class="multiselect">
                                    <div class="selectBox" onclick="toggleCheckboxes()">
                                        <span id="equipment-selected">Válassz felszereltséget</span>
                                        ▼
                                    </div>

                                    <div class="checkboxes" id="equipment-checkboxes">
                                        <label><input type="checkbox" value="2. sofőr"> 2. sofőr</label>
                                        <label><input type="checkbox" value="A-Schild"> A-Schild</label>
                                        <label><input type="checkbox" value="ADR"> ADR</label>
                                        <label><input type="checkbox" value="BF3 kísérőjármű"> BF3 kísérőjármű</label>
                                        <label><input type="checkbox" value="BF4 kísérőjármű"> BF4 kísérőjármű</label>
                                        <label><input type="checkbox" value="Béka"> Béka</label>
                                        <label><input type="checkbox" value="Emelőhátfal"> Emelőhátfal</label>
                                        <label><input type="checkbox" value="Farönkszállító"> Farönkszállító</label>
                                        <label><input type="checkbox" value="GPS követő"> GPS követő</label>
                                        <label><input type="checkbox" value="Húskampó"> Húskampó</label>
                                        <label><input type="checkbox" value="Rakodódaru"> Rakodódaru</label>
                                        <label><input type="checkbox" value="Rámpa"> Rámpa</label>
                                        <label><input type="checkbox" value="Takaróponyva"> Takaróponyva</label>
                                        <label><input type="checkbox" value="Targonca"> Targonca</label>
                                        <label><input type="checkbox" value="Válaszfal"> Válaszfal</label>
                                        <label><input type="checkbox" value="Vámzsinór"> Vámzsinór</label>
                                    </div>
                                </div>

                                <!-- Hidden select a formhoz -->
                                <select id="equipment" name="equipment" multiple hidden>
                                    <option value="2. sofőr">2. sofőr</option>
                                    <option value="A-Schild">A-Schild</option>
                                    <option value="ADR">ADR</option>
                                    <option value="BF3 kísérőjármű">BF3 kísérőjármű</option>
                                    <option value="BF4 kísérőjármű">BF4 kísérőjármű</option>
                                    <option value="Béka">Béka</option>
                                    <option value="Emelőhátfal">Emelőhátfal</option>
                                    <option value="Farönkszállító">Farönkszállító</option>
                                    <option value="GPS követő">GPS követő</option>
                                    <option value="Húskampó">Húskampó</option>
                                    <option value="Rakodódaru">Rakodódaru</option>
                                    <option value="Rámpa">Rámpa</option>
                                    <option value="Takaróponyva">Takaróponyva</option>
                                    <option value="Targonca">Targonca</option>
                                    <option value="Válaszfal">Válaszfal</option>
                                    <option value="Vámzsinór">Vámzsinór</option>
                                </select>
                            </div>

                        <div class="vehicle-odd-row">
                            <label for="certificates">Tanúsítványok</label>
                            <input type="text" id="certificates" name="certificates">
                            <label for="cargo_securement">Rakományrögzítés</label>
                            <input type="text" id="cargo_securement" name="cargo_securement">
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Áru<span class="required">*</span></legend>
                        <label for="length">Hossz (m)<span class="required">*</span></label>
                        <input type="number" id="length" name="length" step="0.1" min="0" required>
                        <label for="weight">Tömeg (t)<span class="required">*</span></label>
                        <input type="number" id="weight" name="weight" step="0.5" min="0" required>
                        <label for="description">Leírás</label>
                        <input type="text" id="description" name="description">
                    </fieldset>
                </div>

              <button type="submit">Áru feltölése és fuvar keresése</button>
            </form>
        </div>

        <!-- Táblázat -->
        <div class="table-container">
            <h2>Szabad járművek</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rendszám</th>
                        <th>Típus</th>
                        <th>Kapacitás</th>
                        <th>Helyszín</th>
                    </tr>
                </thead>
                <tbody>
                {% for vehicle in vehicles %}
                <tr>
                    <td>{{ vehicle.plate }}</td>
                    <td>{{ vehicle.type }}</td>
                    <td>{{ vehicle.capacity }}</td>
                    <td>{{ vehicle.location }}</td>
                </tr>
                {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const swapBtn = document.getElementById('swap-btn');

    swapBtn.addEventListener('click', () => {
        const fromCountry = document.getElementById('from-country');
        const fromPostcode = document.getElementById('from-postcode');
        const fromCity = document.getElementById('from-city');
        const is_hidden_from = document.querySelector('input[name="is_hidden_from"]');

        const toCountry = document.getElementById('to-country');
        const toPostcode = document.getElementById('to-postcode');
        const toCity = document.getElementById('to-city');
        const is_hidden_to = document.querySelector('input[name="is_hidden_to"]');

        // Csere
        [fromCountry.value, toCountry.value] = [toCountry.value, fromCountry.value];
        [fromPostcode.value, toPostcode.value] = [toPostcode.value, fromPostcode.value];
        [fromCity.value, toCity.value] = [toCity.value, fromCity.value];
        [is_hidden_from.checked, is_hidden_to.checked] = [is_hidden_to.checked, is_hidden_from.checked]
    });
});

document.addEventListener('DOMContentLoaded', function() {
    function setupAutocomplete(inputId, url, extraParams = {}) {
        const input = document.getElementById(inputId);
        const datalist = document.getElementById(input.getAttribute('list'));

        input.addEventListener('input', () => {
            let params = {...extraParams, term: input.value};
            fetch(url + '?' + new URLSearchParams(params))
                .then(res => res.json())
                .then(data => {
                    datalist.innerHTML = '';
                    data.forEach(item => {
                        let option = document.createElement('option');
                        option.value = item;
                        datalist.appendChild(option);
                    });
                });
        });
    }

    // Ország autocomplete
    setupAutocomplete('from-country', '/autocomplete/country');
    setupAutocomplete('to-country', '/autocomplete/country');


    function setupCityAutocomplete(cityInputId, countryInputId) {
    const cityInput = document.getElementById(cityInputId);
    const countryInput = document.getElementById(countryInputId);
    const datalist = document.getElementById(cityInput.getAttribute('list'));

    cityInput.addEventListener('input', () => {
        const countryName = countryInput.value;

        // 1. Lekérjük a FIPS kódot
        fetch(`/country/fips?country=${countryName}`)
            .then(res => res.json())
            .then(data => {
                const fips = data.fips || '';
                if (!fips) return;

                // 2. Lekérjük a városokat FIPS kód alapján
                fetch(`/autocomplete/city?term=${cityInput.value}&country=${fips}`)
                    .then(res => res.json())
                    .then(cities => {
                        datalist.innerHTML = '';
                        cities.forEach(city => {
                            let option = document.createElement('option');
                            option.value = city;
                            datalist.appendChild(option);
                        });
                    });
            });
    });
}

        // Használat
        setupCityAutocomplete('from-city', 'from-country');
        setupCityAutocomplete('to-city', 'to-country');


    // Irányítószám kitöltés várossal
    document.getElementById('from-postcode').addEventListener('blur', () => {
        let country = document.getElementById('from-country').value;
        let postcode = document.getElementById('from-postcode').value;
        fetch(`/zipcode?postalcode=${postcode}&country=${country}`)
            .then(res => res.json())
            .then(data => {
                if (data.city) document.getElementById('from-city').value = data.city;
            });
    });

    document.getElementById('to-postcode').addEventListener('blur', () => {
        let country = document.getElementById('to-country').value;
        let postcode = document.getElementById('to-postcode').value;
        fetch(`/zipcode?postalcode=${postcode}&country=${country}`)
            .then(res => res.json())
            .then(data => {
                if (data.city) document.getElementById('to-city').value = data.city;
            });
    });
});
</script>

<style>

.multiselect {
    position: relative;
    display: inline-block;
}

.selectBox {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border: 1px solid #aaa;
    padding: 8px;
    border-radius: 5px;
    background: #fff;
    cursor: pointer;
}

.checkboxes {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 oszlop */
  gap: 0.5rem 1rem; /* sor és oszlop közti távolság */
  padding: 0.5rem;
}

.checkboxes label {
  display: grid;           /* checkbox és szöveg egysorban */
  align-items: center;     /* checkbox középre */
  gap: 0.4rem;             /* kis távolság */
  cursor: pointer;
  white-space: normal;     /* szöveg törhet, ha hosszú */
}

.checkboxes input[type="checkbox"] {
  margin: 0;
  flex-shrink: 0; /* ne nyomódjon össze a checkbox */
}


.home-container {
    display: flex;
    min-height: 100vh;
    min-width: 100vw;
}

.date-container{
height: 85%;
}

.swap-container {
    display: flex;
    align-self: center;
    justify-content: center;
    text-align: left;
}

#swap-btn {
    display: flex;
    align-items: center;      /* függőlegesen középre */
    justify-content: center;  /* vízszintesen középre */
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 18px;
    cursor: pointer;
    padding: 0;               /* padding eltávolítása, hogy tényleg középen legyen */
    line-height: 1;           /* sor magasság normalizálása */
    text-align: center;
    transition: background 0.2s;
}

.main-content {
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    margin-left: 10%;
}

.cim {
    align-self: flex-start;
    font-size: 28px;
    margin-bottom: 20px;
    margin-left: 10%;
}

.cargo-container {
    min-width: 80%;
    max-width: 80%;
    margin: 10px auto;
}

.accordion-btn {
    width: 50%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    margin-bottom: 10px;
    transition: background 0.2s;
}


.selected-items {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.selected-item {
  background: #e0ffe0;
  border: 1px solid #00aa00;
  color: #006600;
  padding: 0.3rem 0.6rem;
  border-radius: 15px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
}

.selected-item:hover {
  background: #c4f5c4;
}

.accordion-btn:hover {
    background-color: #0056b3;
}

.accordion-content {
    display: none;
}

.datetime-row {
    margin-top: 5px;
}

.datetime-row label {
    display: block;
    margin-bottom: 2px; /* kis tér a label és az inputok között */
}

.datetime-inputs {
    display: grid;
    grid-template-columns: 40% 25% 25%;
    gap: 5px;
}

fieldset{
    height: 80%;
}

.date-input,
.time-input {
    width: 100%;
    box-sizing: border-box;
}

.freight-form {
    min-width: 100%;
    /*margin: auto;*/
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: sans-serif;
    display: grid;
}
/* Honnan-Hová + Mikor */
.grid-top {
    display: grid;
    grid-template-columns: 1fr auto 1fr 1fr; /* Honnan, swap gomb, Hová, Mikor */
    column-gap: 20px;
    align-items: start;
    width: 100%;
    margin-bottom: 20px;
}

/* Swap gomb középre a két fieldset között */
.swap-container {
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Áru és Jármű alatta, 45-45% */
.grid-bottom {
    display: grid;
    align-items: end;
    grid-template-columns: 63% 35%;
    column-gap: 2%;
    width: 100%;
}

.vehicle-grid {
  display: grid;
  grid-template-columns: 1fr 2fr 1fr 2fr; /* 2 oszlop */
  gap: 1rem; /* sor és oszlop közti távolság */
  align-items: start;
}

.vehicle-odd-row {
  display: contents; /* a gyermek elemek közvetlenül a gridbe kerülnek */
}

.vehicle-even-row {
  grid-column: 1 / -1; /* a teljes szélességet elfoglalja (1-2. oszlop) */
  display: flex;
  flex-direction: column; /* label + mező egymás alatt */
}


/* minden label+mező blokk függőlegesen egymás alatt */
.vehicle-grid label {
  display: block;
  margin-bottom: 4px;
}

/* felszereltség mező teljes sorban */
.multiselect,
#equipment[hidden] {
  grid-column: 1 / span 2; /* 2 oszlopot foglal */
}


fieldset {
    border: 1px solid #ccc;
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    max-width: 100%;
}

legend {
    font-weight: bold;
    padding: 0 10px;
}

label {
    display: block;
    margin-top: 10px;
    font-size: 14px;
    color: #333;
}

input {
    width: 100%;
    padding: 8px 10px;
    margin-top: 4px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

button[type="submit"] {
    background: #4a90e2;
    color: #fff;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s;
}

button[type="submit"]:hover {
    background: #3578c3;
}

.table-container {
    overflow-x: auto;
    margin-top: 15px;
}

table, th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    align-content: center;

}

.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 26px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #4a90e2;
}

input:checked + .slider:before {
    transform: translateX(24px);
}


.table-container{
    align-content: center;
    min-width: 100%;
}

th {
    background: #007bff;
    color: white;
}

tr:nth-child(even) {
    background: #f9f9f9;
}


</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const accordionBtn = document.querySelector('.accordion-btn');
    const accordionContent = document.querySelector('.accordion-content');

    accordionBtn.addEventListener('click', () => {
        if (accordionContent.style.display === "block") {
            accordionContent.style.display = "none";
        } else {
            accordionContent.style.display = "block";
        }
    });
});

$(function() {
    let selectedCountryISO = '';

    $("#from-country").autocomplete({
        source: "/autocomplete/country",
        minLength: 1,
        select: function(event, ui) {
            // FIPS/ISO kód elmentése
            selectedCountryISO = ui.item.iso;
        }
    });
    $("#to-country").autocomplete({
        source: "/autocomplete/country",
        minLength: 1,
        select: function(event, ui) {
            // FIPS/ISO kód elmentése
            selectedCountryISO = ui.item.iso;
        }
    });


    $("#from-city").autocomplete({
        source: function(request, response) {
            $.getJSON("/autocomplete/city", {
                term: request.term,
                country: $("#from-city").data("fips")  // ország FIPS kód
            }, function(data) {
                response($.map(data, function(item) {
                    return {
                        label: item.name,   // amit a user lát
                        value: item.name,   // ami az inputba kerül
                        fips: item.fips     // extra adat, hidden mezőbe
                    };
                }));
            });
        },
        select: function(event, ui) {
            $("#to-city").val(ui.item.value);       // csak a város neve
            $("#to-city-fips").val(ui.item.fips);   // hiddenbe a FIPS
            return false;
        }
    });

    $("#to-city").autocomplete({
        source: function(request, response) {
            $.getJSON("/autocomplete/city", {
                term: request.term,
                country: $("#to-country").data("fips")  // ország FIPS kód
            }, function(data) {
                response($.map(data, function(item) {
                    return {
                        label: item.name,   // amit a user lát
                        value: item.name,   // ami az inputba kerül
                        fips: item.fips     // extra adat, hidden mezőbe
                    };
                }));
            });
        },
        select: function(event, ui) {
            $("#to-city").val(ui.item.value);       // csak a város neve
            $("#to-city-fips").val(ui.item.fips);   // hiddenbe a FIPS
            return false;
        }
    });

});

let expanded = false;

function toggleCheckboxes() {
    const checkboxes = document.getElementById("equipment-checkboxes");
    checkboxes.style.display = expanded ? "none" : "grid";
    expanded = !expanded;
}

// Szinkronizálás a hidden selecttel
const checkboxes = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]');
const hiddenSelect = document.getElementById('equipment');
const selectedSpan = document.getElementById('equipment-selected');

checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        // Először minden option selected false
        Array.from(hiddenSelect.options).forEach(option => option.selected = false);

        // Most minden checked checkbox-hoz selected=true
        const checkedValues = [];
        checkboxes.forEach(cb => {
            if(cb.checked){
                const option = Array.from(hiddenSelect.options).find(o => o.value === cb.value);
                if(option) option.selected = true;
                checkedValues.push(cb.value);
            }
        });

        // Frissítjük a span szövegét
        selectedSpan.textContent = checkedValues.length ? checkedValues.join(', ') : 'Válassz felszereltséget';
    });
});


  // kattintás máshova → bezár
document.addEventListener('click', function(event) {
    const multiselect = document.querySelector('.multiselect');
    if (!multiselect.contains(event.target)) {
      document.getElementById("equipment-checkboxes").style.display = "none";
      expanded = false;
    }
  });

window.addEventListener('DOMContentLoaded', () => {
    function nextWeekday(date, n = 1) {
        let result = new Date(date);
        let added = 0;
        while (added < n) {
            result.setDate(result.getDate() + 1);
            const day = result.getDay();
            if (day !== 0 && day !== 6) { // 0 = vasárnap, 6 = szombat
                added++;
            }
        }
        return result;
    }

    function formatDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    const dateInputs = document.querySelectorAll('input[type="date"]');
    const today = new Date();

    if(dateInputs.length >= 4){
        dateInputs[0].value = formatDate(today); // Ma
        dateInputs[1].value = formatDate(nextWeekday(today, 1)); // Következő munkanap
        dateInputs[2].value = formatDate(nextWeekday(today, 1)); // Következő munkanap
        dateInputs[3].value = formatDate(nextWeekday(today, 2)); // Következő utáni munkanap
    }

    // document.querySelector('input[name="departure_from_time_start"]').value = "08:00";
    // document.querySelector('input[name="departure_from_time_end"]').value = "16:00";
    // document.querySelector('input[name="departure_end_time_start"]').value = "08:00";
    // document.querySelector('input[name="departure_end_time_end"]').value = "16:00";
    // document.querySelector('input[name="arrival_start_time_start"]').value = "08:00";
    // document.querySelector('input[name="arrival_start_time_end"]').value = "16:00";
    // document.querySelector('input[name="arrival_end_time_start"]').value = "08:00";
    // document.querySelector('input[name="arrival_end_time_end"]').value = "16:00";
});

window.addEventListener('DOMContentLoaded', () => {
    const dateInputs = document.querySelectorAll('input[type="date"]');

    dateInputs.forEach(input => {
        input.addEventListener("input", () => validateDates(dateInputs));
    });

    function validateDates(inputs) {
    const depStart = new Date(inputs[0].value);
    const depEnd   = new Date(inputs[1].value);
    const arrStart = new Date(inputs[2].value);
    const arrEnd   = new Date(inputs[3].value);

    // pickup vége >= pickup kezdete
    if (depEnd < depStart) {
        inputs[1].setCustomValidity("A felvétel vége nem lehet a kezdete előtt.");
    } else {
        inputs[1].setCustomValidity("");
    }

    // delivery kezdete >= pickup kezdete
    if (arrStart < depStart) {
        inputs[2].setCustomValidity("A letétel nem lehet korábbi, mint a felvétel kezdete.");
    } else {
        inputs[2].setCustomValidity("");
    }

    // delivery vége >= pickup vége
    if (arrEnd < depEnd) {
        inputs[3].setCustomValidity("A letétel vége nem lehet korábbi, mint a felvétel vége.");
    } else {
        inputs[3].setCustomValidity("");
    }

    // delivery vége >= delivery eleje
    if (arrEnd < arrStart) {
        inputs[3].setCustomValidity("A letétel vége nem lehet korábbi, mint a letétel eleje.");
    } else {
        inputs[3].setCustomValidity("");
    }

}

});

document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector(".freight-form");
    const inputs = form.querySelectorAll("input[required], select[required]");

    inputs.forEach(input => {
        // ha elhagyta a mezőt, jelzi a hibát
        input.addEventListener("blur", () => {
            input.dataset.touched = "true";
            validateInput(input);
        });

        // ha ír bele valamit, újra ellenőriz
        input.addEventListener("input", () => {
            if (input.dataset.touched === "true") {
                validateInput(input);
            }
        });
    });

    form.addEventListener("submit", (e) => {
        let valid = true;
        inputs.forEach(input => {
            if (!validateInput(input)) {
                valid = false;
            }
        });
        if (!valid) {
            e.preventDefault(); // ne küldje el
        }
    });

    function validateInput(input) {
        let isValid = true;
        if (input.hasAttribute("required") && !input.value) {
            isValid = false;
            input.classList.add("invalid");
        } else {
            input.classList.remove("invalid");
        }
        return isValid;
    }
});

window.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.freight-form');

    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // megállítja a normál submitot

        // töröljük a korábbi hibákat
        form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        form.querySelectorAll('.error-msg').forEach(el => el.remove());

        // adatgyűjtés
        const formData = new FormData(form);

        // AJAX POST
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if(data.success){
            // sikeres mentés, átirányítás vagy üzenet
            window.location.reload();
        } else {
            // hibák feldolgozása
            for(const [fieldName, msg] of Object.entries(data.errors)){
                const field = form.querySelector(`[name="${fieldName}"]`);
                if(field){
                    field.classList.add('error');
                    const errorSpan = document.createElement('span');
                    errorSpan.classList.add('error-msg');
                    errorSpan.textContent = msg;
                    field.parentNode.appendChild(errorSpan);
                }
            }
        }
    });
});


</script>
{% endblock %}
