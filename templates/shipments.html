{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
        <h1 class="cim">Rakom√°nyok</h1>

        <div class="cargo-container">
        <button class="accordion-btn">Rakt√©r felt√∂lt√©se / rakom√°ny keres√©se ‚ñº</button>
        <!-- Leny√≠l√≥ form -->
        <div class="accordion-content">
            <!-- Tabs gombok -->
            <div id="form-tab" class="tab-content" style="display:block;">
                <form action="{{ url_for('vehicles.save_vehicle') }}" method="POST" id="vehicleForm" class="freight-form">
                    <div class="template-select-wrapper">
                        <label for="vehicle_template_select"><strong>Sablon bet√∂lt√©se:</strong></label>
                        <!-- Most m√°r l√°that√≥ select -->
                        <select id="vehicle_template_select" name="template_id">
                            <option value="" selected disabled>V√°lassz sablont</option>
                            {% for t in templates %}
                                <option value="{{ t.id }}">
                                    {{ t.origin_city }} ‚Üí {{ t.destination_city }} | {{ t.capacity_t }} t | {{ t.volume_m3 }} m¬≥ | {{ t.vehicle_type or '‚Äì' }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Eredet -->
                    <div class="form-section">
                        <h4>Hely adatok</h4>
                        <div class="places">
                            <label for="origin" class="elso_label">Honnan?</label>
                            <label for="origin_diff" class="x"></label>
                            <label for="swap-btn" class="y"></label>
                            <label for="destination" class="masodik_label">Hova?</label>
                            <label for="destination_diff" class="z"></label>

                            <div class="autocomplete-wrapper">
                                <input type="text" id="origin" placeholder="V√°ros" autocomplete="off">
                                <div id="origin_suggestions" class="suggestions"></div>
                                <input type="hidden" id="origin_city" name="origin_city">
                                <input type="hidden" id="origin_zip" name="origin_zip">
                                <input type="hidden" id="origin_country" name="origin_country">
                            </div>


                            <select id="origin_diff" name="origin_diff">
                                <option value="0" selected>+0 km</option>
                                <option value="25">+25 km</option>
                                <option value="50">+50 km</option>
                                <option value="100">+100 km</option>
                                <option value="any">+any km</option>
                            </select>
                            <button type="button" id="swap-btn">‚áÑ</button>

                            <div class="autocomplete-wrapper">
                                <input type="text" id="destination" placeholder="V√°ros" autocomplete="off">
                                <div id="destination_suggestions" class="suggestions"></div>
                                <input type="hidden" id="destination_city" name="destination_city">
                                <input type="hidden" id="destination_zip" name="destination_zip">
                                <input type="hidden" id="destination_country" name="destination_country">
                            </div>


                            <select id="destination_diff" name="destination_diff">
                                <option value="0" selected>+0 km</option>
                                <option value="25">+25 km</option>
                                <option value="50">+50 km</option>
                                <option value="100">+100 km</option>
                                <option value="any">+any km</option>
                            </select>

                            <input type="date" id="available_from" name="available_from">
                            <input type="date" id="available_until" name="available_until">
                        </div>

                        <div class="form-section hidden" id="destination-countries-section">
                        <label for="destination_countries">Orsz√°gok, ahova mehet a j√°rm≈±</label>
                        <div class="multiselect">
                            <div class="selectBox" onclick="toggleCheckboxes('destination_countries')">
                                <span id="destination_countries-selected">V√°lassz orsz√°got</span> ‚ñº
                            </div>
                            <select id="destination_countries" name="destination_countries" multiple hidden>
                                {% for country in eu_countries %}
                                    <option value="{{ country.code }}">{{ country.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                    </div>

                    </div>
                    <br>

                    <!-- J√°rm≈± alapadatok -->
                    <div class="form-section">
                        <h4>About vehicle</h4>
                        <div class="vehicle-col">
                            <label for="vehicle_type">J√°rm≈± t√≠pusa *</label>
                            <label for="structure">Fel√©p√≠tm√©ny<span class="required">*</span></label>
                            <select id="vehicle_type" name="vehicle_type" required>
                            <option value="" disabled selected>V√°lassz j√°rm≈± t√≠pust</option>
                            <option value="J√°rm≈± 3,5 t-ig">J√°rm≈± 3,5 t-ig</option>
                            <option value="Nyerges szerelv√©ny">Nyerges szerelv√©ny</option>
                            <option value="P√≥tos szerelv√©ny">P√≥tos szerelv√©ny</option>
                            <option value="Teherg√©pj√°rm≈± 7,5 t-ig">Teherg√©pj√°rm≈± 7,5 t-ig</option>
                            <option value="Teherg√©pj√°rm≈± 12 t-ig">Teherg√©pj√°rm≈± 12 t-ig</option>
                        </select>
                            <select id="structure" name="structure" required>
                                <option value="" disabled selected>V√°lassz fel√©p√≠tm√©nyt</option>
                                <option value="Aut√≥sz√°ll√≠t√≥">Aut√≥sz√°ll√≠t√≥</option>
                                <option value="Billen≈ës kont√©ner">Billen≈ës kont√©ner</option>
                                <option value="Cserefel√©p√≠tm√©ny-Chassis">Cserefel√©p√≠tm√©ny-Chassis</option>
                                <option value="Dobozos">Dobozos</option>
                                <option value="Furgon">Furgon</option>
                                <option value="Dupla kabinos">Dupla kabinos</option>
                                <option value="F√©lp√≥tkocsi">F√©lp√≥tkocsi</option>
                                <option value="H≈±t≈ë">H≈±t≈ë</option>
                                <option value="Jumbo">Jumbo</option>
                                <option value="Klipper">Klipper</option>
                                <option value="Kont√©nersz√°ll√≠t√≥">Kont√©nersz√°ll√≠t√≥</option>
                                <option value="K√°beldobsz√°l√≠lt√≥">K√°beldobsz√°l√≠lt√≥</option>
                                <option value="K√∂z√©prakod√≥s">K√∂z√©prakod√≥s</option>
                                <option value="Mega">Mega</option>
                                <option value="Mozg√≥padl√≥s">Mozg√≥padl√≥s</option>
                                <option value="Mozg√≥padl√≥s (√∂mlesztett √°ru)">Mozg√≥padl√≥s (√∂mlesztett √°ru)</option>
                                <option value="M√©lyb√∂lcs≈ës">M√©lyb√∂lcs≈ës</option>
                                <option value="Nyitott teherg√©pkocsi">Nyitott teherg√©pkocsi</option>
                                <option value="Oldalrakod√≥s">Oldalrakod√≥s</option>
                                <option value="Ponyv√°s">Ponyv√°s</option>
                                <option value="Sassz√©">Sassz√©</option>
                                <option value="Sil√≥">Sil√≥</option>
                                <option value="Speci√°lis j√°rm≈±">Speci√°lis j√°rm≈±</option>
                                <option value="Szigetelt">Szigetelt</option>
                                <option value="Sz√°ll√≠t√≥szalagos">Sz√°ll√≠t√≥szalagos</option>
                                <option value="Tart√°lykocsi">Tart√°lykocsi</option>
                                <option value="Tautliner">Tautliner</option>
                                <option value="Tele">Tele</option>
                                <option value="Vontat√≥">Vontat√≥</option>
                            </select>

                            <label for="equipment">Felszerelts√©g</label>
                            <label for="securement">Rakom√°nyr√∂gz√≠t√©s</label>

                            <!-- Felszerelts√©g -->
                            <div class="multiselect">
                                <div class="selectBox" onclick="toggleCheckboxes('equipment')">
                                    <span id="equipment-selected">V√°lassz felszerelts√©get</span> ‚ñº
                                </div>
                                <div class="checkboxes" id="equipment-checkboxes" data-editor-usable="equipment">
                                    <label><input type="checkbox" value="2. sof≈ër"> 2. sof≈ër </label>
                                    <label><input type="checkbox" value="A-Schild"> A-Schild </label>
                                    <label><input type="checkbox" value="ADR"> ADR </label>
                                    <label><input type="checkbox" value="BF3 k√≠s√©r≈ëj√°rm≈±"> BF3</label>
                                    <label><input type="checkbox" value="BF4 k√≠s√©r≈ëj√°rm≈±"> BF4</label>
                                    <label><input type="checkbox" value="B√©ka"> B√©ka</label>
                                    <label><input type="checkbox" value="Emel≈ëh√°tfal"> Emel≈ëh√°tfal</label>
                                    <label><input type="checkbox" value="Far√∂nksz√°ll√≠t√≥"> Far√∂nksz√°ll√≠t√≥</label>
                                    <label><input type="checkbox" value="GPS k√∂vet≈ë"> GPS k√∂vet≈ë</label>
                                    <label><input type="checkbox" value="H√∫skamp√≥"> H√∫skamp√≥</label>
                                    <label><input type="checkbox" value="Rakod√≥daru"> Rakod√≥daru</label>
                                    <label><input type="checkbox" value="R√°mpa"> R√°mpa</label>
                                    <label><input type="checkbox" value="Takar√≥ponyva"> Takar√≥ponyva</label>
                                    <label><input type="checkbox" value="Targonca"> Targonca</label>
                                    <label><input type="checkbox" value="V√°laszfal"> V√°laszfal</label>
                                    <label><input type="checkbox" value="V√°mzsin√≥r"> V√°mzsin√≥r</label>
                                </div>
                            </div>
                            <select id="equipment" name="equipment" multiple hidden>
                                <option value="2. sof≈ër">2. sof≈ër</option>
                                <option value="A-Schild">A-Schild</option>
                                <option value="ADR">ADR</option>
                                <option value="BF3 k√≠s√©r≈ëj√°rm≈±">BF3 k√≠s√©r≈ëj√°rm≈±</option>
                                <option value="BF4 k√≠s√©r≈ëj√°rm≈±">BF4 k√≠s√©r≈ëj√°rm≈±</option>
                                <option value="B√©ka">B√©ka</option>
                                <option value="Emel≈ëh√°tfal">Emel≈ëh√°tfal</option>
                                <option value="Far√∂nksz√°ll√≠t√≥">Far√∂nksz√°ll√≠t√≥</option>
                                <option value="GPS k√∂vet≈ë">GPS k√∂vet≈ë</option>
                                <option value="H√∫skamp√≥">H√∫skamp√≥</option>
                                <option value="Rakod√≥daru">Rakod√≥daru</option>
                                <option value="R√°mpa">R√°mpa</option>
                                <option value="Takar√≥ponyva">Takar√≥ponyva</option>
                                <option value="Targonca">Targonca</option>
                                <option value="V√°laszfal">V√°laszfal</option>
                                <option value="V√°mzsin√≥r">V√°mzsin√≥r</option>
                            </select>

                            <!-- Rakom√°nyr√∂gz√≠t√©s -->
                            <div class="multiselect">
                                <div class="selectBox" onclick="toggleCheckboxes('securement')">
                                    <span id="securement-selected">V√°lassz rakom√°nyr√∂gz√≠t√©st</span> ‚ñº
                                </div>
                                <div class="checkboxes" id="securement-checkboxes" data-editor-usable="securement">
                                    <label><input type="checkbox" value="Cs√∫sz√°sg√°tl√≥"> Cs√∫sz√°sg√°tl√≥</label>
                                    <label><input type="checkbox" value="L√°ncos fesz√≠t≈ë"> L√°ncos fesz√≠t≈ë</label>
                                    <label><input type="checkbox" value="Multilock"> Multilock</label>
                                    <label><input type="checkbox" value="Oldalfalas"> Oldalfalas</label>
                                    <label><input type="checkbox" value="Palettar√∂gz√≠t≈ë gerenda"> R√∂gz√≠t≈ë gerenda</label>
                                    <label><input type="checkbox" value="Rakom√°nyr√∂gz√≠t≈ë r√∫d"> Rakom√°nyr√∂gz√≠t≈ë r√∫d</label>
                                    <label><input type="checkbox" value="Rakonca"> Rakonca</label>
                                    <label><input type="checkbox" value="Spanifer"> Spanifer</label>
                                    <label><input type="checkbox" value="√âlv√©d≈ë"> √âlv√©d≈ë</label>
                                </div>
                            </div>
                            <select id="securement" name="securement" multiple hidden>
                                <option value="Cs√∫sz√°sg√°tl√≥">Cs√∫sz√°sg√°tl√≥</option>
                                <option value="L√°ncos fesz√≠t≈ë">L√°ncos fesz√≠t≈ë</option>
                                <option value="Multilock">Multilock</option>
                                <option value="Oldalfalas">Oldalfalas</option>
                                <option value="Palettar√∂gz√≠t≈ë gerenda">Palettar√∂gz√≠t≈ë gerenda</option>
                                <option value="Rakom√°nyr√∂gz√≠t≈ë r√∫d">Rakom√°nyr√∂gz√≠t≈ë r√∫d</option>
                                <option value="Rakonca">Rakonca</option>
                                <option value="Spanifer">Spanifer</option>
                                <option value="√âlv√©d≈ë">√âlv√©d≈ë</option>
                            </select>
                        </div>
                        <!-- Le√≠r√°s + Rendsz√°m sor -->
                        <div class="form-row" style="display: flex; gap: 15px; align-items: flex-start; margin-top: 10px;">
                            <!-- Le√≠r√°s -->
                            <div class="form-group" style="flex: 3;">
                                <label for="description">Le√≠r√°s</label>
                                <textarea id="description" name="description" placeholder="R√©szletek a j√°rm≈±r≈ël" rows="1" style="width: 100%; max-height: 35px;"></textarea>
                            </div>

                            <!-- Rendsz√°m -->
                            <div class="form-group" style="flex: 1;">
                                <label for="license_plate">
                                    Rendsz√°m
                                    <span data-bs-toggle="tooltip" title="A rendsz√°m nem fog megjelenni senki sz√°m√°ra, am√≠g az √ºzlet meg nem k√∂ttetik. A gyorsabb √ºgyint√©z√©s miatt √©rdemes megadni.">
                                        <img src="{{ url_for('static', filename='icons/tooltip.png') }}" alt="Tooltip" style="width:16px; height:16px; vertical-align: middle;">
                                    </span>
                                </label>
                                <input type="text" id="license_plate" name="license_plate" placeholder="Pl. ABC-123" maxlength="10" style="width: 100%;">
                            </div>
                        </div>

                    </div>

                    <!-- D√≠j / Kapacit√°s sor √°talak√≠tva flexbox-szal -->
                    <div class="form-section flex-row">
                        <div style="flex: 0 0 25%; padding-right:5px;">
                            <label for="capacity_t">Kapacit√°s (t)</label>
                            <input type="number" step="0.1" id="capacity_t" name="capacity_t">
                        </div>

                        <div style="flex: 0 0 25%; padding-right:5px;">
                            <label for="volume_m3">Rakt√©r m√©ret (m¬≥)</label>
                            <input type="number" step="0.1" id="volume_m3" name="volume_m3">
                        </div>

                        <div style="flex: 0 0 30%; padding-right:5px;">
                            <label for="price">√År</label>
                            <input type="number" step="0.01" id="price" name="price">
                        </div>

                        <div style="flex: 0 0 15%;">
                            <label for="currency">P√©nznem</label>
                            <select id="currency" name="currency">
                                <option value="EUR">EUR</option>
                                <option value="HUF">HUF</option>
                            </select>
                        </div>
                    </div>

                    <div class="cards-row">
                        <div id="paletteCard" class="palette-card">Raklap csere <img src="{{ url_for('static', filename='icons/exchange_palette.png') }}" alt="Palettacsere"></div>
                        <input type="hidden" id="palette_exch" name="palette_exchange" value="false">

                        <div id="oversizeCard" class="oversize-card">T√∫lm√©retes √°ru<img src="{{ url_for('static', filename='icons/oversize.png') }}" alt="T√∫lm√©retes"></div>
                        <input type="hidden" id="oversize" name="oversize" value="false">

                        <div id="loadtypeCard" class="loadtype-card">R√©szrakom√°ny <img src="{{ url_for('static', filename='icons/ltl.png') }}" alt="LTL"></div>
                        <input type="hidden" id="load_type" name="load_type" value="false">

                        <div id="publicLicenseCard" class="publiclicense-card" title="M√°sok sz√°m√°ra is el√©rhet≈ë lesz a rendsz√°m m√°r az √ºzletk√∂t√©s el≈ëtt. Ne agg√≥dj, nem fogjuk az arcukba nyomni.">Publikus rendsz√°m <img src="{{ url_for('static', filename='icons/license_plate.png') }}" alt="License plate"></div>
                        <input type="hidden" id="public_license" name="public_license" value="false">
                    </div>

                    <input type="hidden" id="origin_lat" name="origin_lat">
                    <input type="hidden" id="origin_lon" name="origin_lon">
                    <input type="hidden" id="destination_lat" name="destination_lat">
                    <input type="hidden" id="destination_lon" name="destination_lon">
                    <input type="hidden" id="routeCoordsInput" name="routeCoordsInput">
                    <!-- Checkboxok a ment√©s el≈ëtt -->
                    <div class="sablon-wrapper">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="sablonCheckbox" name="sablonCheckbox" class="sablon">
                            <span class="checkmark"></span>
                            Ment√©s sablonk√©nt
                        </label>

                        <label class="custom-checkbox">
                            <input type="checkbox" id="longtermCheckbox" name="longtermCheckbox" class="sablon">
                            <span class="checkmark"></span>
                            Ment√©s √°lland√≥ fuvark√©nt
                        </label>
                    </div>

                    <div class="btn-wrapper" style="margin-top:15px;">
                        <button type="submit">Keres√©s √©s ment√©s</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- Ezt cser√©ld be az eredeti modal-dialog sor hely√©re -->
        <div class="modal fade" id="cargoModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Rakom√°ny r√©szletek</h5>
              </div>
              <div class="modal-body" id="cargoDetails">
                <!-- Ide t√∂ltj√ºk majd AJAX-szal a r√©szleteket -->
              </div>
            </div>
          </div>
        </div>

        {% if cargos %}
        <div class="table-wrapper">
            <table id="shipmentsTable" class="display" style="font-size: 0.9em; border:none;">
            <thead>
                <tr>
                    <th class="felvet datum"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                    <th class="felvet">Rakom√°ny felv√©tel</th>
                    <th class="letet datum"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                    <th class="letet">Rakom√°ny let√©tel</th>
                    <th class="arujarmu"><img src="{{ url_for('static', filename='icons/length2.png') }}" style="width: 24px"> (m)</th>
                    <th class="arujarmu"><img src="{{ url_for('static', filename='icons/weight.png') }}" style="width: 28px"> (t)</th>
                    <th class="arujarmu">J√°rm≈± t√≠pusa</th>
                    <th class="arujarmu">Fel√©p√≠tm√©ny</th>
                    <th class="arujarmu">Felszerel√©s</th>
                    <th class="arujarmu">R√∂gz√≠t√©s</th>
                    <th class="arujarmu">Extr√°k</th>
                    <th class="arujarmu">Megjegyz√©s</th>
                    <th class="hirdeto">Hirdet≈ë c√©g</th>
                    <th class="action-column letet"></th>
                    <th style="display:none;">created_at</th> <!-- rejtett oszlop a cs√∂kken≈ë rendez√©shez -->
                </tr>
            </thead>
            <tbody>
                {% for cargo in cargos %}
                <tr class="cargo-row" data-cargo-id="{{ cargo.cargo_id }}" style="cursor:pointer;">
                    {# Pickup d√°tum + id≈ë #}
                    <td class="datum">
                        {% set pickups = cargo.locations | selectattr('type', 'equalto', 'pickup') | list %}
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% if first_pickup.start_date %}
                                {% if first_pickup.start_date.year == current_year %}
                                    {{ first_pickup.start_date.strftime('%m.%d.') }}
                                {% else %}
                                    {{ first_pickup.start_date.strftime('%Y.%m.%d.') }}
                                {% endif %}
                                {% if first_pickup.end_date %}
                                    {% set delta = (first_pickup.end_date - first_pickup.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}

                            {% if first_pickup.start_time_1 or first_pickup.start_time_2 %}
                                <br>
                                {{ first_pickup.start_time_1.strftime('%H:%M') if first_pickup.start_time_1 else '' }}
                                ‚Äì {{ first_pickup.start_time_2.strftime('%H:%M') if first_pickup.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    {# Pickup hely #}
                    <td class="pickup-cell">
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% set extra_pickups = pickups|length - 1 %}
                            <span class="country-zip">
                                {{ first_pickup.country.upper() }} {{ first_pickup.masked_postcode if first_pickup.is_hidden else first_pickup.postcode }}
                            </span>
                            <br>
                            <span class="city">
                                {{ first_pickup.masked_city if first_pickup.is_hidden else first_pickup.city }}
                            </span>
                            {% if extra_pickups > 0 %}
                                <br><span class="extra-count">(+{{ extra_pickups }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    {# Dropoff d√°tum + id≈ë #}
                    <td class="datum">
                        {% set dropoffs = cargo.locations | selectattr('type', 'equalto', 'dropoff') | list %}
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% if last_dropoff.start_date %}
                                {% if last_dropoff.start_date.year == current_year %}
                                    {{ last_dropoff.start_date.strftime('%m.%d.') }}
                                {% else %}
                                    {{ last_dropoff.start_date.strftime('%Y.%m.%d.') }}
                                {% endif %}
                                {% if last_dropoff.end_date %}
                                    {% set delta = (last_dropoff.end_date - last_dropoff.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}

                            {% if last_dropoff.start_time_1 or last_dropoff.start_time_2 %}
                                <br>
                                {{ last_dropoff.start_time_1.strftime('%H:%M') if last_dropoff.start_time_1 else '' }}
                                ‚Äì {{ last_dropoff.start_time_2.strftime('%H:%M') if last_dropoff.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    {# Dropoff hely #}
                    <td class="dropoff-cell">
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% set extra_dropoffs = dropoffs|length - 1 %}
                            <span class="country-zip">
                                {{ last_dropoff.country.upper() }} {{ last_dropoff.masked_postcode if last_dropoff.is_hidden else last_dropoff.postcode }}
                            </span>
                            <br>
                            <span class="city">
                                {{ last_dropoff.masked_city if last_dropoff.is_hidden else last_dropoff.city }}
                            </span>
                            {% if extra_dropoffs > 0 %}
                                <br><span class="extra-count">(+{{ extra_dropoffs }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    {# A t√∂bbi oszlop v√°ltozatlan marad #}
                    <td>{{ cargo.size }}</td>
                    <td>{{ cargo.weight }}</td>
                    <td>{{ cargo.vehicle_type or '-' }}</td>
                    <td>{{ cargo.structure or '-' }}</td>
                    <td>{{ cargo.equipment or '-' }}</td>
                    <td>{{ cargo.cargo_securement or '-' }}</td>
                    <td>
                        {% set extras = [] %}
                        {% if cargo.palette_exchange %}{% set _ = extras.append('Palettacsere') %}{% endif %}
                        {% if cargo.oversize %}{% set _ = extras.append('T√∫lm√©retes √°ru') %}{% endif %}
                        {{ extras|join('<br>') | safe if extras else '-' }}
                    </td>
                    <td>
                        {% set notes = [] %}
                        {% if cargo.description %}{% set _ = notes.append("Rakom√°ny: " ~ (cargo.description[:50] ~ ('...' if cargo.description|length > 30 else ''))) %}{% endif %}
                        {% if cargo.note %}{% set _ = notes.append("J√°rm≈±: " ~ (cargo.note[:50] ~ ('...' if cargo.note|length > 30 else ''))) %}{% endif %}
                        {{ notes|join('<br>')|safe if notes else '-' }}
                    </td>

                    <td>
                        {% if cargo.company %}
                            <a href="{{ url_for('company.company_profile', slug=cargo.company.slug) }}">
                                {{ cargo.company.name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="action-column-right">
                        {% if cargo.user_id == current_user.user_id %}
                            <button class="action-btn offer-btn" disabled title="Saj√°t rakom√°nyra nem adhatsz aj√°nlatot" style="background-color:#ccc; cursor:not-allowed;">ü§ù</button>
                        {% else %}
                            <button class="action-btn offer-btn" title="Aj√°nlatt√©tel">ü§ù</button>
                        {% endif %}
                    </td>
                    <td style="display:none;">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nincs m√©g rakom√°ny.</p>
        {% endif %}
        </div>

        <!-- Modal a konkr√©t j√°rm≈± aj√°nl√°shoz -->
        <div class="modal fade" id="specificvehicleModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hirdetett rakterek kiv√°laszt√°sa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Ide t√∂ltj√ºk az AJAX-szal a raktereket -->
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
/* Modal body: k√∂z√©pre rendez√©s */
#specificvehicleModal .modal-body {
    display: flex;
    flex-direction: column;   /* f√ºgg≈ëleges lista */
    align-items: center;      /* v√≠zszintesen k√∂z√©pre */
    gap: 15px;                /* kis t√°vols√°g a gombok k√∂z√∂tt */
    padding: 20px;
}

#specificvehicleModal .vehicle-list {
    width: 80%;
}

/* Vehicle gombok a modalban - konkr√©t modal szelektorral, fel√ºl√≠rja a Bootstrap-et */
#specificvehicleModal .vehicle-select-btn {
    width: 100% !important;               /* teljes sz√©less√©g */
    text-align: center !important;
    display: block !important;
    padding: 10px 0 !important;
    font-size: 16px !important;
    border-radius: 8px !important;
    border: 1px solid #333 !important;
    background-color: #eee !important;
    color: #000 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    margin: 0;
}

#specificvehicleModal .vehicle-select-btn.active {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #fff !important;
    margin:0;
}
/* Modal body: k√∂z√©pre rendez√©s */
#specificvehicleModal .modal-body {
    display: flex;
    flex-direction: column;   /* f√ºgg≈ëleges lista */
    align-items: center;      /* v√≠zszintesen k√∂z√©pre */
    gap: 15px;                /* kis t√°vols√°g a gombok k√∂z√∂tt */
    padding: 20px;
    margin:0;
}

#specificvehicleModal .vehicle-list {
    width: 80%;
}

/* Vehicle gombok a modalban - konkr√©t modal szelektorral, fel√ºl√≠rja a Bootstrap-et */
#specificvehicleModal .vehicle-select-btn {
    width: 100% !important;               /* teljes sz√©less√©g */
    text-align: center !important;
    display: block !important;
    padding: 10px 0 !important;
    font-size: 16px !important;
    border-radius: 8px !important;
    border: 1px solid #333 !important;
    background-color: #eee !important;
    color: #000 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

#specificvehicleModal .vehicle-select-btn.active, #specificvehicleModal .vehicle-select-btn.active:hover{
    background-color: #1d1d1d !important;
    border-color: #1d1d1d !important;
    color: #fff !important;
}

#specificvehicleModal .vehicle-select-btn:hover {
    background-color: #818181 !important;
    border-color: #818181 !important;
    color: #fff !important;
}

#vehicle-cancel-btn {
    border: 1px solid #ccc;
    color: #999;
    background-color: #fff;
}

#vehicle-select-confirm-btn:disabled {
    background-color: #ddd;
    border-color: #ccc;
    color: #999;
}

.sablon-wrapper {
    margin-top: 10px;
    width: 15vw;
    display: flex;
    flex-direction: column; /* egym√°s al√° */
    gap: 0.5em;             /* kis t√°vols√°g a checkboxok k√∂z√∂tt */
}

/* A label legyen flex, a checkmark mindig bal oldalon */
.custom-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    position: relative;
    font-size: 0.9em;
    user-select: none;
}

/* Eredeti checkbox elrejt√©se */
.custom-checkbox input[type="checkbox"] {
    display: none;
}

/* Saj√°t checkmark st√≠lus */
.custom-checkbox .checkmark {
    width: 25px;
    height: 25px;
    border: 2px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    position: relative;
    margin-right: 10px; /* sz√∂veg √©s checkmark k√∂zti t√°vols√°g */
}

/* Pipa megjelen√≠t√©se, ha checked */
.custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: "";
    position: absolute;
    left: 6px;
    top: 2px;
    width: 8px;
    height: 16px;
    border: solid #333;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}


@media (max-width: 1550px) {
    .vehicle-second-row {
        flex-direction: column;
    }

}

#destination-countries-section.inline-mode {
    margin: 0;
    padding: 0;
}

#destination-countries-section.inline-mode label {
    display: none; /* ne legyen c√≠m f√∂l√∂tte */
}

#destination-countries-section.inline-mode .multiselect {
    display: inline-block;
    width: 100%;
}

.autocomplete-wrapper.hidden {
    display: none !important;
}

.suggestions {
    display: none;
    position: relative;
    background: #fff;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.result-item {
    padding: 5px 10px;
    cursor: pointer;
}

.result-item:hover {
    background-color: #f0f0f0;
}

/* tal√°latok */
.search-results .result-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
}

.search-results .result-item:hover {
    background-color: #f0f0f0;
}


/* A sticky action oszlop ne takarja el a child tartalmat: adjunk alacsonyabb z-indexet neki */
.action-column-right {
    position: sticky;
    right: 0;
    z-index: 1; /* alacsonyabb, hogy a child (z-index 5) l√°tsz√≥djon f√∂l√∂tte */
    background: #fff;
}

/* DataTables √°ltal besz√∫rt child sor td-jeire √©s a wrapperre biztos h√°tt√©r √©s magasabb z-index */
table.dataTable tr.child td, .offer-child-wrapper {
    background: #fff;
    z-index: 5;
    padding: 10px;
    width: 100%;
}

.dataTables_wrapper .dataTables_filter {
    float: none !important;
    text-align: left !important;
    width: 10vw;
    margin-bottom: 10px;
}

td{
    min-width: 100px;
    max-width: 150px;
}

/* Form st√≠lus (k√©nyelmes sorban) */
.offer-form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
    width : 50%;
    position: sticky;
    left: 10px;
}

/* √öj sor: konkr√©t j√°rm≈± aj√°nl√°sa */
.offer-specific-row {
    width: 100%;
    text-align: center;
    margin-top: 10px;
}

.offer-specific-text {
    cursor: pointer;
    color: #007bff;
    font-weight: 600;
    font-size: 1.5em;
    text-decoration: underline;
}

.offer-form label { display: flex; flex-direction: column; font-size: 0.9em; }
.offer-form button { padding: 6px 10px; cursor: pointer; }

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.country-zip {
    font-weight: bold;
}

.city {
    font-size: 0.9em;
    color: #333;
}

.places{
    display: grid;
    grid-template-columns: 40% 7% 5% 40% 7%;
    grid-template-rows: auto;
    gap: 10px;
}

#origin {
  grid-column: 1 / 2; /* els≈ë oszlop */
}

#origin_diff {
  grid-column: 2 / 3;
    max-height: 40px;
}

#swap-btn {
  grid-column: 3 / 4;
    max-height: 50px;
}

#destination {
  grid-column: 4 / 5;
}

#destination_diff {
  grid-column: 5 / 6;
    max-height: 40px;
}

#available_from {
  grid-column: 1 / 3; /* m√°sodik sorban sz√©th√∫zva */
}
#available_until {
  grid-column: 4 / 6;
}

/* Input √©s select st√≠lus */
.freight-form input,
.freight-form select,
.freight-form textarea {
  width: 100%;
  padding: 6px 10px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s;
}
.flex-row {
    display: flex;
    flex-wrap: nowrap; /* mindig egy sor */
    gap: 5px; /* kis t√©rk√∂z */
}

.freight-form input:focus,
.freight-form select:focus,
.freight-form textarea:focus {
  outline: none;
  border-color: #007bff;
}

/* K√°rty√°k */
.cards-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.palette-card,
.oversize-card,
.loadtype-card,
.publiclicense-card {
  flex: 1;
  text-align: center;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  background: #fafafa;
  user-select: none;
}

/* Gomb */
.btn-wrapper button {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-wrapper button:hover {
  background: #0056b3;
}

#offer-submit-btn{
    padding: 0 8px;
    height:40px;
    margin-top: auto;
}

.palette-card:hover, .oversize-card:hover, .loadtype-card:hover, .publiclicense-card:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.palette-card.active, .oversize-card.active, .loadtype-card.active, .publiclicense-card.active {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
}

.cards-row img{
    width: 28px;
}

/* ---------- LAYOUT (49% / 49%) ---------- */

.vehicle-col {
  display: flex;
  justify-content: space-between;
  gap: 2%;
  flex-wrap: wrap; /* mobiln√°l egym√°s al√° tudjanak t√∂rni */
}

.vehicle-col label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 14px;
}

/* K√∂zvetlen√ºl a label + select p√°rokra */
.vehicle-col select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}

/* A k√©t blokk (label + select) 49%-os sz√©less√©ggel */
.vehicle-col > label,
.vehicle-col > select {
  width: 49%;
  box-sizing: border-box;
}

/* Multiselect is igazodjon a selectekhez (49‚Äì49%) */
.vehicle-col > .multiselect {
  width: 49%;
  box-sizing: border-box;
}

/* Mobilbar√°t t√∂r√©s */
@media (max-width: 700px) {
  .vehicle-col > .multiselect {
    width: 100%;
  }
}

/* Mobilbar√°t: kis kijelz≈ën egym√°s al√° esnek */
@media (max-width: 700px) {
  .vehicle-col > label,
  .vehicle-col > select {
    width: 100%;
  }
}

/* Mobilon legyen 100% */
@media (max-width: 700px) {
  .vehicle-col { width: 100%; }
}

/* ---------- MULTISELECT LOOK ---------- */
/* FONTOS: A .multiselect legyen pozicion√°l√°si referencia */
.multiselect {
  position: relative; /* ez lesz a referenciapont az absolute-hoz */
  display: inline-block;
  width: 100%; /* illeszkedjen a selectBox-hoz */
}

/* A leny√≠l√≥ (checkboxes) pontosan alatta ny√≠ljon meg */
.multiselect .checkboxes {
  position: absolute;
  top: 100%; /* k√∂zvetlen√ºl a selectBox al√° */
  left: 0;
  width: 100%; /* pont akkora, mint a selectBox */
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  margin-top: 4px;
  display: none;
  max-height: 200px;
  overflow-y: auto;
  z-index: 9999; /* biztos, hogy semmi ne takarja */
}

/* amikor l√°tszik */
.multiselect .checkboxes.active {
  display: block;
}

.selectBox {
  border: 1px solid #d0d7de;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  user-select: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(transparent, rgba(0,0,0,0.01));
  box-shadow: 0 1px 2px rgba(11,15,22,0.03);
}

/* Kijelzett sz√∂veg */
.selectBox span {
  display: inline-block;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: calc(100% - 24px);
}


/* ---------- K√ÅRTYAPANEL ---------- */
.cards-panel {
  position: absolute;
  width: 100%;
  z-index: 1200;
  margin-top: 8px;
  left: 0;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(11,15,22,0.08);
  padding: 12px;
  box-sizing: border-box;
  display: none;
}

/* Nyitott √°llapot */
.cards-panel.open { display: grid; }

/* default grid: 4 oszlop (equipmenthez) -- JS √°ll√≠tja a konkr√©t oszlopsz√°mot */
.cards-grid {
  display: grid;
  gap: 10px;
}

/* K√°rtya megjelen√©s */
.card-item {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #e6eef8;
  min-height: 46px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  cursor: pointer;
  font-size: 14px;
  background: linear-gradient(180deg, #ffffff, #fbfdff);
  transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
  user-select: none;
}

/* kiv√°lasztott k√°rtya */
.card-item.selected {
  border-color: #2b9af3;
  box-shadow: 0 6px 18px rgba(43,154,243,0.12);
  transform: translateY(-2px);
  background: linear-gradient(180deg, rgba(43,154,243,0.06), #ffffff);
  font-weight: 600;
}

/* kis meta sor, ha kell */
.card-item small { display:block; font-size:12px; opacity:.8; }

/* ha panel t√∫l magas: g√∂rgethet≈ë */
.cards-panel.scrollable {
  max-height: 320px;
  overflow: auto;
}

/* Felirat: ha semmi nincs kiv√°lasztva */
.select-placeholder { color: #6b7280; }

/* Kis kisz√°ll√≥ ikon ter√ºlet (‚ñº jel) */
.selectBox::after {
  margin-left: 8px;
  font-size: 12px;
  color: #6b7280;
}

/* √Åltal√°nos seg√©doszt√°lyok */
.hidden { display: none !important; }

.accordion-btn {
    width: 30%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    margin-bottom: 10px;
    transition: background 0.2s;
}

.accordion-btn:hover {
    background-color: #0056b3;
}

.accordion-content {
    display: none;
}

.btn-secondary, .btn-primary{
    margin: 0;
}

.btn-holder{
    position: sticky;
    bottom: 10px;
}

.modal-body{
    max-height: 75vh;
}

.vehicle-list{
    max-height: 65vh;
    overflow-y: auto;
}

.modal-footer{
    width: 100%;
    background-color: #fff;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Bootstrap 5 tooltip inicializ√°l√°s
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
})

document.getElementById('destination_diff').addEventListener('change', function() {
    const diffValue = this.value;
    const countriesSection = document.getElementById('destination-countries-section');
    const destinationWrapper = document.querySelector('#destination').closest('.autocomplete-wrapper');
    const parentContainer = destinationWrapper.parentElement;

    if (diffValue === 'any') {
        // --- ha +any km ---
        countriesSection.classList.remove('hidden');

        // rejts√ºk el az autocomplete inputot
        destinationWrapper.classList.add('hidden');

        // helyezz√ºk a countriesSection-t a hely√©re (k√∂zvetlen√ºl a destination hely√©re)
        if (!countriesSection.classList.contains('inline-mode')) {
            parentContainer.insertBefore(countriesSection, destinationWrapper.nextSibling);
            countriesSection.classList.add('inline-mode');
        }
    } else {
        // --- ha nem +any ---
        countriesSection.classList.add('hidden');
        destinationWrapper.classList.remove('hidden');

        // orsz√°gok kiv√°laszt√°s√°nak √ºr√≠t√©se
        const select = document.getElementById('destination_countries');
        Array.from(select.options).forEach(o => o.selected = false);
        updateSelectPlaceholder('destination_countries');
    }
});

function updateSelectPlaceholder(name) {
    const select = document.getElementById(name);
    const selected = Array.from(select.selectedOptions).map(o => o.text);
    const span = document.getElementById(name + '-selected');
    span.innerText = selected.length ? selected.join(', ') : 'V√°lassz orsz√°got';
}

const vehicleForm = document.getElementById("vehicleForm");

document.addEventListener("DOMContentLoaded", function() {
    const destinationDiff = document.getElementById("destination_diff");
    const countriesSection = document.getElementById("destination-countries-section");

    function toggleCountriesSection() {
        if (destinationDiff.value === "any") {
            countriesSection.classList.remove("hidden");
        } else {
            countriesSection.classList.add("hidden");
        }
    }

    destinationDiff.addEventListener("change", toggleCountriesSection);
    toggleCountriesSection(); // azonnal lefut bet√∂lt√©skor is
});

/**
 * Cs√∂kkenti a koordin√°t√°k sz√°m√°t az √∫tvonalon.
 * @param {Array} coords - [[lat, lon], [lat, lon], ...]
 * @param {number} maxPoints - maximum pontsz√°m
 * @returns {Array} cs√∂kkentett koordin√°t√°k
 */

function downsampleRoute(coords, maxPoints) {
    if (coords.length <= maxPoints) return coords;

    const step = Math.ceil(coords.length / maxPoints);
    const downsampled = [];
    for (let i = 0; i < coords.length; i += step) {
        downsampled.push(coords[i]);
    }
    // Mindig biztos√≠tjuk az utols√≥ pontot is
    if (downsampled[downsampled.length - 1] !== coords[coords.length - 1]) {
        downsampled.push(coords[coords.length - 1]);
    }
    return downsampled;
}

vehicleForm.addEventListener("submit", async function(e) {
    e.preventDefault(); // ne t√∂lts√∂n √∫jra az oldalt

    // --- Form mez≈ëk ---
    const originCity = document.getElementById("origin_city").value;
    const originZip = document.getElementById("origin_zip").value;
    const originCountry = document.getElementById("origin_country").value;

    const destinationDiff = document.getElementById("destination_diff").value;
    const selectedDestCountries = Array.from(document.getElementById("destination_countries").selectedOptions).map(o => o.value);

    const destCityInput = document.getElementById("destination_city").value;
    const destZipInput = document.getElementById("destination_zip").value;
    const destCountryInput = document.getElementById("destination_country").value;

    // --- Geocode lek√©r√©s backendr≈ël ---
    async function geocode(city, zip, country) {
        const url = `/cargo/geocode_location?city=${encodeURIComponent(city)}&postcode=${encodeURIComponent(zip)}&country=${encodeURIComponent(country)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Geocode hiba");
        return await res.json();
    }

    let originCoords, destCoords;
    try {
        // Origin koordin√°t√°k mindig lek√©rve
        originCoords = await geocode(originCity, originZip, originCountry);

        // --- ANY eset ---
        if (destinationDiff === "any") {
            // ha nincs megadva city, akkor automatikusan az origin √©rt√©keket haszn√°ljuk
            const destCity = originCity;
            const destZip = originZip;
            const destCountry = originCountry;

            destCoords = await geocode(destCity, destZip, destCountry);

            // hidden mez≈ëk friss√≠t√©se
            document.getElementById("destination_city").value = destCity;
            document.getElementById("destination_zip").value = destZip;
            document.getElementById("destination_country").value = destCountry;
            document.getElementById("destination_lat").value = destCoords.lat;
            document.getElementById("destination_lon").value = destCoords.lng;
        } 
        // --- Konkr√©t c√©l eset ---
        else if (destCityInput || destZipInput || destCountryInput) {
            const destCity = destCityInput || originCity;
            const destZip = destZipInput || originZip;
            const destCountry = destCountryInput || originCountry;

            destCoords = await geocode(destCity, destZip, destCountry);

            document.getElementById("destination_lat").value = destCoords.lat;
            document.getElementById("destination_lon").value = destCoords.lng;
        } 
        // --- Egy√©bk√©nt nincs c√©ladat ---
        else {
            document.getElementById("destination_lat").value = "";
            document.getElementById("destination_lon").value = "";
        }

        // mindig legyen origin koordin√°ta
        document.getElementById("origin_lat").value = originCoords.lat;
        document.getElementById("origin_lon").value = originCoords.lng;

    } catch (err) {
        console.error("Geocode hiba:", err);
        alert("Nem siker√ºlt lek√©rni a koordin√°t√°kat!");
        return;
    }

    // --- OSRM √∫tvonal lek√©r√©se (csak ha van c√©l koordin√°ta) ---
    let routeCoords = [];
    if(destCoords) {
        try {
            const osrmRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${originCoords.lng},${originCoords.lat};${destCoords.lng},${destCoords.lat}?overview=full&geometries=geojson`);
            const data = await osrmRes.json();
            if(data.routes && data.routes.length){
                routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            }
            routeCoords = downsampleRoute(routeCoords, 500);
        } catch(err){
            console.error("OSRM hiba:", err);
        }
    }

    document.getElementById("routeCoordsInput").value = JSON.stringify(routeCoords);

    // --- JSON mez≈ë l√©trehoz√°sa a kiv√°lasztott orsz√°gokhoz ---
    const countriesInput = document.createElement("input");
    countriesInput.type = "hidden";
    countriesInput.name = "selected_dest_countries";
    countriesInput.value = JSON.stringify(selectedDestCountries);
    vehicleForm.appendChild(countriesInput);

    // --- Form submit ---
    vehicleForm.submit();
});

// DataTables inicializ√°l√°s √©s kezel√©se
$(document).ready(function() {
    var table;
    if (! $.fn.DataTable.isDataTable('#shipmentsTable')) {
        table = $('#shipmentsTable').DataTable({
            dom: '<"top"f>rt<"bottom"lip>',
            "order": [[14, "desc"], [0, "asc"]],
            "pageLength": 25,
            // scrollX: true,
            // "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 13 }]
        });
    } else {
        table = $('#shipmentsTable').DataTable(); // l√©tez≈ë p√©ld√°nyt haszn√°ljuk
    }

    // Offer gomb click (child row)
    $(document).on('click', 'button.offer-btn', function(e) {
        e.stopPropagation();

        var tr = $(this).closest('tr');
        var row = table.row(tr);
        const cargoId = tr.data('cargo-id');

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
            return;
        }

        // minden child row bez√°r√°sa el≈ëtte
        table.rows().every(function() {
            if (this.child.isShown()) this.child.hide();
            $(this.node()).removeClass('shown');
        });

        const formHtml = `
            <div class="offer-child-wrapper">
                <form class="offer-form">
                    <input type="hidden" name="cargo_id" value="${cargoId}">

                    <!-- 1. sor: standard inputok -->
                    <label>Felv√©t d√°tuma: <input type="date" name="pickup_date" required></label>
                    <label>Let√©t d√°tuma: <input type="date" name="delivery_date" required></label>
                    <label>√År: <input type="number" name="price" step="1" required></label>
                    <label>Valuta:
                        <select name="currency">
                            <option value="eur">‚Ç¨</option>
                            <option value="huf">Ft</option>
                        </select>
                    </label>
                    <label>Megjegyz√©s: <input type="text" name="note" maxlength="50"></label>
                    <button type="submit" id="offer-submit-btn">K√ºld√©s</button>

                    <!-- 2. sor: konkr√©t j√°rm≈± aj√°nl√°sa -->
                    <div class="offer-specific-row">
                        <span class="offer-specific-text" data-cargo-id="${cargoId}">
                            Konkr√©t j√°rm≈± aj√°nl√°sa
                        </span>
                    </div>
                </form>
            </div>
        `;

        row.child(formHtml).show();
        tr.addClass('shown');
    });

    // üî∏ Glob√°lis v√°ltoz√≥
    let selectedVehicleId = null;

    // Kattint√°s a "Konkr√©t j√°rm≈± aj√°nl√°sa" sz√∂vegre
    $(document).on('click', '.offer-specific-text', function() {
        const cargoId = $(this).data('cargo-id');

        $.get(`/cargo/specific_vehicles/${cargoId}`, function(html) {
            $('#specificvehicleModal .modal-body').html(html);

            const modalEl = document.getElementById('specificvehicleModal');
            const myModal = new bootstrap.Modal(modalEl);

            // üîπ Ellen≈ërizz√ºk, van-e m√°r kiv√°lasztott j√°rm≈±
            const $form = $(`form.offer-form input[name="cargo_id"][value="${cargoId}"]`).closest('form');
            const existingVehicleId = $form.find('input[name="vehicle_id"]').val();

            // Mindent alaphelyzetbe √°ll√≠tunk
            $('#specificvehicleModal .vehicle-select-btn')
                .removeClass('active btn-primary')
                .addClass('btn-outline-primary');

            if (existingVehicleId) {
                // Jel√∂lj√ºk ki a modalban is
                $('#specificvehicleModal .vehicle-select-btn').each(function() {
                    if (String($(this).data('vehicle-id')) === String(existingVehicleId)) {
                        $(this).addClass('active btn-primary').removeClass('btn-outline-primary');
                    }
                });

                // üîπ FONTOS: friss√≠tj√ºk a glob√°lis v√°ltoz√≥t is!
                selectedVehicleId = String(existingVehicleId);

                $('#vehicle-select-toggle-btn')
                    .text('Kiv√°laszt√°s')
                    .removeClass('btn-secondary')
                    .addClass('btn-primary');
            } else {
                selectedVehicleId = null;
                $('#vehicle-select-toggle-btn')
                    .text('M√©gse')
                    .removeClass('btn-primary')
                    .addClass('btn-secondary');
            }

            myModal.show();
        });
    });

    // Kattint√°s egy j√°rm≈±re
    $(document).on('click', '.vehicle-select-btn', function() {
        const clickedId = String($(this).data('vehicle-id')); // üëâ mindig stringk√©nt kezelj√ºk!

        if (selectedVehicleId === clickedId) {
            // Ugyanaz: t√∂r√∂lj√ºk a kijel√∂l√©st
            selectedVehicleId = null;
            $(this).removeClass('active btn-primary').addClass('btn-outline-primary');

            $('#vehicle-select-toggle-btn')
                .text('M√©gse')
                .removeClass('btn-primary')
                .addClass('btn-secondary');
        } else {
            // √öj j√°rm≈± kiv√°laszt√°sa
            $('.vehicle-select-btn').removeClass('active btn-primary').addClass('btn-outline-primary');
            $(this).addClass('active btn-primary').removeClass('btn-outline-primary');

            selectedVehicleId = clickedId;

            $('#vehicle-select-toggle-btn')
                .text('Kiv√°laszt√°s')
                .removeClass('btn-secondary')
                .addClass('btn-primary');
        }
    });

    // Gomb click: kiv√°laszt√°s vagy m√©gse
    $(document).on('click', '#vehicle-select-toggle-btn', function() {
        const $btn = $(this);
        const modalEl = document.getElementById('specificvehicleModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);

        if (selectedVehicleId) {
            // 1Ô∏è‚É£ Keresd meg az aktu√°lis offer formot
            const $activeBtn = $('.vehicle-select-btn.active');
            const cargoId = $activeBtn.data('cargo-id');
            const vehicleName = $activeBtn.data('vehicle-name');
            const vehicleType = $activeBtn.data('vehicle-type');

            const $form = $(`form.offer-form input[name="cargo_id"][value="${cargoId}"]`).closest('form');

            // 2Ô∏è‚É£ Hidden input l√©trehoz√°sa, ha kell
            let $hidden = $form.find('input[name="vehicle_id"]');
            if ($hidden.length === 0) {
                $hidden = $('<input type="hidden" name="vehicle_id">');
                $form.append($hidden);
            }

            // 3Ô∏è‚É£ Be√°ll√≠tjuk a j√°rm≈± ID-t
            $hidden.val(selectedVehicleId);

            // 4Ô∏è‚É£ Formon vizu√°lis jelz√©s
            if (vehicleName !== '') {
                $form.find('.offer-specific-text').text(`Kiv√°lasztott j√°rm≈±: ${vehicleName} (${vehicleType})`);
            } else{
                $form.find('.offer-specific-text').text(`Kiv√°lasztott j√°rm≈±: ${vehicleType}`);
            }
        }

        // Modal bez√°r√°sa
        modalInstance.hide();

        // Reset
        selectedVehicleId = null;
        $('#vehicle-select-toggle-btn')
            .text('M√©gse')
            .removeClass('btn-primary')
            .addClass('btn-secondary');

        $('.vehicle-select-btn').removeClass('active btn-primary').addClass('btn-outline-primary');
    });


    // Offer form submit
    $('#shipmentsTable').on('submit', '.offer-form', function(e) {
        e.preventDefault();
        const $form = $(this);
        const data = $form.serialize();  // <-- vehicle_id automatikusan benne lesz

        $.post('/cargo/offer', data)
            .done(function(response) {
                alert('Aj√°nlat elk√ºldve!');
                $form.closest('.offer-child-wrapper').remove();
            })
            .fail(function(xhr) {
                alert('Hiba: ' + (xhr.responseJSON?.message || 'Ismeretlen hiba'));
            });

        table.rows().every(function() {
            if (this.child.isShown()) this.child.hide();
            $(this.node()).removeClass('shown');
        });
    });

    // Child row-ok bez√°r√°sa √∫jrarenderkor
    table.on('draw', function() {
        table.rows().every(function() {
            if (this.child && this.child.isShown && this.child.isShown()) {
                this.child.hide();
            }
        });
        $('#shipmentsTable tbody tr').removeClass('shown');
    });
});

// SWAP BUTTON
document.addEventListener("DOMContentLoaded", function () {
    const swapBtn = document.getElementById("swap-btn");
    const originInput = document.getElementById("origin");
    const destinationInput = document.getElementById("destination");

    if (!swapBtn) return;

    swapBtn.addEventListener("click", function (e) {
        e.preventDefault();

        if (!originInput || !destinationInput) return;

        // Csere
        const tmp = originInput.value;
        originInput.value = destinationInput.value;
        destinationInput.value = tmp;

        // Trigger input √©s change minden autocomplete pluginnek
        ['input', 'change'].forEach(eventType => {
            originInput.dispatchEvent(new Event(eventType, { bubbles: true }));
            destinationInput.dispatchEvent(new Event(eventType, { bubbles: true }));
        });
    }, false);
});

// Oversize √©s paletta k√°rty√°k
document.addEventListener("DOMContentLoaded", () => {
    // ========== Paletta √©s t√∫lm√©retes k√°rty√°k ==========
    const paletteCard = document.getElementById("paletteCard");
    const oversizeCard = document.getElementById("oversizeCard");
    const paletteInput = document.getElementById("palette_exch");
    const oversizeInput = document.getElementById("oversize");
    const loadtypeCard = document.getElementById("loadtypeCard");
    const loadtypeInput = document.getElementById("load_type");
    const publicLicenseCard = document.getElementById("publicLicenseCard");
    const publiclicenseInput = document.getElementById("public_license");

    if (paletteCard) {
        paletteCard.addEventListener("click", () => {
            paletteCard.classList.toggle("active");
            paletteInput.value = paletteCard.classList.contains("active");
        });
    }

    if (oversizeCard) {
        oversizeCard.addEventListener("click", () => {
            oversizeCard.classList.toggle("active");
            oversizeInput.value = oversizeCard.classList.contains("active");
        });
    }

    if (loadtypeCard) {
        loadtypeCard.addEventListener("click", () => {
            loadtypeCard.classList.toggle("active");
            loadtypeInput.value = loadtypeCard.classList.contains("active");
        });
    }

    if (publicLicenseCard) {
        publicLicenseCard.addEventListener("click", () => {
            publicLicenseCard.classList.toggle("active");
            publiclicenseInput.value = publicLicenseCard.classList.contains("active");
        });
    }
});

// t√©rk√©p √∫jrat√∂lt√©s m√≥dos√≠t√°sn√°l
$('#cargoModal').on('shown.bs.modal', function () {
    // Ha volt kor√°bbi t√©rk√©p, t√°vol√≠tsuk el teljesen (elegend≈ë √∫jrak√©sz√≠t√©shez)
    if (window.currentMap) {
        try {
            window.currentMap.remove(); // elt√°vol√≠tja a DOM-t √©s esem√©nyeket
        } catch (e) {
            console.warn('Kor√°bbi map elt√°vol√≠t√°sa sikertelen:', e);
        }
        window.currentMap = null;
    }

    // Ellen≈ërizz√ºk, hogy a modal tartalma t√©nyleg tartalmazza-e a map div-et
    var mapEl = document.getElementById('map');
    if (!mapEl) {
        console.warn('Nincs #map eleme a modal tartalm√°nak. A r√©szletek HTML-je lehet, hogy nem t√∂lt≈ëd√∂tt be id≈ëben.');
        return;
    }

    // Alapn√©zet: eg√©sz Eur√≥pa (k√∂z√©ppont ~ k√∂z√©p-eur√≥pa, zoom 4)
    window.currentMap = L.map('map', { preferCanvas: true }).setView([54.0, 15.0], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(window.currentMap);

    // Olvassuk be a JSON blokkokat a modalb√≥l
    var pickups = [];
    var dropoffs = [];
    try {
        var pEl = document.getElementById("pickups-data");
        var dEl = document.getElementById("dropoffs-data");
        if (pEl) pickups = JSON.parse(pEl.textContent || "[]");
        if (dEl) dropoffs = JSON.parse(dEl.textContent || "[]");
        console.log('cargoModal: parsed pickups/dropoffs JSON');
        console.log('  pickups:', pickups);
        console.log('  dropoffs:', dropoffs);
    } catch (e) {
        console.error('Hiba a pick/ drop JSON parsing sor√°n:', e);
    }

    // K√©t sz√≠n: felrak√≥k (loading) = z√∂ld, lerak√≥k (unloading) = piros
    var pickupColor = '#2ca25f';   // z√∂ld
    var dropoffColor = '#d73027';  // piros

    // LayerGroup-ek, hogy k√∂nny≈± legyen kezelni / t√∂r√∂lni ≈ëket, vagy k√©s≈ëbb ki-/bekapcsolni
    var pickupsLayer = L.layerGroup().addTo(window.currentMap);
    var dropoffsLayer = L.layerGroup().addTo(window.currentMap);
    window.pickupsLayer = pickupsLayer;
    window.dropoffsLayer = dropoffsLayer;

    // Seg√©d: valid koordin√°ta-e?
    function validCoord(lat, lng) {
        return typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng) && !(lat === 0 && lng === 0);
    }

    // Haversine distance in kilometers between two lat/lng points
    function haversineKm(lat1, lon1, lat2, lon2) {
        function toRad(v) { return v * Math.PI / 180; }
        var R = 6371; // Earth radius km
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Remove previous route layers if present
    function clearRoute() {
        if (window.routeLine) {
            try { window.currentMap.removeLayer(window.routeLine); } catch (e) {}
            window.routeLine = null;
        }
        if (window.pickupsLayer) {
            try { window.currentMap.removeLayer(window.pickupsLayer); } catch (e) {}
            window.pickupsLayer = null;
        }
        if (window.dropoffsLayer) {
            try { window.currentMap.removeLayer(window.dropoffsLayer); } catch (e) {}
            window.dropoffsLayer = null;
        }
    }

    var allCoords = [];
        pickups.forEach(function(p) {
            try {
                var lat = Number(p.lat);
                var lng = Number(p.lng);
                console.log('pickup entry:', p, '-> parsed lat/lng:', lat, lng);
                if (!validCoord(lat, lng)) {
                        console.warn('Skipping pickup with invalid coords', {lat: lat, lng: lng, entry: p});
                        return;
                }
                var m = L.circleMarker([lat, lng], {
                     radius: 7,
                     color: '#000',          // k√∂rvonal
                     weight: 1,
                     fillOpacity: 0.9,
                     fillColor: pickupColor
                }).bindPopup("<b>Felrak√≥</b><br>" + (p.city || p.masked_city || ''));
                console.log('Adding pickup marker at', lat, lng);
                pickupsLayer.addLayer(m);
                allCoords.push([lat, lng]);
            } catch (e) {
                console.error('Error processing pickup entry', p, e);
            }
        });

        dropoffs.forEach(function(p) {
            try {
                var lat = Number(p.lat);
                var lng = Number(p.lng);
                console.log('dropoff entry:', p, '-> parsed lat/lng:', lat, lng);
                if (!validCoord(lat, lng)) {
                        console.warn('Skipping dropoff with invalid coords', {lat: lat, lng: lng, entry: p});
                        return;
                }
                var m = L.circleMarker([lat, lng], {
                     radius: 7,
                     color: '#000',
                     weight: 1,
                     fillOpacity: 0.9,
                     fillColor: dropoffColor
                }).bindPopup("<b>Lerak√≥</b><br>" + (p.city || p.masked_city || ''));
                console.log('Adding dropoff marker at', lat, lng);
                dropoffsLayer.addLayer(m);
                allCoords.push([lat, lng]);
            } catch (e) {
                console.error('Error processing dropoff entry', p, e);
            }
        });

    // Ha vannak koordin√°t√°k, igaz√≠tsuk a n√©zetet r√°juk; k√ºl√∂nben marad Europe view
    console.log('All coords collected for map:', allCoords);
    console.log('Number of coords:', allCoords.length);
    // Draw route: order pickups then dropoffs
    var routeCoords = [];
    pickups.forEach(function(p) { var lat=Number(p.lat); var lng=Number(p.lng); if(validCoord(lat,lng)) routeCoords.push([lat,lng]); });
    dropoffs.forEach(function(p) { var lat=Number(p.lat); var lng=Number(p.lng); if(validCoord(lat,lng)) routeCoords.push([lat,lng]); });

    function fallbackToHaversineAndDraw() {
        if (window.routeLine) { try { window.currentMap.removeLayer(window.routeLine); } catch(e){} }
        window.routeLine = L.polyline(routeCoords, {color: '#3388ff', weight: 3, opacity: 0.8}).addTo(window.currentMap);
        // compute distance via haversine
        var totalKm = 0;
        for (var i=0;i<routeCoords.length-1;i++) {
            totalKm += haversineKm(routeCoords[i][0], routeCoords[i][1], routeCoords[i+1][0], routeCoords[i+1][1]);
        }
        var avgSpeedKmh = 60;
        var hours = totalKm / avgSpeedKmh;
        var etaHours = Math.floor(hours);
        var etaMins = Math.round((hours - etaHours) * 60);
        var etaStr = etaHours + 'h ' + etaMins + 'm';
        var infoEl = document.getElementById('route-info');
        if (infoEl) infoEl.textContent = 'T√°vols√°g: ' + totalKm.toFixed(1) + ' km ¬∑ Becs√ºlt utaz√°si id≈ë: ' + etaStr + ' (k√∂z√∫ti becsl√©s hi√°ny√°ban Haversine)';
        // adjust view
        try { window.currentMap.fitBounds(window.routeLine.getBounds(), { padding: [30,30] }); } catch(e) { console.warn('fitBounds failed for haversine route', e); }
    }

    if (routeCoords.length >= 2) {
        // Try OSRM routing first (free public server). Build lon,lat;... list
        try {
            var coordPairs = routeCoords.map(function(c) { return c[1] + ',' + c[0]; }).join(';');
            var osrmUrl = 'https://router.project-osrm.org/route/v1/driving/' + coordPairs + '?overview=full&geometries=geojson';
            fetch(osrmUrl).then(function(resp){ return resp.json(); }).then(function(osrmData){
                if (osrmData && osrmData.routes && osrmData.routes.length) {
                    var r = osrmData.routes[0];
                    var coords = r.geometry.coordinates.map(function(c){ return [c[1], c[0]]; });
                    if (window.routeLine) { try { window.currentMap.removeLayer(window.routeLine); } catch(e){} }
                    window.routeLine = L.polyline(coords, {color: '#3388ff', weight: 3, opacity: 0.9}).addTo(window.currentMap);
                    // use OSRM distance/duration (meters, seconds)
                    var totalKm = (r.distance || 0) / 1000.0;
                    var durationSec = r.duration || 0;
                    var hours = Math.floor(durationSec / 3600);
                    var mins = Math.round((durationSec - hours*3600) / 60);
                    var etaStr = hours + 'h ' + mins + 'm';
                    var infoEl = document.getElementById('route-info');
                    if (infoEl) infoEl.textContent = '√ötvonal t√°vols√°g: ' + totalKm.toFixed(1) + ' km ¬∑ Becs√ºlt utaz√°si id≈ë: ' + etaStr + ' (OSRM)';
                    try { window.currentMap.fitBounds(window.routeLine.getBounds(), { padding: [30,30] }); } catch(e) { console.warn('fitBounds failed for OSRM route', e); }
                } else {
                    console.warn('OSRM returned no route, falling back');
                    fallbackToHaversineAndDraw();
                }
            }).catch(function(err){
                console.warn('OSRM request failed, falling back', err);
                fallbackToHaversineAndDraw();
            });
        } catch (ex) {
            console.warn('Error building OSRM request, falling back', ex);
            fallbackToHaversineAndDraw();
        }
    }
});

// Rakom√°ny sor kattint√°s ‚Äì modal megnyit√°s AJAX-szal
document.addEventListener("DOMContentLoaded", function() {
    // Sor kattint√°s
     document.querySelectorAll(".cargo-row").forEach(function(row) {
        row.addEventListener("click", function(e) {
            let cargoId = this.dataset.cargoId;

            if ($(e.target).closest('.action-column-right').length) {
                return; // kil√©p√ºnk, modal nem ny√≠lik
            }

            // Lek√©r√©s Flask v√©gpontr√≥l
            fetch(`/cargo/${cargoId}/details`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById("cargoDetails").innerHTML = html;

                    // Bootstrap modal el≈ëh√≠v√°sa
                    var myModal = new bootstrap.Modal(document.getElementById('cargoModal'));
                    myModal.show();
                });
        });
    });
});

// k√°rty√°s multiselect
(function(){
  const PLACEHOLDERS = {
    equipment: 'V√°lassz felszerelts√©get',
    securement: 'V√°lassz rakom√°nyr√∂gz√≠t√©st',
    destination_countries: 'V√°lassz orsz√°got'
  };

  window.toggleCheckboxes = function(name) {
    let panel = document.getElementById(name + '-panel');
    if (!panel) {
      panel = createPanelFromSelect(name);
    }
    if (!panel) return;

    panel.classList.toggle('open');

    if (panel.classList.contains('open')) {
      const first = panel.querySelector('.card-item');
      if (first) first.focus();
    }
  };

  function createPanelFromSelect(name) {
    let selectEl = document.getElementById(name);
    let panel = document.getElementById(name + '-panel');
    if (panel) return panel;
    if (!selectEl) return null;

    const multiselect = selectEl.closest('.multiselect') || selectEl.previousElementSibling?.closest('.multiselect') || selectEl.parentElement;
    if (!multiselect) return null;

    panel = document.createElement('div');
    panel.className = 'cards-panel';
    panel.id = name + '-panel';

    const grid = document.createElement('div');
    grid.className = 'cards-grid';
    let cols = name === 'securement' ? 3 : 4;
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    Array.from(selectEl.options).forEach((opt, idx) => {
        const card = document.createElement('div');
        card.className = 'card-item';
        card.tabIndex = 0;
        card.dataset.value = opt.value;
        card.dataset.index = idx;
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'center'; // k√∂z√©pre igaz√≠t√°s v√≠zszintesen
        card.style.justifyContent = 'center'; // k√∂z√©pre f√ºgg≈ëlegesen (ha kell)

        if (opt.selected) card.classList.add('selected');

        // Orsz√°g neve
        const span = document.createElement('span');
        span.textContent = opt.text;
        span.style.display = 'block';
        span.style.textAlign = 'center';
        span.style.marginBottom = '5px';

        // Z√°szl√≥ csak destination_countries eset√©n
        if (name === 'destination_countries') {
            const flagCode = opt.dataset.flag || opt.value;
            const img = document.createElement('img');
            img.src = `/static/images/flags/${flagCode}.png`;
            img.alt = opt.text;
            img.style.display = 'block';
            img.style.margin = '0 auto';
            img.style.width = '28px';
            img.style.height = 'auto';
            card.appendChild(img);
        }

        card.appendChild(span);

        card.addEventListener('click', () => toggleOption(selectEl, opt, card));
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleOption(selectEl, opt, card);
            }
        });

        grid.appendChild(card);
    });

    if (selectEl.options.length > cols * cols) panel.classList.add('scrollable');

    panel.appendChild(grid);
    multiselect.appendChild(panel);

    refreshSelectedText(name);
    return panel;
  }

    function toggleOption(selectEl, optEl, cardEl) {
        const wasSelected = optEl.selected;
        optEl.selected = !wasSelected;
        cardEl.classList.toggle('selected', optEl.selected);

        // Trigger change event a selectn√©l
        const ev = new Event('change', { bubbles: true });
        selectEl.dispatchEvent(ev);

        refreshSelectedText(selectEl.id);

        // --- Hidden input friss√≠t√©se csak +any eset√©n ---
        if (selectEl.id === 'destination_countries') {
            const destinationDiff = document.getElementById('destination_diff').value;
            if (destinationDiff === 'any') {
                const hiddenInput = document.getElementById('destination_country');
                // Ha van kiv√°lasztott elem, a hidden inputba csak az els≈ë k√≥dot √≠rjuk (vagy tetsz≈ëleges logika)
                const selectedOpts = Array.from(selectEl.selectedOptions).map(o => o.value);
                hiddenInput.value = selectedOpts.length ? selectedOpts.join(',') : '';
            }
        }
    }


  function refreshSelectedText(name) {
    const span = document.getElementById(name + '-selected');
    const select = document.getElementById(name);
    if (!span || !select) return;

    const selected = Array.from(select.selectedOptions).map(o => o.text);
    if (selected.length === 0) {
      span.textContent = PLACEHOLDERS[name] || 'V√°lassz';
      span.classList.add('select-placeholder');
    } else if (selected.length <= 3) {
      span.textContent = selected.join(', ');
      span.classList.remove('select-placeholder');
    } else {
      span.textContent = `${selected.length} kiv√°lasztva`;
      span.classList.remove('select-placeholder');
    }
  }

  document.addEventListener('click', function(event) {
    const openPanels = document.querySelectorAll('.cards-panel.open');
    openPanels.forEach(panel => {
      const multiselect = panel.closest('.multiselect');
      if (!multiselect) return;
      if (!multiselect.contains(event.target)) {
        panel.classList.remove('open');
      }
    });
  });

  document.addEventListener('change', function(e){
    const el = e.target;
    if (el && el.tagName === 'SELECT' && el.multiple) {
      const panel = document.getElementById(el.id + '-panel');
      if (!panel) return;
      const cards = panel.querySelectorAll('.card-item');
      cards.forEach(card => {
        const val = card.dataset.value;
        const opt = Array.from(el.options).find(o => o.value === val);
        if (opt) card.classList.toggle('selected', opt.selected);
      });
      refreshSelectedText(el.id);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
        fetch('/vehicles/api/eu-countries')
            .then(res => res.json())
            .then(countries => {
                const select = document.getElementById('destination_countries');
                countries.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code;
                    opt.textContent = c.name;
                    opt.dataset.flag = c.code; // z√°szl√≥ k√≥d
                    select.appendChild(opt);
                });

                // L√©trehozzuk a panelt
                createPanelFromSelect('destination_countries');
            })
            .catch(err => console.error("Hiba EU orsz√°gok bet√∂lt√©s√©n√©l:", err));

        // Friss√≠tj√ºk a feliratokat
        ['equipment','securement','destination_countries'].forEach(name => refreshSelectedText(name));
    });
})();

// d√°tum mez≈ëk
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('available_from');
    if (dateInput) {
        const today = new Date(); // mai d√°tum
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0'); // h√≥nap 0-t√≥l van
        const day = String(today.getDate()).padStart(2, '0');

        dateInput.value = `${year}-${month}-${day}`; // be√°ll√≠tjuk a mez≈ë √©rt√©k√©t
    }
});

// accordion
document.addEventListener('DOMContentLoaded', function() {
    const accordionBtn = document.querySelector('.accordion-btn');
    const accordionContent = document.querySelector('.accordion-content');

    if (accordionBtn && accordionContent) {
        accordionBtn.addEventListener('click', function() {
            if (accordionContent.style.display === 'block') {
                accordionContent.style.display = 'none';
                accordionBtn.textContent = 'Rakt√©r felt√∂lt√©se / rakom√°ny keres√©se ‚ñº';
            } else {
                accordionContent.style.display = 'block';
                accordionBtn.textContent = 'Rakt√©r felt√∂lt√©se / rakom√°ny keres√©se ‚ñ≤';
            }
        });
    }
});

$(document).ready(function() {
    let searchTimer;
    const apiUrl = "/cargo/ajax/city_search";

    // Deleg√°lt input esem√©ny minden autocomplete-wrapper inputj√°ra
    $(document).on("input", "#origin, #destination", function() {
        const $input = $(this);
        const query = $input.val().trim();
        const $results = $input.siblings(".suggestions");

        clearTimeout(searchTimer);
        $results.empty().hide();

        if(query.length < 2) return;

        searchTimer = setTimeout(() => {
            const terms = query.split(" ").filter(t => t.length > 0);

            $.get(apiUrl, { q: query }, function(data) {
                $results.empty();

                if(!data.length) return;

                data.forEach(item => {
                    let matched = false;
                    for(const term of terms) {
                        if(/^\d+$/.test(term)) {
                            matched = item.zipcode && item.zipcode.includes(term);
                        } else if(term.length === 2) {
                            matched = item.country_code && item.country_code.toLowerCase().includes(term.toLowerCase());
                        } else {
                            matched = item.city_name.toLowerCase().includes(term.toLowerCase());
                        }
                        if(!matched) break;
                    }

                    if(matched) {
                        const text = `${item.city_name}, ${item.country_code} (${item.zipcode}) `;
                        const $li = $('<div class="result-item"></div>').text(text).data({
                            city: item.city_name,
                            zipcode: item.zipcode,
                            country: item.country_code
                        });
                        $results.append($li);
                    }
                });

                if($results.children().length) $results.show();
            });
        }, 300);
    });

    // Click esem√©ny a tal√°latokra
    $(document).on("click", ".result-item", function() {
        const $li = $(this);
        const $input = $li.closest(".autocomplete-wrapper").find("input[type=text]");
        const fieldset = $input.closest(".autocomplete-wrapper");

        $input.val($li.text());

        // Hidden mez≈ëk kit√∂lt√©se
        fieldset.find("input[type=hidden][id$='_city']").val($li.data("city"));
        fieldset.find("input[type=hidden][id$='_zip']").val($li.data("zipcode"));
        fieldset.find("input[type=hidden][id$='_country']").val($li.data("country"));

        $li.parent().empty().hide();
    });

    // Blur esem√©ny a tal√°lati lista bez√°r√°s√°hoz
    $(document).on("blur", "#origin, #destination", function() {
        const $results = $(this).siblings(".suggestions");
        setTimeout(() => $results.hide(), 200);
    });

    // --- Vehicle sablon bet√∂lt√©s ---
    const templateSelect = document.getElementById('vehicle_template_select');
    const paletteCard = document.getElementById('paletteCard');
    const oversizeCard = document.getElementById('oversizeCard');
    const loadtypeCard = document.getElementById('loadtypeCard');
    const publicLicenseCard = document.getElementById('publicLicenseCard');

    templateSelect.addEventListener('change', async function() {
        const templateId = this.value;
        if (!templateId) return;

        try {
            const res = await fetch(`/vehicles/template/${templateId}`);
            const data = await res.json();

            if (!data.success) {
                alert('Hiba: ' + data.error);
                return;
            }

            const t = data.template;
            console.log('[DEBUG] Bet√∂lt√∂tt sablon:', t);

            // Egyszer≈± mez≈ëk
            const simpleFields = ['vehicle_type', 'structure', 'capacity_t', 'volume_m3', 'price', 'currency', 'description'];
            simpleFields.forEach(f => {
                const el = document.getElementById(f);
                if (el) el.value = t[f] ?? '';
            });

            // V√°rosok automatikus kiv√°laszt√°sa
            await fillCityFromTemplate('origin', t.origin_city, t.origin_country, t.origin_postcode);
            await fillCityFromTemplate('destination', t.destination_city, t.destination_country, t.destination_postcode);

            // Kapcsol√≥ gombok
            setActive(paletteCard, 'palette_exch', t.palette_exchange);
            setActive(oversizeCard, 'oversize', t.oversize);
            setActive(loadtypeCard, 'load_type', t.load_type === 'LTL');
            setActive(publicLicenseCard, 'public_license', t.public_license);

            // Multiselectek
            setMultiselect('equipment', t.equipment);
            setMultiselect('securement', t.cargo_securement);

        } catch (err) {
            console.error('Hiba a sablon bet√∂lt√©sekor:', err);
            alert('Nem siker√ºlt bet√∂lteni a sablont.');
        }
    });

    function setActive(cardEl, hiddenId, active) {
        const hidden = document.getElementById(hiddenId);
        if (active) {
            cardEl.classList.add('active');
            hidden.value = 'true';
        } else {
            cardEl.classList.remove('active');
            hidden.value = 'false';
        }
    }

    function setMultiselect(type, valueStr) {
        const selected = valueStr ? valueStr.split(',').map(v => v.trim()) : [];
        const checkboxes = document.querySelectorAll(`#${type}-checkboxes input[type="checkbox"]`);
        const displaySpan = document.getElementById(`${type}-selected`);
        const hiddenSelect = document.getElementById(type);

        let selectedLabels = [];

        checkboxes.forEach(cb => {
            cb.checked = selected.includes(cb.value);
            if (cb.checked) selectedLabels.push(cb.value);
        });

        if (displaySpan) {
            displaySpan.textContent = selectedLabels.length
                ? selectedLabels.join(', ')
                : (type === 'equipment' ? 'V√°lassz felszerelts√©get' : 'V√°lassz rakom√°nyr√∂gz√≠t√©st');
        }

        if (hiddenSelect) {
            [...hiddenSelect.options].forEach(opt => {
                opt.selected = selected.includes(opt.value);
            });
        }
    }

    // --- V√°rosmez≈ë automatikus kiv√°laszt√°sa sablonb√≥l ---
    async function fillCityFromTemplate(type, city, countryCode, postcode) {
        return new Promise((resolve) => {
            if (!city) return resolve();

            const input = document.getElementById(type);
            const $results = $(input).siblings(".suggestions");
            if (!input || !$results.length) return resolve();

            // 1Ô∏è‚É£ Be√≠rjuk az inputba a v√°ros adatokat
            input.value = `${countryCode || ''} ${postcode || ''} ${city}`.trim();

            // 2Ô∏è‚É£ Triggerelj√ºk az input esem√©nyt, hogy az autocomplete lefusson
            $(input).trigger('input');

            // 3Ô∏è‚É£ V√°runk max. 2 m√°sodpercet, √©s ha megjelenik a tal√°lat, kattintunk az els≈ëre
            let tries = 0;
            const maxTries = 20; // 20*100ms = 2s
            const interval = setInterval(() => {
                const $first = $results.children().first();
                if ($first.length) {
                    $first.click();
                    clearInterval(interval);
                    console.log(`[DEBUG] Autocomplete kiv√°lasztva: ${$first.text()}`);
                    resolve();
                } else if (tries++ >= maxTries) {
                    clearInterval(interval);
                    console.warn(`[DEBUG] Nincs tal√°lat (timeout): ${city}`);
                    resolve();
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}
