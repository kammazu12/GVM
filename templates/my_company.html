<!-- templates/company_profile.html -->
{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>

    <main class="main-content">
        <!-- C√≠m -->
        <h1 class="company-title">{{ company.name }}</h1>

        <!-- Log√≥ √©s adatok -->
        <div class="company-header">
            <div class="company-logo-container" style="position: relative; display: inline-block;">
                <img id="company-logo"
                     src="{{ url_for('static', filename='uploads/company_logos/' + company.logo_filename) if company.logo_filename else url_for('static', filename='icons/company.png') }}"
                     alt="{{ company.name }}" style="width:120px; height:120px; border-radius:12px; object-fit:cover;">

                {% if is_company_admin %}
                <div id="logo-overlay" style="
                    position: absolute;
                    top: 0; left: 0;
                    width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5);
                    color: #fff;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    border-radius: 12px;
                    opacity: 0;
                    transition: opacity 0.3s;
                    cursor: pointer;
                    ">
                    K√©p cser√©je
                </div>
                <input type="file" id="logo-input" style="display: none;" accept="image/*,.heic">
                {% endif %}
            </div>
            <div class="company-info">
                <p><strong>Hely:</strong> {{ company.country }}</p>
                <p><strong>C√≠m:</strong> {{ company.post_code }}, {{ company.street }} {{ company.house_number }}</p>
                <p><strong>Ad√≥sz√°m:</strong> {{ company.tax_number }}</p>
                <p><strong>Tags√°g kezdete:</strong> {{ company.created_at.strftime('%Y-%m-%d') if company.created_at else '' }}</p>
            </div>
        </div>

        <!-- Alkalmazottak list√°ja -->
        <h2 style="display:flex; align-items:center;">
            Alkalmazottak
            {% if is_company_admin %}
            <span class="invite-button-container">
                <button id="invite-toggle-btn" class="invite-btn" aria-expanded="false" aria-controls="invite-panel">
                    <img src="{{ url_for('static', filename='icons/envelope_plus.png') }}" class="invite-icon" alt="Megh√≠v√≥">
                    Megh√≠v√°s
                </button>
                <button type="button" class="blocked-btn" data-bs-toggle="modal" data-bs-target="#blockedCompaniesModal">
                    <img src="{{ url_for('static', filename='icons/blacklist.png') }}" class="block-icon" alt="Tilt√≥lista">
                    Tilt√≥lista kezel√©se
                </button>
            </span>
            {% endif %}
        </h2>


        <div id="invite-panel" class="invite-panel hidden" aria-hidden="true">
            <h2>Megh√≠v√≥k kezel√©se</h2>

            <!-- SZ√ÅM BE√ÅLL√çT√ì: mennyi sort szeretn√©l -->
            <div style="margin-bottom:10px;">
                <label for="num_invites" style="margin-right:8px;">Megh√≠v√≥k sz√°ma:</label>
                <input type="number" id="num_invites" min="1" max="20" value="1" style="width:70px; padding:6px;">
            </div>

            <form method="POST" action="{{ url_for('company.generate_invite') }}" class="invite-form space-y-6 max-w-md bg-white p-6 rounded-xl shadow-md" id="invite-form">
                <div id="invite-rows" class="invite-rows" aria-live="polite">
                    <!-- Sorok ide lesznek besz√∫rva JS-sel -->
                </div>

                <div style="margin-top:12px;">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">Megh√≠v√≥k gener√°l√°sa</button>
                </div>
            </form>

            <h3 style="margin-top:16px;">Akt√≠v megh√≠v√≥k:</h3>
            <p>
                {% set active_invites = company.invite_codes | selectattr("is_used", "equalto", False) | selectattr("expires_at", "gt", now) | list %}
                {{ active_invites | length }} db
            </p>
        </div>

        <div class="employees-list">
                    {% if company.users %}
                        {% for employee in company.users %}
                            <a id="employee_card" href="{{ url_for('company.user_profile', company_slug=company.slug, email=employee.email) }}">
                                <div class="employee-card relative">

                                    <!-- Jobb fels≈ë ikonok -->
                                    {% if is_company_admin or current_user_role == 'owner' %}
                                    <div class="employee-actions">
                                        {% if not employee.is_company_admin %}
                                            {% if current_user_role == 'owner' and employee.role !='owner'%}
                                                {% if employee.user_id != current_user_id %}
                                                    <button class="action-btn promote-btn" title="Admin jog megad√°sa" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/crown.png') }}" class="invite-icon" alt="Korona">
                                                    </button>
                                                    <button class="action-btn remove-btn" title="T√∂rl√©s a c√©gb≈ël" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/kick.png') }}" class="invite-icon" alt="Kick">
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                {% if not employee.is_company_admin and employee.user_id != current_user_id %}
                                                    <button class="action-btn promote-btn" title="Admin jog megad√°sa" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/crown.png') }}" class="invite-icon" alt="Korona">
                                                    </button>
                                                    <button class="action-btn remove-btn" title="T√∂rl√©s a c√©gb≈ël" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/kick.png') }}" class="invite-icon" alt="Kick">
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        {% else %}
                                            {% if current_user_role == 'owner' and employee.role !='owner'%}
                                                {% if employee.user_id != current_user_id %}
                                                    <button class="action-btn promote-btn" title="Admin jog megvon√°sa" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/crown_down.png') }}" class="invite-icon" alt="Nem korona">
                                                    </button>
                                                    <button class="action-btn remove-btn" title="T√∂rl√©s a c√©gb≈ël" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/kick.png') }}" class="invite-icon" alt="Kick">
                                                    </button>
                                                {% endif %}
                                            {% else %}
                                                {% if not employee.is_company_admin and employee.user_id != current_user_id %}
                                                    <button class="action-btn promote-btn" title="Admin jogmegvon√°sa" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/crown_down.png') }}" class="invite-icon" alt="Nem korona">
                                                    </button>
                                                    <button class="action-btn remove-btn" title="T√∂rl√©s a c√©gb≈ël" data-user-id="{{ employee.user_id }}">
                                                        <img src="{{ url_for('static', filename='icons/kick.png') }}" class="invite-icon" alt="Kick">
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}

                                    </div>
                                    {% endif %}

                                    <div class="employee-left">
                                        <img src="{% if employee.profile_picture %}
                                                    {{ url_for('static', filename='uploads/profile_pictures/' + employee.profile_picture) }}
                                                 {% else %}
                                                    {{ url_for('static', filename='icons/user.png') }}
                                                 {% endif %}"
                                             alt="{{ employee.first_name }}" class="emp-avatar">
                                    </div>
                                    <div class="employee-right">
                                        <p class="emp-name"><strong>{{ employee.first_name }} {{ employee.last_name }}</strong></p>
                                        <p class="emp-role">{{ employee.role }}</p>
                                        <p class="emp-email">{{ employee.email }}</p>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <p>Nincsenek alkalmazottak.</p>
                    {% endif %}
                </div>

        <h2>Hirdetett fuvarok</h2>
        {% if cargos %}
        <div class="table-wrapper">
            <table id="companyCargos" class="display" style="width:100%; font-size:0.9em;">
                <thead>
                    <tr>
                        <th class="felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                        <th class="felvet">Rakom√°ny felv√©tel</th>
                        <th class="letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                        <th class="letet">Rakom√°ny let√©tel</th>
                        <th class="arujarmu">Hossza (m)</th>
                        <th class="arujarmu">T√∂mege (t)</th>
                        <th class="arujarmu" colspan="5">J√°rm≈± tulajdons√°gok</th>
                        <th class="hirdeto">Hirdet≈ë</th>
                        <th style="display: none">created_at</th> <!-- rejtett oszlop a cs√∂kken≈ë rendez√©shez -->
                    </tr>
                </thead>
                <tbody>
                    {% for cargo in cargos %}
                    <tr data-id="{{ cargo.cargo_id }}">
                    <td class="datum">
                        {% set pickups = cargo.locations | selectattr('type', 'equalto', 'pickup') | list %}
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% if first_pickup.start_date %}
                                {{ first_pickup.start_date.strftime('%m.%d.') }}
                                {% if first_pickup.start_date.year != current_year %}
                                    .{{ first_pickup.start_date.year }}
                                {% endif %}
                                {% if first_pickup.end_date %}
                                    {% set delta = (first_pickup.end_date - first_pickup.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}
                            {% if first_pickup.start_time_1 or first_pickup.start_time_2 %}
                                <br>
                                {{ first_pickup.start_time_1.strftime('%H:%M') if first_pickup.start_time_1 else '' }}
                                ‚Äì {{ first_pickup.start_time_2.strftime('%H:%M') if first_pickup.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    <td>
                        {% if pickups %}
                            {% set first_pickup = pickups[0] %}
                            {% set extra_pickups = pickups|length - 1 %}
                            <span class="country-zip"><strong>{{ first_pickup.country.upper() }} {{ first_pickup.masked_postcode if first_pickup.is_hidden else first_pickup.postcode }}</strong></span><br>
                            <span class="city">{{ first_pickup.masked_city if first_pickup.is_hidden else first_pickup.city }}</span>
                            {% if extra_pickups > 0 %}
                                <br><span class="extra-count">(+{{ extra_pickups }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <td class="datum">
                        {% set dropoffs = cargo.locations | selectattr('type', 'equalto', 'dropoff') | list %}
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% if last_dropoff.start_date %}
                                {{ last_dropoff.start_date.strftime('%m.%d.') }}
                                {% if last_dropoff.start_date.year != current_year %}
                                    .{{ last_dropoff.start_date.year }}
                                {% endif %}
                                {% if last_dropoff.end_date %}
                                    {% set delta = (last_dropoff.end_date - last_dropoff.start_date).days %}
                                    (+{{ delta }})
                                {% endif %}
                            {% endif %}
                            {% if last_dropoff.start_time_1 or last_dropoff.start_time_2 %}
                                <br>
                                {{ last_dropoff.start_time_1.strftime('%H:%M') if last_dropoff.start_time_1 else '' }}
                                ‚Äì {{ last_dropoff.start_time_2.strftime('%H:%M') if last_dropoff.start_time_2 else '' }}
                            {% endif %}
                        {% endif %}
                    </td>

                    <td>
                        {% if dropoffs %}
                            {% set last_dropoff = dropoffs[-1] %}
                            {% set extra_dropoffs = dropoffs|length - 1 %}
                            <span class="country-zip"><strong>{{ last_dropoff.country.upper() }} {{ last_dropoff.masked_postcode if last_dropoff.is_hidden else last_dropoff.postcode }}</strong></span><br>
                            <span class="city">{{ last_dropoff.masked_city if last_dropoff.is_hidden else last_dropoff.city }}</span>
                            {% if extra_dropoffs > 0 %}
                                <br><span class="extra-count">(+{{ extra_dropoffs }})</span>
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>


                        {# Tov√°bbi oszlopok v√°ltozatlanul #}
                        <td>{{ cargo.size }}</td>
                        <td>{{ cargo.weight }}</td>
                        <td>{{ cargo.vehicle_type or '-' }}</td>
                        <td>{{ cargo.stucture or '-' }}</td>
                        <td>{{ cargo.equipment or '-' }}</td>
                        <td>{{ cargo.cargo_securement or '-' }}</td>
                        <td>{{ cargo.certificates or '-' }}</td>
                        <td>
                            {% if cargo.posted_by %}
                                <a href="{{ url_for('company.user_profile', company_slug=cargo.company.slug, email=cargo.posted_by.email) }}">
                                    {{ cargo.posted_by.first_name }} {{ cargo.posted_by.last_name }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td style="display: none">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
        <p>Ez a c√©g m√©g nem hirdetett fuvarokat.</p>
        {% endif %}
        </div>

        <!-- Tiltott c√©gek modal (Bootstrap) -->
        <div class="modal fade" id="blockedCompaniesModal" tabindex="-1" aria-labelledby="blockedCompaniesModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- modal-lg: nagyobb sz√©less√©g -->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="blockedCompaniesModalLabel">Tiltott c√©gek</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <table class="table table-striped" id="blockedCompaniesTable">
                  <tbody>
                    <!-- JS t√∂lti fel ide a sorokat -->
                  </tbody>
                </table>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bez√°r</button>
              </div>
            </div>
          </div>
        </div>
    </main>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    var table;
    if (! $.fn.DataTable.isDataTable('#companyCargos')) {
        table = $('#companyCargos').DataTable({
            "order": [[8, "desc"], [1, "asc"]],
            "pageLength": 5,
            "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 0 }]
        });
    } else {
        table = $('#companyCargos').DataTable(); // l√©tez≈ë p√©ld√°nyt haszn√°ljuk
    }
});

</script>
{% endblock %}

{% if is_company_admin %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // safe DOM queries
    const inviteBtn = document.getElementById('invite-toggle-btn');
    const invitePanel = document.getElementById('invite-panel');
    const numInput = document.getElementById('num_invites');
    const rowsContainer = document.getElementById('invite-rows');

    // create a single invite card (index i) ‚Äî returns a DOM node styled as employee-card
    function createInviteCard(i) {
        // card uses same class as employee-card so it visually matches
        const card = document.createElement('div');
        card.className = 'employee-card invite-card';
        // make card content flexible
        card.style.flexDirection = 'column';
        card.style.height = 'auto';
        card.style.padding = '12px';

        // top area: email and role
        const top = document.createElement('div');
        top.style.display = 'flex';
        top.style.flexDirection = 'row'; // sorban
        top.style.flex = '1';
        top.style.gap = '12px'; // r√©s az inputok k√∂z√∂tt

        // --- Email ---
        const emailWrapper = document.createElement('div'); // oszlop a label + input sz√°m√°ra
        emailWrapper.style.display = 'flex';
        emailWrapper.style.flexDirection = 'column';
        emailWrapper.style.flex = '1'; // kit√∂lt≈ë a rendelkez√©sre √°ll√≥ helyen

        const emailLabel = document.createElement('label');
        emailLabel.textContent = 'E-mail';
        emailLabel.style.fontSize = '13px';
        emailLabel.style.fontWeight = '600';
        emailLabel.style.marginBottom = '4px';

        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.name = `invites[${i}][email]`;
        emailInput.placeholder = 'email@example.com';
        emailInput.required = true;
        emailInput.style.padding = '6px';
        emailInput.style.border = '1px solid #ddd';
        emailInput.style.borderRadius = '6px';
        emailInput.style.width = '100%';

        emailWrapper.appendChild(emailLabel);
        emailWrapper.appendChild(emailInput);

        // --- Role ---
        const roleWrapper = document.createElement('div'); // oszlop a label + select sz√°m√°ra
        roleWrapper.style.display = 'flex';
        roleWrapper.style.flexDirection = 'column';
        roleWrapper.style.flex = '1';

        const roleLabel = document.createElement('label');
        roleLabel.textContent = 'Szerepk√∂r';
        roleLabel.style.fontSize = '13px';
        roleLabel.style.fontWeight = '600';
        roleLabel.style.marginBottom = '4px';

        const roleSelect = document.createElement('select');
        roleSelect.name = `invites[${i}][role]`;
        roleSelect.style.padding = '6px';
        roleSelect.style.border = '1px solid #ddd';
        roleSelect.style.borderRadius = '6px';
        roleSelect.style.width = '100%';
        roleSelect.innerHTML = `
            <option value="freight_forwarder">Spedit≈ër</option>
            <option value="manager">Manager</option>
            <option value="accountant">P√©nz√ºgy</option>
            <option value="owner">Tulaj</option>
        `;

        // --- Role select esem√©ny figyel√©s ---
        roleSelect.addEventListener('change', function() {
            if (roleSelect.value === 'owner') {
                // ha owner, automatikusan admin, checkbox ne jelenjen meg
                adminWrapper.style.display = 'none';
                adminCheckbox.checked = true; // backendnek is k√ºldje
            } else {
                // minden m√°s esetben toggle l√°tszik
                adminWrapper.style.display = 'flex';
                adminCheckbox.checked = false;
            }
        });

        // ha alap√©rtelmezetten owner van kiv√°lasztva
        if (roleSelect.value === 'owner') {
            adminWrapper.style.display = 'none';
            adminCheckbox.checked = true;
        }


        roleWrapper.appendChild(roleLabel);
        roleWrapper.appendChild(roleSelect);

        // --- Assemble top row ---
        top.appendChild(emailWrapper);
        top.appendChild(roleWrapper);


        // bottom area: admin toggle and optional actions
        const bottom = document.createElement('div');
        bottom.style.display = 'flex';
        bottom.style.justifyContent = 'space-between';
        bottom.style.alignItems = 'center';
        bottom.style.marginTop = '8px';
        bottom.style.width = '100%';

        // Admin toggle: keep exact structure for toggle-switch + slider
        const adminWrapper = document.createElement('div');
        adminWrapper.style.display = 'flex';
        adminWrapper.style.alignItems = 'center';
        adminWrapper.style.gap = '8px';

        const adminText = document.createElement('span');
        adminText.textContent = 'Admin jog';
        adminText.style.fontSize = '14px';

        const adminLabel = document.createElement('label');
        adminLabel.className = 'toggle-switch'; // reuse CSS

        const adminCheckbox = document.createElement('input');
        adminCheckbox.type = 'checkbox';
        adminCheckbox.name = `invites[${i}][for_admin]`;
        adminCheckbox.value = '1';

        const sliderSpan = document.createElement('span');
        sliderSpan.className = 'slider';

        adminLabel.appendChild(adminCheckbox);
        adminLabel.appendChild(sliderSpan);

        adminWrapper.appendChild(adminText);
        adminWrapper.appendChild(adminLabel);

        bottom.appendChild(adminWrapper);

        // Optionally, include a small remove button for the card (client-side)
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'T√∂r√∂l';
        removeBtn.style.background = 'transparent';
        removeBtn.style.border = 'none';
        removeBtn.style.color = '#d9534f';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.fontWeight = '600';
        removeBtn.addEventListener('click', function () {
            card.remove();
            // after removing, reindex remaining cards so names are sequential
            reindexInviteCards();
        });
        bottom.appendChild(removeBtn);

        // assemble
        card.appendChild(top);
        card.appendChild(bottom);

        return card;
    }

    // reindex names (invites[0]... ) after removal to keep server-side loop working
    function reindexInviteCards() {
        const cards = Array.from(rowsContainer.querySelectorAll('.invite-card'));
        cards.forEach((card, idx) => {
            // find inputs/selects inside card and update names
            const email = card.querySelector('input[type="email"]');
            if (email) email.name = `invites[${idx}][email]`;
            const select = card.querySelector('select');
            if (select) select.name = `invites[${idx}][role]`;
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.name = `invites[${idx}][for_admin]`;
        });
        // also update number input to reflect count
        if (numInput) numInput.value = Math.max(1, cards.length);
    }

    function renderRows() {
        if (!rowsContainer || !numInput) return;
        let num = parseInt(numInput.value, 10);
        if (isNaN(num) || num < 1) num = 1;
        if (num > 20) num = 20;
        // write back sanitized value
        numInput.value = num;

        // ensure rows container layout: flex with wrapping so 3 cards per row (employee-card width ~30%)
        rowsContainer.style.display = 'flex';
        rowsContainer.style.flexWrap = 'wrap';
        rowsContainer.style.gap = '20px';

        // preserve existing values: only add or remove cards as necessary
        const existingCards = Array.from(rowsContainer.querySelectorAll('.invite-card'));
        const existingCount = existingCards.length;

        if (existingCount < num) {
            // add new cards without touching existing ones
            for (let i = existingCount; i < num; i++) {
                const card = createInviteCard(i);
                rowsContainer.appendChild(card);
            }
        } else if (existingCount > num) {
            // remove excess cards (from the end) but keep the first `num` cards and their values
            for (let i = existingCount - 1; i >= num; i--) {
                existingCards[i].remove();
            }
        }
        // reindex names so they are sequential and correct after changes
        reindexInviteCards();
    }

    // initial render (only create if empty to avoid wiping user input)
    if (rowsContainer && rowsContainer.children.length === 0) {
        renderRows();
    }

    // update whenever number changes (preserve inputs)
    if (numInput) {
        numInput.addEventListener('input', function () {
            renderRows();
        });
    }

    // toggle panel
    if (inviteBtn && invitePanel) {
        inviteBtn.addEventListener('click', function () {
            const wasHidden = invitePanel.classList.contains('hidden');
            invitePanel.classList.toggle('hidden');
            invitePanel.setAttribute('aria-hidden', String(!wasHidden));
            inviteBtn.setAttribute('aria-expanded', String(wasHidden));
            // if showing and no rows (edge), render
            if (!invitePanel.classList.contains('hidden') && (!rowsContainer || rowsContainer.children.length === 0)) {
                renderRows();
            }
        });
    }

    // --- logo upload overlay (safe) ---
    const logoContainer = document.querySelector('.company-logo-container');
    const overlay = document.getElementById('logo-overlay');
    const input = document.getElementById('logo-input');
    const logoImg = document.getElementById('company-logo');

    if (logoContainer && overlay) {
        logoContainer.addEventListener('mouseenter', () => overlay.style.opacity = 1);
        logoContainer.addEventListener('mouseleave', () => overlay.style.opacity = 0);
        overlay.addEventListener('click', () => input && input.click());
    }

    if (input) {
        input.addEventListener('change', () => {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('logo', file);

            fetch("{{ url_for('company.upload_company_logo') }}", {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (logoImg) logoImg.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert(data.error || 'Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n.');
            });
        });
    }

    // promote/remove buttons
    document.querySelectorAll('.promote-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();   // <<< link navig√°ci√≥ tilt√°sa
            e.stopPropagation();  // <<< click nem megy fel a <a>-nak
            const userId = btn.dataset.userId;
            if (!userId) return;

            const isAdmin = btn.title.includes('megvon√°sa');
            const msg = isAdmin ? "Biztosan megvonod az admin jogot?" : "Biztosan admin jogot adsz?";
            if(!confirm(msg)) return;

            fetch(`/company/company/{{ company.company_id }}/promote/${userId}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // --- Friss√≠tj√ºk az ikont ---
                    if (btn.tagName === 'BUTTON') {
                        const img = btn.querySelector('img');
                        if (img) {
                            if (isAdmin) {
                                img.src = "{{ url_for('static', filename='icons/crown.png') }}"; // megvon√°s ut√°n
                                btn.title = "Admin jog megad√°sa";
                            } else {
                                img.src = "{{ url_for('static', filename='icons/crown_down.png') }}"; // megad√°s ut√°n
                                btn.title = "Admin jog megvon√°sa";
                            }
                        }
                    }
                } else {
                    alert(data.error || 'Hiba a prom√≥ci√≥ sor√°n.');
                }
            })
        });
    });

    // Remove gomb
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();   // <<< link navig√°ci√≥ tilt√°sa
            e.stopPropagation();  // <<< click nem megy fel a <a>-nak

            const userId = btn.dataset.userId;
            if (!userId) return;

            if (!confirm("Biztosan t√∂rl√∂d ezt a felhaszn√°l√≥t a c√©gt≈ël?")) return;

            fetch(`/company//company/{{ company.company_id }}/remove/${userId}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // t√∂rl√©s a DOM-b√≥l
                    const card = btn.closest('.employee-card');
                    if (card) card.remove();
                } else {
                    alert(data.error || 'Hiba a t√∂rl√©s sor√°n.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Hiba a t√∂rl√©s sor√°n.');
            });
        });
    });

});


// Modal kezel√©se
document.addEventListener("DOMContentLoaded", () => {
    console.log("‚úÖ blockedCompanies.js inicializ√°lva");

    const modal = document.getElementById("blockedCompaniesModal");
    const tbody = modal.querySelector("tbody");

    // Ez a gomb a HTML-ben l√©v≈ë "Tilt√≥lista kezel√©se" gomb
    const openButtons = document.querySelectorAll('[data-bs-target="#blockedCompaniesModal"]');

    // --- Lista bet√∂lt√©se ---
    const loadBlockedCompanies = () => {
        console.log("üîÑ Tiltott c√©gek lek√©r√©se a /blocked_companies v√©gpointr√≥l...");

        fetch("/company/blocked_companies")
            .then(res => {
                console.log("üì° Lek√©r√©s st√°tuszk√≥d:", res.status);
                return res.json();
            })
            .then(data => {
                console.log("üì¶ V√°lasz JSON:", data);

                tbody.innerHTML = "";

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted">Nincsenek tiltott c√©gek.</td></tr>`;
                    console.log("‚ö†Ô∏è √úres lista");
                    return;
                }

                data.forEach(c => {
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <!-- C√©g log√≥ -->
                        <td style="width:15%; border:none; padding:5px;">
                            <img src="${c.logo_filename ? `/static/uploads/company_logos/${c.logo_filename}` : '/static/icons/company.png'}"
                                 alt="${c.name}"
                                 style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                        </td>

                        <!-- C√©g neve √©s c√≠me -->
                        <td style="width:55%; border:none; padding:5px;">
                            <strong>${c.name}</strong><br>
                            <small class="text-muted">
                                ${c.tax_number || ''} | ${c.country || ''} ${c.post_code || ''}, ${c.street || ''} ${c.house_number || ''}
                            </small>
                        </td>

                        <!-- Tilt√°s felold√°sa gomb -->
                        <td class="text-end" style="width:30%; border:none; padding:5px;">
                            <button class="btn btn-success btn-unblock" data-id="${c.company_id}">
                                Tilt√°s felold√°sa
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });


            })
            .catch(err => {
                console.error("‚ùå Hiba t√∂rt√©nt a fetch sor√°n:", err);
            });
    };

    // --- Modal megnyit√°sra adatbet√∂lt√©s ---
    openButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            console.log("üü¢ Tilt√≥lista modal megnyitva");
            loadBlockedCompanies();
        });
    });

    // --- Enged√©lyez√©s gomb kezel√©se ---
    tbody.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-unblock")) {
            const id = e.target.dataset.id;
            console.log("üß© Enged√©lyez√©s indult ID:", id);

            fetch(`/company/unblock_company/${id}`, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    console.log("üì¨ V√°lasz az enged√©lyez√©sre:", data);
                    if (data.success) {
                        loadBlockedCompanies();
                    } else {
                        alert(data.error || "Hiba t√∂rt√©nt!");
                    }
                })
                .catch(err => console.error("‚ùå Enged√©lyez√©s fetch hiba:", err));
        }
    });
});

</script>
{% endif %}

<style>
.dataTables_wrapper .dataTables_filter {
    float: none !important;
    text-align: left !important;
    margin-bottom: 10px;
    width: 10vw;
}

#blockedCompaniesModal td {
    vertical-align: middle; /* k√∂z√©pre igaz√≠t√°s f√ºgg≈ëlegesen */
}

#blockedCompaniesModal td strong {
    font-size: 1rem; /* nagyobb bet≈± a n√©vnek */
}

#blockedCompaniesModal td small {
    color: #666;      /* halv√°nyabb sz√≠n a c√≠mnek */
    font-size: 0.85rem;
}

td{
    width: 200px;
}
.company-title {
    font-size: 28px;
    margin-bottom: 20px;
}

.company-header {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    align-items: center;
}

.company-logo-container{
    display: flex;
    align-items: center;
    gap: 10px;
}

.company-logo img {
    width: 120px;
    height: 120px;
    border-radius: 12px;
    object-fit: cover;
}

.company-info p {
    margin: 5px 0;
    font-size: 16px;
}

.invite-button-container {
    margin-left: auto;  /* tolja a gombokat a sor jobb sz√©l√©re */
    display: flex;
    gap: 8px;           /* kis t√°vols√°g a gombok k√∂z√∂tt */
}

.invite-btn, .blocked-btn {
    background-color: #4a90e2;
    color: white;
    font-weight: 600;
    padding: 10px 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
}

.invite-btn:hover {
    background-color: #357fBD;
}


.invite-icon, .block-icon {
    width: 20px;
    height: 20px;
}
.invite-button-container {
    margin-left: auto; /* jobbra tolja */
}
.invite-panel {
    margin-top: 20px;
}
.hidden {
    display: none;
}

/* Alkalmazott k√°rty√°k */
.employees-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}
.employee-card {
    position: relative;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 12px;
    width: 30%;
    min-width: 25vw;
    height: 150px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-sizing: border-box;
}

.employee-actions {
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    gap: 6px;
}

.action-btn {
    background: transparent;
    /*border: 1px solid violet;*/
    text-align: center;
    cursor: pointer;
    font-size: 18px;
    transition: transform 0.2s;
    padding: 10px 10px;
}

.action-btn:hover {
    transform: scale(1.2);
}

.employee-left {
    flex-shrink: 0;
}

.emp-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #eee;
}

.employee-right .emp-name {
    margin: 0 0 4px 0;
    font-size: 15px;
}

.employee-right .emp-role, .employee-right .emp-email {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #4a90e2;
}

input:checked + .slider:before {
    transform: translateX(22px);
}


/* Reszponz√≠v */
@media (max-width: 1100px) {
    .employee-card {
        width: 45%;
    }
}

@media (max-width: 700px) {
    .employee-card {
        width: 100%;
    }
}
</style>
{% endblock %}
