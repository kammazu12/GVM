{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
    <h1 class="cim">Járművek</h1>
    <div class="cargo-container">
        <button class="accordion-btn">Rakomány feltöltése / fuvar keresése▼</button>
        <!-- Lenyíló form -->
        <div class="accordion-content">
            <!-- Tabs gombok -->
            <div class="tabs">
                <button type="button" class="tab-btn active" data-tab="form-tab">Kézi felvitel</button>
                <button type="button" class="tab-btn" data-tab="emails-tab">E-mailes felvitel</button>
            </div>
            <div id="form-tab" class="tab-content" style="display:block;">
                <form action="{{ url_for('cargo.cargo') }}" class="freight-form">
                    <!-- Honnan és Hová blokk egymás mellett -->
                    <!-- Sablon kiválasztó -->
                    <div class="template-select-wrapper">
                      <label for="template_select"><strong>Sablon betöltése:</strong></label>

                      <!-- Fallback select (ha nincs JS) -->
                      <select id="template_select" name="template_id" style="display:none;">
                          {% if templates|length == 0 %}
                              <option value="" selected disabled>Jelenleg még nincs sablon</option>
                          {% else %}
                              <option value="" selected disabled>Válassz sablont</option>
                              {% for t in templates %}
                                {% set pickups = t.locations|selectattr("type", "equalto", "pickup")|list %}
                                {% set dropoffs = t.locations|selectattr("type", "equalto", "dropoff")|list %}
                                {% set pickup_count = pickups|length %}
                                {% set delivery_count = dropoffs|length %}

                                {% if pickup_count > 0 %}
                                    {% set first_loc = pickups[0] %}
                                {% else %}
                                    {% set first_loc = None %}
                                {% endif %}

                                {% if delivery_count > 0 %}
                                    {% set last_loc = dropoffs[-1] %}
                                {% else %}
                                    {% set last_loc = None %}
                                {% endif %}

                                  <option value="{{ t.id }}">
                                    {% if first_loc %}
                                        {{ first_loc.country_code }} {{ first_loc.zip }} {{ first_loc.city }}
                                        {% if pickup_count > 1 %}(+{{ pickup_count - 1 }}){% endif %}
                                    {% else %}
                                        Nincs felrakó
                                    {% endif %}
                                    ➡
                                    {% if last_loc %}
                                        {{ last_loc.country_code }} {{ last_loc.zip }} {{ last_loc.city }}
                                        {% if delivery_count > 1 %}(+{{ delivery_count - 1 }}){% endif %}
                                    {% else %}
                                        Nincs lerakó
                                    {% endif %}
                                    | {{ t.weight }} t | {{ t.size }} m
                                    {% if t.price %}| {{ t.price }} {{ t.currency }}{% endif %}
                                  </option>


                              {% endfor %}
                          {% endif %}
                      </select>

                      <!-- Egyedi lenyíló (JS tölti be) -->
                      <div id="template-dropdown" class="custom-template-dropdown"></div>
                    </div>
                    <br>
                    <div class="grid-top">
                        <div class="pickup-wrapper">
                            <legend>Honnan</legend>
                            <label for="pickup-count"><strong>Felvételi helyek száma:</strong></label>
                            <input type="number" id="pickup-count" name="pickup_count" min="1" max="9" value="1" style="width:70px; margin-bottom:8px;">
                            <div id="pickup-container" class="pickup-container">
                                <!-- első (alap) fieldset ide kerül JS által -->
                            </div>
                        </div>
                        <div class="swap-container">
                            <button type="button" id="swap-btn">⇄</button>
                        </div>
                        <!-- DROPOFFS (Hová) konténer és számláló -->
                        <div class="dropoff-wrapper">
                            <legend>Hová</legend>
                            <label for="dropoff-count"><strong>Lerakási helyek száma:</strong></label>
                            <input type="number" id="dropoff-count" name="dropoff_count" min="1" max="9" value="1" style="width:70px; margin-bottom:8px;">
                            <div id="dropoff-container" class="dropoff-container">
                                <!-- első (alap) fieldset ide kerül JS által -->
                            </div>
                        </div>
                        <template id="pickup-template" data-editor-usable="1">
                            <fieldset class="pickup-fieldset">
                                <div class="move-buttons">
                                    <button type="button" class="move-up"><img src="{{ url_for('static', filename='icons/up-arrow.png') }}" alt="Move up" class="move-up"></button>
                                    <button type="button" class="move-down"><img src="{{ url_for('static', filename='icons/down-arrow.png') }}" alt="Move down" class="move-down"></button>
                                </div>

                                <div class="location-grid">
                                    <!-- Bal oldal -->
                                    <div class="left-side" style="position: relative; width: 100%;">
                                        <label>Felrakó:</label>
                                        <input type="text" name="from_city[__INDEX__]" class="city-search" required minlength="2" autocomplete="off">
                                        <input type="hidden" name="from_city_valid[__INDEX__]" class="city-valid" value="0">
                                        <input type="hidden" name="from_country[__INDEX__]" class="city-country">
                                        <input type="hidden" name="from_postcode[__INDEX__]" class="city-postcode">
                                        <ul class="search-results" style="display:none;"></ul>
                                    </div>

                                    <!-- Jobb oldal -->
                                    <div class="right-side">
                                        <div class="start-flex">
                                            <label>Kezdő dátum</label>
                                            <input type="date" name="from_start_date[__INDEX__]" required>
                                            <div class="time-row">
                                                <input type="time" name="from_start_time_start[__INDEX__]" placeholder="08:00">
                                                <input type="time" name="from_start_time_end[__INDEX__]" placeholder="16:00">
                                            </div>
                                        </div>
                                        <div class="end-flex">
                                            <label>Záró dátum</label>
                                            <input type="date" name="from_end_date[__INDEX__]" required>
                                            <div class="time-row">
                                                <input type="time" name="from_end_time_start[__INDEX__]" placeholder="08:00">
                                                <input type="time" name="from_end_time_end[__INDEX__]" placeholder="16:00">
                                            </div>
                                        </div>

                                        <div class="cards-row">
                                            <div class="toggle-card" id="hiddenFromCard">
                                                <span id="hiddenFromText"><b>Bújtatott fuvar</b> <img src="{{ url_for('static', filename='icons/disguise.png') }}" alt="Bújtatott fuvar"></span>
                                            </div>
                                            <input type="hidden" id="is_hidden_from" name="is_hidden_from" value="false">

                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </template>
                        <template id="dropoff-template" data-editor-usable="1">
                            <fieldset class="dropoff-fieldset">
                                <div class="move-buttons">
                                    <button type="button" class="move-up"><img src="{{ url_for('static', filename='icons/up-arrow.png') }}" alt="Move up" class="move-up"></button>
                                    <button type="button" class="move-down"><img src="{{ url_for('static', filename='icons/down-arrow.png') }}" alt="Move down" class="move-down"></button>
                                </div>
                                <div class="location-grid">
                                    <!-- Bal oldal -->
                                    <div class="left-side" style="position: relative; width: 100%;">
                                        <label>Lerakó:</label>
                                        <input type="text" name="to_city[__INDEX__]" class="city-search" required minlength="2" autocomplete="off">
                                        <input type="hidden" name="to_city_valid[__INDEX__]" class="city-valid" value="0">
                                        <input type="hidden" name="to_country[__INDEX__]" class="city-country">
                                        <input type="hidden" name="to_postcode[__INDEX__]" class="city-postcode">
                                        <ul class="search-results" style="display:none;"></ul>
                                    </div>
                                    <!-- Jobb oldal -->
                                    <div class="right-side">
                                        <div class="start-flex">
                                            <label>Kezdő dátum</label>
                                            <input type="date" name="to_start_date[__INDEX__]" required>
                                            <div class="time-row">
                                                <input type="time" name="to_start_time_start[__INDEX__]" placeholder="08:00">
                                                <input type="time" name="to_start_time_end[__INDEX__]" placeholder="16:00">
                                            </div>
                                        </div>
                                        <div class="end-flex">
                                            <label>Záró dátum</label>
                                            <input type="date" name="to_end_date[__INDEX__]" required>
                                            <div class="time-row">
                                                <input type="time" name="to_end_time_start[__INDEX__]" placeholder="08:00">
                                                <input type="time" name="to_end_time_end[__INDEX__]" placeholder="16:00">
                                            </div>
                                        </div>
                                        <div class="cards-row">
                                            <div class="toggle-card" id="hiddenToCard">
                                                <span id="hiddenToText"><b>Bújtatott fuvar</b> <img src="{{ url_for('static', filename='icons/disguise.png') }}" alt="Bújtatott fuvar"></span>
                                            </div>
                                            <input type="hidden" id="is_hidden_to" name="is_hidden_to" value="false">
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </template>
                    </div>
                    <br>
                    <!-- Áru és Jármű alatta -->
                    <div class="grid-bottom">
                        <div class="vehicle-wrapper">
                            <legend>Jármű adatok</legend>
                            <fieldset class="vehicle-grid">
                                <div class="vehicle-first-row">
                                            <div class="vehicle-col">
                                                <label for="vehicle_type">Típus<span class="required">*</span></label>
                                                <select id="vehicle_type" name="vehicle_type" required>
                                                    <option value="" disabled selected>Válassz jármű típust</option>
                                                    <option value="Jármű 3,5 t-ig">Jármű 3,5 t-ig</option>
                                                    <option value="Nyerges szerelvény">Nyerges szerelvény</option>
                                                    <option value="Pótos szerelvény">Pótos szerelvény</option>
                                                    <option value="Tehergépjármű 7,5 t-ig">Tehergépjármű 7,5 t-ig</option>
                                                    <option value="Tehergépjármű 12 t-ig">Tehergépjármű 12 t-ig</option>
                                                </select>
                                            </div>

                                            <div class="vehicle-col">
                                                <label for="superstructure">Felépítmény<span class="required">*</span></label>
                                                <select id="superstructure" name="superstructure" required>
                                                    <option value="" disabled selected>Válassz felépítményt</option>
                                                    <option value="Autószállító">Autószállító</option>
                                                    <option value="Billenős konténer">Billenős konténer</option>
                                                    <option value="Cserefelépítmény-Chassis">Cserefelépítmény-Chassis</option>
                                                    <option value="Dobozos">Dobozos</option>
                                                    <option value="Furgon">Furgon</option>
                                                    <option value="Dupla kabinos">Dupla kabinos</option>
                                                    <option value="Félpótkocsi">Félpótkocsi</option>
                                                    <option value="Hűtő">Hűtő</option>
                                                    <option value="Jumbo">Jumbo</option>
                                                    <option value="Klipper">Klipper</option>
                                                    <option value="Konténerszállító">Konténerszállító</option>
                                                    <option value="Kábeldobszálíltó">Kábeldobszálíltó</option>
                                                    <option value="Középrakodós">Középrakodós</option>
                                                    <option value="Mega">Mega</option>
                                                    <option value="Mozgópadlós">Mozgópadlós</option>
                                                    <option value="Mozgópadlós (ömlesztett áru)">Mozgópadlós (ömlesztett áru)</option>
                                                    <option value="Mélybölcsős">Mélybölcsős</option>
                                                    <option value="Nyitott tehergépkocsi">Nyitott tehergépkocsi</option>
                                                    <option value="Oldalrakodós">Oldalrakodós</option>
                                                    <option value="Ponyvás">Ponyvás</option>
                                                    <option value="Sasszé">Sasszé</option>
                                                    <option value="Siló">Siló</option>
                                                    <option value="Speciális jármű">Speciális jármű</option>
                                                    <option value="Szigetelt">Szigetelt</option>
                                                    <option value="Szállítószalagos">Szállítószalagos</option>
                                                    <option value="Tartálykocsi">Tartálykocsi</option>
                                                    <option value="Tautliner">Tautliner</option>
                                                    <option value="Tele">Tele</option>
                                                    <option value="Vontató">Vontató</option>
                                                </select>
                                            </div>
                                        </div>

                                <div class="vehicle-second-row">
                                    <!-- Felszereltség -->
                                    <div class="vehicle-col">
                                        <label for="equipment">Felszereltség</label>
                                        <div class="multiselect">
                                            <div class="selectBox" onclick="toggleCheckboxes('equipment')">
                                                <span id="equipment-selected">Válassz felszereltséget</span> ▼
                                            </div>
                                            <div class="checkboxes" id="equipment-checkboxes" data-editor-usable="equipment">
                                                <label><input type="checkbox" value="2. sofőr"> 2. sofőr </label>
                                                <label><input type="checkbox" value="A-Schild"> A-Schild </label>
                                                <label><input type="checkbox" value="ADR"> ADR </label>
                                                <label><input type="checkbox" value="BF3 kísérőjármű"> BF3</label>
                                                <label><input type="checkbox" value="BF4 kísérőjármű"> BF4</label>
                                                <label><input type="checkbox" value="Béka"> Béka</label>
                                                <label><input type="checkbox" value="Emelőhátfal"> Emelőhátfal</label>
                                                <label><input type="checkbox" value="Farönkszállító"> Farönkszállító</label>
                                                <label><input type="checkbox" value="GPS követő"> GPS követő</label>
                                                <label><input type="checkbox" value="Húskampó"> Húskampó</label>
                                                <label><input type="checkbox" value="Rakodódaru"> Rakodódaru</label>
                                                <label><input type="checkbox" value="Rámpa"> Rámpa</label>
                                                <label><input type="checkbox" value="Takaróponyva"> Takaróponyva</label>
                                                <label><input type="checkbox" value="Targonca"> Targonca</label>
                                                <label><input type="checkbox" value="Válaszfal"> Válaszfal</label>
                                                <label><input type="checkbox" value="Vámzsinór"> Vámzsinór</label>
                                            </div>
                                        </div>
                                        <select id="equipment" name="equipment" multiple hidden>
                                            <option value="2. sofőr">2. sofőr</option>
                                            <option value="A-Schild">A-Schild</option>
                                            <option value="ADR">ADR</option>
                                            <option value="BF3 kísérőjármű">BF3 kísérőjármű</option>
                                            <option value="BF4 kísérőjármű">BF4 kísérőjármű</option>
                                            <option value="Béka">Béka</option>
                                            <option value="Emelőhátfal">Emelőhátfal</option>
                                            <option value="Farönkszállító">Farönkszállító</option>
                                            <option value="GPS követő">GPS követő</option>
                                            <option value="Húskampó">Húskampó</option>
                                            <option value="Rakodódaru">Rakodódaru</option>
                                            <option value="Rámpa">Rámpa</option>
                                            <option value="Takaróponyva">Takaróponyva</option>
                                            <option value="Targonca">Targonca</option>
                                            <option value="Válaszfal">Válaszfal</option>
                                            <option value="Vámzsinór">Vámzsinór</option>
                                        </select>
                                    </div>

                                    <!-- Rakományrögzítés -->
                                    <div class="vehicle-col">
                                        <label for="securement">Rakományrögzítés</label>
                                        <div class="multiselect">
                                            <div class="selectBox" onclick="toggleCheckboxes('securement')">
                                                <span id="securement-selected">Válassz rakományrögzítést</span> ▼
                                            </div>
                                            <div class="checkboxes" id="securement-checkboxes" data-editor-usable="securement">
                                                <label><input type="checkbox" value="Csúszásgátló"> Csúszásgátló</label>
                                                <label><input type="checkbox" value="Láncos feszítő"> Láncos feszítő</label>
                                                <label><input type="checkbox" value="Multilock"> Multilock</label>
                                                <label><input type="checkbox" value="Oldalfalas"> Oldalfalas</label>
                                                <label><input type="checkbox" value="Palettarögzítő gerenda"> Rögzítő gerenda</label>
                                                <label><input type="checkbox" value="Rakományrögzítő rúd"> Rakományrögzítő rúd</label>
                                                <label><input type="checkbox" value="Rakonca"> Rakonca</label>
                                                <label><input type="checkbox" value="Spanifer"> Spanifer</label>
                                                <label><input type="checkbox" value="Élvédő"> Élvédő</label>
                                            </div>
                                        </div>
                                        <select id="securement" name="securement" multiple hidden>
                                            <option value="Csúszásgátló">Csúszásgátló</option>
                                            <option value="Láncos feszítő">Láncos feszítő</option>
                                            <option value="Multilock">Multilock</option>
                                            <option value="Oldalfalas">Oldalfalas</option>
                                            <option value="Palettarögzítő gerenda">Palettarögzítő gerenda</option>
                                            <option value="Rakományrögzítő rúd">Rakományrögzítő rúd</option>
                                            <option value="Rakonca">Rakonca</option>
                                            <option value="Spanifer">Spanifer</option>
                                            <option value="Élvédő">Élvédő</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="vehicle-third-row">
                                    <label for="vehicle_notes">Megjegyzés a járművel kapcsolatban</label>
                                    <textarea id="vehicle_notes" name="vehicle_notes" rows="2" placeholder="Írj ide bármilyen kiegészítő információt..."></textarea>
                                </div>

                            </fieldset>
                        </div>

                        <div class="goods-wrapper">
                            <legend>Áru</legend>
                            <fieldset class="cargo-inner-fieldset">
                                <label for="length">Hossz (m)<span class="required">*</span></label>
                                <input type="number" id="length" name="length" step="0.1" min="0" required>

                                <label for="weight">Tömeg (t)<span class="required">*</span></label>
                                <input type="number" id="weight" name="weight" step="0.1" min="0" required>

                                <label for="price">Ár</label>
                                <div class="price-row">
                                    <input type="number" id="price" name="price" step="5" min="0">
                                    <select name="currency" id="currency">
                                        <option value="EUR">EUR</option>
                                        <option value="HUF">HUF</option>
                                    </select>
                                </div>

                                <label for="description">Rakomány leírása</label>
                                <input type="text" id="description" name="description">

                                <div class="cards-row">
                                    <div class="palette-card" id="paletteCard">
                                        <span id="paletteText"><b>Palettacsere</b> <img src="{{ url_for('static', filename='icons/exchange_palette.png') }}" alt="Palettacsere"></span>
                                    </div>
                                    <input type="hidden" id="palette_exchange" name="palette_exchange" value="false">
                                    <div class="oversize-card" id="oversizeCard">
                                        <span id="oversizeText"><b>Túlméretes áru</b> <img src="{{ url_for('static', filename='icons/oversize.png') }}" alt="Palettacsere"></span>
                                    </div>
                                    <input type="hidden" id="oversize" name="oversize" value="false">
                                </div>
                        </fieldset>
                        </div>
                    </div>
                    <div class="sablon-wrapper">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="sablonCheckbox" name="sablonCheckbox" class="sablon">
                            <span class="checkmark"></span>
                            Mentés sablonként
                        </label>
                    </div>
                    <div class="btn-wrapper">
                        <button type="submit">Áru feltölése és fuvar keresése</button>
                    </div>
                </form>
            </div>
            <div id="emails-tab" class="tab-content" style="display:none;">
                <div id="email-container-wrapper" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                    <div id="email-container" class="email-container">
                        <a href="{{ url_for('login.login_google') }}">Connect your Gmail</a>
                        <button id="open-gmail">Open Gmail</button>
                        <ul id="email-list"></ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Táblázat -->
        <div class="table-wrapper">
            <table id="vehiclesTable" class="display" style="font-size:0.9em; border:none;">
                <thead>
                    <tr>
                        <th class="datum felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                        <th class="felvet">Indulás helye</th>
                        <th class="datum letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                        <th  class="letet">Érkezés helye</th>
                        <th class="arujarmu">Jármű típusa</th>
                        <th class="arujarmu">Felépítmény</th>
                        <th class="arujarmu">Felszerelés</th>
                        <th class="arujarmu">Rögzítés</th>
                        <th class="arujarmu">Megjegyzés</th>
                        <th class="arujarmu">Extrák</th>
                        <th class="arujarmu">Rakodás típusa</th>
                        <th class="letet">Jármű kapacitása</th>
                        <th class="letet">Raktér mérete</th>
                        <th class="letet">Ár</th>
                        <th class="letet">Hirdető cég</th>
                        <th style="display:none;">created_at</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr class="vehicle-row" data-vehicle-id="{{ vehicle.vehicle_id }}" style="cursor:pointer;">
                        <!-- Elérhető (from) -->
                        <td class="datum">
                            {% if vehicle.available_from %}
                                {% if vehicle.available_from.year == current_year %}
                                    {{ vehicle.available_from.strftime('%m.%d.') }}
                                {% else %}
                                    {{ vehicle.available_from.strftime('%Y.%m.%d.') }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- Indulási hely -->
                        <td class="pickup-cell">
                            <span class="country-zip">
                                <strong>{{ vehicle.origin_country or '-' }} {{ vehicle.origin_postcode or '-' }}</strong>
                            </span><br>
                            <span class="city">{{ vehicle.origin_city or '-' }}</span>
                            {% if vehicle.origin_diff %}
                                <br>
                                <span class="diff">(+{{ vehicle.origin_diff }} km)</span>
                            {% endif %}
                        </td>

                        <!-- Elérhető (to) -->
                        <td class="datum">
                            {% if vehicle.available_until %}
                                {% if vehicle.available_until.year == current_year %}
                                    {{ vehicle.available_until.strftime('%m.%d.') }}
                                {% else %}
                                    {{ vehicle.available_until.strftime('%Y.%m.%d.') }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- Hova -->
                        <td class="dropoff-cell">
                            {% if vehicle.destination_diff != None %}
                                <span class="country-zip">
                                    <strong>{{ vehicle.destination_country or '-' }} {{ vehicle.destination_postcode or '-' }}</strong>
                                </span><br>
                                <span class="city">{{ vehicle.destination_city or '-' }}</span>
                                {% if vehicle.destination_diff > 0 %}
                                    <br>
                                    <span class="diff">(+{{ vehicle.destination_diff }} km)</span>
                                {% endif %}
                            {% else %}
                                {% for d in vehicle.extra_destinations %}
                                    <strong>{{ d.country }}</strong>{% if not loop.last %}, {% endif %}
                                {% else %}
                                    -
                                {% endfor %}
                            {% endif %}
                        </td>


                        <!-- Jármű jellemzői külön mezők -->
                        <td>{{ vehicle.vehicle_type or '-' }}</td>
                        <td>{{ vehicle.structure or '-' }}</td>
                        <td>{{ vehicle.equipment or '-' }}</td>
                        <td>{{ vehicle.cargo_securement or '-' }}</td>
                        <td>{{ vehicle.description or '-' }}</td>

                        <!-- Extrák -->
                        <td>
                            {% set extras = [] %}
                            {% if vehicle.palette_exchange %}{% set _ = extras.append('Palettacsere') %}{% endif %}
                            {% if vehicle.oversize %}{% set _ = extras.append('Túlméretes áru') %}{% endif %}
                            {{ extras|join(', ') if extras else '-' }}
                        </td>


                        <!-- Rakodás típusa -->
                        <td>{{ vehicle.load_type or '-' }}</td>

                        <!-- Áru mérete -->
                        <td>
                            {% if vehicle.capacity_t %}{{ vehicle.capacity_t }} t{% else %}-{% endif %}
                        </td>
                        <td>
                            {% if vehicle.volume_m3 %}{{ vehicle.volume_m3 }} m³{% else %}-{% endif %}
                        </td>

                        <!-- Ár -->
                        <td>{{ vehicle.price or '-' }} {{ vehicle.currency or '-' }}</td>

                        <!-- Hirdető cég -->
                        <td>
                            {% if vehicle.company %}
                                <a href="{{ url_for('company.company_profile', slug=vehicle.company.slug) }}">
                                    {{ vehicle.company.name }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <!-- rejtett oszlop a csökkenő rendezéshez -->
                        <td style="display:none;">{{ vehicle.created_at.strftime('%Y-%m-%d %H:%M:%S') if vehicle.created_at else '-' }}</td>


                        <!-- Hidden JSON adatok a modal JS-hez -->
                        <div id="pickups-data" style="display:none;">{{ vehicle.pickups_json | safe }}</div>
                        <div id="dropoffs-data" style="display:none;">{{ vehicle.dropoffs_json | safe }}</div>
                        <div id="radius-km" style="display:none;">{{ vehicle.radius_km or 0 }}</div>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal fade" id="vehicleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Jármű részletek</h5>
                </div>
                <div class="modal-body" id="vehicleDetails">
                    <!-- Ide töltjük majd AJAX-szal a részleteket -->
                </div>
            </div>
        </div>
    </div>
    <!-- Matching Modal -->
    <div class="modal fade" id="matchingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Matching járművek</h5>
            <button id="reloadBtn" class="btn btn-primary">Bezárás és frissítés</button>
          </div>
          <div class="modal-body">
            <p>Az alábbi járművek pontszám alapján leginkább megfelelnek a rakománynak:</p>
            <div id="matchingList"></div> <!-- ide kerül a táblázat -->
          </div>
        </div>
      </div>
    </div>
</main>
</div>

<style>
.custom-template-dropdown {
  position: relative;
  width: 100%;
  min-width: 280px;
}

.custom-template-dropdown .dropdown-header {
  background: #fff;
  border: 1px solid #ccc;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.custom-template-dropdown .dropdown-list {
  display: none;
  position: absolute;
  top: 105%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  max-height: 250px;
  overflow-y: auto;
  z-index: 100;
}

.custom-template-dropdown.open .dropdown-list {
  display: block;
}

.custom-template-dropdown .dropdown-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  cursor: pointer;
}

.custom-template-dropdown .dropdown-item:hover {
  background: #f2f2f2;
}

.custom-template-dropdown .delete-btn {
  color: black;       /* fekete X */
  background: none;   /* nincs háttér */
  border: none;       /* nincs keret */
  border-radius: 0;   /* nincs lekerekítés */
  width: auto;        /* ne fix méret */
  height: auto;
  padding: 0 4px;     /* kis belső margó */
  font-weight: bold;
  cursor: pointer;
  flex-shrink: 0;
}


.template-select-wrapper{
    width: 45%;
}

#vehiclesTable td{
    width: 300px;
}

/* Matching Modal testreszabása */
#matchingModal .modal-dialog {
  max-width: 80vw;       /* szélesség max 80% viewport width */
  width: 80vw;           /* tényleges szélesség */
  margin: auto;          /* vízszintesen középre igazítja */
}

#matchingModal .modal-content {
  width: 100%;
}

#matchingModal .modal-body {
  overflow-x: auto;      /* ha széles a táblázat, görgethető legyen */
}

#matchingModal table th {
    background: #4a90e2;
    color: white;
}

#matchingModal table tr:nth-child(even) {
    background: #f9f9f9;
}

#matchingModal .letet, .hirdeto{
    background-color: red;
}

#matchingModal .arujarmu, #matchingModal .felvet{
    background-color: #111;
    color: white;
}

.search-results {
    position: absolute;
    top: 100%;
    right: 0;
    width: 100%; /* a konténerhez igazodik, nem a fieldsethez */
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    z-index: 1000;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.search-results li {
    padding: 8px 12px;
    cursor: pointer;
    transition: background 0.2s;
}

.search-results li:hover {
    background-color: #007bff;
    color: white;
}

.cards-row{
    display: flex;
    gap: 10%;
}

.tab-content {
    display: none; /* alapból elrejtve, kivéve a form-tab */
    padding: 10px 0;
}

.tab-content form {
    width: 100%;
}

.email-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.email-card {
    border: 1px solid #ddd;
    padding: 10px 15px;
    border-radius: 8px;
    background-color: #f9f9f9;
    font-family: monospace;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.email-card h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #333;
}

.email-card p {
    margin: 0;
    font-size: 12px;
    color: #555;
    white-space: pre-wrap;
}

.multiselect {
    position: relative;
    display: inline-block;
}

.selectBox {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border: 1px solid #aaa;
    padding: 8px;
    border-radius: 5px;
    background: #fff;
    cursor: pointer;
}

.checkboxes {
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  z-index: 1000;
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 kártya egy sorban */
  gap: 0.75rem; /* kártyák közötti tér */
  padding: 0.75rem;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  max-height: 320px;
  overflow: auto;
}

#securement-checkboxes {
  grid-template-columns: repeat(3, 1fr);
}

.checkboxes label {
    display: flex;
    flex-direction: row-reverse;
    /*justify-content: space-between;*/
    align-items: center;
    text-align: center;
     vertical-align: middle !important;
    /*justify-content: center;*/
    width: 75%;
    padding: 10px 8px;
    min-height: 35px; /* egységes magasság és középre zárás */
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    white-space: normal;
    transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
}

.checkboxes label:hover {
  background: #f2f6ff;
  border-color: #cfe0ff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.checkboxes label.selected {
  background: #e9f5ff;
  border-color: #5aa3ff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.checkboxes input[type="checkbox"] {
  display: none;       /* checkbox eltüntetése, csak kártya marad */
}

.date-container{
height: 85%;
}

#swap-btn {
    display: flex;
    align-items: center;      /* függőlegesen középre */
    justify-content: center;  /* vízszintesen középre */
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 18px;
    cursor: pointer;
    padding: 0;               /* padding eltávolítása, hogy tényleg középen legyen */
    line-height: 1;           /* sor magasság normalizálása */
    text-align: center;
    transition: background 0.2s;
}

.cargo-container {
    min-width: 80%;
    max-width: 100%;
    margin: 10px auto;
}

.accordion-btn {
    width: 30%;
    background-color: #007bff;
    color: white;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    margin-bottom: 10px;
    transition: background 0.2s;
}


.accordion-btn:hover {
    background-color: #0056b3;
}

.accordion-content {
    display: none;
}


.datetime-row label {
    display: block;
    margin-bottom: 2px; /* kis tér a label és az inputok között */
}


fieldset{
    height: 80%;
}

.freight-form {
    min-width: 100%;
    /*margin: auto;*/
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: sans-serif;
    display: grid;
}

/* Honnan-Hová + Mikor */
.grid-top {
    display: flex;
    column-gap: 10px;
    align-items: flex-start;
    width: 100%;
    padding-bottom: 20px;
}

/* Pickup és Dropoff rész */
.pickup-wrapper,
.dropoff-wrapper {
    flex: 0 0 45%;  /* vagy a fel- és lerakó összesen 78% */
    max-width:45%;
}

.swap-container {
    flex: 0 0 8%;  /* swap gomb 5% */
    max-width : 5%;
    display: flex;
    justify-content: center;
    align-items: center;
    align-self: center;
    text-align: left;
}

/* Ár input + valuta select sorban */
.price-row {
    display: flex;
    gap: 5px;
}

.price-row input[type="number"] {
    flex: 2; /* nagyobb része az értéknek */
}

.price-row select {
    flex: 1; /* kisebb része a valutának */
    height: 90%;
}

/* Áru és Jármű alatta, 45-45% */
.grid-bottom {
    display: flex;
    column-gap: 2%;
    width: 100%;
    align-items: flex-start;
}

.vehicle-wrapper{
    flex: 0 0 70%;  /* vagy az áru és jármű összesen 98% */
    max-width:70%;
}

.goods-wrapper{
    flex: 0 0 24%;  /* vagy az áru és jármű összesen 98% */
    max-width:24%;
}

.vehicle-grid {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px;
}


/* Első sor: Típus + Felépítmény */
.vehicle-first-row {
    display: flex;
    gap: 20px;
}

.vehicle-first-row .vehicle-col {
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Második sor: Felszereltség + Rakományrögzítés */
.vehicle-second-row {
    display: flex;
    gap: 2%;
}

.vehicle-second-row .vehicle-col {
    flex: 0 0 49%;
    display: flex;
    flex-direction: column;
}

.vehicle-second-row select[multiple] {
    height: 100px; /* fix magasság a selectnek */
}

.vehicle-third-row {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.vehicle-third-row textarea {
    width: 100%;
    resize: vertical;   /* lehessen magasítani, de ne vízszintesen széthúzni */
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.4;
}

/* minden label+mező blokk függőlegesen egymás alatt */
.vehicle-grid label {
  display: block;
  margin-bottom: 4px;
}


/* felszereltség mező teljes sorban */
.multiselect,
#equipment[hidden] {
  grid-column: 1 / span 2; /* 2 oszlopot foglal */
}

fieldset {
    border: 1px solid #ccc;
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    max-width: 100%;
    height: 100%;
}

legend {
    font-weight: bold;
    padding: 0 10px;
}

label {
    margin-top: 10px;
    font-size: 14px;
    color: #333;
}

input {
    width: 100%;
    padding: 8px 10px;
    margin-top: 4px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

button[type="submit"] {
    background: #4a90e2;
    color: #fff;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.2s;
}

button[type="submit"]:hover {
    background: #3578c3;
}

.table-container {
    overflow-x: auto;
    margin-top: 15px;
}

table, th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    align-content: center;

}

.switch input {
    opacity: 0;
    width: 50px;
    height: 10px;
}
.toggle-card {
    text-align: center;
    display: flex;
    flex: 0 0 45%;
    justify-content: center;
    align-items: center;
    padding: 12px;
    margin-top: 8px;
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    user-select: none;
}

.toggle-card:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.toggle-card.active {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
}

.table-container{
    align-content: center;
    min-width: 100%;
}

th {
    background: #007bff;
    color: white;
}

tr:nth-child(even) {
    background: #f9f9f9;
}

/* move buttons styling: hide by default, position top-right inside fieldset */
.pickup-fieldset, .dropoff-fieldset {
    width: 100%;
    position: relative;
    padding-top: 28px; /* space for the buttons */
}

.move-buttons {
    position: absolute;
    top: 2px;
    bottom: 10px;
    right: 8px;
    display: none; /* JS will show only when needed */
    gap: 20px;
}

.move-buttons button {
    background: #fff;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    padding: 0;
    line-height: 1;
    cursor: pointer;
}

.location-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: start;
}

.time-row {
    display: grid;
    grid-template-columns: 49% 49%;
    gap: 5px;
}

.left-side{
    display: flex;
    flex-direction: row;
    gap: 6px;
    width: 100%;
}

.left-side label{
    font-size: 20px;
}

.right-side{
    display: flex;
    flex-direction: row;
    gap: 6px;
    width: 100%;
}

.pickup-wrapper,
.dropoff-wrapper {
    flex: 1;
}

.start-flex, .end-flex{
    width: 100%;
}


.palette-card {
    text-align: center;
    display: flex;
    flex: 0 0 45%;
    justify-content: center;
    align-items: center;
    padding: 12px;
    margin-top: 8px;
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    user-select: none;
}

.oversize-card {
    display: flex;
    text-align: center;
    flex: 0 0 45%;
    justify-content: center;
    align-items: center;
    padding: 12px;
    margin-top: 8px;
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    background: #fafafa;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    user-select: none;
}

.palette-card:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.palette-card.active {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
}

.oversize-card:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.oversize-card.active {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-weight: 500;
}

img{
    width: 24px;
}

label img{
    width: 20px;
}

#paletteText, #oversizeText {
    color: #000;

}

.sablon-wrapper {
    margin-top: 10px;
    margin-bottom: 20px;
    width: 15vw;
    display: flex;
    flex-direction: column; /* egymás alá */
    gap: 0.5em;             /* kis távolság a checkboxok között */
}

/* A label legyen flex, a checkmark mindig bal oldalon */
.custom-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    position: relative;
    font-size: 0.9em;
    user-select: none;
}

/* Eredeti checkbox elrejtése */
.custom-checkbox input[type="checkbox"] {
    display: none;
}

/* Saját checkmark stílus */
.custom-checkbox .checkmark {
    width: 25px;
    height: 25px;
    border: 2px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    position: relative;
    margin-right: 10px; /* szöveg és checkmark közti távolság */
}

/* Pipa megjelenítése, ha checked */
.custom-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: "";
    position: absolute;
    left: 6px;
    top: 2px;
    width: 8px;
    height: 16px;
    border: solid #333;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}


@media (max-width: 1550px) {
    .vehicle-second-row {
        flex-direction: column;
    }

}
</style>

{% endblock %}

{% block scripts %}
<script>
// ------------------------------------------- MATCHING MODAL ------------------------------------------------
console.log("freight.js betöltődött");

document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector(".freight-form");
    if (!form) {
        console.error("Nem található .freight-form");
        return;
    }

    const matchingModalEl = document.getElementById('matchingModal');
    const matchingModal = new bootstrap.Modal(matchingModalEl);
    const matchingList = document.getElementById("matchingList");
    const reloadBtn = document.getElementById("reloadBtn");

    // --- EGYETLEN SUBMIT LISTENER ---
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Submit event triggered");

        const formData = new FormData(form);

        // Városvalidálás (marad a korábbi logika)
        let allValid = true;
        form.querySelectorAll(".city-valid").forEach(el => {
            if (el.value !== "1") allValid = false;
        });
        if (!allValid) {
            alert("Minden városnál érvényes értéket kell kiválasztani a listából!");
            return;
        }

        try {
            const resp = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            });

            const data = await resp.json();
            // console.log("POST /cargo/cargo válasz:", data);

            if (!data.success) {
                // Hibák megjelenítése, **ne írja felül a modal-t**
                for (const [fieldName, msg] of Object.entries(data.errors || {})) {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.classList.add('error');
                        const errorSpan = document.createElement('span');
                        errorSpan.classList.add('error-msg');
                        errorSpan.textContent = msg;
                        field.parentNode.appendChild(errorSpan);
                    }
                }
                alert("Hiba történt a mentés során!");
                return;
            }

            // --- MATCHES RENDER ---
            if (Array.isArray(data.matches) && data.matches.length > 0) {
                renderMatchesTable(data.matches);
                matchingModal.show();
            } else if (data.cargo_id) {
                await fetchMatchesAndShow(data.cargo_id);
            } else if (Array.isArray(data.top_vehicle_ids) && data.top_vehicle_ids.length > 0) {
                const rows = data.top_vehicle_ids.map(id => ({ vehicle_id: id, score: "—" }));
                renderMatchesTable(rows);
                matchingModal.show();
            } else {
                matchingList.innerHTML = "<p>Nincs ajánlott jármű (nincs adat).</p>";
                matchingModal.show();
            }

        } catch (err) {
            console.error("Hálózati/JS hiba:", err);
            alert("Hiba a kapcsolódásban. Nézd a konzolt a részletekért.");
        }
    });

    // reload gomb
    reloadBtn?.addEventListener("click", () => {
        matchingModal.hide();
        location.reload();
    });

    // --- HELPER FÜGGVÉNYEK ---
    async function fetchMatchesAndShow(cargo_id) {
        try {
            const r = await fetch("/find_matches", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cargo_id })
            });
            const dd = await r.json();

            if (dd && Array.isArray(dd.matches) && dd.matches.length > 0) {
                renderMatchesTable(dd.matches);
            } else {
                matchingList.innerHTML = "<p>Nincs találat.</p>";
            }
            matchingModal.show();
        } catch (err) {
            console.error("Hiba a /find_matches hívásakor:", err);
            matchingList.innerHTML = "<p>Hiba a találatok lekérésekor.</p>";
            matchingModal.show();
        }
    }

    function formatDate(dateStr) {
        if (!dateStr) return "-";
        const date = new Date(dateStr);
        return date.toLocaleDateString('hu-HU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function renderMatchesTable(matches) {
        matchingList.innerHTML = "";
        const table = document.createElement("table");
        table.className = "table table-striped";

        const thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
                <th class="datum felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                <th class="felvet">Indulási hely</th>
                <th class="datum letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                <th class="letet">Hova</th>
                <th class="arujarmu">Jármű típusa</th>
                <th class="arujarmu">Felépítmény</th>
                <th class="arujarmu">Felszerelés</th>
                <th class="arujarmu">Rögzítés</th>
                <th class="arujarmu">Megjegyzés</th>
                <th class="arujarmu">Rakodás típusa</th>
                <th class="letet">Jármű kapacitása</th>
                <th class="letet">Raktér mérete</th>
                <th class="letet">Ár</th>
                <th class="letet">Hirdető cég</th>
                <th>Pontszám</th>
            </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        matches.forEach(m => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td class="datum">${m.available_from ? formatDate(m.available_from) : "-"}</td>
                <td class="pickup-cell">
                    <strong>${m.origin_country || "-"} ${m.origin_postcode || "-"}</strong><br>
                    <span class="city">${m.origin_city || "-"}</span><br>
                    <small class="text-muted">(+${m.origin_diff ?? 0} km)</small>
                </td>
                <td class="datum">${m.available_until ? formatDate(m.available_until) : "-"}</td>
                <td class="dropoff-cell">
                    <strong>${m.destination_country || "-"} ${m.destination_postcode || "-"}</strong><br>
                    <span class="city">${m.destination_city || "-"}</span><br>
                    <small class="text-muted">(+${m.destination_diff ?? 0} km)</small>
                </td>
                <td>${m.vehicle_type || "-"}</td>
                <td>${m.structure || "-"}</td>
                <td>${m.equipment || "-"}</td>
                <td>${m.cargo_securement || "-"}</td>
                <td>${m.description || "-"}</td>
                <td>${m.load_type || "-"}</td>
                <td>${m.capacity_t ? m.capacity_t + " t" : "-"}</td>
                <td>${m.volume_m3 ? m.volume_m3 + " m³" : "-"}</td>
                <td>${m.price || "-"} ${m.currency || ""}</td>
                <td>${m.company || "-"}</td>
                <td><strong>${m.score}</strong></td>
            `;

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        matchingList.appendChild(table);
    }

});

const form = document.querySelector(".freight-form");
console.log("Form:", form);

if (form) {
    form.addEventListener("submit", async function(e) {
        e.preventDefault();
        console.log("Submit event triggered");
        // cargo_id teszt
        const cargoId = form.dataset.cargoId || document.querySelector('input[name="cargo_id"]')?.value;
        console.log("Cargo ID:", cargoId);
    });
}

// --- Modal kirajzolása ---
function showMatchingModal(matches) {
    const list = document.getElementById("matchingList");

    // védelem: ha már van táblázat érvényes pontszámokkal, ne írjuk felül
    const existingScores = list.querySelectorAll("tbody tr td:nth-child(2)");
    if (existingScores.length > 0) {
        let hasRealScore = Array.from(existingScores).some(td => {
            const txt = td.textContent.trim();
            return txt !== "N/A" && txt !== "—";
        });
        if (hasRealScore) {
            console.log("Táblázat már létezik pontszámokkal → showMatchingModal nem írja felül.");
            const modal = new bootstrap.Modal(document.getElementById("matchingModal"));
            modal.show();
            return;
        }
    }

    // új táblázat építése (ha eddig nem volt értelmes adat)
    list.innerHTML = "";
    const table = document.createElement("table");
    table.className = "table table-striped";

    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>Jármű ID</th><th>Pontszám</th></tr>";
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    matches.forEach(match => {
        let vehicleId, score;
        if (typeof match === "object") {
            vehicleId = match.vehicle_id ?? (match.id ?? "N/A");
            score = match.score ?? "N/A";
        } else {
            vehicleId = match; // sima ID tömb
            score = "—";
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${vehicleId}</td><td>${score}</td>`;
        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    list.appendChild(table);

    const modal = new bootstrap.Modal(document.getElementById("matchingModal"));
    modal.show();
}

// --- Bezárás + frissítés gomb ---
document.getElementById("reloadBtn").addEventListener("click", function() {
    location.reload();
});

$('#matchingModal').off('hidden.bs.modal').on('hidden.bs.modal', async function () {
    location.reload();
});

// ---------------------------------------------------------------------------------------------------------
// ---------------------------------------------------------------------------------------------------------
// ---------------------------------- Település kereső JS + mentés -----------------------------------------

$(document).ready(function() {
    let searchTimer; // ide mentjük az időzítőt

    // delegált esemény a dinamikusan létrehozott city-search inputokra
    $(document).on("input", ".city-search", function() {
        let $input = $(this);
        let query = $input.val().trim();
        let $results = $input.siblings(".search-results");

        // reseteljük az időzítőt minden billentyűnél
        clearTimeout(searchTimer);

        if(query.length < 2){
            $results.hide();
            return;
        }

        // csak 500ms inaktivitás után fut le a keresés
        searchTimer = setTimeout(() => {
            $.get("/cargo/ajax/city_search", { q: query }, function(data) {
                $results.empty();

                if(data.length === 0){
                    $results.hide();
                    return;
                }

                data.slice(0, 10).forEach(item => { // max 10 találat
                    let text = `${item.city_name}, ${item.country_code} (${item.zipcode || ""})`;
                    $results.append(`<li class="result-item">${text}</li>`);
                });

                $results.show();
            });
        }, 300); // 0.3 másodperc
    });

    // delegált click esemény
    $(document).on("click", ".result-item", function() {
        let $li = $(this);
        let $ul = $li.parent();
        let $input = $ul.siblings(".city-search");
        let $valid = $ul.siblings(".city-valid");

        $input.val($li.text());
        $valid.val("1");  // Érvényes város kiválasztva
        $ul.hide();
    });

    // blur esemény
    $(document).on("blur", ".city-search", function() {
        let $ul = $(this).siblings(".search-results");
        setTimeout(() => $ul.hide(), 200);
    });

    // Ha a felhasználó szerkeszti az inputot, reseteljük az érvényességet
    $(document).on("input", ".city-search", function() {
        let $input = $(this);
        let $valid = $input.siblings(".city-valid");
        $valid.val("0");  // új beírás → nincs még érvényes város
    });

    // $(".freight-form").on("submit", function(e) {
    //     console.log("Form submit event");
    //     e.preventDefault(); // minden submitot blokkolunk, nem lesz újratöltés
    //
    //     let allValid = true;
    //     $(this).find(".city-valid").each(function() {
    //         if ($(this).val() !== "1") {
    //             allValid = false;
    //             return false; // kilépés a loopból
    //         }
    //     });
    //
    //     if (!allValid) {
    //         alert("Minden városnál érvényes értéket kell kiválasztani a listából!");
    //         return; // megszakítjuk a mentést
    //     }
    //
    //     // --- AJAX POST ---
    //     const form = this;
    //     const formData = new FormData(form);
    //
    //     fetch(form.action, {
    //         method: "POST",
    //         body: formData,
    //         headers: {
    //             "X-Requested-With": "XMLHttpRequest"
    //         }
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if(data.success){
    //             showMatchingModal(data.top_vehicle_ids); // csak a modal megjelenítése
    //         } else {
    //             alert("Hiba történt a fuvar keresésekor:\n" + (data.error || data.errors?.join("\n")));
    //         }
    //     })
    //     .catch(err => console.error(err));
    // });
});

$(document).on("click", ".result-item", function() {
    let $li = $(this);
    let $ul = $li.parent();
    let $input = $ul.siblings(".city-search");
    let $valid = $ul.siblings(".city-valid");

    $input.val($li.text());
    $valid.val("1");  // Érvényes város kiválasztva
    $ul.hide();
});

// Ha a felhasználó szerkeszti az inputot, reseteljük az érvényességet
$(document).on("input", ".city-search", function() {
    let $input = $(this);
    let $valid = $input.siblings(".city-valid");
    $valid.val("0");  // új beírás → nincs még érvényes város
});

function selectCity(element, cityData) {
    // cityData: {city, country, postcode}
    const fieldset = element.closest("fieldset");

    // city input
    element.value = cityData.city;

    // hidden mezők
    const countryInput = fieldset.querySelector(".city-country");
    const postcodeInput = fieldset.querySelector(".city-postcode");

    if (countryInput) countryInput.value = cityData.country;
    if (postcodeInput) postcodeInput.value = cityData.postcode;

    // city_valid checkbox / hidden
    const validInput = fieldset.querySelector(".city-valid");
    if (validInput) validInput.value = 1;
}

// ---------------------------------------------------------------------------------------------------------

document.addEventListener("click", (e) => {
    const target = e.target.closest("#hiddenFromCard");
    if (target) {
        const input = document.getElementById("is_hidden_from");
        const isActive = target.classList.toggle("active");
        input.value = isActive ? "true" : "false";
    }

    const target2 = e.target.closest("#hiddenToCard");
    if (target2) {
        const input2 = document.getElementById("is_hidden_to");
        const isActive2 = target2.classList.toggle("active");
        input2.value = isActive2 ? "true" : "false";
    }

    const target3 = e.target.closest("#paletteCard");
    if (target3) {
        const input3 = document.getElementById("palette_exchange");
        const isActive3 = target3.classList.toggle("active");
        input3.value = isActive3 ? "true" : "false";
    }

    const target4 = e.target.closest("#oversizeCard");
    if (target4) {
        const input4 = document.getElementById("oversize");
        const isActive4 = target4.classList.toggle("active");
        input4.value = isActive4 ? "true" : "false";
    }
});

function reindexFields(containerSelector, prefix) {
    const container = document.querySelector(containerSelector);
    const fieldsets = container.querySelectorAll("fieldset");

    fieldsets.forEach((fs, idx) => {
        const inputs = fs.querySelectorAll("input, select, textarea");

        inputs.forEach(input => {
            if (input.name) {
                if (input.name.includes("[__INDEX__]")) {
                    // sablonból jött
                    input.name = input.name.replace("[__INDEX__]", `[${idx}]`);
                } else {
                    // már indexelt → frissítjük
                    input.name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                }
            }
        });
    });
}

function refreshMoveButtons(containerSelector, prefix) {
    const container = document.querySelector(containerSelector);
    const fieldsets = container.querySelectorAll("fieldset");

    // Ha nincs, vagy csak 1 → minden gomb elrejt
    if (fieldsets.length <= 1) {
        fieldsets.forEach(fs => {
            const btns = fs.querySelector(".move-buttons");
            if (btns) btns.style.display = "none";
        });
        return;
    }

    // Ha legalább 2 van → helyesen állítjuk be
    fieldsets.forEach((fs, idx) => {
        const btns = fs.querySelector(".move-buttons");
        if (!btns) return;

        btns.style.display = "block";
        const upBtn = fs.querySelector(".move-up");
        const downBtn = fs.querySelector(".move-down");

        // először minden látszik
        upBtn.style.display = "inline-block";
        downBtn.style.display = "inline-block";

        if (idx === 0) {
            upBtn.style.display = "none";   // első → nincs ↑
        }
        if (idx === fieldsets.length - 1) {
            downBtn.style.display = "none"; // utolsó → nincs ↓
        }
    });

    // backend sorrend frissítése
    reindexFields(containerSelector, prefix);
}

function setupMoveButtons(containerSelector, prefix) {
    const container = document.querySelector(containerSelector);

    container.addEventListener("click", (e) => {
        if (e.target.classList.contains("move-up") || e.target.classList.contains("move-down")) {
            const fieldset = e.target.closest("fieldset");
            if (e.target.classList.contains("move-up")) {
                const prev = fieldset.previousElementSibling;
                if (prev) {
                    container.insertBefore(fieldset, prev);
                }
            } else if (e.target.classList.contains("move-down")) {
                const next = fieldset.nextElementSibling;
                if (next) {
                    container.insertBefore(next, fieldset);
                }
            }
            refreshMoveButtons(containerSelector, prefix);
        }
    });

    // induláskor is frissítsen
    refreshMoveButtons(containerSelector, prefix);
}

document.addEventListener("DOMContentLoaded", () => {
    setupMoveButtons("#pickup-container", "from");
    setupMoveButtons("#dropoff-container", "to");

    // darabszám változásra frissítés
    document.getElementById("pickup-count").addEventListener("input", () => {
        refreshMoveButtons("#pickup-container", "from");
    });
    document.getElementById("dropoff-count").addEventListener("input", () => {
        refreshMoveButtons("#dropoff-container", "to");
    });
});

function toggleSwapVisibility() {
    const pickupCount = parseInt(document.getElementById("pickup-count").value, 10);
    const dropoffCount = parseInt(document.getElementById("dropoff-count").value, 10);
    const swapBtn = document.getElementById("swap-btn");

    if (pickupCount === 1 && dropoffCount === 1) {
        swapBtn.disabled = false;
        swapBtn.style.visibility = "visible";   // látszik
        swapBtn.style.opacity = "1";            // teljesen átlátszatlan
    } else {
        swapBtn.disabled = true;                // nem kattintható
        swapBtn.style.visibility = "hidden";    // helyet foglal, de nem látszik
        swapBtn.style.opacity = "0";            // teljesen átlátszó
    }
}

// eseményfigyelők a szám inputokra
document.getElementById("pickup-count").addEventListener("input", toggleSwapVisibility);
document.getElementById("dropoff-count").addEventListener("input", toggleSwapVisibility);

// első betöltéskor fusson le
document.addEventListener("DOMContentLoaded", toggleSwapVisibility);

document.addEventListener('DOMContentLoaded', function() {
    const pickupCountInput = document.getElementById('pickup-count');
    const dropoffCountInput = document.getElementById('dropoff-count');
    const pickupContainer = document.getElementById('pickup-container');
    const dropoffContainer = document.getElementById('dropoff-container');
    const pickupTemplate = document.getElementById('pickup-template').content;
    const dropoffTemplate = document.getElementById('dropoff-template').content;
    const MAX_TOTAL = 10;
    const MAX_EACH = 5;
    const MIN_EACH = 1;

    // ===== Helper: create node from template and index it =====
    function createNode(template, index) {
        const node = template.cloneNode(true);
        const html = node.firstElementChild.outerHTML.replace(/__INDEX__/g, index);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;

        wrapper.querySelectorAll('input, select, textarea').forEach(el => {
            if (!el.id) {
                const baseName = (el.getAttribute('name') || 'fld').replace(/\[.*\]$/, '');
                el.id = `${baseName.replace(/[^a-z0-9_-]/gi, '')}_${index}`;
            }
        });
        return wrapper.firstElementChild;
    }

    // ===== Read / apply values =====
    function readValues(container) {
        const values = [];
        container.querySelectorAll('fieldset').forEach(fs => {
            const obj = {};
            fs.querySelectorAll('input, select, textarea').forEach(el => {
                const name = el.getAttribute('name') || '';
                obj[name] = (el.type === 'checkbox') ? el.checked : el.value;
            });
            values.push(obj);
        });
        return values;
    }

    function applyValuesToNew(node, valuesObj) {
        node.querySelectorAll('input, select, textarea').forEach(el => {
            const name = el.getAttribute('name');
            if (!name) return;
            for (const k in valuesObj) {
                const baseK = k.replace(/\[\d+\]$/, '');
                const baseName = name.replace(/\[\d+\]$/, '');
                if (baseK === baseName) {
                    if (el.type === 'checkbox') el.checked = valuesObj[k] === "on" || valuesObj[k] === true || valuesObj[k] === "true";
                    else el.value = valuesObj[k] || '';
                }
            }
        });
    }

    // ===== Render pickups / dropoffs =====
    function renderPickups(count) {
        const oldVals = readValues(pickupContainer);
        pickupContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const fs = createNode(pickupTemplate, i);

            // egyedi datalist beállítás, ha van
            const cityInput = fs.querySelector('input[name="from_city['+i+']"]');
            if (cityInput) {
                const datalist = fs.querySelector('datalist');
                if (datalist) {
                    const uniqueId = 'city-list-pickup-' + i;
                    datalist.id = uniqueId;
                    cityInput.setAttribute('list', uniqueId);
                }
            }

            if (oldVals[i]) applyValuesToNew(fs, oldVals[i]);
            else if (oldVals.length > 0) applyValuesToNew(fs, oldVals[Math.min(i, oldVals.length-1)]);
            pickupContainer.appendChild(fs);
        }
        refreshMoveButtons('#pickup-container', 'from');
    }

    function renderDropoffs(count) {
        const oldVals = readValues(dropoffContainer);
        dropoffContainer.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const fs = createNode(dropoffTemplate, i);

            const cityInput = fs.querySelector('input[name="to_city['+i+']"]');
            if (cityInput) {
                const datalist = fs.querySelector('datalist');
                if (datalist) {
                    const uniqueId = 'city-list-dropoff-' + i;
                    datalist.id = uniqueId;
                    cityInput.setAttribute('list', uniqueId);
                }
            }

            if (oldVals[i]) applyValuesToNew(fs, oldVals[i]);
            else if (oldVals.length > 0) applyValuesToNew(fs, oldVals[Math.min(i, oldVals.length-1)]);
            dropoffContainer.appendChild(fs);
        }
        refreshMoveButtons('#dropoff-container', 'to');
    }

    // ===== Limits =====
    function syncLimits(changed) {
        let pickups = parseInt(pickupCountInput.value) || 1;
        let dropoffs = parseInt(dropoffCountInput.value) || 1;

        if (pickups < MIN_EACH) pickups = MIN_EACH;
        if (pickups > MAX_EACH) pickups = MAX_EACH;
        if (dropoffs < MIN_EACH) dropoffs = MIN_EACH;
        if (dropoffs > MAX_EACH) dropoffs = MAX_EACH;

        if (pickups + dropoffs > MAX_TOTAL) {
            if (changed === 'pickup') dropoffs = Math.max(MIN_EACH, MAX_TOTAL - pickups);
            else if (changed === 'dropoff') pickups = Math.max(MIN_EACH, MAX_TOTAL - dropoffs);
        }

        pickupCountInput.value = pickups;
        dropoffCountInput.value = dropoffs;

        pickupCountInput.max = Math.min(MAX_EACH, MAX_TOTAL - dropoffs + pickups);
        dropoffCountInput.max = Math.min(MAX_EACH, MAX_TOTAL - pickups + dropoffs);
    }

    // ===== Events =====
    pickupCountInput.addEventListener('change', () => { syncLimits('pickup'); renderPickups(parseInt(pickupCountInput.value)); });
    dropoffCountInput.addEventListener('change', () => { syncLimits('dropoff'); renderDropoffs(parseInt(dropoffCountInput.value)); });

    pickupCountInput.addEventListener('input', () => {
        let v = parseInt(pickupCountInput.value) || 1;
        if (v < MIN_EACH) v = MIN_EACH;
        if (v > MAX_EACH) v = MAX_EACH;
        pickupCountInput.value = v;
    });
    dropoffCountInput.addEventListener('input', () => {
        let v = parseInt(dropoffCountInput.value) || 1;
        if (v < MIN_EACH) v = MIN_EACH;
        if (v > MAX_EACH) v = MAX_EACH;
        dropoffCountInput.value = v;
    });

    // ===== Initialize =====
    syncLimits();
    renderPickups(parseInt(pickupCountInput.value || 1));
    renderDropoffs(parseInt(dropoffCountInput.value || 1));

    // ===== Form validation =====
    const freightForm = document.querySelector('.freight-form');
    if (freightForm) {
        freightForm.addEventListener('submit', function(e) {
            console.log("Form submit validation");
            const p = parseInt(pickupCountInput.value) || 1;
            const d = parseInt(dropoffCountInput.value) || 1;
            if (p < 1 || d < 1 || (p + d) > MAX_TOTAL) {
                e.preventDefault();
                alert('Érvénytelen fel- vagy lerakó szám. Ellenőrizd a beállításokat (összesen max 10).');
            }
        });
    }
});

//// Tab váltás
var tabs = document.querySelectorAll('.tab-btn');
tabs.forEach(btn => {
   btn.addEventListener('click', () => {
       tabs.forEach(b => b.classList.remove('active'));
       btn.classList.add('active');

       document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
       const activeTab = document.getElementById(btn.dataset.tab);
       activeTab.style.display = 'block';
   });
});

function decodeHTML(html) {
   const txt = document.createElement("textarea");
   txt.innerHTML = html;
   return txt.value;
}

function fillCargoForm(data) {
   // Honnan
   // console.log('Form tab:', document.querySelector('[data-tab="form-tab"]'));
   // console.log("fillCargoForm data:", data);

   document.querySelector('input[name="from_country"]').value = data.from_country || '';
   document.querySelector('input[name="from_postcode"]').value = data.from_postcode || '';
   document.querySelector('input[name="from_city"]').value = data.from_city || '';
   document.querySelector('input[name="is_hidden_from"]').checked = data.is_hidden_from || false;

   document.querySelector('input[name="to_country"]').value = data.to_country || '';
   document.querySelector('input[name="to_postcode"]').value = data.to_postcode || '';
   document.querySelector('input[name="to_city"]').value = data.to_city || '';
   document.querySelector('input[name="is_hidden_to"]').checked = data.is_hidden_to || false;

   document.querySelector('input[name="departure_from"]').value = data.departure_from || '';
   document.querySelector('input[name="departure_from_time_start"]').value = data.departure_from_time_start || '';
   document.querySelector('input[name="departure_from_time_end"]').value = data.departure_from_time_end || '';
   document.querySelector('input[name="departure_end_date"]').value = data.departure_end_date || '';
   document.querySelector('input[name="departure_end_time_start"]').value = data.departure_end_time_start || '';
   document.querySelector('input[name="departure_end_time_end"]').value = data.departure_end_time_end || '';

   document.querySelector('input[name="arrival_start_date"]').value = data.arrival_start_date || '';
   document.querySelector('input[name="arrival_start_time_start"]').value = data.arrival_start_time_start || '';
   document.querySelector('input[name="arrival_start_time_end"]').value = data.arrival_start_time_end || '';
   document.querySelector('input[name="arrival_end_date"]').value = data.arrival_end_date || '';
   document.querySelector('input[name="arrival_end_time_start"]').value = data.arrival_end_time_start || '';
   document.querySelector('input[name="arrival_end_time_end"]').value = data.arrival_end_time_end || '';

   document.querySelector('input[name="length"]').value = data.length || '';
   document.querySelector('input[name="weight"]').value = data.weight || '';
   document.querySelector('input[name="description"]').value = data.description || '';

   document.querySelector('select[name="vehicle_type"]').value = data.vehicle_type || '';
   document.querySelector('select[name="superstructure"]').value = data.superstructure || '';
   document.querySelector('input[name="certificates"]').value = data.certificates || '';
   document.querySelector('input[name="cargo_securement"]').value = data.cargo_securement || '';

   const equipmentSelect = document.querySelectorAll('#equipment-checkboxes input[type="checkbox"]');
   equipmentSelect.forEach(cb => cb.checked = data.equipment?.includes(cb.value) || false);


   // Automatikusan vált a form tabra
   document.querySelector('[data-tab="form-tab"]').click();
}

const emailCache = {};

document.getElementById('open-gmail').addEventListener('click', function() {
   fetch('/email/api/gmail-emails')
   .then(res => res.json())
   .then(data => {
       const container = document.getElementById('email-container');

       data.forEach(email => {
           if (document.getElementById(`email-${email.id}`)) return;

           const card = document.createElement('div');
           card.classList.add('email-card');
           card.id = `email-${email.id}`;
           card.style.borderBottom = "1px solid #ddd";
           card.style.padding = "5px 0";

           const title = document.createElement('h4');
           title.textContent = `${decodeHTML(email.from)}  :  ${decodeHTML(email.subject)}`;
           title.style.fontWeight = 'bold';
           card.appendChild(title);

           const bodyDiv = document.createElement('div');
           bodyDiv.classList.add('email-body');
           bodyDiv.style.display = 'none';
           bodyDiv.style.marginTop = '5px';
           card.appendChild(bodyDiv);

           // Rakomány gomb
           const button = document.createElement('button');
           button.textContent = "Rakománnyá alakítás";
           button.style.marginLeft = "10px";

           button.addEventListener('click', (e) => {
               e.stopPropagation(); // ne nyissa/csukja a body-t
               fetch(`/email/api/gmail-email-ai/${email.id}`)
                   .then(res => res.json())
                   .then(data => fillCargoForm(data))
                   .catch(console.error);
           });

           card.appendChild(button);

           card.addEventListener('click', () => {
               if (bodyDiv.style.display === 'none') {
                   if (emailCache[email.id]) {
                       bodyDiv.innerHTML = emailCache[email.id];
                       bodyDiv.style.display = 'block';
                       title.style.fontWeight = 'normal';
                   } else {
                       fetch(`/email/api/gmail-email/${email.id}`)
                       .then(res => res.json())
                       .then(full => {
                           let content = '';
                           if (/<[a-z][\s\S]*>/i.test(full.body)) {
                               content = full.body;
                           } else {
                               content = `<pre>${full.body}</pre>`;
                           }
                           bodyDiv.innerHTML = content;
                           bodyDiv.style.display = 'block';
                           emailCache[email.id] = content;
                           title.style.fontWeight = 'normal';
                       })
                       .catch(console.error);
                   }
               } else {
                   bodyDiv.style.display = 'none';
                   title.style.fontWeight = 'bold';
               }
           });

           container.appendChild(card);
       });

       // Automatikusan vált az Emails tabra
       document.querySelector('[data-tab="emails-tab"]').click();
   })
   .catch(console.error);
});

// -----------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function () {
   const swapBtn = document.getElementById("swap-btn");

   swapBtn.addEventListener("click", function () {
       const pickup0 = document.querySelector(".pickup-fieldset");
       const dropoff0 = document.querySelector(".dropoff-fieldset");
       if (!pickup0 || !dropoff0) return;

       // swapolandó mezők párosítása
       const fields = [
           ["from_country[0]", "to_country[0]"],
           ["from_postcode[0]", "to_postcode[0]"],
           ["from_city[0]", "to_city[0]"]
       ];

       fields.forEach(([fromName, toName]) => {
           const elA = document.querySelector(`[name="${fromName}"]`);
           const elB = document.querySelector(`[name="${toName}"]`);
           if (!elA || !elB) return;

           if (elA.type === "checkbox") {
               // checkbox checked állapot csere
               const tmp = elA.checked;
               elA.checked = elB.checked;
               elB.checked = tmp;
           } else {
               // input value csere
               const tmp = elA.value;
               elA.value = elB.value;
               elB.value = tmp;
           }
       });
   });
});

document.addEventListener('DOMContentLoaded', function() {
   const accordionBtn = document.querySelector('.accordion-btn');
   const accordionContent = document.querySelector('.accordion-content');

   accordionBtn.addEventListener('click', () => {
       if (accordionContent.style.display === "block") {
           accordionContent.style.display = "none";
       } else {
           accordionContent.style.display = "block";
       }
   });
});

let expanded = { equipment: false, cargo: false };

function toggleCheckboxes(type) {
   const checkboxes = document.getElementById(type + "-checkboxes");
   checkboxes.style.display = expanded[type] ? "none" : "grid";
   expanded[type] = !expanded[type];
}

// Szinkronizálás a hidden selecttel
function initMultiselect(type) {
    const checkboxes = document.querySelectorAll(`#${type}-checkboxes input[type="checkbox"]`);
    const hiddenSelect = document.getElementById(type);
    const selectedSpan = document.getElementById(type + "-selected");

    function updateSelection() {
        const checkedValues = [];
        checkboxes.forEach(cb => {
            const option = Array.from(hiddenSelect.options).find(o => o.value === cb.value);
            if(option) option.selected = cb.checked;
            if(cb.checked) {
                checkedValues.push(cb.value);
                cb.parentElement.classList.add('selected');
            } else {
                cb.parentElement.classList.remove('selected');
            }
        });
        selectedSpan.textContent = checkedValues.length ? checkedValues.join(', ') :
            (type==='equipment' ? 'Válassz felszereltséget' : 'Válassz rakományrögzítést');
    }

    // Event listener minden checkboxra
    checkboxes.forEach(cb => cb.addEventListener('change', updateSelection));

    // Betöltéskor frissítés (még nincs template, csak a checked állapot)
    updateSelection();

    // Visszaadjuk a frissítő függvényt, hogy később sablon alapján meghívhassuk
    return function selectValue(value) {
        if(!value) return;
        checkboxes.forEach(cb => cb.checked = (cb.value === value));
        updateSelection();
    };
}

// --- Init DOM betöltéskor ---
const selectEquipment = initMultiselect('equipment');
const selectSecurement = initMultiselect('securement');

// Bezárás kattintás máshova
document.addEventListener('click', function(event) {
   ['equipment','securement'].forEach(type => {
       const multiselect = document.querySelector(`#${type}-checkboxes`).parentElement;
       if (!multiselect.contains(event.target)) {
           document.getElementById(type + "-checkboxes").style.display = "none";
           expanded[type] = false;
       }
   });
});

window.addEventListener('DOMContentLoaded', () => {
   function nextWeekday(date, n = 1) {
       let result = new Date(date);
       let added = 0;
       while (added < n) {
           result.setDate(result.getDate() + 1);
           const day = result.getDay();
           if (day !== 0 && day !== 6) { // 0 = vasárnap, 6 = szombat
               added++;
           }
       }
       return result;
   }

   function formatDate(date) {
       const yyyy = date.getFullYear();
       const mm = String(date.getMonth() + 1).padStart(2, '0');
       const dd = String(date.getDate()).padStart(2, '0');
       return `${yyyy}-${mm}-${dd}`;
   }

   const dateInputs = document.querySelectorAll('input[type="date"]');
   const today = new Date();

   if(dateInputs.length >= 4){
       dateInputs[0].value = formatDate(today); // Ma
       dateInputs[1].value = formatDate(nextWeekday(today, 1)); // Következő munkanap
       dateInputs[2].value = formatDate(nextWeekday(today, 1)); // Következő munkanap
       dateInputs[3].value = formatDate(nextWeekday(today, 2)); // Következő utáni munkanap
   }

   // document.querySelector('input[name="departure_from_time_start"]').value = "08:00";
   // document.querySelector('input[name="departure_from_time_end"]').value = "16:00";
   // document.querySelector('input[name="departure_end_time_start"]').value = "08:00";
   // document.querySelector('input[name="departure_end_time_end"]').value = "16:00";
   // document.querySelector('input[name="arrival_start_time_start"]').value = "08:00";
   // document.querySelector('input[name="arrival_start_time_end"]').value = "16:00";
   // document.querySelector('input[name="arrival_end_time_start"]').value = "08:00";
   // document.querySelector('input[name="arrival_end_time_end"]').value = "16:00";
});

window.addEventListener('DOMContentLoaded', () => {
   const dateInputs = document.querySelectorAll('input[type="date"]');

   dateInputs.forEach(input => {
       input.addEventListener("input", () => validateDates(dateInputs));
   });

   function validateDates(inputs) {
   const depStart = new Date(inputs[0].value);
   const depEnd   = new Date(inputs[1].value);
   const arrStart = new Date(inputs[2].value);
   const arrEnd   = new Date(inputs[3].value);

   // pickup vége >= pickup kezdete
   if (depEnd < depStart) {
       inputs[1].setCustomValidity("A felvétel vége nem lehet a kezdete előtt.");
   } else {
       inputs[1].setCustomValidity("");
   }

   // delivery kezdete >= pickup kezdete
   if (arrStart < depStart) {
       inputs[2].setCustomValidity("A letétel nem lehet korábbi, mint a felvétel kezdete.");
   } else {
       inputs[2].setCustomValidity("");
   }

   // delivery vége >= pickup vége
   if (arrEnd < depEnd) {
       inputs[3].setCustomValidity("A letétel vége nem lehet korábbi, mint a felvétel vége.");
   } else {
       inputs[3].setCustomValidity("");
   }

   // delivery vége >= delivery eleje
   if (arrEnd < arrStart) {
       inputs[3].setCustomValidity("A letétel vége nem lehet korábbi, mint a letétel eleje.");
   } else {
       inputs[3].setCustomValidity("");
   }
}
});

document.addEventListener("DOMContentLoaded", () => {
   const form = document.querySelector(".freight-form");
   const inputs = form.querySelectorAll("input[required], select[required]");

   inputs.forEach(input => {
       // ha elhagyta a mezőt, jelzi a hibát
       input.addEventListener("blur", () => {
           input.dataset.touched = "true";
           validateInput(input);
       });

       // ha ír bele valamit, újra ellenőriz
       input.addEventListener("input", () => {
           if (input.dataset.touched === "true") {
               validateInput(input);
           }
       });
   });

   form.addEventListener("submit", (e) => {
       console.log("Form submit validation");
       let valid = true;
       inputs.forEach(input => {
           if (!validateInput(input)) {
               valid = false;
           }
       });
       if (!valid) {
           e.preventDefault(); // ne küldje el
       }
   });

   function validateInput(input) {
       let isValid = true;
       if (input.hasAttribute("required") && !input.value) {
           isValid = false;
           input.classList.add("invalid");
       } else {
           input.classList.remove("invalid");
       }
       return isValid;
   }
});

// window.addEventListener('DOMContentLoaded', () => {
//     const form = document.querySelector('.freight-form');
//
//     form.addEventListener('submit', async (e) => {
//         console.log('AJAX form submit');
//         e.preventDefault(); // **Fontos**, hogy ne töltse újra az oldalt
//
//         // Korábbi hibák törlése
//         form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
//         form.querySelectorAll('.error-msg').forEach(el => el.remove());
//
//         // Form adatok összegyűjtése
//         const formData = new FormData(form);
//
//         try {
//             const response = await fetch(form.action, {
//                 method: 'POST',
//                 body: formData,
//                 headers: {
//                     "X-Requested-With": "XMLHttpRequest" // jelezzük, hogy AJAX
//                 }
//             });
//
//             const data = await response.json();
//
//             if (!data.success) {
//                 // Hibák megjelenítése
//                 for (const [fieldName, msg] of Object.entries(data.errors || {})) {
//                     const field = form.querySelector(`[name="${fieldName}"]`);
//                     if (field) {
//                         field.classList.add('error');
//                         const errorSpan = document.createElement('span');
//                         errorSpan.classList.add('error-msg');
//                         errorSpan.textContent = msg;
//                         field.parentNode.appendChild(errorSpan);
//                     }
//                 }
//                 alert("Hiba történt a mentés során!");
//             }
//
//         } catch (err) {
//             console.error(err);
//             alert("Hálózati vagy szerverhiba történt!");
//         }
//     });
// });

// template betöltés és autocomplete városkeresés
document.addEventListener('DOMContentLoaded', function() {
    const templateSelect = document.getElementById('template_select');

    // --- Segédfüggvények ---
    function nextWeekday(date, n = 1) {
        let result = new Date(date);
        let added = 0;
        while (added < n) {
            result.setDate(result.getDate() + 1);
            const day = result.getDay();
            if (day !== 0 && day !== 6) added++;
        }
        return result;
    }

    function formatDate(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    async function fetchCitySuggestions(q) {
        if (!q || q.trim().length < 2) return [];
        try {
            const res = await fetch('/cargo/ajax/city_search?q=' + encodeURIComponent(q));
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            // console.log('[autocomplete] fetch', q, '→', data.length, 'results');
            return Array.isArray(data) ? data.slice(0, 10) : [];
        } catch (err) {
            console.warn('[autocomplete] fetch error', err);
            return [];
        }
    }

    function formatDisplay(item) {
        // formátum amit a backend split_city_string ismer: "City, CC (ZIP)"
        const zip = item.zipcode || '';
        const cc = item.country_code || '';
        return `${item.city_name}${cc ? ', ' + cc : ''}${zip ? ' (' + zip + ')' : ''}`;
    }

    function findResultsListFor(input) {
        // keresünk sibling UL.search-results (a sablonban ott van)
        const wrapper = input.closest('.left-side') || input.parentElement;
        if (!wrapper) return null;
        return wrapper.querySelector('.search-results');
    }

    function setHiddenFieldsFromFieldset(fieldset, country, postcode) {
        // próbálunk sokféle selectorral találni (class, name, id) hogy kompatibilis legyen
        const countryEl = fieldset.querySelector('.city-country') || fieldset.querySelector('input[name^="from_country"]') || fieldset.querySelector('input[name^="to_country"]');
        const postEl = fieldset.querySelector('.city-postcode') || fieldset.querySelector('input[name^="from_postcode"]') || fieldset.querySelector('input[name^="to_postcode"]');
        const validEl = fieldset.querySelector('.city-valid') || fieldset.querySelector('input[name^="from_city_valid"]') || fieldset.querySelector('input[name^="to_city_valid"]');

        if (countryEl) countryEl.value = country || '';
        if (postEl) postEl.value = postcode || '';
        if (validEl) validEl.value = '1';
        // console.log('[autocomplete] hidden set:', { country, postcode, validEl: !!validEl });
    }

    function clearHiddenFieldsFromFieldset(fieldset) {
        const countryEl = fieldset.querySelector('.city-country') || fieldset.querySelector('input[name^="from_country"]') || fieldset.querySelector('input[name^="to_country"]');
        const postEl = fieldset.querySelector('.city-postcode') || fieldset.querySelector('input[name^="from_postcode"]') || fieldset.querySelector('input[name^="to_postcode"]');
        const validEl = fieldset.querySelector('.city-valid') || fieldset.querySelector('input[name^="from_city_valid"]') || fieldset.querySelector('input[name^="to_city_valid"]');

        if (countryEl) countryEl.value = '';
        if (postEl) postEl.value = '';
        if (validEl) validEl.value = '0';
        // console.log('[autocomplete] hidden cleared');
    }

    async function openSuggestionsForInput(inputEl, query) {
        const ul = findResultsListFor(inputEl);
        if (!ul) {
            console.warn('Nincs search-results ul a mező mellett');
            return;
        }
        ul.innerHTML = '';
        ul.style.display = 'none';

        if (!query || query.trim().length < 2) return;

        const suggestions = await fetchCitySuggestions(query);
        if (!suggestions.length) return;

        suggestions.forEach(item => {
            const li = document.createElement('li');
            li.className = 'result-item';
            li.textContent = formatDisplay(item);
            // tároljuk az objektumot data attribútumban (JSON)
            li.dataset.item = JSON.stringify(item);

            li.addEventListener('click', function() {
                const obj = JSON.parse(this.dataset.item || '{}');
                const display = formatDisplay(obj);
                // kitöltjük az inputot a full formátummal (backend-compatibilis)
                inputEl.value = display;

                // hidden mezők és valid jelölése a fieldset-ben
                const fieldset = inputEl.closest('fieldset') || inputEl.parentElement;
                setHiddenFieldsFromFieldset(fieldset, obj.country_code || obj.country || '', obj.zipcode || '');

                // elrejtjük a listát
                ul.style.display = 'none';
                ul.innerHTML = '';
                // console.log('[autocomplete] selected:', display);
            });

            ul.appendChild(li);
        });

        ul.style.display = 'block';
    }

    async function autoSelectFirstSuggestion(inputEl, query) {
        const suggestions = await fetchCitySuggestions(query);
        if (!suggestions.length) {
            console.warn('[autocomplete] nincs találat automata kiválasztáshoz:', query);
            return;
        }
        const obj = suggestions[0]; // első találat
        const display = formatDisplay(obj);

        inputEl.value = display;

        const fieldset = inputEl.closest('fieldset') || inputEl.parentElement;
        setHiddenFieldsFromFieldset(fieldset, obj.country_code || obj.country || '', obj.zipcode || '');
        // console.log('[autocomplete] auto-selected:', display);
    }


    // Ha sablon betöltés történik: csak városnév kerül a mezőbe, hidden-ek törlődnek, autocomplete lefut és megmutatja a találatokat.
    templateSelect && templateSelect.addEventListener('change', async function() {
        const templateId = this.value;
        if (!templateId) return;

        try {
            const res = await fetch(`/cargo/template/${templateId}`);
            const data = await res.json();
            if (!data.success) {
                alert('Hiba a sablon betöltésekor: ' + data.error);
                return;
            }
            const template = data.template;

            console.log(template)

            // --- Általános mezők ---
            document.getElementById('weight').value = template.weight || '';
            document.getElementById('length').value = template.size || '';
            document.getElementById('price').value = template.price || '';
            if (template.currency) document.getElementById('currency').value = template.currency;
            document.getElementById('description').value = template.description || '';
            document.getElementById('vehicle_type').value = template.vehicle_type || '';
            document.getElementById('superstructure').value = template.structure || '';
            document.getElementById('vehicle_notes').value = template.note || '';

            // --- Multiselect-ek ---
            if(template.equipment) selectEquipment(template.equipment);
            if(template.cargo_securement) selectSecurement(template.cargo_securement);

            // --- PICKUPS ---
            const pickupContainer = document.getElementById('pickup-container');
            pickupContainer.innerHTML = '';
            for (let i = 0; i < template.pickups.length; i++) {
                const loc = template.pickups[i];
                const frag = document.getElementById('pickup-template').content.cloneNode(true);

                frag.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.name) el.name = el.name.replace('__INDEX__', i);
                });

                pickupContainer.appendChild(frag);

                const fs = pickupContainer.querySelectorAll('fieldset')[pickupContainer.querySelectorAll('fieldset').length - 1];
                if (!fs) continue;

                const cityInput = fs.querySelector('.city-search');
                if (cityInput && [loc.city, loc.country, loc.postcode].some(Boolean)) {
                    const query = [loc.city, loc.country, loc.postcode].filter(Boolean).join(' ');
                    cityInput.value = query;
                    clearHiddenFieldsFromFieldset(fs);
                    if (query.trim().length >= 2) await autoSelectFirstSuggestion(cityInput, query);
                }

                // Dátum kitöltés
                const startDateInput = fs.querySelector('input[name^="from_start_date"]');
                const endDateInput = fs.querySelector('input[name^="from_end_date"]');
                if (startDateInput && endDateInput) {
                    const today = new Date();
                    startDateInput.value = formatDate(today);
                    endDateInput.value = formatDate(nextWeekday(today, 1));
                }
            }

            // --- DROPOFFS ---
            const dropoffContainer = document.getElementById('dropoff-container');
            dropoffContainer.innerHTML = '';
            for (let i = 0; i < template.dropoffs.length; i++) {
                const loc = template.dropoffs[i];
                const frag = document.getElementById('dropoff-template').content.cloneNode(true);

                frag.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.name) el.name = el.name.replace('__INDEX__', i);
                });

                dropoffContainer.appendChild(frag);

                const fs = dropoffContainer.querySelectorAll('fieldset')[dropoffContainer.querySelectorAll('fieldset').length - 1];
                if (!fs) continue;

                const cityInput = fs.querySelector('.city-search');
                if (cityInput && [loc.city, loc.country, loc.postcode].some(Boolean)) {
                    const query = [loc.city, loc.country, loc.postcode].filter(Boolean).join(' ');
                    cityInput.value = query;
                    clearHiddenFieldsFromFieldset(fs);
                    if (query.trim().length >= 2) await autoSelectFirstSuggestion(cityInput, query);
                }

                // Dátum kitöltés
                const startDateInput = fs.querySelector('input[name^="to_start_date"]');
                const endDateInput = fs.querySelector('input[name^="to_end_date"]');
                if (startDateInput && endDateInput) {
                    const today = new Date();
                    const startNext = nextWeekday(today, 1);
                    const endNext = nextWeekday(startNext, 1);
                    startDateInput.value = formatDate(startNext);
                    endDateInput.value = formatDate(endNext);
                }
            }

            // ✅ Palettacsere és túlméretes áru kijelzés
            const paletteCard = document.getElementById('paletteCard');
            const paletteInput = document.getElementById('palette_exchange');
            const oversizeCard = document.getElementById('oversizeCard');
            const oversizeInput = document.getElementById('oversize');

            function isTrue(val) {
                return val === true || val === 'true' || val === 1 || val === '1';
            }

            if (isTrue(template.palette_exchange)) {
                paletteCard.classList.add('active');
                paletteInput.value = "true";
            } else {
                paletteCard.classList.remove('active');
                paletteInput.value = "false";
            }
            if (isTrue(template.oversize)) {
                oversizeCard.classList.add('active');
                oversizeInput.value = "true";
            } else {
                oversizeCard.classList.remove('active');
                oversizeInput.value = "false";
            }

            // Frissítjük a számláló mezőket
            document.getElementById('pickup-count').value = template.pickups.length;
            document.getElementById('dropoff-count').value = template.dropoffs.length;

        } catch (err) {
            console.error('[template] betöltési hiba:', err);
            alert('Hiba történt a sablon betöltésekor.');
        }


    });

    // --- Sablon törlés gomb kezelése ---
    // --- Egyedi dropdown sablonkezelés ---
    const dropdown = document.getElementById('template-dropdown');
    const realSelect = document.getElementById('template_select');

    // --- Dropdown újrarenderelése ---
    function renderTemplateDropdown() {
        const templates = Array.from(realSelect.options).filter(o => o.value && o.value !== "");

        dropdown.innerHTML = '';

        // Header
        const header = document.createElement('div');
        header.className = 'dropdown-header';
        header.textContent = 'Válassz sablont';
        dropdown.appendChild(header);

        // Lista
        const list = document.createElement('div');
        list.className = 'dropdown-list';

        if (templates.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'dropdown-item';
            empty.textContent = 'Jelenleg még nincs sablon';
            list.appendChild(empty);
        } else {
            templates.forEach(opt => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';

                const text = document.createElement('span');
                text.textContent = opt.textContent;

                const del = document.createElement('button');
                del.type = 'button'; // nagyon fontos
                del.className = 'delete-btn';
                del.title = 'Sablon törlése';
                del.textContent = '✕';

                // --- Törlés esemény ---
                del.addEventListener('click', async e => {
                    e.stopPropagation();
                    e.preventDefault(); // Nincs form submit
                    if (!confirm('Biztosan törlöd ezt a sablont?')) return;

                    try {
                        const res = await fetch(`/cargo/template/delete/${opt.value}`, { method: 'POST' });
                        const data = await res.json();
                        if (data.success) {
                            opt.remove();
                            renderTemplateDropdown();
                        } else {
                            alert('Hiba történt: ' + (data.error || 'Ismeretlen hiba.'));
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Hálózati hiba.');
                    }
                });

                // --- Betöltés esemény ---
                item.addEventListener('click', async () => {
                    header.textContent = opt.textContent;
                    realSelect.value = opt.value;
                    dropdown.classList.remove('open');

                    // Kiváltjuk az eredeti change-t, hogy a sablon betöltődjön
                    const ev = new Event('change', { bubbles: true });
                    realSelect.dispatchEvent(ev);
                });

                item.appendChild(text);
                item.appendChild(del);
                list.appendChild(item);
            });
        }
        dropdown.appendChild(list);
        // Header click toggle
        header.addEventListener('click', () => {
            dropdown.classList.toggle('open');
        });
    }

    renderTemplateDropdown();

    // Bezárás kattintásra a body más részén
    document.addEventListener('click', e => {
        if (!dropdown.contains(e.target)) dropdown.classList.remove('open');
    });

    // - extra: ha a user gépel az inputba, a meglévő delegated autocomplete jQuery kód működni fog -
    //   de a sablon-újrakészítésnél függetlenül betöltjük a találatokat (openSuggestionsForInput),
    //   így a felhasználónak tényleg ki kell választania egy találatot.
});

function setupCityAutocomplete(selector) {
    document.querySelectorAll(selector).forEach(input => {
        input.addEventListener('input', async function () {
            const query = this.value.trim();
            if (query.length < 2) return; // legalább 2 karakter kell

            try {
                const response = await fetch(`/cargo/api/cities?q=${encodeURIComponent(query)}`);
                const cities = await response.json();

                // töröljük a régi datalistát
                let listId = this.getAttribute('list');
                let datalist = document.getElementById(listId);
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    listId = `city-list-${Math.random().toString(36).substring(2, 9)}`;
                    datalist.id = listId;
                    this.setAttribute('list', listId);
                    document.body.appendChild(datalist);
                }
                datalist.innerHTML = '';

                // új opciók betöltése
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = `${city.city_name} (${city.zipcode})`;
                    option.dataset.cityId = city.id;
                    option.dataset.country = city.country_code;
                    datalist.appendChild(option);
                });

            } catch (err) {
                console.error("Autocomplete fetch error:", err);
            }
        });
    });
}

// Inicializáljuk a pickup/dropoff inputokra
setupCityAutocomplete('input[name^="from_city"]');
setupCityAutocomplete('input[name^="to_city"]');

$(document).ready(function() {
    var table;
    if (!$.fn.DataTable.isDataTable('#vehiclesTable')) {
        table = $('#vehiclesTable').DataTable({
            dom: '<"top"f>rt<"bottom"lip>',
            "order": [[15, "desc"], [0, "asc"]],  // created_at csökkenő szerint
            "pageLength": 25,
            "stripeClasses": ['odd-row', 'even-row']
        });
    } else {
        table = $('#vehiclesTable').DataTable();
    }

    // Sor kattintás (például részletek megjelenítéshez később)
    $('#vehiclesTable tbody').on('click', 'tr', function() {
        var data = table.row(this).data();
        // console.log("Kiválasztott jármű:", data);
    });
});

// --- COUNTRY GEOJSON LAZY LOAD + CACHE ---
const countryBorders = {};
const countryPromises = {}; // cache a fetch Promise-okhoz

async function drawCountryIfNeeded(countryCode, layer, color) {
    console.log("drawCountryIfNeeded hívás:", countryCode);

    if (!countryCode) {
        console.log("Nincs countryCode");
        return;
    }

    if (!countryBorders[countryCode]) {
        console.log("GeoJSON nincs még cache-ben:", countryCode);
        if (!countryPromises[countryCode]) {
            console.log("Új fetch Promise létrehozása:", countryCode);
            countryPromises[countryCode] = fetch(`/static/geojson/countries/${countryCode}.geojson`)
            .then(res => res.text())
            .then(text => {
                try {
                    const geojson = JSON.parse(text);
                    console.log("GeoJSON betöltve:", countryCode, geojson);
                    countryBorders[countryCode] = geojson;
                    return geojson;
                } catch (e) {
                    console.error("JSON parse hiba:", countryCode, e, text);
                }
            })
            .catch(e => {
                console.warn("GeoJSON betöltés hiba:", countryCode, e);
            });

        }

        await countryPromises[countryCode];
    } else {
        // console.log("GeoJSON már cache-ben:", countryCode);
    }

    if (countryBorders[countryCode]) {
        console.log("GeoJSON hozzáadása a layerhez:", countryCode);
        L.geoJSON(countryBorders[countryCode], {
            style: { color: color, weight: 2, fillOpacity: 0.1 }
        }).addTo(layer);
    } else {
        console.warn("GeoJSON nincs elérhető:", countryCode);
    }
}

// --- VEHICLE MODAL ---
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".vehicle-row").forEach(function(row) {
        row.addEventListener("click", async function(e) {
            let vehicleId = this.dataset.vehicleId;
            if ($(e.target).closest('.action-column-right').length) return;

            const res = await fetch(`/vehicles/${vehicleId}/details`);
            const html = await res.text();
            let vehicleDetailsEl = document.getElementById("vehicleDetails");
            vehicleDetailsEl.innerHTML = html;

            // Toggle esemény
            const toggle = document.getElementById("route-cities-toggle");
            const content = document.getElementById("route-cities-content");
            if (toggle && content) {
                toggle.addEventListener("click", function() {
                    if (content.style.display === "none") {
                        content.style.display = "block";
                        toggle.textContent = "▼ Útvonal települések";
                    } else {
                        content.style.display = "none";
                        toggle.textContent = "▶ Útvonal települések";
                    }
                });
            }

            let myModalEl = document.getElementById('vehicleModal');
            let myModal = new bootstrap.Modal(myModalEl);
            myModal.show();

            $('#vehicleModal').off('shown.bs.modal').on('shown.bs.modal', async function () {
                // --- TÉRKÉP ---
                if(window.currentVehicleMap){
                    window.currentVehicleMap.remove();
                    window.currentVehicleMap = null;
                }

                window.currentVehicleMap = L.map('map', { preferCanvas: true }).setView([54.0, 15.0], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(window.currentVehicleMap);

                let pickupsLayer = L.layerGroup().addTo(window.currentVehicleMap);
                let dropoffsLayer = L.layerGroup().addTo(window.currentVehicleMap);
                let citiesLayer = L.layerGroup().addTo(window.currentVehicleMap);

                function validCoord(lat,lng){ return !isNaN(lat) && !isNaN(lng) && lat!==0 && lng!==0; }

                let pickups = JSON.parse(vehicleDetailsEl.querySelector("#pickups-data")?.textContent || "[]");
                let dropoffs = JSON.parse(vehicleDetailsEl.querySelector("#dropoffs-data")?.textContent || "[]");
                let allCoords = [];

                // --- EXTRA DESTINATIONS (piros) ---
                let extraDestinations = [];
                try {
                    extraDestinations = JSON.parse(vehicleDetailsEl.querySelector("#extra-destinations")?.textContent || "[]");
                } catch (e) { console.warn("extraDestinations JSON hiba:", e); }
                console.log("extraDestinations:", extraDestinations);
                for (const code of extraDestinations) {
                    console.log("drawing extra destination country:", code);
                    await drawCountryIfNeeded(code, dropoffsLayer, '#d73027');
                }
                console.log("we tried to draw extra destinations");
                // --- PICKUPS (zöld) ---
                for (const p of pickups) {
                    const hasCoords = validCoord(p.lat, p.lng);
                    const needCountry = !hasCoords || p.origin_diff === null;

                    if (hasCoords && p.origin_diff !== null) {
                        L.circleMarker([p.lat, p.lng], {radius:7, color:'#000', fillColor:'#2ca25f', fillOpacity:0.9})
                          .bindPopup(`<b>Felrakó</b><br>${p.city||p.masked_city||''}`)
                          .addTo(pickupsLayer);

                        if (p.radiusKm) {
                            L.circle([p.lat, p.lng], {radius: p.radiusKm*1000, color:'#2ca25f', fillOpacity:0.1})
                             .addTo(pickupsLayer);
                        }
                        allCoords.push([p.lat, p.lng]);
                    }

                    if (needCountry && p.country) {
                        await drawCountryIfNeeded(p.country, pickupsLayer, '#2ca25f');
                    }
                }

                // --- DROPOFFS (piros) ---
                for (const d of dropoffs) {
                    const hasCoords = validCoord(d.lat, d.lng);
                    const needCountry = !hasCoords || d.destination_diff === null;

                    if (hasCoords && d.destination_diff !== null) {
                        L.circleMarker([d.lat, d.lng], {radius:7, color:'#000', fillColor:'#d73027', fillOpacity:0.9})
                          .bindPopup(`<b>Lerakó</b><br>${d.city||d.masked_city||''}`)
                          .addTo(dropoffsLayer);

                        if (d.radiusKm) {
                            L.circle([d.lat, d.lng], {radius: d.radiusKm*1000, color:'#d73027', fillOpacity:0.1})
                             .addTo(dropoffsLayer);
                        }
                        allCoords.push([d.lat, d.lng]);
                    }

                    if (needCountry && d.country) {
                        await drawCountryIfNeeded(d.country, dropoffsLayer, '#d73027');
                    }
                }

                // --- VEHICLE DESTINATIONS (kék) ha pickup=dropoff ---
                const sameLocation = pickups.length === 1 && dropoffs.length === 1 &&
                                     pickups[0].city === dropoffs[0].city &&
                                     pickups[0].country === dropoffs[0].country;

                if (sameLocation) {
                    let vehicleDestinations = [];
                    try {
                        vehicleDestinations = JSON.parse(vehicleDetailsEl.querySelector("#vehicle-destinations")?.textContent || "[]");
                    } catch(e) { console.warn("VehicleDestination JSON hiba:", e); }

                    for (const code of vehicleDestinations) {
                        await drawCountryIfNeeded(code, dropoffsLayer, '#3388ff'); // kék
                    }
                }

                // --- OSRM ÚTVONAL ---
                let routeCoords = [];
                if(allCoords.length>=2){
                    try {
                        let coordPairs = allCoords.map(c=>c[1]+','+c[0]).join(';');
                        let osrmData = await (await fetch('https://router.project-osrm.org/route/v1/driving/'+coordPairs+'?overview=full&geometries=geojson')).json();
                        if(osrmData.routes && osrmData.routes.length){
                            let r = osrmData.routes[0];
                            routeCoords = r.geometry.coordinates.map(c=>[c[1],c[0]]);
                            L.polyline(routeCoords, {color:'#3388ff', weight:3, opacity:0.9}).addTo(window.currentVehicleMap);
                            window.currentVehicleMap.fitBounds(L.polyline(routeCoords).getBounds(), {padding:[30,30]});

                            let km = (r.distance||0)/1000;
                            let infoEl = document.getElementById('route-info');
                            if(infoEl) infoEl.textContent = `Útvonal távolság: ${km.toFixed(1)} km (OSRM)`;
                        } else {
                            routeCoords = allCoords;
                        }
                    } catch(e){ console.warn('OSRM hiba', e); routeCoords = allCoords; }
                }

                // --- Települések a route mentén ---
                if(routeCoords.length>=2){
                    const citiesEl = document.getElementById('route-cities-content');
                    if(!citiesEl) return;

                    const response = await (await fetch('/vehicles/cities_near_route', {
                        method:'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ route: routeCoords, radius_km: 3 })
                    })).json();

                    if(response && response.length){
                        citiesEl.innerHTML = response.map(c=>c.city_name).join(" → ");
                        response.forEach(city=>{
                            if(!pickups.some(p=>p.lat==city.latitude && p.lng==city.longitude) &&
                               !dropoffs.some(d=>d.lat==city.latitude && d.lng==city.longitude)){
                                L.circleMarker([city.latitude, city.longitude], {
                                    radius: 6,
                                    color: '#000',
                                    fillColor: '#3388ff',
                                    fillOpacity: 0.9
                                }).bindPopup(`<b>${city.city_name}</b>`).addTo(citiesLayer);
                            }
                        });
                    }
                }
            });
        });
    });
});


</script>
{% endblock %}