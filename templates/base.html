<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fuvarszervez≈ë{% endblock %}</title>
    

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <meta id="current-user-json" data-json='{{ (current_user.user_id if current_user.is_authenticated else None) | tojson | e }}'>
    <script>
        (function(){
            var metaEl = document.getElementById('current-user-json');
            try {
                var raw = metaEl ? metaEl.getAttribute('data-json') : 'null';
                window.CURRENT_USER_ID = JSON.parse(raw);
            } catch (e) {
                window.CURRENT_USER_ID = null;
            }
        })();
    </script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logiailogo.png') }}">
</head>
<body>
{% block content %}{% endblock %}

<script>
$(document).ready(function() {
    if (typeof CURRENT_USER_ID !== 'undefined' && CURRENT_USER_ID !== null) {
        socket.on('connect', function() {
            socket.emit('join', { room: 'user_' + CURRENT_USER_ID });
        });
    }

    // Global handler: any element with data-offer opens the chat
    $(document).on('click', '[data-offer]', function(e) {
        const offerId = parseInt($(this).attr('data-offer'), 10);
        if (!offerId) return;
        e.preventDefault();
        $.getJSON('/offer_info/' + offerId, function(data) {
            if (!data || data.error) return;

            const isCurrentUserOfferOwner = (CURRENT_USER_ID === data.from_user_id);
            const otherUserId = isCurrentUserOfferOwner ? data.to_user_id : data.from_user_id;
            const otherUserName = isCurrentUserOfferOwner ? data.to_user : data.from_user;
            const otherUserCompany = isCurrentUserOfferOwner ? data.to_user_company : data.from_user_company;
            const otherUserProfile = isCurrentUserOfferOwner ? data.to_user_profile_picture : data.from_user_profile_picture;

            openChatWindow(
                data.cargo_id,
                data.offer_id,
                otherUserName,
                otherUserProfile,
                data,
                otherUserCompany,
                CURRENT_USER_ID,
                otherUserId
            );
        });
    });
});
</script>

{% block scripts %}{% endblock %}
</body>
</html>
