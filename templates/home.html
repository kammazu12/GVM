{% extends "base.html" %}
{% block content %}
<div class="home-container">
    <aside class="sidebar">
        {% include 'sidebar.html' %}
    </aside>
    <main class="main-content">
        <h1 class="cim">Kezdőlap</h1>
        <h2>Hirdetett rakományaim</h2>
        {% if cargos %}
        <div class="table-actions">
            <button id="deleteSelected" title="Törlés">
                <img src="{{ url_for('static', filename='icons/trash.png') }}" style="width:20px">
            </button>
            <button id="republishSelected" title="Újraközlés">
                <img src="{{ url_for('static', filename='icons/refresh.png') }}" style="width:20px">
            </button>
        </div>

        <div class="table-outer">
            <table id="homeTable" class="display" style="font-size: 0.9rem; width:100%;">
                <thead>
                    <tr>
                        <th class="felvet"><input type="checkbox" id="selectAll"></th>
                        <th class="felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                        <th class="felvet">Felvét helyszín</th>
                        <th class="letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                        <th class="letet">Letét helyszín</th>
                        <th class="arujarmu"><img src="{{ url_for('static', filename='icons/length2.png') }}" style="width: 24px"> (m)</th>
                        <th class="arujarmu"><img src="{{ url_for('static', filename='icons/weight.png') }}" style="width: 24px"> (t)</th>
                        <th class="arujarmu">Jármű típusa</th>
                        <th class="arujarmu">Jármű szerkezete</th>
                        <th class="arujarmu">Jármű felszereltsége</th>
                        <th class="arujarmu">Rakomány rögzítése</th>
                        <th class="arujarmu">Extrák</th>
                        <th class="arujarmu">Ár</th>
                        <th class="arujarmu">Leírás</th>
                        <th style="display:none;">created_at</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cargo in cargos %}
                    <tr data-id="{{ cargo.cargo_id }}">
                        <td><input type="checkbox" class="rowCheckbox"></td>
                        <td class="datum">
                            {% set pickups = cargo.locations | selectattr('type', 'equalto', 'pickup') | list %}
                            {% if pickups %}
                                {% set first_pickup = pickups[0] %}
                                {% if first_pickup.start_date %}
                                    {% if first_pickup.start_date.year == current_year %}
                                        {{ first_pickup.start_date.strftime('%m.%d.') }}
                                    {% else %}
                                        {{ first_pickup.start_date.strftime('%Y.%m.%d.') }}
                                    {% endif %}
                                    {% if first_pickup.end_date %}
                                        {% set delta = (first_pickup.end_date - first_pickup.start_date).days %}
                                        (+{{ delta }})
                                    {% endif %}
                                {% endif %}
                                {% if first_pickup.start_time_1 or first_pickup.start_time_2 %}
                                    <br>
                                    {{ first_pickup.start_time_1.strftime('%H:%M') if first_pickup.start_time_1 else '' }}
                                    – {{ first_pickup.start_time_2.strftime('%H:%M') if first_pickup.start_time_2 else '' }}
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="pickup-cell">
                            {% if pickups %}
                                {% set first_pickup = pickups[0] %}
                                {% set extra_pickups = pickups|length - 1 %}
                                <span class="country-zip">
                                    {{ first_pickup.country.upper() }} {{ first_pickup.masked_postcode if first_pickup.is_hidden else first_pickup.postcode }}
                                </span>
                                <br>
                                <span class="city">
                                    {{ first_pickup.masked_city if first_pickup.is_hidden else first_pickup.city }}
                                </span>
                                {% if extra_pickups > 0 %}
                                    <br><span class="extra-count">(+{{ extra_pickups }})</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td class="datum">
                            {% set dropoffs = cargo.locations | selectattr('type', 'equalto', 'dropoff') | list %}
                            {% if dropoffs %}
                                {% set last_dropoff = dropoffs[-1] %}
                                {% if last_dropoff.start_date %}
                                    {% if last_dropoff.start_date.year == current_year %}
                                        {{ last_dropoff.start_date.strftime('%m.%d.') }}
                                    {% else %}
                                        {{ last_dropoff.start_date.strftime('%Y.%m.%d.') }}
                                    {% endif %}
                                    {% if last_dropoff.end_date %}
                                        {% set delta = (last_dropoff.end_date - last_dropoff.start_date).days %}
                                        (+{{ delta }})
                                    {% endif %}
                                {% endif %}

                                {% if last_dropoff.start_time_1 or last_dropoff.start_time_2 %}
                                    <br>
                                    {{ last_dropoff.start_time_1.strftime('%H:%M') if last_dropoff.start_time_1 else '' }}
                                    – {{ last_dropoff.start_time_2.strftime('%H:%M') if last_dropoff.start_time_2 else '' }}
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="dropoff-cell">
                            {% if dropoffs %}
                                {% set last_dropoff = dropoffs[-1] %}
                                {% set extra_dropoffs = dropoffs|length - 1 %}
                                <span class="country-zip">
                                    {{ last_dropoff.country.upper() }} {{ last_dropoff.masked_postcode if last_dropoff.is_hidden else last_dropoff.postcode }}
                                </span>
                                <br>
                                <span class="city">
                                    {{ last_dropoff.masked_city if last_dropoff.is_hidden else last_dropoff.city }}
                                </span>
                                {% if extra_dropoffs > 0 %}
                                    <br><span class="extra-count">(+{{ extra_dropoffs }})</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>{{ cargo.size }}</td>
                        <td>{{ cargo.weight }}</td>
                        <td>{{ cargo.vehicle_type or '-' }}</td>
                        <td>{{ cargo.structure or '-' }}</td>
                        <td>{{ cargo.equipment or '-' }}</td>
                        <td>{{ cargo.cargo_securement or '-' }}</td>
                        <td>
                            {% set extras = [] %}
                            {% if cargo.palette_exchange %}{% set _ = extras.append('Palettacsere') %}{% endif %}
                            {% if cargo.oversize %}{% set _ = extras.append('Túlméretes áru') %}{% endif %}
                            {{ extras|join('<br>') | safe if extras else '-' }}
                        </td>
                        <td>{{ cargo.price or '-' }} {{ cargo.currency if cargo.price else ""}}</td>
                        <td>
                            {% set notes = [] %}
                            {% if cargo.description %}
                                {% set _ = notes.append("Rakomány: " ~ (cargo.description[:50] ~ ('...' if cargo.description|length > 30 else ''))) %}
                            {% endif %}
                            {% if cargo.note %}
                                {% set _ = notes.append("Jármű: " ~ (cargo.note[:50] ~ ('...' if cargo.note|length > 30 else ''))) %}
                            {% endif %}
                            {{ notes|join('<br>')|safe if notes else '-' }}
                        </td>


                        <td style="display:none;">{{ cargo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="rowActions">
                <button class="edit" title="Szerkesztés">✏️</button>
                <!-- <button class="done" title="Teljesített fuvar">✅</button> -->
                <button class="delete" title="Törlés"><img src="{{ url_for('static', filename='icons/red_trashbin.png') }}" style="width:16px"></button>
            </div>
        </div>
        {% else %}
        <p>Nincs még rakománya.</p>
        {% endif %}

        <h2>Hirdetett raktereim</h2>
        {% if vehicles %}

        <div class="table-actions">
            <button id="deleteVehicles" title="Törlés">
                <img src="{{ url_for('static', filename='icons/trash.png') }}" style="width:20px">
            </button>
            <button id="republishVehicles" title="Újraközlés">
                <img src="{{ url_for('static', filename='icons/refresh.png') }}" style="width:20px">
            </button>
        </div>

        <div class="table-outer">
            <table id="homeTableVehicles" class="display" style="font-size: 0.9rem; width:100%;">
                <thead>
                    <tr>
                        <th class="felvet"><input type="checkbox" id="selectAllVehicles"></th>
                        <th class="datum felvet"><img src="{{ url_for('static', filename='icons/calendar_up.png') }}" style="width: 24px"></th>
                        <th class="felvet">Indulási helyszín</th>
                        <th class="datum letet"><img src="{{ url_for('static', filename='icons/calendar_done.png') }}" style="width: 24px"></th>
                        <th  class="letet">Érekzési helyszín</th>
                        <th class="arujarmu"><img src="{{ url_for('static', filename='icons/length2.png') }}" style="width: 24px"> (m)</th>
                        <th class="arujarmu"><img src="{{ url_for('static', filename='icons/weight.png') }}" style="width: 24px"> (t)</th>
                        <th class="arujarmu">Jármű típusa</th>
                        <th class="arujarmu">Felépítmény</th>
                        <th class="arujarmu">Felszerelés</th>
                        <th class="arujarmu">Rögzítés</th>
                        <th class="arujarmu">Extrák</th>
                        <th class="arujarmu">Ár</th>
                        <th class="arujarmu">Megjegyzés</th>
                        <th style="display:none;">created_at</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in vehicles %}
                    <tr data-id="{{ vehicle.vehicle_id }}">
                        <td><input type="checkbox" class="selectVehicle"></td>
                        <td>
                            {% if vehicle.available_from %}
                                {% if vehicle.available_from.year == current_year %}
                                    {{ vehicle.available_from.strftime('%m.%d.') }}
                                {% else %}
                                    {{ vehicle.available_from.strftime('%Y.%m.%d.') }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <span class="country-zip"><strong>{{ vehicle.origin_country or '-' }} {{ vehicle.origin_postcode or '-' }}</strong></span><br>
                            <span class="city">{{ vehicle.origin_city or '-' }}</span>
                        </td>

                        <td>
                            {% if vehicle.available_until %}
                                {% if vehicle.available_until.year == current_year %}
                                    {{ vehicle.available_until.strftime('%m.%d.') }}
                                {% else %}
                                    {{ vehicle.available_until.strftime('%Y.%m.%d.') }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <span class="country-zip"><strong>{{ vehicle.destination_country or '-' }} {{ vehicle.destination_postcode or '-' }}</strong></span><br>
                            <span class="city">{{ vehicle.destination_city or '-' }}</span>
                        </td>
                        <td>{{ vehicle.volume_m3 or '-' }}</td>
                        <td>{{ vehicle.capacity_t or '-' }}</td>
                        <td>{{ vehicle.vehicle_type or '-' }}</td>
                        <td>{{ vehicle.structure or '-' }}</td>
                        <td>{{ vehicle.equipment or '-' }}</td>
                        <td>{{ vehicle.cargo_securement or '-' }}</td>
                        <td>{{ vehicle.load_type or '' }}{{ "\nPalettacsere" if vehicle.palette_exchange }}{{ "\nTúlméretes áru" if vehicle.oversize }}</td>
                        <td>{{ vehicle.price or '-' }} {{ vehicle.currency if vehicle.price else '' }}</td>
                        <td>{{ vehicle.description or '-' }}</td>
                        <td style="display:none;">{{ vehicle.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            <div id="vehicleRowActions">
                <button class="editVehicle" title="Szerkesztés">✏️</button>
                <button class="deleteVehicle" title="Törlés"><img src="{{ url_for('static', filename='icons/red_trashbin.png') }}" style="width:16px"></button>
            </div>
            </table>
        </div>

        {% else %}
        <p>Nincs még raktere.</p>
        {% endif %}

        <!-- Cargo Editor Modal -->
        <div class="modal fade" id="cargoModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl"> <!-- extra wide modal -->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Rakomány szerkesztése</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
              </div>
              <div class="modal-body">
                <form id="cargoModalForm">
                  <!-- ide kerül a buildEditorHtml() tartalma, de csak a form része, <tr> nélkül -->
                  <div class="editor-container"></div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicle Modal -->
        <div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalLabel">Jármű szerkesztése</h5>
              </div>

              <div class="modal-body">
                <form action="{{ url_for('vehicles.save_vehicle') }}" method="POST" id="vehicleForm" class="freight-form">

                  <!-- Hely adatok -->
                  <div class="form-section">
                    <h4>Hely adatok</h4>
                    <div class="places">
                      <label for="origin" class="elso_label">Honnan?</label>
                      <label for="origin_diff" class="x"></label>
                      <label for="swap-btn" class="y"></label>
                      <label for="destination" class="masodik_label">Hova?</label>
                      <label for="destination_diff" class="z"></label>

                      <div class="autocomplete-wrapper">
                        <input type="text" id="origin" placeholder="Város" autocomplete="off">
                        <div id="origin_suggestions" class="suggestions"></div>
                        <input type="hidden" id="origin_city" name="origin_city">
                        <input type="hidden" id="origin_zip" name="origin_zip">
                        <input type="hidden" id="origin_country" name="origin_country">
                      </div>

                      <select id="origin_diff" name="origin_diff">
                        <option value="0" selected>+0 km</option>
                        <option value="25">+25 km</option>
                        <option value="50">+50 km</option>
                        <option value="100">+100 km</option>
                        <option value="any">+any km</option>
                      </select>

                      <button type="button" id="swap-btn">⇄</button>

                      <div class="autocomplete-wrapper">
                        <input type="text" id="destination" placeholder="Város" autocomplete="off">
                        <div id="destination_suggestions" class="suggestions"></div>
                        <input type="hidden" id="destination_city" name="destination_city">
                        <input type="hidden" id="destination_zip" name="destination_zip">
                        <input type="hidden" id="destination_country" name="destination_country">
                      </div>

                      <select id="destination_diff" name="destination_diff">
                        <option value="0" selected>+0 km</option>
                        <option value="25">+25 km</option>
                        <option value="50">+50 km</option>
                        <option value="100">+100 km</option>
                        <option value="any">+any km</option>
                      </select>

                      <input type="date" id="available_from" name="available_from">
                      <input type="date" id="available_until" name="available_until">
                    </div>
                  </div>

                  <!-- Jármű alapadatok -->
                  <div class="form-section">
                    <h4>Jármű adatok</h4>
                    <div class="vehicle-col">
                      <label for="vehicle_type">Jármű típusa *</label>
                      <select id="vehicle_type" name="vehicle_type" required>
                        <option value="" disabled selected>Válassz jármű típust</option>
                        <option value="Jármű 3,5 t-ig">Jármű 3,5 t-ig</option>
                        <option value="Nyerges szerelvény">Nyerges szerelvény</option>
                        <option value="Pótos szerelvény">Pótos szerelvény</option>
                        <option value="Tehergépjármű 7,5 t-ig">Tehergépjármű 7,5 t-ig</option>
                        <option value="Tehergépjármű 12 t-ig">Tehergépjármű 12 t-ig</option>
                      </select>

                      <label for="structure">Felépítmény *</label>
                      <select id="structure" name="structure" required>
                        <option value="" disabled selected>Válassz felépítményt</option>
                        <option value="Autószállító">Autószállító</option>
                        <option value="Billenős konténer">Billenős konténer</option>
                        <option value="Cserefelépítmény-Chassis">Cserefelépítmény-Chassis</option>
                        <option value="Dobozos">Dobozos</option>
                        <option value="Furgon">Furgon</option>
                        <option value="Dupla kabinos">Dupla kabinos</option>
                        <option value="Félpótkocsi">Félpótkocsi</option>
                        <option value="Hűtő">Hűtő</option>
                        <option value="Jumbo">Jumbo</option>
                        <option value="Klipper">Klipper</option>
                        <option value="Konténerszállító">Konténerszállító</option>
                        <option value="Kábeldobszálíltó">Kábeldobszálíltó</option>
                        <option value="Középrakodós">Középrakodós</option>
                        <option value="Mega">Mega</option>
                        <option value="Mozgópadlós">Mozgópadlós</option>
                        <option value="Mozgópadlós (ömlesztett áru)">Mozgópadlós (ömlesztett áru)</option>
                        <option value="Mélybölcsős">Mélybölcsős</option>
                        <option value="Nyitott tehergépkocsi">Nyitott tehergépkocsi</option>
                        <option value="Oldalrakodós">Oldalrakodós</option>
                        <option value="Ponyvás">Ponyvás</option>
                        <option value="Sasszé">Sasszé</option>
                        <option value="Siló">Siló</option>
                        <option value="Speciális jármű">Speciális jármű</option>
                        <option value="Szigetelt">Szigetelt</option>
                        <option value="Szállítószalagos">Szállítószalagos</option>
                        <option value="Tartálykocsi">Tartálykocsi</option>
                        <option value="Tautliner">Tautliner</option>
                        <option value="Tele">Tele</option>
                        <option value="Vontató">Vontató</option>
                      </select>

                      <label for="equipment">Felszereltség</label>
                      <label for="securement">Rakományrögzítés</label>

                      <!-- Multiselect-ek -->
                      <div class="multiselect">
                        <div class="selectBox" onclick="toggleCheckboxes('equipment')">
                          <span id="equipment-selected">Válassz felszereltséget</span> ▼
                        </div>
                        <div class="checkboxes" id="equipment-checkboxes" data-editor-usable="equipment"></div>
                      </div>

                      <div class="multiselect">
                        <div class="selectBox" onclick="toggleCheckboxes('securement')">
                          <span id="securement-selected">Válassz rakományrögzítést</span> ▼
                        </div>
                        <div class="checkboxes" id="securement-checkboxes" data-editor-usable="securement"></div>
                      </div>

                      <textarea id="description" name="description" placeholder="Részletek a járműről"></textarea>
                    </div>
                  </div>

                  <!-- Rakomány és díj -->
                  <div class="form-section">
                    <label for="capacity_t">Kapacitás (t)</label>
                    <input type="number" step="0.1" id="capacity_t" name="capacity_t">

                    <label for="volume_m3">Raktér méret (m³)</label>
                    <input type="number" step="0.1" id="volume_m3" name="volume_m3">

                    <label for="price">Ár</label>
                    <input type="number" step="0.01" id="price" name="price">

                    <label for="currency">Pénznem</label>
                    <select id="currency" name="currency">
                      <option value="EUR">EUR</option>
                      <option value="HUF">HUF</option>
                    </select>
                  </div>

                </form>
              </div>
              <div class="modal-footer">
                <button type="button" id="vehicleModalSave" class="btn btn-primary">Mentés</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Expired modal -->
        <div id="expiredModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
          <!-- Overlay -->
          <div class="absolute inset-0 bg-black/70 transition-opacity duration-300 opacity-0" id="expiredOverlay"></div>

          <!-- Modal content -->
          <div id="expiredContent" class="relative bg-white rounded-2xl shadow-xl flex flex-col transform scale-95 opacity-0 transition-all duration-300" style="width:50vw; height:60vh;">

            <!-- Fejléc -->
            <div class="p-4 border-b flex flex-col fejlec">
              <h2 id="expiredTitle" class="text-xl font-semibold">Lejárt tétel</h2>
              <p id="expiredSub" class="text-sm text-gray-600">Lejárat: 2025.10.10 • Budapest → Debrecen</p>
            </div>

            <!-- Képek 50-50%, csak a fejléc alatti rész -->
            <div class="h-full kepek">

                <!-- Bal oldal = törlés -->
                <div id="expiredDeleteArea" class="w-1/2 h-full relative cursor-pointer group overflow-hidden">
                    <img src="/static/icons/trash-bin.png" alt="Törlés" class="w-full h-full object-cover rounded-bl-2xl">

                    <!-- Hover overlay -->
                    <div class="hover-overlay"></div>

                    <div class="hover-text">Megbízás törlése</div>
                </div>

                <!-- Jobb oldal = hosszabbítás -->
                <div id="expiredExtendArea" class="w-1/2 h-full relative cursor-pointer group flex items-center justify-center overflow-hidden">
                    <img src="/static/icons/time-passing.png" alt="Hosszabbítás"
                    class="w-full h-full object-cover rounded-br-2xl">

                    <!-- Hover overlay -->
                    <div class="hover-overlay"></div>

                    <div class="hover-text">
                        Meghosszabbítás ennyi nappal:
                    </div>

                    <input type="number" value="1" id="expiredExtendDays" class="expired-input">
                </div>
            </div>

          </div>
        </div>
    </main>
</div>

{% block scripts %}
<script>
// --------------------------- LEJÁRT AUTO TÖRLÉS / HOSSZABBÍTÁS ---------------------------
let currentItem = null;
let expiredQueue = [];

function showExpiredModal(item) {
  currentItem = item;
  const modal = document.getElementById('expiredModal');
  const overlay = document.getElementById('expiredOverlay');
  const content = document.getElementById('expiredContent');

  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  overlay.classList.remove('opacity-0');
  content.classList.remove('opacity-0', 'scale-95');

  setTimeout(() => content.classList.add('scale-100'), 10);

  // --- itt módosítunk ---
  let titleText = "Lejárt tétel";
  if (item.type === "cargo") {
    titleText = "Lejárt rakomány";
  } else if (item.type === "vehicle" || item.type === "storage") {
    titleText = "Lejárt raktér";
  }

  document.getElementById('expiredTitle').textContent = titleText;
  // ----------------------

  const firstCity = item.first_city || item.start_city || "?";
  const lastCity = item.last_city || item.end_city || "?";
  const endDate = new Date(item.end_date || item.expiry_date || item.available_until).toLocaleDateString('hu-HU');

  document.getElementById('expiredSub').textContent = `Lejárat: ${endDate} • ${firstCity} → ${lastCity}`;
}

function hideExpiredModal() {
  const modal = document.getElementById('expiredModal');
  const overlay = document.getElementById('expiredOverlay');
  const content = document.getElementById('expiredContent');

  overlay.classList.add('opacity-0');
  content.classList.add('opacity-0', 'scale-95');

  setTimeout(() => {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    currentItem = null;
    // Csak most hívjuk a következőt
    checkNextExpired();
  }, 200); // megegyezik az animáció hosszával
}

// Bal oldal törlés
document.getElementById('expiredDeleteArea').addEventListener('click', () => handleAction('delete'));

// Jobb oldal hosszabbítás (input nem számít, csak kép)
document.getElementById('expiredExtendArea').addEventListener('click', (e) => {
  const extendInput = document.getElementById('expiredExtendDays');

  // Ha az inputra kattintott, akkor NE indítsa el a hosszabbítást!
  if (e.target === extendInput) {
    return;
  }

  const days = parseInt(extendInput.value);
  handleAction('extend', days);
});

// Overlay kattintás vagy ESC
window.addEventListener('click', e => {
  const modal = document.getElementById('expiredModal');
  if (e.target === modal) handleAction('delete');
});
window.addEventListener('keydown', e => { if (e.key === 'Escape') handleAction('delete'); });

// API hívás
async function handleAction(action, days = 0) {
  if (!currentItem) return;

  const res = await fetch("/cargo/api/expired_items/action", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ ...currentItem, action, days })
  });

  const data = await res.json();
  console.log("[DEBUG] Action response:", data);

  hideExpiredModal();
}

// Check expired items
async function checkExpiredItems() {
  try {
    const res = await fetch("/cargo/api/expired_items/check");
    const data = await res.json();
    if (data.expired && data.expired.length > 0) {
      expiredQueue = data.expired;
      checkNextExpired();
    }
  } catch (err) {
    console.error(err);
  }
}

function checkNextExpired() {
  if (expiredQueue.length === 0) return;
  const next = expiredQueue.shift();
  showExpiredModal(next);
}

document.addEventListener("DOMContentLoaded", () => checkExpiredItems());

// --------------------------- INPUT ENGEDÉLYEZÉS / TILTÁS ---------------------------
const extendInput = document.getElementById('expiredExtendDays');

// alapállapot: ne zavarja a hover eseményt
extendInput.style.pointerEvents = "none";
extendInput.style.opacity = "0.8";

// ha ráfókuszál
extendInput.addEventListener("focus", () => {
  extendInput.style.pointerEvents = "auto";
  extendInput.style.opacity = "1";
});

// ha elveszti a fókuszt
extendInput.addEventListener("blur", () => {
  // kis késleltetés, hogy a click események lezáruljanak
  setTimeout(() => {
    extendInput.style.pointerEvents = "none";
    extendInput.style.opacity = "0.8";
  }, 150);
});

document.getElementById('expiredExtendArea').addEventListener('mouseenter', () => {
  extendInput.style.pointerEvents = "auto";
});

document.getElementById('expiredExtendArea').addEventListener('mouseleave', () => {
  if (document.activeElement !== extendInput) {
    extendInput.style.pointerEvents = "none";
  }
});

// -------------------------------------------------------------------------------

// ---------------------------
// Globális változók
// ---------------------------
var openEditorRow = null; // a jelenleg megnyitott editor TR (jQuery objektum)
var openEditorCargoId = null; // id
var equipmentOptions = [
    "2. sofőr","A-Schild","ADR","BF3 kísérőjármű","BF4 kísérőjármű","Béka",
    "Emelőhátfal","Farönkszállító","GPS követő","Húskampó","Rakodódaru",
    "Rámpa","Takaróponyva","Targonca","Válaszfal","Vámzsinór"
];

// ---------------------------
// Globális függvények
// ---------------------------
window.buildEditorHtml = function(data) {
    var colspan = 17;
    return `
    <tr class="editor-row" data-editor-for="${data.cargo_id || ''}">
        <td colspan="${colspan}">
            <div class="editor-container">
                <!-- Itt kezdődik a form -->
                <form class="inline-edit-form">

                    <!-- Pickup / Dropoff top -->
                    <div class="grid-top" style="display:flex; gap:12px;">
                        <div class="pickup-wrapper">
                            <legend>Honnan</legend>
                            <div id="editor_pickup_container" class="pickup-container"></div>
                            <div class="location-btn-row" id="pickup-btn-row" style="margin-top:6px; display:flex; gap:8px; justify-content:flex-end;"></div>
                        </div>
                        <div class="dropoff-wrapper">
                            <legend>Hová</legend>
                            <div id="editor_dropoff_container" class="dropoff-container"></div>
                            <div class="location-btn-row" id="dropoff-btn-row" style="margin-top:6px; display:flex; gap:8px; justify-content:flex-end;"></div>
                        </div>

                        <!-- Templates (will be used by render helpers) -->
                        <template id="editor_pickup_template" data-editor-usable="1">
                            <br>
                            <fieldset class="pickup-fieldset">
                                <div class="location-grid">
                                    <div class="left-side" style="position: relative; width: 100%;">
                                        <label>Felrakó:</label>
                                        <input type="text" name="from_city[__INDEX__]" class="city-search" required minlength="2" autocomplete="off" placeholder="Város, irányítószám vagy település">
                                        <input type="hidden" name="from_city_clean[__INDEX__]" class="city-clean">
                                        <input type="hidden" name="from_city_valid[__INDEX__]" class="city-valid" value="0">
                                        <input type="hidden" name="from_country[__INDEX__]" class="city-country">
                                        <input type="hidden" name="from_postcode[__INDEX__]" class="city-postcode">
                                        <ul class="search-results" style="display:none; position:absolute; left:0; right:0; z-index:1300; background:#fff; border:1px solid #ddd; max-height:240px; overflow:auto; padding:0; margin:4px 0 0 0; list-style:none;"></ul>
                                        <input type="hidden" name="from_latitude[__INDEX__]">
                                        <input type="hidden" name="from_longitude[__INDEX__]">
                                    </div>

                                    <div class="right-side reformed-right-side">
                                        <div class="date-time-col">
                                            <label>Kezdő dátum
                                            <input type="date" name="from_start_date[__INDEX__]"></label>
                                            <div class="time-row">
                                                <input type="time" name="from_start_time_start[__INDEX__]">
                                                <input type="time" name="from_start_time_end[__INDEX__]">
                                            </div>
                                        </div>
                                        <div class="date-time-col">
                                            <label>Záró dátum
                                            <input type="date" name="from_end_date[__INDEX__]"></label>
                                            <div class="time-row">
                                                <input type="time" name="from_end_time_start[__INDEX__]">
                                                <input type="time" name="from_end_time_end[__INDEX__]">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                            <br>
                        </template>

                        <!-- Dropoff template -->
                        <template id="editor_dropoff_template" data-editor-usable="1">
                            <br>
                            <fieldset class="dropoff-fieldset">
                                <div class="location-grid">
                                    <div class="left-side" style="position: relative; width: 100%;">
                                        <label>Lerakó:</label>
                                        <input type="text" name="to_city[__INDEX__]" class="city-search" required minlength="2" autocomplete="off" placeholder="Város, irányítószám vagy település">
                                        <input type="hidden" name="to_city_clean[__INDEX__]" class="city-clean">
                                        <input type="hidden" name="to_city_valid[__INDEX__]" class="city-valid" value="0">
                                        <input type="hidden" name="to_country[__INDEX__]" class="city-country">
                                        <input type="hidden" name="to_postcode[__INDEX__]" class="city-postcode">
                                        <ul class="search-results" style="display:none; position:absolute; left:0; right:0; z-index:1300; background:#fff; border:1px solid #ddd; max-height:240px; overflow:auto; padding:0; margin:4px 0 0 0; list-style:none;"></ul>
                                        <input type="hidden" name="to_latitude[__INDEX__]">
                                        <input type="hidden" name="to_longitude[__INDEX__]">
                                    </div>

                                    <div class="right-side reformed-right-side">
                                        <div class="date-time-col">
                                            <label>Kezdő dátum
                                            <input type="date" name="to_start_date[__INDEX__]"></label>
                                            <div class="time-row">
                                                <input type="time" name="to_start_time_start[__INDEX__]">
                                                <input type="time" name="to_end_time_start[__INDEX__]">
                                            </div>
                                        </div>
                                        <div class="date-time-col">
                                            <label>Záró dátum
                                            <input type="date" name="to_end_date[__INDEX__]"></label>
                                            <div class="time-row">
                                                <input type="time" name="to_end_time_start[__INDEX__]">
                                                <input type="time" name="to_end_time_end[__INDEX__]">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                            <br>
                        </template>
                    </div>

                    <!-- Vehicle & Cargo -->
                    <div class="grid-bottom" style="display:flex; gap:12px; margin-top:12px; flex-direction: column">
                        <fieldset class="vehicle-fieldset" style="flex:1;">
                            <legend>Jármű</legend>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <div style="flex:1;">
                                    <label>Típus</label>
                                    <select name="vehicle_type">
                                        <option value="">--</option>
                                        <option>Jármű 3,5 t-ig</option>
                                        <option>Nyerges szerelvény</option>
                                        <option>Pótos szerelvény</option>
                                        <option>Tehergépjármű 7,5 t-ig</option>
                                        <option>Tehergépjármű 12 t-ig</option>
                                    </select>
                                </div>
                                <div style="flex:1;">
                                    <label>Felépítmény</label>
                                    <select name="structure">
                                        <option value="" disabled selected>Válassz felépítményt</option>
                                        ${[
        "Autószállító", "Billenős konténer", "Cserefelépítmény-Chassis", "Dobozos",
        "Furgon", "Dupla kabinos", "Félpótkocsi", "Hűtő", "Jumbo", "Klipper", "Konténerszállító",
        "Kábeldobszálíltó", "Középrakodós", "Mega", "Mozgópadlós", "Mozgópadlós (ömlesztett áru)",
        "Mélybölcsős", "Nyitott tehergépkocsi", "Oldalrakodós", "Ponyvás", "Sasszé", "Siló",
        "Speciális jármű", "Szigetelt", "Szállítószalagos", "Tartálykocsi", "Tautliner", "Tele", "Vontató"
    ].map(v => `<option value="${v}">${v}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Felszereltség -->
                            <div style="margin-top:8px;">
                                <label>Felszereltség</label>
                                <div class="equipment-box" style="display:grid; grid-template-columns: repeat(4,1fr); gap: 6px; margin-top:6px;">
                                    ${equipmentOptions.map(opt => `<label class="equip-label"><input type="checkbox" class="equip-checkbox" value="${opt}"> ${opt}</label>`).join('')}
                                </div>
                                <select name="equipment" multiple hidden>
                                    ${equipmentOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Rögzítés -->
                            <div style="margin-top:8px;">
                                <label>Rögzítés</label>
                                <div class="secure-box" style="display:grid; grid-template-columns: repeat(3,1fr); gap: 6px; margin-top:6px;">
                                    ${[
        "Csúszásgátló", "Láncos feszítő", "Multilock", "Oldalfalas", "Palettarögzítő gerenda",
        "Rakományrögzítő rúd", "Rakonca", "Spanifer", "Élvédő"
    ].map(opt => `<label class="secure-label"><input type="checkbox" class="secure-checkbox" value="${opt}"> ${opt}</label>`).join('')}
                                </div>
                                <select name="cargo_securement" multiple hidden>
                                    ${[
        "Csúszásgátló", "Láncos feszítő", "Multilock", "Oldalfalas", "Palettarögzítő gerenda",
        "Rakományrögzítő rúd", "Rakonca", "Spanifer", "Élvédő"
    ].map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>

                            <div style="margin-top:8px;">
                                <label>Jármű megjegyzés</label>
                                <textarea name="note" rows="2"></textarea>
                            </div>
                        </fieldset>

                        <legend>Áru</legend>
                        <fieldset class="cargo-fieldset" style="display: flex; flex-direction: column; width: 100%;">
                          <div class="cargo-row-1" style="display: flex; gap: 12px; flex-direction: row; width: 100%;">
                            <div class="length-weight-price" style="display: flex; flex-direction: column; gap: 10px; flex: 1;">
                              <div class="length-weight-row" style="display: flex; justify-content: space-between; gap: 10px; width: 100%;">
                                <div class="length-field" style="width: 49%;">
                                  <label>Hossz (m)</label>
                                  <input type="number" name="length" step="0.1" min="0" style="width: 100%;">
                                </div>
                                <div class="weight-field" style="width: 49%;">
                                  <label>Tömeg (t)</label>
                                  <input type="number" name="weight" step="0.1" min="0" style="width: 100%;">
                                </div>
                              </div>
                              <div class="price-field" style="width: 100%;">
                                <label>Ár</label>
                                <div style="display: flex; align-items: center; gap: 6px; width: 100%;">
                                  <input type="number" name="price" step="1" min="0" style="width: 70%;">
                                  <select name="currency" style="width: 30%;">
                                    <option value="EUR">EUR</option>
                                    <option value="HUF">HUF</option>
                                  </select>
                                </div>
                              </div>
                            </div>

                            <div class="description-textarea" style="display: flex; flex-direction: column; flex: 1;">
                              <label>Áru leírása</label>
                              <textarea name="description" cols="30" rows="6" style="width: 100%;"></textarea>
                            </div>

                            <div class="other-cargo-info" style="display: flex; flex-direction: column; justify-content: flex-start; gap: 10px;">
                              <div class="palette-card" id="editor_paletteCard">
                                <span id="editor_paletteText">
                                  <b>Palettacsere</b>
                                  <img src="{{ url_for('static', filename='icons/exchange_palette.png') }}" alt="Palettacsere">
                                </span>
                              </div>
                              <input type="hidden" id="editor_palette_exchange" name="palette_exchange" value="false">

                              <div class="oversize-card" id="editor_oversizeCard">
                                <span id="editor_oversizeText">
                                  <b>Túlméretes áru</b>
                                  <img src="{{ url_for('static', filename='icons/oversize.png') }}" alt="Túlméretes">
                                </span>
                              </div>
                              <input type="hidden" id="editor_oversize" name="oversize" value="false">
                            </div>
                          </div>
                        </fieldset>
                    </div>

                    <!-- Gombok -->
                    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                        <button class="editor-save" type="button" id="saveCargoBtn">Mentés</button>
                        <button class="editor-cancel" type="button" data-bs-dismiss="modal">Mégse</button>
                    </div>
                </form> <!-- Itt záródik a form -->
            </div>
        </td>
    </tr>
    `;
};

// --- Helpers to render pickup/dropoff fieldsets inside the injected editor ---
function renderEditorFieldsets($editorRow, containerSelector, templateSelector, items, namePrefixFromTo) {
    var $container = $editorRow.find(containerSelector);
    $container.empty();
    var tpl = $editorRow.find(templateSelector).html();
    if(!tpl) return;
    items = items && items.length ? items : [{}];
    items.forEach(function(loc, idx){
        var html = tpl.replace(/__INDEX__/g, idx);
        var $fs = $(html);
        // If location has an id, store it on the fieldset and add a hidden input so submit can include it
        if (loc && (loc.id || loc.id === 0)) {
            $fs.attr('data-loc-id', loc.id);
            $fs.append($('<input type="hidden" name="location_id['+idx+']">').val(loc.id));
        }
        // fill values
        function setIf(name, val){
            var sel = $fs.find('[name="'+name+'"]');
            if(sel.length){
                if(sel.attr('type')==='checkbox') sel.prop('checked', !!val);
                else sel.val(val == null ? '' : val);
            }
        }
        if(namePrefixFromTo === 'from'){
            // visible city-search is name="from_city[idx]"
            setIf('from_country['+idx+']', loc.country || loc.from_country || '');
            setIf('from_postcode['+idx+']', loc.postcode || loc.from_postcode || '');
            setIf('from_city['+idx+']', loc.city || loc.from_city || '');
            setIf('from_city_valid['+idx+']', loc.city_valid ? loc.city_valid : 0);
            setIf('is_hidden_from['+idx+']', loc.is_hidden || loc.is_hidden_from || false);
            setIf('from_start_date['+idx+']', loc.start_date || loc.start_date || '');
            setIf('from_start_time_start['+idx+']', loc.start_time_1 || '');
            setIf('from_start_time_end['+idx+']', loc.start_time_2 || '');
            setIf('from_end_date['+idx+']', loc.end_date || loc.end_date || '');
            setIf('from_end_time_start['+idx+']', loc.end_time_1 || '');
            setIf('from_end_time_end['+idx+']', loc.end_time_2 || '');
            if (loc.latitude !== undefined) setIf('from_latitude['+idx+']', loc.latitude);
            if (loc.longitude !== undefined) setIf('from_longitude['+idx+']', loc.longitude);
        } else {
            setIf('to_country['+idx+']', loc.country || loc.to_country || '');
            setIf('to_postcode['+idx+']', loc.postcode || loc.to_postcode || '');
            setIf('to_city['+idx+']', loc.city || loc.to_city || '');
            setIf('to_city_valid['+idx+']', loc.city_valid ? loc.city_valid : 0);
            setIf('is_hidden_to['+idx+']', loc.is_hidden || loc.is_hidden_to || false);
            setIf('to_start_date['+idx+']', loc.start_date || '');
            setIf('to_start_time_start['+idx+']', loc.start_time_1 || '');
            setIf('to_start_time_end['+idx+']', loc.start_time_2 || '');
            setIf('to_end_date['+idx+']', loc.end_date || '');
            setIf('to_end_time_start['+idx+']', loc.end_time_1 || '');
            setIf('to_end_time_end['+idx+']', loc.end_time_2 || '');
            if (loc.latitude !== undefined) setIf('to_latitude['+idx+']', loc.latitude);
            if (loc.longitude !== undefined) setIf('to_longitude['+idx+']', loc.longitude);
        }
        $container.append($fs);
        // Insert swap button after each except the last
        if (idx < items.length - 1) {
            var swapBtnWrap = $('<div class="swap-btn-row"></div>').css({display:'flex',justifyContent:'center',alignItems:'center',width:'100%'});
            var swapBtn = $('<button type="button" class="swap-location-btn" data-type="'+namePrefixFromTo+'" data-idx="'+idx+'" title="Hely cseréje">⇅</button>');
            swapBtnWrap.append(swapBtn);
            $container.append(swapBtnWrap);
        }
    });

    // Add [+] and/or [-] buttons under the last fieldset
    var $btnRow = namePrefixFromTo === 'from'
        ? $editorRow.find('#pickup-btn-row')
        : $editorRow.find('#dropoff-btn-row');
    $btnRow.empty();
    var count = $container.find('fieldset').length;
    if (count === 1) {
        $btnRow.append(`<button type="button" class="add-location-btn" data-type="${namePrefixFromTo}" title="Hely hozzáadása">➕</button>`);
    } else if (count === 5) {
        $btnRow.append(`<button type="button" class="remove-location-btn" data-type="${namePrefixFromTo}" title="Hely eltávolítása">➖</button>`);
    } else {
        $btnRow.append(`<button type="button" class="remove-location-btn" data-type="${namePrefixFromTo}" title="Hely eltávolítása">➖</button>`);
        $btnRow.append(`<button type="button" class="add-location-btn" data-type="${namePrefixFromTo}" title="Hely hozzáadása">➕</button>`);
    }
}

// ---------------------------------- city-search (delegált, dinamikus mezőkhöz) ----------------------------------
(function(){
    // Input esemény (debounce)
    $(document).on("input", ".city-search", function() {
        var $input = $(this);
        var query = $input.val().trim();
        var $results = $input.siblings(".search-results");

        // Clear previous timer
        var prevTimer = $input.data('search-timer');
        if(prevTimer) clearTimeout(prevTimer);

        // Reset validity
        var $valid = $input.siblings(".city-valid");
        if($valid.length) $valid.val("0");

        if(query.length < 2) {
            $results.hide();
            return;
        }

        var timer = setTimeout(function(){
            // AJAX keresés
            $.get("/cargo/ajax/city_search", { q: query })
                .done(function(data){
                    $results.empty();
                    if(!Array.isArray(data) || data.length === 0){
                        $results.hide();
                        return;
                    }

                    // 🔹 Itt építjük a találati listát
                    data.slice(0,10).forEach(function(item){
                        var text = (item.city_name||'') + ', ' + (item.country_code||'') + ' ' + (item.zipcode||'');

                        // 🔸 Ez az elem viszi a backendből kapott adatokat
                        var $li = $('<li class="result-item" role="option" style="padding:8px; border-bottom:1px solid #f0f0f0; cursor:pointer;"></li>');
                        $li.text(text);
                        $li.attr('data-city', item.city_name || '');
                        $li.attr('data-country', item.country_code || '');
                        $li.attr('data-postcode', item.zipcode || '');

                        $results.append($li);
                    });

                    $results.show();
                })
                .fail(function(){ $results.hide(); });
        }, 300);

        $input.data('search-timer', timer);
    });

    // result click (delegált)
    $(document).on("click", ".search-results .result-item", function() {
        var $li = $(this);
        var $ul = $li.closest('.search-results');
        var $fieldset = $ul.closest('fieldset');
        var $input = $fieldset.find('.city-search').first();
        var $country = $fieldset.find('.city-country').first();
        var $postcode = $fieldset.find('.city-postcode').first();
        var $valid = $fieldset.find('.city-valid').first();
        var $cityHidden = $fieldset.find('.city-clean').first();

        // 🔹 A data- attribútumokból nyerjük ki az értékeket
        var city = $li.attr('data-city') || '';
        var country = $li.attr('data-country') || '';
        var postcode = $li.attr('data-postcode') || '';

        console.log(city, country, postcode)

        // Látható input érték beállítása
        var displayValue = `${city}, ${country} (${postcode})`;
        $input.val(displayValue);

        // 🔸 Hidden mezők frissítése
        if ($cityHidden.length) $cityHidden.val(city);
        if ($country.length) $country.val(country);
        if ($postcode.length) $postcode.val(postcode);
        if ($valid.length) $valid.val("1");

        console.log('NA EZ:')
        console.log($cityHidden.val())

        // Eredmények elrejtése
        $ul.hide();
        $input.trigger('change');
    });

    // Blur: rejtsük el kis késleltetéssel
    $(document).on("blur", ".city-search", function(){
        var $ul = $(this).siblings('.search-results');
        setTimeout(function(){ $ul.hide(); }, 180);
    });

    // Manuális szerkesztés: invalidáljuk
    $(document).on("input", ".city-search", function(e){
        // Ha ez nem egy selectCityFromSearch hívás, érvénytelenítünk
        if (!$(this).data('from-select')) {
            var $valid = $(this).siblings(".city-valid");
            if($valid.length) $valid.val("0");
            var $clean = $(this).siblings(".city-clean");
            if($clean.length) $clean.val(''); // csak manuális input törlés
        }
        // reset flag
        $(this).data('from-select', false);
    });

    // Segédfüggvény: programból is beállítható
    window.selectCityFromSearch = function($input, cityObj){
        var $ul = $input.siblings('.search-results');
        var $country = $input.siblings('.city-country');
        var $postcode = $input.siblings('.city-postcode');
        var $valid = $input.siblings('.city-valid');
        var $clean = $input.siblings('.city-clean');

        // FLAG: jelzi, hogy ez select esemény
        $input.data('from-select', true);

        if(cityObj.city) $input.val(cityObj.city); // Látható inputot is csak városnévre állítjuk
        if(cityObj.country && $country.length) $country.val(cityObj.country);
        if(cityObj.postcode && $postcode.length) $postcode.val(cityObj.postcode);
        if($valid.length) $valid.val("1");
        if($clean.length) $clean.val(cityObj.city); // Hidden mindig városnév

        $ul.hide();
        $input.trigger('change');
    };

})();

// ---------------------------
// populateEditorFields
// ---------------------------
window.populateEditorFields = function($editorRow, data) {
    if(!data) return;

    // Normalize server keys to editor-friendly keys
    // length -> size
    if (data.length !== undefined && data.size === undefined) data.size = data.length;

    // Build pickups/dropoffs compatibility: prefer explicit arrays if present
    var pickups = [];
    var dropoffs = [];
    if (Array.isArray(data.pickups) || Array.isArray(data.dropoffs)) {
        pickups = Array.isArray(data.pickups) ? data.pickups : [];
        dropoffs = Array.isArray(data.dropoffs) ? data.dropoffs : [];
    } else if (Array.isArray(data.locations)) {
        pickups = (data.locations || []).filter(function(l){ return l.type === 'pickup'; });
        dropoffs = (data.locations || []).filter(function(l){ return l.type === 'dropoff'; });
    }

    // normalize per-location field names for render helper
    function normalizeLocFields(arr){
        return (arr || []).map(function(loc){
            return {
                id: loc.id || loc.ID || loc.location_id || '',
                country: loc.country || loc.from_country || loc.to_country || '',
                postcode: loc.postcode || loc.postcode || loc.from_postcode || loc.to_postcode || '',
                city: (() => {
                    var cityName = loc.city || loc.from_city || loc.to_city || '';
                    var country = loc.country || loc.from_country || loc.to_country || '';
                    var postcode = loc.postcode || loc.from_postcode || loc.to_postcode || '';
                    return cityName + (country || postcode ? ', ' + country + ' (' + postcode + ')': '');
                })(),
                is_hidden: (loc.is_hidden !== undefined ? loc.is_hidden : (loc.is_hidden_from || loc.is_hidden_to || false)),
                start_date: loc.start_date || loc.start_date || '',
                start_time_1: loc.start_time_1 || loc.start_time || '',
                start_time_2: loc.start_time_2 || '',
                end_date: loc.end_date || '',
                end_time_1: loc.end_time_1 || '',
                end_time_2: loc.end_time_2 || ''
            };
        });
    }

    // Fill simple cargo fields (map both modern & legacy keys)
    var simpleKeys = ['length','weight','price','currency','description','vehicle_type','structure','certificates','cargo_securement','note','created_at','last_republished_at','is_template','palette_exchange','oversize'];
    simpleKeys.forEach(function(k){
        var $el = $editorRow.find('[name="'+k+'"]');
        if(!$el.length && k==='structure') $el = $editorRow.find('[name="structure"]'); // legacy name fallback
        // set from alternative server keys too
        var val = data[k];
        if (val === undefined) {
            if (k === 'length') val = data.length;
            if (k === 'description' && data.note) val = data.note;
            if (k === 'note' && data.description) val = data.description;
        }
        if($el.length){
            if($el.attr('type') === 'checkbox') $el.prop('checked', !!val);
            else $el.val(val === null || val === undefined ? '' : val);
        }
    });

    // --- PALETTE/OVERSIZE BUTTONS: set active state and hidden input value ---
    // Palette exchange
    var paletteVal = data.palette_exchange !== undefined ? data.palette_exchange : data.palette_exchange;
    var $paletteCard = $editorRow.find('#editor_paletteCard');
    var $paletteInput = $editorRow.find('#editor_palette_exchange');
    if ($paletteCard.length && $paletteInput.length) {
        if (paletteVal) {
            $paletteCard.addClass('active');
            $paletteInput.val('true');
        } else {
            $paletteCard.removeClass('active');
            $paletteInput.val('false');
        }
    }
    // Oversize
    var oversizeVal = data.oversize;
    var $oversizeCard = $editorRow.find('#editor_oversizeCard');
    var $oversizeInput = $editorRow.find('#editor_oversize');
    if ($oversizeCard.length && $oversizeInput.length) {
        if (oversizeVal) {
            $oversizeCard.addClass('active');
            $oversizeInput.val('true');
        } else {
            $oversizeCard.removeClass('active');
            $oversizeInput.val('false');
        }
    }

    // equipment (string or array)
    var equipmentVals = [];
    if(Array.isArray(data.equipment)) equipmentVals = data.equipment;
    else if (typeof data.equipment === 'string' && data.equipment.length) equipmentVals = data.equipment.split(',').map(function(s){ return s.trim(); });

    $editorRow.find('.equip-checkbox').each(function(){
        var v = $(this).val();
        $(this).prop('checked', equipmentVals.indexOf(v) !== -1);
    });
    var $hiddenEquip = $editorRow.find('select[name="equipment"]');
    if($hiddenEquip.length) $hiddenEquip.val(equipmentVals);

    // cargo_securement (string or array) -> secure-checkboxes + hidden select
    var secureVals = [];
    if (Array.isArray(data.cargo_securement)) secureVals = data.cargo_securement;
    else if (typeof data.cargo_securement === 'string' && data.cargo_securement.length) secureVals = data.cargo_securement.split(',').map(function(s){ return s.trim(); });

    $editorRow.find('.secure-checkbox').each(function(){
        var v = $(this).val();
        $(this).prop('checked', secureVals.indexOf(v) !== -1);
    });
    var $hiddenSecure = $editorRow.find('select[name="cargo_securement"]');
    if($hiddenSecure.length) $hiddenSecure.val(secureVals);

    // Render pickups/dropoffs into fieldsets and fill each field
    renderEditorFieldsets($editorRow, '#editor_pickup_container', '#editor_pickup_template', normalizeLocFields(pickups), 'from');
    renderEditorFieldsets($editorRow, '#editor_dropoff_container', '#editor_dropoff_template', normalizeLocFields(dropoffs), 'to');

    // If no locations present, render one blank each
    if((pickups.length + dropoffs.length) === 0){
        renderEditorFieldsets($editorRow, '#editor_pickup_container', '#editor_pickup_template', [{}], 'from');
        renderEditorFieldsets($editorRow, '#editor_dropoff_container', '#editor_dropoff_template', [{}], 'to');
    }

    // Add dynamic add/remove handlers for pickup/dropoff locations
    function getLocs(type) {
        if (type === 'from') return $editorRow.find('#editor_pickup_container .pickup-fieldset');
        return $editorRow.find('#editor_dropoff_container .dropoff-fieldset');
    }
    function getLocArr(type) {
        if (type === 'from') return normalizeLocFields(pickups);
        return normalizeLocFields(dropoffs);
    }
    function rerender(type, arr) {
        if (type === 'from') renderEditorFieldsets($editorRow, '#editor_pickup_container', '#editor_pickup_template', arr, 'from');
        else renderEditorFieldsets($editorRow, '#editor_dropoff_container', '#editor_dropoff_template', arr, 'to');
        wireLocBtns();
    }
    function wireLocBtns() {
        $editorRow.find('.add-location-btn').off('click').on('click', function() {
            var type = $(this).data('type');
            var arr = [];
            getLocs(type).each(function(i, el) {
                var $fs = $(el);
                // Collect ALL field values for this location
                var loc = {
                    country: $fs.find('input[name^="'+(type==="from"?"from_country":"to_country")+'"]').val(),
                    postcode: $fs.find('input[name^="'+(type==="from"?"from_postcode":"to_postcode")+'"]').val(),
                    city: $fs.find('input[name^="'+(type==="from"?"from_city":"to_city")+'"]').val(),
                    is_hidden: $fs.find('input[name^="'+(type==="from"?"is_hidden_from":"is_hidden_to")+'"]').is(':checked'),
                    start_date: $fs.find('input[name^="'+(type==="from"?"from_start_date":"to_start_date")+'"]').val(),
                    start_time_1: $fs.find('input[name^="'+(type==="from"?"from_start_time_start":"to_start_time_start")+'"]').val(),
                    start_time_2: $fs.find('input[name^="'+(type==="from"?"from_start_time_end":"to_start_time_end")+'"]').val(),
                    end_date: $fs.find('input[name^="'+(type==="from"?"from_end_date":"to_end_date")+'"]').val(),
                    end_time_1: $fs.find('input[name^="'+(type==="from"?"from_end_time_start":"to_end_time_start")+'"]').val(),
                    end_time_2: $fs.find('input[name^="'+(type==="from"?"from_end_time_end":"to_end_time_end")+'"]').val(),
                };
                // Also preserve id if present
                var idInput = $fs.find('input[name^="location_id["]');
                if (idInput.length) loc.id = idInput.val();
                $fs.data('loc-id') && (loc.id = $fs.data('loc-id'));
                arr.push(loc);
            });
            if (arr.length < 5) arr.push({});
            rerender(type, arr);
        });
        $editorRow.find('.remove-location-btn').off('click').on('click', function() {
            var type = $(this).data('type');
            var arr = [];
            getLocs(type).each(function(i, el) {
                var $fs = $(el);
                var loc = {
                    country: $fs.find('input[name^="'+(type==="from"?"from_country":"to_country")+'"]').val(),
                    postcode: $fs.find('input[name^="'+(type==="from"?"from_postcode":"to_postcode")+'"]').val(),
                    city: $fs.find('input[name^="'+(type==="from"?"from_city":"to_city")+'"]').val(),
                    is_hidden: $fs.find('input[name^="'+(type==="from"?"is_hidden_from":"is_hidden_to")+'"]').is(':checked'),
                    start_date: $fs.find('input[name^="'+(type==="from"?"from_start_date":"to_start_date")+'"]').val(),
                    start_time_1: $fs.find('input[name^="'+(type==="from"?"from_start_time_start":"to_start_time_start")+'"]').val(),
                    start_time_2: $fs.find('input[name^="'+(type==="from"?"from_start_time_end":"to_start_time_end")+'"]').val(),
                    end_date: $fs.find('input[name^="'+(type==="from"?"from_end_date":"to_end_date")+'"]').val(),
                    end_time_1: $fs.find('input[name^="'+(type==="from"?"from_end_time_start":"to_end_time_start")+'"]').val(),
                    end_time_2: $fs.find('input[name^="'+(type==="from"?"from_end_time_end":"to_end_time_end")+'"]').val(),
                };
                var idInput = $fs.find('input[name^="location_id["]');
                if (idInput.length) loc.id = idInput.val();
                $fs.data('loc-id') && (loc.id = $fs.data('loc-id'));
                arr.push(loc);
            });
            if (arr.length > 1) arr.pop();
            rerender(type, arr);
        });
        // --- Swap location logic ---
        $editorRow.find('.swap-location-btn').off('click').on('click', function() {
            var type = $(this).data('type');
            var idx = parseInt($(this).data('idx'));
            var arr = [];
            // Collect all current locations for this type
            getLocs(type).each(function(i, el) {
                var $fs = $(el);
                var loc = {
                    country: $fs.find('input[name^="'+(type==="from"?"from_country":"to_country")+'"]').val(),
                    postcode: $fs.find('input[name^="'+(type==="from"?"from_postcode":"to_postcode")+'"]').val(),
                    city: $fs.find('input[name^="'+(type==="from"?"from_city":"to_city")+'"]').val(),
                    is_hidden: $fs.find('input[name^="'+(type==="from"?"is_hidden_from":"is_hidden_to")+'"]').is(':checked'),
                    start_date: $fs.find('input[name^="'+(type==="from"?"from_start_date":"to_start_date")+'"]').val(),
                    start_time_1: $fs.find('input[name^="'+(type==="from"?"from_start_time_start":"to_start_time_start")+'"]').val(),
                    start_time_2: $fs.find('input[name^="'+(type==="from"?"from_start_time_end":"to_start_time_end")+'"]').val(),
                    end_date: $fs.find('input[name^="'+(type==="from"?"from_end_date":"to_end_date")+'"]').val(),
                    end_time_1: $fs.find('input[name^="'+(type==="from"?"from_end_time_start":"to_end_time_start")+'"]').val(),
                    end_time_2: $fs.find('input[name^="'+(type==="from"?"from_end_time_end":"to_end_time_end")+'"]').val(),
                    // --- include coordinates ---
                    latitude: $fs.find('input[name^="'+(type==="from"?"from_latitude":"to_latitude")+'"]').val(),
                    longitude: $fs.find('input[name^="'+(type==="from"?"from_longitude":"to_longitude")+'"]').val()
                };
                var idInput = $fs.find('input[name^="location_id["]');
                if (idInput.length) loc.id = idInput.val();
                $fs.data('loc-id') && (loc.id = $fs.data('loc-id'));
                arr.push(loc);
            });
            // Swap all fields, including coordinates
            if (arr[idx+1]) {
                var fields = ['country','postcode','city','is_hidden','start_date','start_time_1','start_time_2','end_date','end_time_1','end_time_2','latitude','longitude'];
                fields.forEach(function(f) {
                    var tmp = arr[idx][f];
                    arr[idx][f] = arr[idx+1][f];
                    arr[idx+1][f] = tmp;
                });
            }
            rerender(type, arr);
        });
    }
    wireLocBtns();
};

// ---------------------------
// closeOpenEditor
// ---------------------------
window.closeOpenEditor = function() {
    if (openEditorRow && openEditorRow.length) {
        openEditorRow.stop(true, true).remove();
    }
    openEditorRow = null;
    openEditorCargoId = null;
};

// ---------------------------
// syncEquipmentHidden
// ---------------------------
window.syncEquipmentHidden = function($editorRow) {
    var selected = [];
    $editorRow.find('.equip-checkbox:checked').each(function() {
        selected.push($(this).val());
    });
    var $hiddenSelect = $editorRow.find('select[name="equipment"]');
    if ($hiddenSelect.length) $hiddenSelect.val(selected);
};

// ---------------------------
// syncCargoSecureHidden (for Rögzítés)
// ---------------------------
window.syncCargoSecureHidden = function($editorRow) {
    var selected = [];
    $editorRow.find('.secure-checkbox:checked').each(function() {
        selected.push($(this).val());
    });
    var $hiddenSelect = $editorRow.find('select[name="cargo_securement"]');
    if ($hiddenSelect.length) $hiddenSelect.val(selected);
};

// ---------------------------
// $(document).ready
// ---------------------------
var tableVehicles;
$(function() {
    // ---------------------------
    // DataTable inicializálás
    // ---------------------------
    if (!$.fn.DataTable.isDataTable('#homeTableVehicles')) {
        tableVehicles = $('#homeTableVehicles').DataTable({
            "order": [[14, "desc"], [1, "asc"]],
            "pageLength": 5,
            scrollX: true,
            "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 0 }]
        });
    } else {
        tableVehicles = $('#homeTableVehicles').DataTable();
    }

    // 'Select all' checkbox
    $('#selectAllVehicles').on('click', function() {
        var checked = $(this).prop('checked');
        $('.selectVehicle').prop('checked', checked);
        console.log('Select all vehicles:', checked);
    });

    $('#deleteVehicles').off('click').on('click', function () {
        var selectedIds = [];
        $('#homeTableVehicles input.selectVehicle:checked').each(function () {
            selectedIds.push($(this).closest('tr').data('id'));
        });

        if (selectedIds.length === 0) {
            alert("Nincs kiválasztva sor!");
            return;
        }

        if (confirm("Biztosan törölni szeretnéd a kiválasztott járműveket?")) {
            $.ajax({
                url: "{{ url_for('vehicles.delete_vehicles') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ ids: selectedIds }),
                success: function (resp) {
                    $('#homeTableVehicles input.selectVehicle:checked').closest('tr').remove();
                    tableVehicles.draw(false);  // frissíti a DataTable-t
                },
                error: function(xhr) {
                    console.error("Törlés hiba:", xhr.responseText);
                    alert("Hiba történt a törlés során!");
                }
            });
        }
    });

    $('#republishSelectedVehicles').off('click').on('click', function(){
        var selectedIds = [];
        $('#homeTableVehicles input.selectVehicle:checked').each(function(){
            selectedIds.push($(this).closest('tr').data('id'));
        });

        if(selectedIds.length === 0){
            alert("Nincs kiválasztva jármű!");
            return;
        }

        if(!confirm("Biztosan szeretnéd újraközölni a kiválasztott járműveket?")) return;

        $.ajax({
            url: "/vehicles/republish_vehicles",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ids: selectedIds}),
            success: function(resp){
                if(resp.republished && resp.republished.length){
                    $('#homeTableVehicles').DataTable().rows().every(function(){
                        var id = $(this.node()).data('id');
                        if(resp.republished.includes(id)){
                            // Példa: frissítjük a "created_at" oszlopot
                            this.data()[18] = resp.now; // az indexet a created_at oszlopnak megfelelően állítsd
                        }
                    });
                    $('#homeTableVehicles').DataTable().draw(false);
                    alert("Sikeres újraközlés!");
                }
            },
            error: function(xhr){
                console.error("Újraközlés hiba:", xhr.responseText);
                alert("Hiba történt az újraközlés során!");
            }
        });
    });

    // ---------------------------
    // Hover panel logika
    // ---------------------------
    var $vehicleScrollBody = $('#homeTableVehicles_wrapper .dataTables_scrollBody');
    var $vehicleActions = $('#vehicleRowActions');

    // Mozgatjuk a scroll body-ba
    $vehicleActions.appendTo($vehicleScrollBody);
    $vehicleActions.css('position','absolute');

    var lastVehicleRow = null;

    function positionVehiclePanel($row) {
        if (!$row || !$row.length) return;

        // először láthatatlanul "mérjük"
        $vehicleActions.css({
            visibility: 'hidden',
            display: 'block'
        });

        var rowOffset = $row.position(); // scroll body-hoz képest
        $vehicleActions.css({
            top: rowOffset.top + ($row.outerHeight()/2 - $vehicleActions.outerHeight()/2),
            left: $vehicleScrollBody.innerWidth() - $vehicleActions.outerWidth() - 5
        }).data('rowId', $row.data('id'));

        // most már ténylegesen mutatjuk
        $vehicleActions.css({visibility: 'visible'}).fadeIn(100);
    }

    $('#homeTableVehicles tbody').on('mouseenter', 'tr', function() {
        var $row = $(this);
        console.log('Hover row ID:', $row.data('id'));
        if (lastVehicleRow && lastVehicleRow.is($row)) return;
        lastVehicleRow = $row;
        positionVehiclePanel($row);
    });

    $vehicleScrollBody.on('scroll', function() {
        if ($vehicleActions.is(':visible') && lastVehicleRow) {
            console.log('Scroll: reposition panel');
            positionVehiclePanel(lastVehicleRow);
        }
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('#vehicleRowActions').length) {
            $vehicleActions.fadeOut(100);
            lastVehicleRow = null;
            console.log('Click outside actions panel: hide panel');
        }
    });

    // ---------------------------
    // Modal kezelés (Bootstrap 5)
    // ---------------------------
    var vehicleModalEl = document.getElementById('vehicleModal');
    var vehicleModal = new bootstrap.Modal(vehicleModalEl);
    var openVehicleId = null;

    function closeOpenVehicleEditor() {
        console.log('Closing vehicle editor');
        vehicleModal.hide();
        openVehicleId = null;
    }

    // ---------------------------
    // Edit gomb
    // ---------------------------
    $vehicleScrollBody.off('click', '.editVehicle').on('click', '.editVehicle', function(e){
        e.stopPropagation();
        var vehicleId = $vehicleActions.data('rowId');
        console.log('Edit clicked vehicle ID:', vehicleId);

        if (!vehicleId) return;

        if (openVehicleId === vehicleId) {
            closeOpenVehicleEditor();
            return;
        }
        closeOpenVehicleEditor();

        $.getJSON("/vehicles/get_vehicle/" + vehicleId)
            .done(function(data) {
                $('#vehicleModal input[name="vehicle_type"]').val(data.vehicle_type);
                $('#vehicleModal input[name="structure"]').val(data.structure);
                $('#vehicleModal input[name="equipment"]').val(data.equipment);
                $('#vehicleModal input[name="cargo_securement"]').val(data.cargo_securement);
                $('#vehicleModal textarea[name="description"]').val(data.description);
                $('#vehicleModal input[name="capacity_t"]').val(data.capacity_t);
                $('#vehicleModal input[name="volume_m3"]').val(data.volume_m3);
                $('#vehicleModal input[name="price"]').val(data.price);
                $('#vehicleModal input[name="currency"]').val(data.currency);

                openVehicleId = vehicleId;
                vehicleModal.show();
                console.log('Vehicle modal opened for ID:', vehicleId);
            })
            .fail(function() { alert("Nem sikerült lekérni a jármű adatait."); });
    });

    // ---------------------------
    // Delete gomb
    // ---------------------------
    $vehicleScrollBody.off('click', '.deleteVehicle').on('click', '.deleteVehicle', function(e){
        e.stopPropagation();
        var vehicleId = $vehicleActions.data('rowId');
        console.log('Delete clicked vehicle ID:', vehicleId);

        if (!vehicleId) return;
        if (!confirm("Biztosan törlöd ezt a járművet?")) return;

        $.ajax({
            url: '/vehicles/delete/' + vehicleId,
            type: 'DELETE',
            success: function(resp) {
                console.log('Vehicle deleted, reloading:', vehicleId);
                window.location.reload();
            },
            error: function() { alert("Hiba a törlésnél"); }
        });
    });

    // ---------------------------
    // Save modal
    // ---------------------------
    $('#vehicleModalSave').on('click', function() {
        if (!openVehicleId) return;

        var payload = {
            vehicle_id: openVehicleId,
            field: 'vehicle_type', // szükség esetén több mező
            value: $('#vehicleModal input[name="vehicle_type"]').val()
        };

        console.log('Saving vehicle ID:', openVehicleId, payload);

        $.ajax({
            url: '/vehicles/update_vehicle',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function() {
                alert("Sikeres mentés");
                closeOpenVehicleEditor();
                window.location.reload();
            },
            error: function(err) { alert("Hiba a mentésnél"); }
        });
    });

    // Ablak resize / table redraw
    $(window).on('resize', closeOpenVehicleEditor);
    $('#homeTableVehicles').on('draw.dt', closeOpenVehicleEditor);

    // -------------------------------------------
    // Rakományok táblázat
    // -------------------------------------------
    var table;
    if (! $.fn.DataTable.isDataTable('#homeTable')) {
        table = $('#homeTable').DataTable({
            "order": [[14, "desc"], [1, "asc"]],
            "pageLength": 5,
            scrollX: true,
            "stripeClasses": ['odd-row', 'even-row'],
            "columnDefs": [{ "orderable": false, "targets": 0 }]
        });
    } else table = $('#homeTable').DataTable();

    var $actions = $('#rowActions');
    var $scrollBody = $('.dataTables_scrollBody');
    var lastRow = null;

    function positionPanel($row) {
        if (!$row || !$row.length) return;
        var rowOffset = $row.offset();
        var containerOffset = $scrollBody.offset();
        $actions.css({
            top: rowOffset.top + ($row.outerHeight()/2 - $actions.outerHeight()/2),
            left: containerOffset.left + $scrollBody.innerWidth() - $actions.outerWidth() - 5
        }).data('rowId', $row.data('id')).fadeIn(100);
    }

    $('#homeTable tbody').on('mouseenter', 'tr', function() {
        var $row = $(this);
        if (lastRow && lastRow.is($row)) return;
        lastRow = $row;
        positionPanel($row);
    });

    $scrollBody.on('scroll', function() {
        if ($actions.is(':visible') && lastRow) positionPanel(lastRow);
    });

    $(document).on('click', function(e) {
        $actions.fadeOut(100);
        lastRow = null;
    });

    // ---------------------------
    // Rakomány szerkesztő modal
    // ---------------------------
    var cargoModalEl = document.getElementById('cargoModal');
    var cargoModal = new bootstrap.Modal(cargoModalEl);
    var openCargoId = null;

    // --- EDIT gomb ---
    $actions.off('click', '.edit').on('click', '.edit', function () {
        var cargoId = $actions.data('rowId');
        if (!cargoId) return;

        console.group(`🟢 [CARGO MODAL NYITÁS] cargoId=${cargoId}`);
        console.log("➡️ Edit gomb megnyomva, rakomány betöltése indul...");

        $.getJSON("cargo/get_cargo/" + cargoId)
            .done(function (data) {
                console.log("✅ Adatok beérkeztek:", data);

                openCargoId = cargoId;
                console.log("🔓 openCargoId beállítva:", openCargoId);

                // Editor HTML beillesztése
                var editorHtml = buildEditorHtml(data);
                var $editorForm = $(editorHtml).find('.editor-container').html();
                $('#cargoModal .editor-container').html($editorForm);

                // Mezők feltöltése
                populateEditorFields($('#cargoModal'), data);
                console.log("📋 Mezők feltöltve adatokkal.");

                // Checkbox események
                $('#cargoModal').find('.equip-checkbox').on('change', function () {
                    syncEquipmentHidden($('#cargoModal'));
                });
                $('#cargoModal').find('.secure-checkbox').on('change', function () {
                    syncCargoSecureHidden($('#cargoModal'));
                });

                // Paletta / túlméretes logika
                const paletteCard = $('#cargoModal').find('#editor_paletteCard');
                const paletteInput = $('#cargoModal').find('#editor_palette_exchange');
                paletteCard.off('click').on('click', function () {
                    const isActive = paletteCard.toggleClass('active').hasClass('active');
                    paletteInput.val(isActive ? 'true' : 'false');
                    console.log("🎨 Palettacsere állapot:", isActive);
                });

                const oversizeCard = $('#cargoModal').find('#editor_oversizeCard');
                const oversizeInput = $('#cargoModal').find('#editor_oversize');
                oversizeCard.off('click').on('click', function () {
                    const isActive = oversizeCard.toggleClass('active').hasClass('active');
                    oversizeInput.val(isActive ? 'true' : 'false');
                    console.log("📦 Túlméretes állapot:", isActive);
                });

                cargoModal.show();
                $('#cargoModal').data('cargo-id', cargoId);
                console.log("✅ Modal megnyitva cargoId:", cargoId);
                console.groupEnd();
            })
            .fail(function () {
                console.error("⛔ Nem sikerült lekérni a rakomány adatait cargoId:", cargoId);
                console.groupEnd();
                alert("Nem sikerült lekérni a rakomány adatait.");
            });
    });

    // --- MENTÉS gomb a cargo modalban ---
    $(document).on('click', '#saveCargoBtn', async function(e) {
        e.preventDefault();

        const $modal = $('#cargoModal');
        const cargoId = openCargoId || $modal.data('cargo-id');
        if (!cargoId) {
            console.error("⛔ cargoId hiányzik, nem menthető!");
            return;
        }

        const $form = $modal.find('form');
        if (!$form.length) {
            console.error("⛔ Nincs form a modalban!");
            return;
        }

        const payload = {};

        // --- Alap inputok, textarea, select ---
        $form.find('input, select, textarea').each(function() {
            const name = $(this).attr('name');
            if (!name) return;

            const type = $(this).attr('type');
            if (type === 'checkbox') return; // checkboxok külön kezelve
            payload[name] = $(this).val();
        });

        // --- Equip & Secure checkboxok ---
        const equipmentVals = [];
        $form.find('.equip-checkbox:checked').each(function() {
            equipmentVals.push($(this).val());
        });
        payload['equipment'] = equipmentVals.join(', ');

        const secureVals = [];
        $form.find('.secure-checkbox:checked').each(function() {
            secureVals.push($(this).val());
        });
        payload['cargo_securement'] = secureVals.join(', ');

        // --- Palettacsere & túlméretes ---
        payload['palette_exchange'] = $form.find('#editor_palette_exchange').val() === 'true';
        payload['oversize'] = $form.find('#editor_oversize').val() === 'true';

        // --- Lokációk (pickup & dropoff) ---
        const locations = [];

        $form.find('.pickup-fieldset').each(function(idx, el) {
            const $fs = $(el);
            const loc = {
                type: 'pickup',
                id: $fs.data('loc-id') || $fs.find(`input[name="location_id[${idx}]"]`).val(),
                // A hidden mezőt használjuk
                city: $fs.find(`[name="from_city_clean[${idx}]"]`).val(),
                country: $fs.find(`[name="from_country[${idx}]"]`).val(),
                postcode: $fs.find(`[name="from_postcode[${idx}]"]`).val(),
                is_hidden: !!$fs.find(`[name="is_hidden_from[${idx}]"]`).is(':checked'),
                start_date: $fs.find(`[name="from_start_date[${idx}]"]`).val() || null,
                start_time_1: $fs.find(`[name="from_start_time_start[${idx}]"]`).val() || null,
                start_time_2: $fs.find(`[name="from_start_time_end[${idx}]"]`).val() || null,
                end_date: $fs.find(`[name="from_end_date[${idx}]"]`).val() || null,
                end_time_1: $fs.find(`[name="from_end_time_start[${idx}]"]`).val() || null,
                end_time_2: $fs.find(`[name="from_end_time_end[${idx}]"]`).val() || null,
                latitude: $fs.find(`[name="from_latitude[${idx}]"]`).val() || null,
                longitude: $fs.find(`[name="from_longitude[${idx}]"]`).val() || null
            };
            if (loc.latitude) loc.latitude = Number(loc.latitude);
            if (loc.longitude) loc.longitude = Number(loc.longitude);
            locations.push(loc);
        });

        $form.find('.dropoff-fieldset').each(function(idx, el) {
            const $fs = $(el);
            const loc = {
                type: 'dropoff',
                id: $fs.data('loc-id') || $fs.find(`input[name="location_id[${idx}]"]`).val(),
                // A hidden mezőt használjuk
                city: $fs.find(`[name="to_city_clean[${idx}]"]`).val(),
                country: $fs.find(`[name="to_country[${idx}]"]`).val(),
                postcode: $fs.find(`[name="to_postcode[${idx}]"]`).val(),
                is_hidden: !!$fs.find(`[name="is_hidden_to[${idx}]"]`).is(':checked'),
                start_date: $fs.find(`[name="to_start_date[${idx}]"]`).val() || null,
                start_time_1: $fs.find(`[name="to_start_time_start[${idx}]"]`).val() || null,
                start_time_2: $fs.find(`[name="to_start_time_end[${idx}]"]`).val() || null,
                end_date: $fs.find(`[name="to_end_date[${idx}]"]`).val() || null,
                end_time_1: $fs.find(`[name="to_end_time_start[${idx}]"]`).val() || null,
                end_time_2: $fs.find(`[name="to_end_time_end[${idx}]"]`).val() || null,
                latitude: $fs.find(`[name="to_latitude[${idx}]"]`).val() || null,
                longitude: $fs.find(`[name="to_longitude[${idx}]"]`).val() || null
            };
            if (loc.latitude) loc.latitude = Number(loc.latitude);
            if (loc.longitude) loc.longitude = Number(loc.longitude);
            locations.push(loc);
        });

        payload['locations'] = locations;

        // --- Number mezők konvertálása ---
        ['price','weight','length','length'].forEach(key => {
            if (payload[key] !== undefined && payload[key] !== '') payload[key] = Number(payload[key]);
        });

        // --- AJAX POST ---
        try {
            const response = await $.ajax({
                url: `/cargo/update_cargo/${cargoId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload)
            });

            if (response.success) {
                cargoModal.hide();
                console.log(cargoId, response.cargo);
            } else {
                showModalError("A mentés nem sikerült: " + (response.error || 'Ismeretlen hiba.'));
            }
        } catch (err) {
            console.error("⛔ AJAX hiba cargoId:", cargoId, err);
            showModalError("Hiba történt a mentés során. Nézd meg a konzolt!");
        }
    });

    // --- Hibajelzés modálon belül ---
    function showModalError(message) {
        let $errorBox = $('#cargoModal .modal-error');
        if ($errorBox.length === 0) {
            $errorBox = $('<div class="modal-error alert alert-danger mt-2"></div>');
            $('#cargoModal .modal-body').prepend($errorBox);
        }
        $errorBox.text(message).show();
    }

    // --- Modal bezárás: reset ---
    cargoModalEl.addEventListener('hidden.bs.modal', function () {
        console.log("❎ Cargo modal bezárult, állapot törlése.");
        openCargoId = null;
        $('#cargoModal .editor-container').empty();
    });

    // // === CARGO MODAL MENTÉS (részletes logolással, reload nélkül) ===
    // $(document).on('click', '#cargoModalSave', function (e) {
    //     e.preventDefault();
    //
    //     const cargoId = $('#cargoModal').data('cargo-id'); // modalhoz eltárolt id
    //     console.log('Mentés indult cargoId:', cargoId);
    //
    //     // payload összeállítása
    //     const payload = {};
    //     $('#cargoModal')
    //         .find('input, select, textarea')
    //         .each(function () {
    //             const name = $(this).attr('name');
    //             if (name) payload[name] = $(this).val();
    //         });
    //
    //     console.log('Küldött payload:', payload);
    //
    //     // AJAX kérés
    //     $.ajax({
    //         url: `/cargo/update_cargo/${cargoId}`,
    //         method: 'POST',
    //         contentType: 'application/json',
    //         data: JSON.stringify(payload),
    //         success: function (response) {
    //             console.log('Mentés sikeres:', response);
    //
    //             // Frissítjük a táblázat adott sorát, ne legyen reload
    //             const $row = $(`#cargo-row-${cargoId}`);
    //             if ($row.length) {
    //                 for (const [key, value] of Object.entries(payload)) {
    //                     const cell = $row.find(`.cargo-${key}`);
    //                     if (cell.length) cell.text(value);
    //                 }
    //             }
    //
    //             // Modal bezárása
    //             $('#cargoModal').modal('hide');
    //
    //             // Opcionális: kis vizuális visszajelzés
    //             $row.addClass('updated');
    //             setTimeout(() => $row.removeClass('updated'), 1500);
    //         },
    //         error: function (xhr) {
    //             console.error('Mentési hiba:', xhr.responseText);
    //             const $errorBox = $('#cargoModal .error-message');
    //             if ($errorBox.length) {
    //                 $errorBox.text('Hiba történt a mentés során!').show();
    //             } else {
    //                 alert('Hiba történt a mentés során!');
    //             }
    //         }
    //     });
    // });

    $actions.off('click', '.delete').on('click', '.delete', function(e) {
        e.preventDefault();
        var rowId = $actions.data('rowId');
        if (!rowId) return;
        if (!confirm("Biztosan törlöd ezt a fuvart?")) return;

        var $targetRow = $(this).closest('tr');

        $.ajax({
            url: 'cargo/delete_cargo/' + rowId,
            type: 'DELETE',
            success: function(resp){
                if(resp && resp.success){
                    // Oldal újratöltése, hogy látszódjon a törlés
                    window.location.reload();
                } else {
                    alert('Hiba a törlés során: ' + (resp.error || JSON.stringify(resp)));
                }
            },
            error: function(xhr, status, error) {
                alert("Nem sikerült törölni: " + error);
            }
        });
    });

    $('#selectAll').on('click',function(){
        var rows = table.rows({'search':'applied'}).nodes();
        $('input.rowCheckbox',rows).prop('checked',this.checked);
    });

    $('#deleteSelected').off('click').on('click',function(){
        var selectedIds=[];
        table.$('input.rowCheckbox:checked').each(function(){ selectedIds.push($(this).closest('tr').data('id')); });
        if(selectedIds.length===0){ alert("Nincs kiválasztva sor!"); return; }
        if(confirm("Biztosan törölni szeretnéd a kiválasztott sorokat?")){
            $.ajax({
                url:"{{ url_for('cargo.delete_cargos') }}",
                type:"POST",
                contentType:"application/json",
                data:JSON.stringify({ids:selectedIds}),
                success:function(resp){ table.rows($('input.rowCheckbox:checked').parents('tr')).remove().draw(); },
                error:function(){ alert("Hiba történt a törlés során!"); }
            });
        }
    });

    var republishCooldown=false;
    $('#republishSelected').off('click').on('click',function(){
        if(republishCooldown){ alert("Várj, az újraközlés csak 30 másodpercenként lehetséges!"); return; }
        var selectedIds=[];
        table.$('input.rowCheckbox:checked').each(function(){ selectedIds.push($(this).closest('tr').data('id')); });
        if(selectedIds.length===0){ alert("Nincs kiválasztva sor!"); return; }
        if(confirm("Biztosan szeretnéd újraközölni a kiválasztott sorokat?")){
            $.ajax({
                url:"{{ url_for('cargo.republish_cargos') }}",
                type:"POST",
                contentType:"application/json",
                data:JSON.stringify({ids:selectedIds}),
                success:function(resp){
                    table.rows().every(function(){
                        var id = $(this.node()).data('id');
                        if(resp.republished.includes(id)) this.data()[17] = resp.now;
                    });
                    table.draw(false);
                    alert("Sikeres újraközlés!");
                },
                error:function(){ alert("Hiba történt az újraközlés során!"); }
            });
        }
    });

    $(window).on('resize', function() {
        closeOpenEditor();
    });

    $('#homeTable').on('draw.dt', function() {
        closeOpenEditor();
    });

    // Add Palettacsere and Túlméretes card logic for the editor
    $(document).on('mouseenter', '.editor-row', function() {
        // Only bind once per editor row
        const $row = $(this);
        if ($row.data('cards-initialized')) return;
        $row.data('cards-initialized', true);
        const paletteCard = $row.find('#editor_paletteCard');
        const paletteInput = $row.find('#editor_palette_exchange');
        paletteCard.on('click', function() {
            const isActive = paletteCard.toggleClass('active').hasClass('active');
            paletteInput.val(isActive ? 'true' : 'false');
        });
        const oversizeCard = $row.find('#editor_oversizeCard');
        const oversizeInput = $row.find('#editor_oversize');
        oversizeCard.on('click', function() {
            const isActive = oversizeCard.toggleClass('active').hasClass('active');
            oversizeInput.val(isActive ? 'true' : 'false');
        });
    });

    // ---------------------------
    // Inline editor: Country autocomplete & City autofill (by postcode)
    // ---------------------------

    // Helper: fetch JSON
    function fetchJson(url) {
        return fetch(url).then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        });
    }

    // Attach delegated listeners to pickup/dropoff containers in the inline editor
    $(document).on('mouseenter', '.editor-row', function() {
        const $editorRow = $(this);
        // Only bind once per editor row
        if ($editorRow.data('autocomplete-initialized')) return;
        $editorRow.data('autocomplete-initialized', true);

        // For both pickup and dropoff containers
        ['#editor_pickup_container', '#editor_dropoff_container'].forEach(function(containerSel) {
            const $container = $editorRow.find(containerSel);
            if (!$container.length) return;

            // Delegated input event for country fields
            $container.on('input', 'input[name^="from_country"], input[name^="to_country"]', function(e) {
                const $input = $(this);
                const val = $input.val();
                if (!val) return;
                // If ISO code (2 uppercase letters), skip
                if (/^[A-Z]{2}$/.test(val.trim())) return;
                // Find or create datalist
                let $datalist = $input.siblings('datalist');
                if (!$datalist.length) {
                    // Try to find in parent
                    $datalist = $input.closest('fieldset').find('datalist');
                }
                if (!$datalist.length) return;
                fetchJson('/cargo/autocomplete/country?term=' + encodeURIComponent(val))
                    .then(function(data) {
                        $datalist.empty();
                        data.forEach(function(item) {
                            const iso = item.value || item.iso || '';
                            const name = item.label || item.countryName || item.name || iso;
                            $('<option>').val(iso || name).text(name).appendTo($datalist);
                        });
                    })
                    .catch(function(err) {
                        // silently ignore
                    });
            });

            // Delegated blur event for postcode fields
            $container.on('blur', 'input[name^="from_postcode"], input[name^="to_postcode"]', function(e) {
                const $postcode = $(this);
                const $fieldset = $postcode.closest('fieldset');
                const $country = $fieldset.find('input[name^="from_country"], input[name^="to_country"]');
                const $city = $fieldset.find('input[name^="from_city"], input[name^="to_city"]');
                if (!$country.length || !$city.length) return;
                const country = $country.val() || '';
                const postalcode = $postcode.val() || '';
                if (!postalcode) return;
                fetchJson('/cargo/zipcode?postalcode=' + encodeURIComponent(postalcode) + '&country=' + encodeURIComponent(country))
                    .then(function(data) {
                        if (data && data.city) {
                            $city.val(data.city);
                            $city.trigger('change'); // trigger change for coordinate update
                        }
                    })
                    .catch(function(err) {
                        // silently ignore
                    });
            });

            // Delegated change event for city fields: update coordinates
            let geocodeTimeout = null;
            let geocodeAbortController = null;

            function scheduleGeocode($fieldset) {
                if (geocodeTimeout) clearTimeout(geocodeTimeout);

                geocodeTimeout = setTimeout(() => {
                    if (geocodeAbortController) {
                        geocodeAbortController.abort();
                    }
                    geocodeAbortController = new AbortController();

                    const $country = $fieldset.find('input[name^="from_country"], input[name^="to_country"]');
                    const $city = $fieldset.find('input[name^="from_city"], input[name^="to_city"]');
                    const $postcode = $fieldset.find('input[name^="from_postcode"], input[name^="to_postcode"]');
                    const $lat = $fieldset.find('input[name^="from_latitude"], input[name^="to_latitude"]');
                    const $lng = $fieldset.find('input[name^="from_longitude"], input[name^="to_longitude"]');

                    const country = $country.val() || '';
                    const city = $city.val() || '';
                    const postcode = $postcode.val() || '';
                    if (!city) return;

                    fetch('/cargo/geocode_location?country=' + encodeURIComponent(country) +
                          '&city=' + encodeURIComponent(city) +
                          '&postcode=' + encodeURIComponent(postcode), {
                        signal: geocodeAbortController.signal
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data && typeof data.lat === 'number' && typeof data.lng === 'number') {
                            $lat.val(data.lat);
                            $lng.val(data.lng);
                        }
                    })
                    .catch(err => {
                        if (err.name === 'AbortError') return; // ezt szándékosan állítottuk le
                        console.error("Geocode error", err);
                    });
                }, 500); // debounce idő (0.5s)
            }

            // és az esemény így:
            $container.on('input', 'input[name^="from_city"], input[name^="to_city"]', function(e) {
                const $fieldset = $(this).closest('fieldset');
                scheduleGeocode($fieldset);
            });
        });
    });
});

document.addEventListener("DOMContentLoaded", function () {
  const swapBtn = document.getElementById("swap-btn");
  const originInput = document.getElementById("origin");
  const destinationInput = document.getElementById("destination");
  swapBtn?.addEventListener("click", function(e){
    e.preventDefault();
    [originInput.value, destinationInput.value] = [destinationInput.value, originInput.value];
    ['input','change'].forEach(ev=> { originInput.dispatchEvent(new Event(ev,{bubbles:true})); destinationInput.dispatchEvent(new Event(ev,{bubbles:true})); });
  });
});

// 2. Card toggles
['paletteCard','oversizeCard','loadtypeCard'].forEach(id=>{
  const el=document.getElementById(id);
  const hidden=document.getElementById(id==='paletteCard'?'palette_exchange':id==='oversizeCard'?'oversize':'load_type');
  el?.addEventListener('click', ()=>{ el.classList.toggle('active'); hidden.value=el.classList.contains('active'); });
});

// 4. Date default
if (typeof today === 'undefined') {
    var today = new Date();
}
const y = today.getFullYear(),
      m = String(today.getMonth() + 1).padStart(2, '0'),
      d = String(today.getDate()).padStart(2, '0');
document.getElementById('available_from').value = `${y}-${m}-${d}`;

let expanded = { equipment: false, securement: false };

function toggleCheckboxes(type) {
   const checkboxes = document.getElementById(type + "-checkboxes");
   checkboxes.style.display = expanded[type] ? "none" : "grid";
   expanded[type] = !expanded[type];
}

// Szinkronizálás a hidden selecttel
function setupMultiselect(type) {
   const checkboxes = document.querySelectorAll(`#${type}-checkboxes input[type="checkbox"]`);
   const hiddenSelect = document.getElementById(type);
   const selectedSpan = document.getElementById(type + "-selected");

   checkboxes.forEach(cb => {
       cb.addEventListener('change', () => {
           Array.from(hiddenSelect.options).forEach(option => option.selected = false);

           const checkedValues = [];
           checkboxes.forEach(cb => {
               if(cb.checked){
                   const option = Array.from(hiddenSelect.options).find(o => o.value === cb.value);
                   if(option) option.selected = true;
                   checkedValues.push(cb.value);
                   cb.parentElement.classList.add('selected');
               } else {
                   cb.parentElement.classList.remove('selected');
               }
           });
           selectedSpan.textContent = checkedValues.length ? checkedValues.join(', ') : (type==='equipment' ? 'Válassz felszereltséget' : 'Válassz rakományrögzítést');
       });
   });

   // Betöltéskor kijelölés
   checkboxes.forEach(cb => {
       if(cb.checked) cb.parentElement.classList.add('selected');
       else cb.parentElement.classList.remove('selected');
   });
}

// Init hívás
setupMultiselect('equipment');
setupMultiselect('securement');

window.openCargoEditorModal = function(data) {
    const $modal = $('#cargoEditorModal');
    const $container = $('#cargoEditorContainer');

    // build form HTML inline helyett a containerbe
    $container.html(buildEditorHtml(data));

    // Populate fields
    populateEditorFields($container.find('.editor-row'), data);

    // show modal
    $modal.show();

    // close button
    $modal.find('.modal-close').off('click').on('click', closeCargoEditorModal);
}

window.closeCargoEditorModal = function() {
    $('#cargoEditorModal').hide();
    $('#cargoEditorContainer').empty();
}

$(document).on('click', '.editor-cancel', function(e){
    e.preventDefault();
    closeCargoEditorModal();
});

// $('#cargoEditorContainer').on('submit', '.inline-edit-form', function(e){
//     e.preventDefault();
//     const $form = $(this);
//     const $editorRow = $form.closest('.editor-row'); // helyesen innen kell olvasni!
//     const cargoId = $editorRow.data('editor-for');
//     console.log("➡️ Form submit – cargoId:", cargoId);
//
//     if (!cargoId) {
//         console.error("❌ Nincs cargoId a szerkesztéshez!");
//         alert("Nem található rakomány ID – mentés megszakítva.");
//         return;
//     }
//
//     submitEditorForm($editorRow, cargoId, null);
// });

$('.edit-cargo-btn').on('click', function(){
    const cargoId = $(this).data('id');
    // fetch data az API-ból vagy DataTable-ból
    $.get('/cargo/get/' + cargoId, function(data){
        openCargoEditorModal(data);
    });
});
</script>
{% endblock %}

<style>
#expiredModal {
  display: flex; /* hidden class helyett */
  position: fixed;
  inset: 0;
  justify-content: center;
  align-items: center;
  background-color: rgba(0,0,0,0.5);
  z-index: 9999;
}
#expiredContent {
  overflow-y: hidden; /* ha túl sok minden van benne, lehessen görgetni */
}
#expiredModal.hidden {
  display: none;
}
.flex{
    flex-wrap: wrap;
}
.fejlec{
    width: 100%;
}
.kepek{
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: nowrap;
}
.kepek img:hover{
    transform: scale(1.05);
    transition: transform 0.3s ease;
    cursor: pointer;
    border-radius: 8px;
}
#expiredExtendArea {
    position: relative; /* már jó */
    width: 100%;
    height: 100%;
}
#expiredDeleteArea {
    position: relative; /* már jó */
    width: 100%;
    height: 100%;
}
#expiredExtendArea input {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none; /* ne fogja meg a kattintást, csak látszódjon */
    z-index: 10;
    width: 60px; /* szükség szerint */
    padding: 4px 6px;
    text-align: center;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: rgba(255,255,255,0.8);
}
.expired-input {
  position: absolute;
  top: 65%; /* pontosításhoz lehet finomhangolni */
  left: 75%; /* kb. a jobb kép közepe */
  transform: translate(-50%, -50%);
  z-index: 99999;
  width: 60px;
  padding: 4px 6px;
  text-align: center;
  border-radius: 6px;
  border: 1px solid #ccc;
  background-color: rgba(255,255,255,0.9);
  transition: opacity 0.3s ease;
}

/* Ha nem az extendArea fölött van az egér, halványabb */
#expiredExtendArea:not(:hover) ~ .expired-input {
  opacity: 0.3;
}

/* Ha fölé viszed, kiemelkedik */
#expiredExtendArea:hover ~ .expired-input {
  opacity: 1;
}

/* Törlés szöveg */
#expiredDeleteArea .hover-text {
    transform: translateX(-50%);
    bottom: 60%;
    left: 50%;
}
/* Hosszabbítás szöveg */
#expiredExtendArea .hover-text {
    bottom: 60%; /* az input fölé */
    left: 50%;
    transform: translateX(-50%);
}
/* Hover overlay a képeken */
.hover-overlay {
    position: absolute;
    inset: 0; /* lefedi a teljes szülő divet */
    background-color: rgba(0,0,0,0); /* alapból láthatatlan */
    transition: background-color 0.3s ease;
    z-index: 5; /* az input és szöveg alatt */
    pointer-events: none; /* ne blokkolja a kattintást */
}

/* Amikor hover a szülő .group */
.group:hover .hover-overlay {
    background-color: rgba(0,0,0,0.4); /* félig átlátszó fekete */
}

/* Hover szöveg */
.hover-text {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
    font-weight: 600;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 10; /* input fölött */
}

.group:hover .hover-text {
    opacity: 1;
    transform: translateY(0);
}

/* Kép animáció hoverkor */
.kepek img {
    width: 95%;
    height: 90%;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.group:hover img {
    transform: scale(1.05);
    opacity: 0.6; /* kissé elhalványul a kép */
}

.suggestions { display:none; position:relative; background:#fff; border:1px solid #ccc; max-height:200px; overflow-y:hidden; width:100%; z-index:1100; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.result-item { padding:5px 10px; cursor:pointer;}
.result-item:hover { background-color:#f0f0f0; }

/* Form stílus */
.offer-form { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.offer-form label { display:flex; flex-direction:column; font-size:0.9em; }
.offer-form input, .offer-form select, .offer-form textarea { width:100%; padding:6px 10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; transition:border-color 0.2s; }
.offer-form input:focus, .offer-form select:focus, .offer-form textarea:focus { outline:none; border-color:#007bff; }

.places { display:grid; grid-template-columns:40% 7% 5% 40% 7%; gap:10px; }
#origin { grid-column:1/2; } #origin_diff { grid-column:2/3; } #swap-btn { grid-column:3/4; } #destination { grid-column:4/5; } #destination_diff { grid-column:5/6; }
#available_from { grid-column:1/3; } #available_until { grid-column:4/6; }

/* Kártyák */
.cards-row { display:flex; gap:12px; margin-top:12px; }
.palette-card, .oversize-card, .loadtype-card { flex:1; text-align:center; padding:12px; border:2px solid #ddd; border-radius:12px; cursor:pointer; background:#fafafa; transition:all 0.2s; }
.palette-card:hover, .oversize-card:hover, .loadtype-card:hover { background:#f2f6ff; border-color:#cfe0ff; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
.palette-card.active, .oversize-card.active, .loadtype-card.active { background:#e9f5ff; border-color:#5aa3ff; box-shadow:0 2px 6px rgba(0,0,0,0.08); font-weight:500; }

/* Multiselect */
.multiselect { position:relative; font-family:Arial, Helvetica, sans-serif; }
.selectBox { border:1px solid #d0d7de; padding:10px 12px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(transparent, rgba(0,0,0,0.01)); box-shadow:0 1px 2px rgba(11,15,22,0.03);}
.selectBox span { display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:calc(100% - 24px);}
.cards-panel { position:absolute; width:100%; z-index:1200; margin-top:8px; left:0; background:#fff; border:1px solid #e2e8f0; border-radius:10px; box-shadow:0 8px 24px rgba(11,15,22,0.08); padding:12px; box-sizing:border-box; display:none; }
.cards-panel.open { display:grid; }
.cards-grid { display:grid; gap:10px; }
.card-item { padding:10px; border-radius:8px; border:1px solid #e6eef8; min-height:46px; display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; font-size:14px; background:linear-gradient(180deg, #ffffff, #fbfdff); transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease; }
.card-item.selected { border-color:#2b9af3; box-shadow:0 6px 18px rgba(43,154,243,0.12); transform:translateY(-2px); background:linear-gradient(180deg, rgba(43,154,243,0.06), #ffffff); font-weight:600; }

/* Accordion */
.accordion-btn { width:30%; background-color:#007bff; color:white; padding:12px; font-size:16px; border:none; border-radius:8px; cursor:pointer; text-align:left; margin-bottom:10px; }
.accordion-btn:hover { background-color:#0056b3; }
.accordion-content { display:none; }

/* Submit button */
.btn-wrapper button { background:#007bff; color:white; border:none; padding:10px 18px; border-radius:8px; font-size:15px; cursor:pointer; }
.btn-wrapper button:hover { background:#0056b3; }
.home-container { display: flex; flex-wrap: wrap; max-width: 100%; }
.sidebar { flex: 1 1 200px; }
.main-content { flex: 3 1 100%; padding: 15px; }
.table-actions { margin-bottom: 10px; max-width: 80%; }
.table-outer { max-width: 100%; }
.dataTables_wrapper .dataTables_scroll { margin-right: 20px; margin-left: 20px; }
.dataTables_scroll { border: 1px solid black; overflow: auto; }
#rowActions { position: absolute; display: none; background: #f1f1f1; border: 1px solid #ccc; padding: 2px; border-radius: 4px; z-index: 10; }
#vehicleRowActions {
    position: absolute;
    display: none;
    background: #f1f1f1;
    border: 1px solid #ccc;
    padding: 2px;
    border-radius: 4px;
    z-index: 10;

    white-space: nowrap;      /* ne törjön új sorba */
}
#vehicleRowActions button {
    display: inline-block; /* egymás mellett */
    margin: 2px;
    padding: 2px 5px; cursor: pointer; border: none; background: #fff; border-radius: 4px;
}
#rowActions button { margin: 2px; padding: 2px 5px; cursor: pointer; border: none; background: #fff; border-radius: 4px; }
.odd-row { background-color: #fafafa; }
.even-row { background-color: #eee; }

/* ---------------------------
   Bootstrap modal fixek
   --------------------------- */
.modal {
    display: none; /* Bootstrap JS kezeli */
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5); /* sötét hátteret ad */
    z-index: 1050; /* Bootstrap alap modal z-index */
}

/* Egyedi modals - magasabb z-index, ha egyszerre több modal van */
#cargoModal { z-index: 1060; }
#vehicleModal { z-index: 1070; }

/* Modal dialog középre igazítása */
.modal-dialog {
    margin: 1.5rem auto;
    display: flex;
    align-items: center;
    min-height: calc(100vh - 3rem);
}

/* Modal content */
.modal-content {
    background-color: #fff;
    border-radius: 12px;
    padding: 16px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}

/* Modal backdrop fix */
.modal-backdrop {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1040; /* modal alá kerül */
}

/* Ha több modal van egyszerre */
.modal.show + .modal-backdrop { z-index: 1055; }

/* Editor inline tartalom */
.editor-container {
    position: sticky !important;
    left: 40px;
    align-self: flex-start;
    padding: 6px;
    background: #ffffff;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    margin: 4px;
    font-size: 0.82rem;
    width: 100%;
}

.editor-row td {
    padding: 0;
    border-top: 1px solid #ddd;
    background: #fbfbfb;
}

.vehicle-fieldset {
    flex: 0 0 70%;
    min-width: 100%;
}

.cargo-fieldset{
    display: flex;
    max-width: 100%;
    align-items: start;
    flex-direction: row;
    gap: 10px;
}
.cargo-fieldset label{
    width: 100%;
}
.cargo-fieldset input{
    width: 300px;
}
.cargo-fieldset .cargo-row-2 label input{
    width: 100px;
}
.cargo-fieldset .cargo-row-2 select{
    width: 100px;
}

.inline-fieldset legend {
    font-weight: bold;
    padding: 0 4px;
    font-size: 0.8rem;
}

.inline-col input[type="text"],
.inline-col input[type="date"],
.inline-col input[type="time"],
.inline-col input[type="number"],
.inline-col select {
    padding: 4px 6px;
    border-radius: 4px;
    border: 1px solid #cfcfcf;
    font-size: 0.82rem;
    background: #fff;
}
.inline-col input[type="date"] { width: 50%; }
.inline-col input[type="time"] { width: 40%; }

.equipment-box, .secure-box {
    display: grid;
    gap: 0.4rem;
    max-height: 100px;
    overflow: auto;
    padding: 6px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
}
.equipment-box { grid-template-columns: repeat(4, 1fr); }
.secure-box { grid-template-columns: repeat(3, 1fr); }

.equip-label, .secure-label {
    display: flex;
    flex-direction: row-reverse;
    align-items: center;
    text-align: center;
    justify-content: center;
    width: 80%;
    padding: 4px 4px;
    min-height: 26px;
    border: 1px solid #e6e6e6;
    border-radius: 10px;
    background: #fff;
    cursor: pointer;
    white-space: normal;
    transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    font-size: 0.75rem;
}
.equip-label:hover, .secure-label:hover {
    background: #f2f6ff;
    border-color: #cfe0ff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.equip-label:has(.equip-checkbox:checked),
.secure-label:has(.secure-checkbox:checked) {
    background: #e9f5ff;
    border-color: #5aa3ff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.equip-checkbox, .secure-checkbox { display: none; }

.editor-save, .editor-cancel {
    padding: 4px 8px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.8rem;
}
.editor-save { background: #0b7a3f; color: white; }
.editor-cancel { background: #f1f1f1; color: #333; }

.grid-top {
    display: block;            /* biztosan blokkos legyen */
    width: 100%;               /* teljes szélesség */
    flex: 1 1 100%;            /* flexbox esetén is töltse ki */
    box-sizing: border-box;    /* padding ne növelje a szélességet */
    max-width: 100%;           /* ne lépje túl */
}

.pickup-wrapper, .dropoff-wrapper{
    width: 100%;
}

.pickup-cell, .dropoff-cell {
    white-space: nowrap;
}
.country-zip {
    font-weight: bold;
}
.extra-count {
    color: #666;
    font-size: 0.8em;
}

.dataTable thead tr th, .dataTable td {
    padding: 8px 10px;
    vertical-align: middle;
    text-align: center;
}

/* Dates redesign */
.editor-dates .dates-fieldset { padding: 6px; }
.editor-dates .dates-side { flex: 1 1 50%; display: flex; gap: 6px; align-items: flex-end; }
.editor-dates .dates-side .dates-side-block { display: flex; flex-direction: column; justify-content: flex-end; }
.editor-dates .dates-side .dates-side-block:nth-child(1) { width: 45%; }
.editor-dates .dates-side .dates-side-block:nth-child(2) { width: 25%; }
.editor-dates .dates-side .dates-side-block:nth-child(3) { width: 25%; }
.editor-dates .dates-side .dates-side-block input[type="date"],
.editor-dates .dates-side .dates-side-block input[type="time"] { width: 100%; box-sizing: border-box; padding: 4px 6px; border-radius: 4px; border: 1px solid #cfcfcf; font-size: 0.82rem; }
.editor-dates .dates-side .dates-side-block label { font-weight: 600; font-size: 0.78rem; margin-bottom: 2px; }

/* Location fields: one row layout (25% / 25% / 40%) */
.location-grid { width: 100%; }
.location-grid .left-side { display: grid; grid-template-columns: 95%; gap: 8px; align-items: center; }
.location-grid .left-side label { margin: 0; font-weight: 600; font-size: 0.78rem; }
.location-grid .left-side label:nth-of-type(1) { grid-column: 1; }
.location-grid .left-side label:nth-of-type(2) { grid-column: 2; }
.location-grid .left-side label:nth-of-type(3) { grid-column: 3; }
.location-grid .left-side input[type="text"]:nth-of-type(1) { grid-column: 1; width:100%; box-sizing:border-box; }
.location-grid .left-side input[type="text"]:nth-of-type(2) { grid-column: 2; width:100%; box-sizing:border-box; }
.location-grid .left-side input[type="text"]:nth-of-type(3) { grid-column: 3; width:100%; box-sizing:border-box; }
.location-grid .left-side label:nth-of-type(4),
.location-grid .left-side input[type="checkbox"] { grid-column: 3; }

.location-grid .right-side { display: grid; grid-template-columns: 45% 45%; gap: 15px; align-items: end; width: 100%; }
.location-grid .right-side label { margin: 0; font-weight: 600; width: 100%; font-size: 0.78rem; }
.location-grid .right-side label:nth-of-type(1) { grid-column: 1; }
.location-grid .right-side input[type="date"]:nth-of-type(1) { grid-column: 1; width:100%; box-sizing:border-box; }
.location-grid .right-side .time-row:nth-of-type(1) { grid-column: 3; display:flex; gap:8px; align-items:center; justify-content:flex-start; margin-top: 10px;}
.location-grid .right-side label:nth-of-type(2) { grid-column: 2; }
.location-grid .right-side input[type="date"]:nth-of-type(2) { grid-column: 2; width:100%; box-sizing:border-box; }
.location-grid .right-side .time-row:nth-of-type(2) { grid-column: 3; display:flex; gap:8px; align-items:center; justify-content:flex-start; margin-top: 10px; }
.time-row input[type="time"] { width: 48%; box-sizing: border-box; }
.time-row input[type="time"]:nth-of-type(2) { width: 48%; box-sizing: border-box; }

@media (max-width: 700px) {
    .location-grid .left-side, .location-grid .right-side { grid-template-columns: 1fr; gap: 6px; }
    .location-grid .left-side label, .location-grid .right-side label { font-size: 0.76rem; }
    .time-row { display:flex; gap:6px; }
    .time-row input[type="time"] { width: 48%; }
}

/* Add style for location add/remove buttons */
.location-btn-row button.add-location-btn,
.location-btn-row button.remove-location-btn {
    font-size: 1.2em;
    padding: 2px 10px;
    border: none;
    background: #eaf6ff;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
    width: 100%;
}
.location-btn-row button.add-location-btn:hover,
.location-btn-row button.remove-location-btn:hover {
    background: #b6e3ff;
}
.location-btn-row { margin-bottom: 8px; width: 93%; }

.cargo-row-1{ margin-bottom: 8px; display: flex; flex: 0 0 100%; gap: 12px; }
.cargo-row-1 > div { flex: 0 0 32%; max-width: 32%; min-width: 0; box-sizing: border-box; }

.palette-card, .oversize-card { display: flex; flex: 0 0 45%; justify-content: center; align-items: center; padding: 12px; margin-top: 8px; border: 1px solid #e6e6e6; border-radius: 12px; background: #fafafa; cursor: pointer; transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; user-select: none; max-height: 57px; }
.palette-card:hover, .oversize-card:hover { background: #f2f6ff; border-color: #cfe0ff; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
.palette-card.active, .oversize-card.active { background: #e9f5ff; border-color: #5aa3ff; box-shadow: 0 2px 6px rgba(0,0,0,0.08); font-weight: 500; }
#editor_paletteText, #editor_oversizeText { color: #000; }

span img{ width: 20px; }

.swap-btn-row { display: flex; justify-content: center; align-items: center; width: 100%; margin: 0.2em 0 0.2em 0; }
.swap-location-btn { font-size: 1.2em; padding: 2px 0; border: none; background: #eaf6ff; border-radius: 6px; cursor: pointer; transition: background 0.15s; width: 50%; min-width: 80px; max-width: 200px; display: block; margin: 0 auto; font-weight: bold; color: #1a3d5d; }
.swap-location-btn:hover { background: #b6e3ff; }

textarea { max-height: 110px; width: 100% }
</style>
{% endblock %}
